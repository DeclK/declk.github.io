<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>MMCV tutorial</title>
      <link href="/archives/81012a8b.html"/>
      <url>/archives/81012a8b.html</url>
      
        <content type="html"><![CDATA[<h1 id="Understand-MMCV"><a href="#Understand-MMCV" class="headerlink" title="Understand MMCV"></a>Understand MMCV</h1><p>现在想要更深一步学习 mmdetection，于是必不可少地要来了解一下 MMCV 这个基础库。从之前的学习过程来看，一个思想就是一切皆为 class。配置文件有 Config class，管理模块有 Registry class，运行模型有 Runner class…下面来具体看看这些类的一些基础框架</p><h2 id="Config"><a href="#Config" class="headerlink" title="Config"></a>Config</h2><blockquote><p><code>Config</code> class is used for manipulating config and config files. It supports loading configs from multiple file formats including <strong>python</strong>, <strong>json</strong> and <strong>yaml</strong>. It provides dict-like apis to get and set values.</p></blockquote><p>从 mmdetection 代码来看，主要是从 python 文件创建 config class</p><h3 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h3><p>文档举了一个例子</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># test.py</span>a <span class="token operator">=</span> <span class="token number">1</span>b <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>b1<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> b2<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>c <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>d <span class="token operator">=</span> <span class="token string">'string'</span>pre_defined <span class="token operator">=</span> <span class="token string">'{{ fileDirname }}'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>从 <code>test.py</code> 创建 config class</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> mmcv<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>config <span class="token keyword">import</span> Configcfg <span class="token operator">=</span> Config<span class="token punctuation">.</span>fromfile<span class="token punctuation">(</span><span class="token string">'test.py'</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token comment"># print result</span><span class="token comment"># Config (path: a.py): {'a': 1, 'b': {'b1': [0, 1, 2], 'b2': None}, 'c': (1, 2), 'd': 'string',</span><span class="token comment"># 'pre_defined': '/home/hongkun/mmdetection'}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>config class 也支持4个预先定义的变量 <code>{{ var }}</code></p><p><code>{{ fileDirname }}</code> : 当前文件路径</p><p><code>{{ fileBasename }}</code>: 当前文件名，如 <code>test.py</code></p><p><code>{{ fileBasenameNoExtension }}</code>:  当前文件名，无扩展名，如 <code>test</code></p><p><code>{{ fileExtname }}</code>: 当前文件扩展名，如 <code>.py</code></p><h3 id="继承-inheritance"><a href="#继承-inheritance" class="headerlink" title="继承 inheritance"></a>继承 inheritance</h3><p>想要使用其他配置文件中的内容，只需要添加继承关键字 <code>_base_ = file or list_of_file</code> 即可</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># inheritance.py</span>_base_ <span class="token operator">=</span> <span class="token string">'test.py'</span> <span class="token comment"># or a list like, ['config_1.py', 'config_2.py']</span>b <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>b2<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment"># b = dict(b3=1, _delete_=True)</span>e <span class="token operator">=</span> <span class="token string">'new config'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>继承之后，<code>inheritance.py</code> 除了自身的配置，还会包含 <code>test.py</code> 中的所有配置</p><p>当遇到重复的关键字时，例如两个配置文件中都有 <code>b</code> 关键字，config class 也支持修改，此时情况分为：</p><ol><li>key 对应的 value 为字典，那么会将这个字典与需要继承的字典进行融合，如果想要忽略继承文件夹中的同名配置，则需要添加 <code>_delete_=True</code> 键值</li><li>key 对应的 value 为为其他类型，则将使用当前的 value</li></ol><h2 id="Registry"><a href="#Registry" class="headerlink" title="Registry"></a>Registry</h2><p>registry class 是整个 MMCV 的大管家，负责将<strong>类</strong>进行注册并配合 config 中的信息将类实例化，这个类可以是任何已实现的类：可以是模型，也可以是其他类比如 Runner, Datasets…本质上 registry 完成的是一个映射： string —&gt; class，这里的 string 通常在 config 中对应着 <code>type</code> 字段。你在 config 文件中只要看到了 <code>type='CLASS_NAME'</code> 那么就一定可以在项目代码中找到对应的类的实现，而 <code>type</code> 之后填写的其他关键字，正是这些类需要的初始化参数。所以大可以把 registry 看作是一个高级的字典</p><p>使用 registry 管理类需要3个步骤（一般只要2个）：</p><ol><li>创建 build function (一般不用自己创建，Registry 有自带 build_from_cfg 函数)</li><li>创建 registry 类</li><li>把待管理的类注册到 registry 中，即可使用 registry 管理模块</li></ol><h3 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h3><p>假设要管理一个 <code>Converter class</code>，准备在 <code>Converters</code> 文件夹中实现。先尝试用一个 python 文件： <code>builder.py</code> 实现 registry 的管理功能，并通过 registry 实例化 Converter</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># Converters/builder.py</span><span class="token keyword">from</span> mmcv<span class="token punctuation">.</span>utils <span class="token keyword">import</span> Registry<span class="token comment"># 1. create a build function</span><span class="token keyword">def</span> <span class="token function">build_converter</span><span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> registry<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>    cfg_ <span class="token operator">=</span> cfg<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>    converter_type <span class="token operator">=</span> cfg_<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">'type'</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> converter_type <span class="token keyword">not</span> <span class="token keyword">in</span> registry<span class="token punctuation">:</span>        <span class="token keyword">raise</span> KeyError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Unrecognized converter type </span><span class="token interpolation"><span class="token punctuation">{</span>converter_type<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        converter_cls <span class="token operator">=</span> registry<span class="token punctuation">.</span>get<span class="token punctuation">(</span>converter_type<span class="token punctuation">)</span>    converter <span class="token operator">=</span> converter_cls<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">,</span> <span class="token operator">**</span>cfg_<span class="token punctuation">)</span>    <span class="token keyword">return</span> converter<span class="token comment"># 2. create a registry for converters</span>CONVERTERS <span class="token operator">=</span> Registry<span class="token punctuation">(</span><span class="token string">'Converter'</span><span class="token punctuation">,</span> build_func<span class="token operator">=</span>build_converter<span class="token punctuation">)</span><span class="token comment"># if use default build_func: CONVERTERS = Registry('Converter')</span><span class="token comment"># 3. use the registry to manage the module</span><span class="token decorator annotation punctuation">@CONVERTERS<span class="token punctuation">.</span>register_module</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">Converter1</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>a <span class="token operator">=</span> a        self<span class="token punctuation">.</span>b <span class="token operator">=</span> b <span class="token comment"># use this converter through configs</span>converter_cfg <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Converter1'</span><span class="token punctuation">,</span> a<span class="token operator">=</span><span class="token string">'a_value'</span><span class="token punctuation">,</span> b<span class="token operator">=</span><span class="token string">'b_value'</span><span class="token punctuation">)</span>converter <span class="token operator">=</span> CONVERTERS<span class="token punctuation">.</span>build<span class="token punctuation">(</span>converter_cfg<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'converter attribute:'</span><span class="token punctuation">,</span> converter<span class="token punctuation">.</span>a<span class="token punctuation">,</span> converter<span class="token punctuation">.</span>b<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面就是 registry 的工作逻辑：先建造 registry 类，再将待管理的类通过装饰器注册到 registry 类中，最后使用 cfg 建造实例</p><p>如果去看 mmdetection 的代码会发现，其 <code>builder.py</code> 是写得非常简单的，并没有包含 <code>build_func</code> 以及具体管理的类。是因为其使用的是默认的 <code>build_func=build_from_cfg</code> 并且将其他类用单独文件保存，之后通过 <code>__init__.py</code> ，将所有的类注册到 builder 中的 registry 类中</p><h3 id="层级注册-Hierarchy-Registry"><a href="#层级注册-Hierarchy-Registry" class="headerlink" title="层级注册 Hierarchy Registry"></a>层级注册 Hierarchy Registry</h3><p>这里我更想叫它继承注册。在 registry 类中提供了 parent 参数，parent 必须也是 registry 类。这样子 registry 就能够继承 parent registry 的 build_func 来进行实例化，并且每一个类既能够使用注册在自己名下的类，通过指定”族谱“也能够也使用其他 registry 管理的类。但这个”族谱“是按照 OpenMMLab 项目划分的，不是我们能修改的，所以个这继承注册的意义是在于 OpenMMLab 不同项目之间的模型都可以调用，例如 mmdetection 可以调用 mmclassification 中的模型。请前往文档参考 <a href="https://mmcv.readthedocs.io/en/latest/understand_mmcv/registry.html#hierarchy-registry">更多</a></p><h2 id="Runner"><a href="#Runner" class="headerlink" title="Runner"></a>Runner</h2><p>Runner 是管理训练过程的类，有两个子类 <code>EpochBasedRunner</code> and <code>IterBasedRunner</code>。Runner 也能够在 train 和 val 两种模式中切换，和 hook 结合可以在训练过程中有更多拓展功能</p><h3 id="EpochBasedRunner"><a href="#EpochBasedRunner" class="headerlink" title="EpochBasedRunner"></a>EpochBasedRunner</h3><p>该 runner 的工作流是基于 epoch 的，每一个 epoch 将包含多个 iterations。比如当 <code>workflow = [('train', 2), ('val', 1)]</code> 该 runner 就会运行2次训练集1次验证集。下面看看其运行的基本逻辑</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># the condition to stop training</span><span class="token keyword">while</span> curr_epoch <span class="token operator">&lt;</span> max_epochs<span class="token punctuation">:</span>    <span class="token comment"># traverse the workflow.</span>    <span class="token comment"># e.g. workflow = [('train', 2), ('val', 1)]</span>    <span class="token keyword">for</span> i<span class="token punctuation">,</span> flow <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>workflow<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># mode(e.g. train) determines which function to run</span>        mode<span class="token punctuation">,</span> epochs <span class="token operator">=</span> flow        <span class="token comment"># epoch_runner will be either self.train() or self.val()</span>        epoch_runner <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> mode<span class="token punctuation">)</span>        <span class="token comment"># execute the corresponding function</span>        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>            epoch_runner<span class="token punctuation">(</span>data_loaders<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果是 train 模式，那么将调用类似如下函数</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># Currently, epoch_runner could be either train or val</span><span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data_loader<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># traverse the dataset and get batch data for 1 epoch</span>    <span class="token keyword">for</span> i<span class="token punctuation">,</span> data_batch <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>data_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># it will execute all before_train_iter function in the hooks registered. You may want to watch out for the order.</span>        self<span class="token punctuation">.</span>call_hook<span class="token punctuation">(</span><span class="token string">'before_train_iter'</span><span class="token punctuation">)</span>        <span class="token comment"># set train_mode as False in val function</span>        self<span class="token punctuation">.</span>run_iter<span class="token punctuation">(</span>data_batch<span class="token punctuation">,</span> train_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>call_hook<span class="token punctuation">(</span><span class="token string">'after_train_iter'</span><span class="token punctuation">)</span>   self<span class="token punctuation">.</span>call_hook<span class="token punctuation">(</span><span class="token string">'after_train_epoch'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以上两段代码就展示了 runner 的基本逻辑：遍历整个训练集，并在每次遍历前后运行 hook 进行拓展操作</p><h3 id="IterBasedRunner"><a href="#IterBasedRunner" class="headerlink" title="IterBasedRunner"></a>IterBasedRunner</h3><p>与 <code>EpochBasedRunner</code> 类似，但是是基于 iteration 的 runner 实现，一个 iteration 将包含一个 batchsize。如果定义了 <code>workflow = [('train', 2), ('val', 1)]</code> 那么将会循环运行2个训练集 iterations 和1个验证机 iteration。下面也看看其运行逻辑</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># Although we set workflow by iters here, we might also need info on the epochs in some using cases. That can be provided by IterLoader.</span>iter_loaders <span class="token operator">=</span> <span class="token punctuation">[</span>IterLoader<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> data_loaders<span class="token punctuation">]</span><span class="token comment"># the condition to stop training</span><span class="token keyword">while</span> curr_iter <span class="token operator">&lt;</span> max_iters<span class="token punctuation">:</span>    <span class="token comment"># traverse the workflow.</span>    <span class="token comment"># e.g. workflow = [('train', 2), ('val', 1)]</span>    <span class="token keyword">for</span> i<span class="token punctuation">,</span> flow <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>workflow<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># mode(e.g. train) determines which function to run</span>        mode<span class="token punctuation">,</span> iters <span class="token operator">=</span> flow        <span class="token comment"># iter_runner will be either self.train() or self.val()</span>        iter_runner <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> mode<span class="token punctuation">)</span>        <span class="token comment"># execute the corresponding function</span>        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>iters<span class="token punctuation">)</span><span class="token punctuation">:</span>            iter_runner<span class="token punctuation">(</span>iter_loaders<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="使用-Runner"><a href="#使用-Runner" class="headerlink" title="使用 Runner"></a>使用 Runner</h3><p>一般来讲使用 runner 来进行训练有4个基本步骤：</p><ol><li>初始化 dataloader, model, optimizer, etc.</li><li>初始化 runner：将 config, model, optimizer, etc. 传入 Runner 中进行实例化</li><li>注册 training hooks &amp; customized hooks</li><li>开始训练：<code>runner.run(data_loaders, cfg.workflow)</code></li></ol><p>具体示例代码请移步 <a href="https://mmcv.readthedocs.io/en/latest/understand_mmcv/runner.html#a-simple-example">MMCV Runner</a></p><h2 id="File-IO"><a href="#File-IO" class="headerlink" title="File IO"></a>File IO</h2><p>mmcv 给导入和输入文档设有 API，可以导入不同格式的文档，例如 json, yaml, pkl。下面来看看如何导入一个 json 文件为字典</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token comment">// file.json</span><span class="token punctuation">{</span>    <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"0.2.0"</span><span class="token punctuation">,</span>    <span class="token property">"configurations"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token punctuation">{</span>            <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Python: Current File"</span><span class="token punctuation">,</span>            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"python"</span><span class="token punctuation">,</span>            <span class="token property">"request"</span><span class="token operator">:</span> <span class="token string">"launch"</span><span class="token punctuation">,</span>            <span class="token property">"program"</span><span class="token operator">:</span> <span class="token string">"${file}"</span><span class="token punctuation">,</span>            <span class="token property">"console"</span><span class="token operator">:</span> <span class="token string">"integratedTerminal"</span><span class="token punctuation">,</span>            <span class="token property">"justMyCode"</span><span class="token operator">:</span> <span class="token boolean">false</span>        <span class="token punctuation">}</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> mmcv<span class="token builtin">file</span> <span class="token operator">=</span> mmcv<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">'file.json'</span><span class="token punctuation">)</span><span class="token comment"># load data from a file-like object</span><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'file.json'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>    data <span class="token operator">=</span> mmcv<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">,</span> file_format<span class="token operator">=</span><span class="token string">'json'</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">)</span><span class="token comment"># &lt;class 'dict'&gt;</span><span class="token comment"># {'version': '0.2.0', 'configurations': [{'name': 'Python: Current File', 'type': 'python', 'request': 'launch', 'program': '${file}', 'console': 'integratedTerminal', 'justMyCode': False}]}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>也可以使用 <code>mmcv.dump</code> 来转化文件或者输出文件</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> mmcv<span class="token comment"># 将字典转化为字符串</span>info <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'Declan'</span><span class="token punctuation">,</span> age<span class="token operator">=</span><span class="token number">23</span><span class="token punctuation">)</span>dump_info <span class="token operator">=</span> mmcv<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>info<span class="token punctuation">,</span> file_format<span class="token operator">=</span><span class="token string">'yaml'</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>dump_info<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token punctuation">(</span>dump_info<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># age: 23</span><span class="token comment"># name: Declan</span><span class="token comment"># &lt;class 'str'&gt;</span><span class="token comment"># 将文件保存为 info.yaml</span>mmcv<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>info<span class="token punctuation">,</span> <span class="token string">'info.yaml'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>但是以上的 API 不能导入 txt 格式文件，需要使用 <code>mmcv.list_from_txt</code> or <code>mmcv.dict_from_txt</code> 将 txt 文件导入为列表或者字典</p><pre class="line-numbers language-a.txt" data-language="a.txt"><code class="language-a.txt">1 cat2 dog cow3 panda<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python">mmcv<span class="token punctuation">.</span>dict_from_file<span class="token punctuation">(</span><span class="token string">'a.txt'</span><span class="token punctuation">)</span><span class="token comment"># {'1': 'cat', '2': ['dog', 'cow'], '3': 'panda'}</span>mmcv<span class="token punctuation">.</span>list_from_file<span class="token punctuation">(</span><span class="token string">'a.txt'</span><span class="token punctuation">)</span><span class="token comment"># ['1 cat', '2 dog cow', '3 panda']</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Data-Process"><a href="#Data-Process" class="headerlink" title="Data Process"></a>Data Process</h2><blockquote><p>This module provides some image processing methods, which requires <code>opencv</code> to be installed.</p></blockquote><h3 id="Image"><a href="#Image" class="headerlink" title="Image"></a>Image</h3><h4 id="Read-Write-Show"><a href="#Read-Write-Show" class="headerlink" title="Read/Write/Show"></a>Read/Write/Show</h4><p>对于图片的基本操作：读、写、展示，分别使用 <code>imread</code>，<code>imwrite</code>，<code>imshow</code> 三个 API</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> mmcv<span class="token comment"># Read &amp; Write</span>img <span class="token operator">=</span> mmcv<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">'test.jpg'</span><span class="token punctuation">)</span>mmcv<span class="token punctuation">.</span>imwrite<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token string">'out.jpg'</span><span class="token punctuation">)</span><span class="token comment"># Show</span>mmcv<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">'tests/data/color.jpg'</span><span class="token punctuation">)</span><span class="token comment"># Show with bboxes</span>bboxes <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>mmcv<span class="token punctuation">.</span>imshow_bboxes<span class="token punctuation">(</span>img<span class="token punctuation">,</span> bboxes<span class="token punctuation">)</span><span class="token comment"># Show with ndarray</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    img <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>    mmcv<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>img<span class="token punctuation">,</span> win_name<span class="token operator">=</span><span class="token string">'test image'</span><span class="token punctuation">,</span> wait_time<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="More"><a href="#More" class="headerlink" title="More"></a>More</h4><p>对于图片还有更多的操作就不在这里列举了，例如色域转换、剪裁、旋转等，参考 <a href="https://mmcv.readthedocs.io/en/latest/understand_mmcv/data_process.html#data-process">MMCV 文档</a></p><h3 id="Video"><a href="#Video" class="headerlink" title="Video"></a>Video</h3><p>关于视频模块主要实现3个功能：</p><ol><li>读取视频</li><li>编辑视频</li><li>处理光流文件</li></ol><h4 id="VideoReader"><a href="#VideoReader" class="headerlink" title="VideoReader"></a>VideoReader</h4><p>该 API 能够过得视频的一些基本信息，并能够视频中的每一帧进行索引或遍历</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">video <span class="token operator">=</span> mmcv<span class="token punctuation">.</span>VideoReader<span class="token punctuation">(</span><span class="token string">'test.mp4'</span><span class="token punctuation">)</span><span class="token comment"># obtain basic information</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>video<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>video<span class="token punctuation">.</span>width<span class="token punctuation">,</span> video<span class="token punctuation">.</span>height<span class="token punctuation">,</span> video<span class="token punctuation">.</span>resolution<span class="token punctuation">,</span> video<span class="token punctuation">.</span>fps<span class="token punctuation">)</span><span class="token comment"># iterate over all frames</span><span class="token keyword">for</span> frame <span class="token keyword">in</span> video<span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>frame<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token comment"># read the next frame</span>img <span class="token operator">=</span> video<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># read a frame by index</span>img <span class="token operator">=</span> video<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token comment"># read some frames</span>img <span class="token operator">=</span> video<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>该模块内置方法 <code>cvt2frames</code> 可以将 video 转化为 images，同时 <code>mmcv.frames2video</code> 也可以将 images 转化为 video</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># split a video into frames and save to a folder</span>video <span class="token operator">=</span> mmcv<span class="token punctuation">.</span>VideoReader<span class="token punctuation">(</span><span class="token string">'test.mp4'</span><span class="token punctuation">)</span><span class="token comment"># convert a video to frame images</span>video<span class="token punctuation">.</span>cvt2frames<span class="token punctuation">(</span><span class="token string">'out_dir'</span><span class="token punctuation">)</span><span class="token comment"># generate video from frames</span>mmcv<span class="token punctuation">.</span>frames2video<span class="token punctuation">(</span><span class="token string">'out_dir'</span><span class="token punctuation">,</span> <span class="token string">'test.avi'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果熟悉 ffmpeg 的话，通过 ffmpeg 能够实现更多格式的转化，可以使用 python 中的 <code>os.system</code> 执行命令行</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> osos<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">'ffmpeg -version'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>mmcv 中也有一些接口借用了 ffmpeg 以实现对视频的更多操作</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># cut a video clip</span>mmcv<span class="token punctuation">.</span>cut_video<span class="token punctuation">(</span><span class="token string">'test.mp4'</span><span class="token punctuation">,</span> <span class="token string">'clip1.mp4'</span><span class="token punctuation">,</span> start<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> vcodec<span class="token operator">=</span><span class="token string">'h264'</span><span class="token punctuation">)</span><span class="token comment"># join a list of video clips</span>mmcv<span class="token punctuation">.</span>concat_video<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'clip1.mp4'</span><span class="token punctuation">,</span> <span class="token string">'clip2.mp4'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'joined.mp4'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'quiet'</span><span class="token punctuation">)</span><span class="token comment"># resize a video with the specified size</span>mmcv<span class="token punctuation">.</span>resize_video<span class="token punctuation">(</span><span class="token string">'test.mp4'</span><span class="token punctuation">,</span> <span class="token string">'resized1.mp4'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">360</span><span class="token punctuation">,</span> <span class="token number">240</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># resize a video with a scaling ratio of 2</span>mmcv<span class="token punctuation">.</span>resize_video<span class="token punctuation">(</span><span class="token string">'test.mp4'</span><span class="token punctuation">,</span> <span class="token string">'resized2.mp4'</span><span class="token punctuation">,</span> ratio<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="Optical-flow"><a href="#Optical-flow" class="headerlink" title="Optical flow"></a>Optical flow</h4><p>mmcv 也对光流文件的处理提供支持，但我对于其了解不多，暂时不作整理。这里贴一个链接 <a href="https://mmcv.readthedocs.io/en/latest/understand_mmcv/data_process.html#optical-flow">MMCV Optical flow</a></p><h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><h3 id="KITTI-数据集"><a href="#KITTI-数据集" class="headerlink" title="KITTI 数据集"></a>KITTI 数据集</h3><p><a href="https://blog.csdn.net/i6101206007/article/details/112256828">https://blog.csdn.net/i6101206007/article/details/112256828</a></p><p><a href="https://blog.csdn.net/u013086672/article/details/103913361">https://blog.csdn.net/u013086672/article/details/103913361</a></p><p>KITTI数据集有40多个G，相比起来是一个比较小的数据集</p><h3 id="NuScenes-数据集"><a href="#NuScenes-数据集" class="headerlink" title="NuScenes 数据集"></a>NuScenes 数据集</h3><p><a href="https://gas.graviti.cn/dataset/motional/nuScenes">https://gas.graviti.cn/dataset/motional/nuScenes</a></p>]]></content>
      
      
      <categories>
          
          <category> 编程 </category>
          
          <category> OpenMMLab </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mmcv </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MMDetection tutorial note</title>
      <link href="/archives/71f4e62.html"/>
      <url>/archives/71f4e62.html</url>
      
        <content type="html"><![CDATA[<h1 id="MMDetection-tutorial-note"><a href="#MMDetection-tutorial-note" class="headerlink" title="MMDetection tutorial note"></a>MMDetection tutorial note</h1><h2 id="Config"><a href="#Config" class="headerlink" title="Config"></a>Config</h2><p>由于 config 是有继承机制的，所以想要查看完整的 config，可以用官方提供的 <code>print_config.py</code> 函数来查看</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">python tools/misc/print_config.py /<span class="token environment constant">PATH</span>/TO/CONFIG<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="修改-config"><a href="#修改-config" class="headerlink" title="修改 config"></a>修改 config</h3><p>在使用 <code>tools/train.py</code> or <code>tools/test.py</code> 时，可以通过 <code>--cfg-options</code> 来修改此次运行的 config 而不修改 config 文件</p><p>更改字典，列表，元组都可以，只需要按照规范传入参数即可，下面给几个例子</p><ol><li><p>更改字典 <code>--cfg-options model.backbone.norm_eval=False</code></p></li><li><p>更改列表中的字典 <code>[dict(type='LoadImageFromFile'), ...]</code> </p><p><code>--cfg-options data.train.pipeline.0.type=LoadImageFromWebcam</code></p></li><li><p>更改列表，元组 <code>workflow=[('train', 1)]</code></p><p><code>--cfg-options workflow="[(train,1),(val,1)]"</code> 注意必须要加引号，且内部不能有空格</p></li></ol><h3 id="config-结构"><a href="#config-结构" class="headerlink" title="config 结构"></a>config 结构</h3><p>在 <code>config/_base_</code> 中有4个基本的组成部分</p><ol><li>dataset</li><li>models: backbone, neck 是必须有的</li><li>schedule</li><li>default_runtime</li></ol><p>更详细的要求和例子请直接查看 <a href="https://mmdetection.readthedocs.io/en/latest/tutorials/config.html#config-name-style">文档</a></p><p>config 的结构其实就给学习 MMDetection 有一个明确的指导，重点就是这四个部分，怎么建立数据集、模型，训练过程中的策略是什么，在训练过程中需不需要做些其他记录和处理…</p><h2 id="Customize-Datasets"><a href="#Customize-Datasets" class="headerlink" title="Customize Datasets"></a>Customize Datasets</h2><p>数据可以分为两个部分处理，一个是数据本身，另一个是数据的标签信息 <code>annotation_file</code>，所以想要建立个性化的数据集，处理好这两个部分即可</p><p>对于数据本身，比如图片数据、点云数据…其实能够做的处理是比较少的，更多的是做预处理比如 data augmentation，但这些操作就不在这一部分进行，而是到下一节 Data Piplines 中进行</p><h3 id="规范-annotation-file"><a href="#规范-annotation-file" class="headerlink" title="规范 annotation_file"></a>规范 annotation_file</h3><p>现在重心放在处理数据的标签信息上，核心就是把标签信息处理成为一种规范的格式就可以使用了，在 MMDetection 中 COCO format 是一种推荐的格式。COCO format 是一个 json 文件，文件中包含了整个数据集每一个样本的标签信息，其中有3个大的关键字：</p><ul><li><code>images</code>: contains a list of images with their informations like <code>file_name</code>, <code>height</code>, <code>width</code>, and <code>id</code>.</li><li><code>annotations</code>: contains the list of instance annotations.</li><li><code>categories</code>: contains the list of categories names and their ID.</li></ul><p>形如下面的内容</p><pre class="line-numbers language-json" data-language="json"><code class="language-json">'images'<span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token punctuation">{</span>        'file_name'<span class="token operator">:</span> 'COCO_val2014_000000001268.jpg'<span class="token punctuation">,</span>        'height'<span class="token operator">:</span> <span class="token number">427</span><span class="token punctuation">,</span>        'width'<span class="token operator">:</span> <span class="token number">640</span><span class="token punctuation">,</span>        'id'<span class="token operator">:</span> <span class="token number">1268</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    ...<span class="token punctuation">]</span><span class="token punctuation">,</span>'annotations'<span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token punctuation">{</span>        'segmentation'<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">192.81</span><span class="token punctuation">,</span>            <span class="token number">247.09</span><span class="token punctuation">,</span>            ...            <span class="token number">219.03</span><span class="token punctuation">,</span>            <span class="token number">249.06</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  # if you have mask labels        'area'<span class="token operator">:</span> <span class="token number">1035.749</span><span class="token punctuation">,</span>        'iscrowd'<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>        'image_id'<span class="token operator">:</span> <span class="token number">1268</span><span class="token punctuation">,</span>        'bbox'<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">192.81</span><span class="token punctuation">,</span> <span class="token number">224.8</span><span class="token punctuation">,</span> <span class="token number">74.73</span><span class="token punctuation">,</span> <span class="token number">33.43</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        'category_id'<span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">,</span>        'id'<span class="token operator">:</span> <span class="token number">42986</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    ...<span class="token punctuation">]</span><span class="token punctuation">,</span>'categories'<span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token punctuation">{</span>'id'<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> 'name'<span class="token operator">:</span> 'car'<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="更改-config-file-以匹配"><a href="#更改-config-file-以匹配" class="headerlink" title="更改 config file 以匹配"></a>更改 config file 以匹配</h3><p>更改 config file 中的 dataset/data 配置来匹配 <code>annotation_file</code>，需要明确的是三个部分：</p><ol><li><code>annotation_file_path</code> &amp; <code>image_path</code></li><li><code>classes</code> 数据集有哪些类别</li><li><code>num_classes</code> 数据集类别有多少</li></ol><p>这三个部分在 config 中的 train, val, test 字段中均有出现，具体更改哪些部分，参考下面的代码，假设新数据集有5个类别，用字母 a~e 来表示</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># the new config inherits the base configs to highlight the necessary modification</span>_base_ <span class="token operator">=</span> <span class="token string">'./cascade_mask_rcnn_r50_fpn_1x_coco.py'</span><span class="token comment"># 1. dataset settings</span>dataset_type <span class="token operator">=</span> <span class="token string">'CocoDataset'</span>classes <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">,</span> <span class="token string">'d'</span><span class="token punctuation">,</span> <span class="token string">'e'</span><span class="token punctuation">)</span>data <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>    samples_per_gpu<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>    workers_per_gpu<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>    train<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>        <span class="token builtin">type</span><span class="token operator">=</span>dataset_type<span class="token punctuation">,</span>        <span class="token comment"># explicitly add your class names to the field `classes`</span>        classes<span class="token operator">=</span>classes<span class="token punctuation">,</span>        ann_file<span class="token operator">=</span><span class="token string">'path/to/your/train/annotation_data'</span><span class="token punctuation">,</span>        img_prefix<span class="token operator">=</span><span class="token string">'path/to/your/train/image_data'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    val<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>        <span class="token builtin">type</span><span class="token operator">=</span>dataset_type<span class="token punctuation">,</span>        <span class="token comment"># explicitly add your class names to the field `classes`</span>        classes<span class="token operator">=</span>classes<span class="token punctuation">,</span>        ann_file<span class="token operator">=</span><span class="token string">'path/to/your/val/annotation_data'</span><span class="token punctuation">,</span>        img_prefix<span class="token operator">=</span><span class="token string">'path/to/your/val/image_data'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    test<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>        <span class="token builtin">type</span><span class="token operator">=</span>dataset_type<span class="token punctuation">,</span>        <span class="token comment"># explicitly add your class names to the field `classes`</span>        classes<span class="token operator">=</span>classes<span class="token punctuation">,</span>        ann_file<span class="token operator">=</span><span class="token string">'path/to/your/test/annotation_data'</span><span class="token punctuation">,</span>        img_prefix<span class="token operator">=</span><span class="token string">'path/to/your/test/image_data'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># 2. model settings</span><span class="token comment"># explicitly over-write all the `num_classes` field from default 80 to 5.</span>model <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>    roi_head<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>        bbox_head<span class="token operator">=</span><span class="token punctuation">[</span>            <span class="token builtin">dict</span><span class="token punctuation">(</span>                <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Shared2FCBBoxHead'</span><span class="token punctuation">,</span>                <span class="token comment"># explicitly over-write all the `num_classes` field from default 80 to 5.</span>                num_classes<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token builtin">dict</span><span class="token punctuation">(</span>                <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Shared2FCBBoxHead'</span><span class="token punctuation">,</span>                <span class="token comment"># explicitly over-write all the `num_classes` field from default 80 to 5.</span>                num_classes<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token builtin">dict</span><span class="token punctuation">(</span>                <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Shared2FCBBoxHead'</span><span class="token punctuation">,</span>                <span class="token comment"># explicitly over-write all the `num_classes` field from default 80 to 5.</span>                num_classes<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token comment"># explicitly over-write all the `num_classes` field from default 80 to 5.</span>    mask_head<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>num_classes<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里推荐 <a href="https://www.bilibili.com/video/BV1Jb4y1r7ir?p=1">bilibili 教程</a>，有实例讲解了如何处理个性化数据集</p><p>文档中还提到了可以<a href="https://mmdetection.readthedocs.io/en/latest/tutorials/customize_dataset.html#reorganize-new-data-format-to-middle-format"> 建立自己的 Dataset 类</a>，来完成原本的 <code>CocoDataset</code> 类的功能。只需要继承 <code>CustomDataset</code> 基类然后重写 <code>load_annotations(self, ann_file)</code> and <code>get_ann_info(self, idx)</code> 两个方法</p><h2 id="Customize-Data-Pipelines"><a href="#Customize-Data-Pipelines" class="headerlink" title="Customize Data Pipelines"></a>Customize Data Pipelines</h2><p>接下来就要具体地对数据集进行处理了，需要深入到 <code>mmdet/datasets</code> 当中看看，从 <code>builder.py</code> 大致可以看出，类似于 pytorch，mmdetection 也将数据处理分为 <code>Dataset</code> 和 <code>Dataloader</code> 两个类来创建和加载数据集。这一节的重点是在 <code>Dataset</code> 类中，上一节提到的 <code>CocoDataset</code>  类就是其中一个。在上一节，处理了数据集的 annotation 规范问题，这一节需要使用 <code>Dataset</code> 类建立一个 piplines 对数据集进行一系列变换操作</p><h3 id="变换操作"><a href="#变换操作" class="headerlink" title="变换操作"></a>变换操作</h3><p>在 <code>mmdet/datasets/piplines</code> 中有许多的方法，用于对数据的处理。如果想要创建自己的类，步骤也是类似的：</p><ol><li>创建 <code>MyTransform</code> 类</li><li>导入这个类</li><li>将该类加入到 config 中，文档中的 <a href="https://mmdetection.readthedocs.io/en/latest/tutorials/data_pipeline.html#extend-and-use-custom-pipelines">示例代码</a></li></ol><p>下面是 Faster R-CNN config 文件中 pipeline 部分的一个例子</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">img_norm_cfg <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>    mean<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">123.675</span><span class="token punctuation">,</span> <span class="token number">116.28</span><span class="token punctuation">,</span> <span class="token number">103.53</span><span class="token punctuation">]</span><span class="token punctuation">,</span> std<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">58.395</span><span class="token punctuation">,</span> <span class="token number">57.12</span><span class="token punctuation">,</span> <span class="token number">57.375</span><span class="token punctuation">]</span><span class="token punctuation">,</span> to_rgb<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>train_pipeline <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'LoadImageFromFile'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'LoadAnnotations'</span><span class="token punctuation">,</span> with_bbox<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Resize'</span><span class="token punctuation">,</span> img_scale<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1333</span><span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">,</span> keep_ratio<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'RandomFlip'</span><span class="token punctuation">,</span> flip_ratio<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Normalize'</span><span class="token punctuation">,</span> <span class="token operator">**</span>img_norm_cfg<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Pad'</span><span class="token punctuation">,</span> size_divisor<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'DefaultFormatBundle'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Collect'</span><span class="token punctuation">,</span> keys<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">,</span> <span class="token string">'gt_bboxes'</span><span class="token punctuation">,</span> <span class="token string">'gt_labels'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span>test_pipeline <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'LoadImageFromFile'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token builtin">dict</span><span class="token punctuation">(</span>        <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'MultiScaleFlipAug'</span><span class="token punctuation">,</span>        img_scale<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1333</span><span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        flip<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>        transforms<span class="token operator">=</span><span class="token punctuation">[</span>            <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Resize'</span><span class="token punctuation">,</span> keep_ratio<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'RandomFlip'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Normalize'</span><span class="token punctuation">,</span> <span class="token operator">**</span>img_norm_cfg<span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Pad'</span><span class="token punctuation">,</span> size_divisor<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'ImageToTensor'</span><span class="token punctuation">,</span> keys<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Collect'</span><span class="token punctuation">,</span> keys<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Dataset-实现变换操作"><a href="#Dataset-实现变换操作" class="headerlink" title="Dataset 实现变换操作"></a>Dataset 实现变换操作</h3><p>以 <code>CocoDataset</code> 为例，查看该类的代码，并没有发现在 <code>mmdet/datasets/coco.py</code> 中有实现 pipelines。实际上，<code>CocoDataset</code> 负责实现的是对 <code>annotation_file</code> 的处理，而对于 pipelines 的实现，在其继承的 <code>CustomDataset</code> 中实现的，具体实现逻辑如下：</p><ol><li>使用 <code>Compose</code> 类将 config 文件中的所有变换操作类实例化，并将所有的类存储到一个列表中</li><li>对需要处理的 data 依次使用列表中的变化操作，具体参考代码 <a href="https://github.com/open-mmlab/mmdetection/blob/master/mmdet/datasets/custom.py">CustomDataset</a> <a href="https://github.com/open-mmlab/mmdetection/blob/master/mmdet/datasets/pipelines/compose.py">Compose</a></li></ol><h2 id="Customize-Models"><a href="#Customize-Models" class="headerlink" title="Customize Models"></a>Customize Models</h2><p>在 mmdetection 中是通过 registry 来管理各种模块的，当然也包括模型中的模块。而如果想要通过 registry 添加模块的逻辑都是一样的，以添加一个新的 backbone, <code>MobileNet</code> 为例</p><ol><li><p>定义一个新的 backbone, <code>mmdet/models/backbones/mobilenet.py</code></p></li><li><p>导入这个模块，有两种方法</p><ul><li><p>在 <code>__init__.py</code> 中 import 这个模块，<code>from .mobilenet import MobileNet</code></p></li><li><p>在 config 中添加 <code>custom_imports</code> 字典</p></li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python">custom_imports <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>    imports<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'mmdet.models.backbones.mobilenet'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    allow_failed_imports<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>在 config 中使用这个模块</p></li></ol><p>在 <code>mmdet/tools/train.py</code> 中可以看到，通过 <code>build_detector()</code> 将 config 中模型的具体参数实例化 registry 中的类。下面看一个简化的 <code>build_detector()</code></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> mmcv<span class="token punctuation">.</span>cnn <span class="token keyword">import</span> MODELS <span class="token keyword">as</span> MMCV_MODELS<span class="token keyword">from</span> mmcv<span class="token punctuation">.</span>utils <span class="token keyword">import</span> RegistryMODELS <span class="token operator">=</span> Registry<span class="token punctuation">(</span><span class="token string">'models'</span><span class="token punctuation">,</span> parent<span class="token operator">=</span>MMCV_MODELS<span class="token punctuation">)</span>DETECTORS <span class="token operator">=</span> MODELS<span class="token keyword">def</span> <span class="token function">build_detector</span><span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> train_cfg<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> test_cfg<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""Build detector."""</span><span class="token keyword">return</span> DETECTORS<span class="token punctuation">.</span>build<span class="token punctuation">(</span>        cfg<span class="token punctuation">,</span> default_args<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>train_cfg<span class="token operator">=</span>train_cfg<span class="token punctuation">,</span> test_cfg<span class="token operator">=</span>test_cfg<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Customize-Runtime-Settings"><a href="#Customize-Runtime-Settings" class="headerlink" title="Customize Runtime Settings"></a>Customize Runtime Settings</h2><p>这一部分主要讲怎么配置 optimizer 以及训练流程</p><h3 id="Customize-optimization-settings"><a href="#Customize-optimization-settings" class="headerlink" title="Customize optimization settings"></a>Customize optimization settings</h3><p>mmdetection 适配了所有 pytorch 中的优化器，只需要修改 optimizer 的 <code>type</code> 关键字即可</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># use Adam optimizer</span>optimizer <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Adam'</span><span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">0.0003</span><span class="token punctuation">,</span> weight_decay<span class="token operator">=</span><span class="token number">0.0001</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>Optimizer 的实现不是在 mmdetection 项目中，而是在 mmcv 项目中，所以想要个性化的 optimizer 则需要自己新建文件夹进行实现。现在新建 <code>mmdet/core/optimizer</code> 文件夹，新建 <code>my_optimizer.py</code></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> mmcv<span class="token punctuation">.</span>runner<span class="token punctuation">.</span>optimizer <span class="token keyword">import</span> OPTIMIZERS<span class="token keyword">from</span> torch<span class="token punctuation">.</span>optim <span class="token keyword">import</span> Optimizer<span class="token decorator annotation punctuation">@OPTIMIZERS<span class="token punctuation">.</span>register_module</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">MyOptimizer</span><span class="token punctuation">(</span>Optimizer<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p> 然后修改 config 文件，并 import 该模块</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">optimizer <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'MyOptimizer'</span><span class="token punctuation">,</span> a<span class="token operator">=</span>a_value<span class="token punctuation">,</span> b<span class="token operator">=</span>b_value<span class="token punctuation">,</span> c<span class="token operator">=</span>c_value<span class="token punctuation">)</span>custom_imports <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>imports<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'mmdet.core.optimizer.my_optimizer'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                       allow_failed_imports<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>如果想要对 optimizer 有更加精细化的操作，需要构建新的 OPTIMIZER_CONSTRUCTORS，构建逻辑都是差不多的。这里就不展开了，因为很多优化操作并不熟悉，不知道该怎么用，等有具体的例子再进一步了解</p><h3 id="Customize-training-schedules"><a href="#Customize-training-schedules" class="headerlink" title="Customize training schedules"></a>Customize training schedules</h3><p>在训练优化的过程当中，需要对训练过程进行一些微调，例如对 learning rate 进行衰减，mmdetection 也可以通过调用 hook 做到，所谓的 Hook 就是在每个 epoch or iteration 之前、之后进行的一些操作。具体更改 training schedule 的操作为：在 config 文件中配置 <code>lr_config</code> 等字段。例如默认的阶梯策略 <code>StepLR</code> 可以在指定的 epoch 调整学习率</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">lr_config <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>    policy<span class="token operator">=</span><span class="token string">'step'</span><span class="token punctuation">,</span>    warmup<span class="token operator">=</span><span class="token string">'linear'</span><span class="token punctuation">,</span>    warmup_iters<span class="token operator">=</span><span class="token number">500</span><span class="token punctuation">,</span>    warmup_ratio<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">,</span>    step<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Customize-workflow"><a href="#Customize-workflow" class="headerlink" title="Customize workflow"></a>Customize workflow</h3><p>这部分基本上就使用默认的 workflow 就好，即 <code>workflow = [('train',1)]</code> ，这将会一次一次地循环训练集，直到达到 <code>total_epochs/max_epochs</code> 如果想要训练多个 epoch 过后对模型进行 evaluation 则是调用 <code>EvalHook</code>，而这在 config 文件中对应的是 <code>evaluation</code> 字段</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">workflow <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'train'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token comment"># 每间隔一次进行评估</span>evaluation <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>interval<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> metric<span class="token operator">=</span><span class="token string">'bbox'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="Customize-hooks"><a href="#Customize-hooks" class="headerlink" title="Customize hooks"></a>Customize hooks</h3><p>在之前已经提到了 hooks 的作用，mmdetection 中已经实现了一些 hooks：</p><ul><li>og_config</li><li>checkpoint_config</li><li>evaluation</li><li>lr_config</li><li>optimizer_config</li><li>momentum_config</li></ul><p>这些 hooks 能够在训练过程中去提供微调、评估、记录等功能，下面简单介绍一下其中的2个</p><ol><li><p>Checkpoint config，用于保存训练过程中的模型</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">checkpoint_config <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>interval<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>Log config，用于记录训练过程中的关键数据，可以同时使用多个 logger</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">log_config <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>    interval<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span>    hooks<span class="token operator">=</span><span class="token punctuation">[</span>        <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'TextLoggerHook'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'TensorboardLoggerHook'</span><span class="token punctuation">)</span>    <span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><p>如果想要使用个性化的 hook，准备过程也是老3步了</p><ol><li><p>定义新的 hook</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> mmcv<span class="token punctuation">.</span>runner <span class="token keyword">import</span> HOOKS<span class="token punctuation">,</span> Hook<span class="token decorator annotation punctuation">@HOOKS<span class="token punctuation">.</span>register_module</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">MyHook</span><span class="token punctuation">(</span>Hook<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">pass</span>    <span class="token keyword">def</span> <span class="token function">before_run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> runner<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">pass</span>    <span class="token keyword">def</span> <span class="token function">after_run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> runner<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">pass</span>    <span class="token keyword">def</span> <span class="token function">before_epoch</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> runner<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">pass</span>    <span class="token keyword">def</span> <span class="token function">after_epoch</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> runner<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">pass</span>    <span class="token keyword">def</span> <span class="token function">before_iter</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> runner<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">pass</span>    <span class="token keyword">def</span> <span class="token function">after_iter</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> runner<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">pass</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>导入新的 hook</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">custom_imports <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>imports<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'mmdet.core.utils.my_hook'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> allow_failed_imports<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>使用新的 hook</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">custom_hooks <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'MyHook'</span><span class="token punctuation">,</span> a<span class="token operator">=</span>a_value<span class="token punctuation">,</span> b<span class="token operator">=</span>b_value<span class="token punctuation">)</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li></ol><p>对于 hook 的调用，还需要进一步了解 <code>Runner</code> 类。mmdetection 是将这些 hook config 传入到了 <code>runner</code> 实例中，并在其中创建 hook 实例。更多有关 <code>Runner</code> 的内容需要在 <a href="https://mmcv.readthedocs.io/en/latest/understand_mmcv/runner.html#">mmcv</a> 里去查看</p><h2 id="Customize-Losses"><a href="#Customize-Losses" class="headerlink" title="Customize Losses"></a>Customize Losses</h2><p>mmdetction 中损失函数是直接在模型中各个 prediction head 中使用，而不是在 forward pass 之后单独使用，所以其关键字是什么，取决于模型之中各个 prediction head 怎么接收损失函数。以 <code>loss_cls</code> 字段为例使用 <code>FocalLoss</code></p><pre class="line-numbers language-python" data-language="python"><code class="language-python">loss_cls<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>    <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'FocalLoss'</span><span class="token punctuation">,</span>    use_sigmoid<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>    gamma<span class="token operator">=</span><span class="token number">2.0</span><span class="token punctuation">,</span>    alpha<span class="token operator">=</span><span class="token number">0.25</span><span class="token punctuation">,</span>    loss_weight<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Finetuning-Models"><a href="#Finetuning-Models" class="headerlink" title="Finetuning Models"></a>Finetuning Models</h2><p>已经训练好的模型参数已经有较好的特征提取能力，所以将这些参数用于新的数据集只需要一些微调。除了要准备好自己数据集和 config 之外，需要注意的就是调整 training schedule。由于是仅对模型进行微调，所以学习率应该设置得相对小一些，并且 epoch 也应当少一些以避免过拟合。文档给出了一个参考的例子</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># optimizer</span><span class="token comment"># lr is set for a batch size of 8</span>optimizer <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'SGD'</span><span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">,</span> momentum<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">,</span> weight_decay<span class="token operator">=</span><span class="token number">0.0001</span><span class="token punctuation">)</span>optimizer_config <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>grad_clip<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token comment"># learning policy</span>lr_config <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>    policy<span class="token operator">=</span><span class="token string">'step'</span><span class="token punctuation">,</span>    warmup<span class="token operator">=</span><span class="token string">'linear'</span><span class="token punctuation">,</span>    warmup_iters<span class="token operator">=</span><span class="token number">500</span><span class="token punctuation">,</span>    warmup_ratio<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">,</span>    step<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment"># the max_epochs and step in lr_config need specifically tuned for the customized dataset</span>runner <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>max_epochs<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">)</span>log_config <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>interval<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token comment"># We can use the pre-trained Mask RCNN model to obtain higher performance</span>load_from <span class="token operator">=</span> <span class="token string">'checkpoints/mask_rcnn_r50_caffe_fpn_mstrain-poly_3x_coco_bbox_mAP-0.408__segm_mAP-0.37_20200504_163245-42aa3d00.pth'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>可以把 mmdetection 的使用分为两个大块来进行理解：</p><ol><li>模型的建立</li><li>模型的训练</li></ol><p>首先是模型的建立，其核心为 config &amp; registry，要理解这两个类的作用。通过 config 将模型的所有构造细节都以字典的形式包含进来了，将这些 config 传入到 registry 中注册好的模型类中从而实现模型的实例化。从中可以看到注册和使用任何新模块的三个主要步骤：定义模型、导入模型、修改 config 文件</p><p>接着是模型的训练，部分的核心为 optimizer &amp; runner。其中 runner 包含了不同的 hook 以在每一个 epoch/iter 之前/之后进行需要的操作，例如：调整学习率、保存模型、记录数据等等。当然这些功能也是通过 config &amp; registry 来进行管理的</p><p>下面是一个完整的 config 文件及其简要注释说明，为 ResNet50 和 FPN 的 Mask R-CNN 的配置文件。配合之前的 tutorial，可以具体看看每个字段在 config 文件中的什么位置、有什么功能，帮助整体把握。当然也可以直接在 mmdetection github 项目上进行搜索，查找源码也是很方便的</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">model <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>    <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'MaskRCNN'</span><span class="token punctuation">,</span>  <span class="token comment"># 检测器(detector)名称</span>    backbone<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>  <span class="token comment"># 主干网络的配置文件</span>        <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'ResNet'</span><span class="token punctuation">,</span>  <span class="token comment"># 主干网络的类别，可用选项请参考 https://github.com/open-mmlab/mmdetection/blob/master/mmdet/models/backbones/resnet.py#L308</span>        depth<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span>  <span class="token comment"># 主干网络的深度，对于 ResNet 和 ResNext 通常设置为 50 或 101。</span>        num_stages<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span>  <span class="token comment"># 主干网络状态(stages)的数目，这些状态产生的特征图作为后续的 head 的输入。</span>        out_indices<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 每个状态产生的特征图输出的索引。</span>        frozen_stages<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>  <span class="token comment"># 第一个状态的权重被冻结</span>        norm_cfg<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>  <span class="token comment"># 归一化层(norm layer)的配置项。</span>            <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'BN'</span><span class="token punctuation">,</span>  <span class="token comment"># 归一化层的类别，通常是 BN 或 GN。</span>            requires_grad<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 是否训练归一化里的 gamma 和 beta。</span>        norm_eval<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>  <span class="token comment"># 是否冻结 BN 里的统计项。</span>        style<span class="token operator">=</span><span class="token string">'pytorch'</span><span class="token punctuation">,</span>  <span class="token comment"># 主干网络的风格，'pytorch' 意思是步长为2的层为 3x3 卷积， 'caffe' 意思是步长为2的层为 1x1 卷积。</span>       init_cfg<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Pretrained'</span><span class="token punctuation">,</span> checkpoint<span class="token operator">=</span><span class="token string">'torchvision://resnet50'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 加载通过 ImageNet 与训练的模型</span>    neck<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>        <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'FPN'</span><span class="token punctuation">,</span>  <span class="token comment"># 检测器的 neck 是 FPN，我们同样支持 'NASFPN', 'PAFPN' 等，更多细节可以参考 https://github.com/open-mmlab/mmdetection/blob/master/mmdet/models/necks/fpn.py#L10。</span>        in_channels<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">2048</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 输入通道数，这与主干网络的输出通道一致</span>        out_channels<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span>  <span class="token comment"># 金字塔特征图每一层的输出通道</span>        num_outs<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 输出的范围(scales)</span>    rpn_head<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>        <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'RPNHead'</span><span class="token punctuation">,</span>  <span class="token comment"># RPN_head 的类型是 'RPNHead', 我们也支持 'GARPNHead' 等，更多细节可以参考 https://github.com/open-mmlab/mmdetection/blob/master/mmdet/models/dense_heads/rpn_head.py#L12。</span>        in_channels<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span>  <span class="token comment"># 每个输入特征图的输入通道，这与 neck 的输出通道一致。</span>        feat_channels<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span>  <span class="token comment"># head 卷积层的特征通道。</span>        anchor_generator<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>  <span class="token comment"># 锚点(Anchor)生成器的配置。</span>            <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'AnchorGenerator'</span><span class="token punctuation">,</span>  <span class="token comment"># 大多是方法使用 AnchorGenerator 作为锚点生成器, SSD 检测器使用 `SSDAnchorGenerator`。更多细节请参考 https://github.com/open-mmlab/mmdetection/blob/master/mmdet/core/anchor/anchor_generator.py#L10。</span>            scales<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 锚点的基本比例，特征图某一位置的锚点面积为 scale * base_sizes</span>            ratios<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 高度和宽度之间的比率。</span>            strides<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 锚生成器的步幅。这与 FPN 特征步幅一致。 如果未设置 base_sizes，则当前步幅值将被视为 base_sizes。</span>        bbox_coder<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>  <span class="token comment"># 在训练和测试期间对框进行编码和解码。</span>            <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'DeltaXYWHBBoxCoder'</span><span class="token punctuation">,</span>  <span class="token comment"># 框编码器的类别，'DeltaXYWHBBoxCoder' 是最常用的，更多细节请参考 https://github.com/open-mmlab/mmdetection/blob/master/mmdet/core/bbox/coder/delta_xywh_bbox_coder.py#L9。</span>            target_means<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 用于编码和解码框的目标均值</span>            target_stds<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 用于编码和解码框的标准方差</span>        loss_cls<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>  <span class="token comment"># 分类分支的损失函数配置</span>            <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'CrossEntropyLoss'</span><span class="token punctuation">,</span>  <span class="token comment"># 分类分支的损失类型，我们也支持 FocalLoss 等。</span>            use_sigmoid<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>  <span class="token comment"># RPN通常进行二分类，所以通常使用sigmoid函数。</span>            los_weight<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 分类分支的损失权重。</span>        loss_bbox<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>  <span class="token comment"># 回归分支的损失函数配置。</span>            <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'L1Loss'</span><span class="token punctuation">,</span>  <span class="token comment"># 损失类型，我们还支持许多 IoU Losses 和 Smooth L1-loss 等，更多细节请参考 https://github.com/open-mmlab/mmdetection/blob/master/mmdet/models/losses/smooth_l1_loss.py#L56。</span>            loss_weight<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 回归分支的损失权重。</span>    roi_head<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>  <span class="token comment"># RoIHead 封装了两步(two-stage)/级联(cascade)检测器的第二步。</span>        <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'StandardRoIHead'</span><span class="token punctuation">,</span>  <span class="token comment"># RoI head 的类型，更多细节请参考 https://github.com/open-mmlab/mmdetection/blob/master/mmdet/models/roi_heads/standard_roi_head.py#L10。</span>        bbox_roi_extractor<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>  <span class="token comment"># 用于 bbox 回归的 RoI 特征提取器。</span>            <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'SingleRoIExtractor'</span><span class="token punctuation">,</span>  <span class="token comment"># RoI 特征提取器的类型，大多数方法使用  SingleRoIExtractor，更多细节请参考 https://github.com/open-mmlab/mmdetection/blob/master/mmdet/models/roi_heads/roi_extractors/single_level.py#L10。</span>            roi_layer<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>  <span class="token comment"># RoI 层的配置</span>                <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'RoIAlign'</span><span class="token punctuation">,</span>  <span class="token comment"># RoI 层的类别, 也支持 DeformRoIPoolingPack 和 ModulatedDeformRoIPoolingPack，更多细节请参考 https://github.com/open-mmlab/mmdetection/blob/master/mmdet/ops/roi_align/roi_align.py#L79。</span>                output_size<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">,</span>  <span class="token comment"># 特征图的输出大小。</span>                sampling_ratio<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 提取 RoI 特征时的采样率。0 表示自适应比率。</span>            out_channels<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span>  <span class="token comment"># 提取特征的输出通道。</span>            featmap_strides<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 多尺度特征图的步幅，应该与主干的架构保持一致。</span>        bbox_head<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>  <span class="token comment"># RoIHead 中 box head 的配置.</span>            <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Shared2FCBBoxHead'</span><span class="token punctuation">,</span>  <span class="token comment"># bbox head 的类别，更多细节请参考 https://github.com/open-mmlab/mmdetection/blob/master/mmdet/models/roi_heads/bbox_heads/convfc_bbox_head.py#L177。</span>            in_channels<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span>  <span class="token comment"># bbox head 的输入通道。 这与 roi_extractor 中的 out_channels 一致。</span>            fc_out_channels<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">,</span>  <span class="token comment"># FC 层的输出特征通道。</span>            roi_feat_size<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">,</span>  <span class="token comment"># 候选区域(Region of Interest)特征的大小。</span>            num_classes<span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">,</span>  <span class="token comment"># 分类的类别数量。</span>            bbox_coder<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>  <span class="token comment"># 第二阶段使用的框编码器。</span>                <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'DeltaXYWHBBoxCoder'</span><span class="token punctuation">,</span>  <span class="token comment"># 框编码器的类别，大多数情况使用 'DeltaXYWHBBoxCoder'。</span>                target_means<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 用于编码和解码框的均值</span>                target_stds<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 编码和解码的标准方差。因为框更准确，所以值更小，常规设置时 [0.1, 0.1, 0.2, 0.2]。</span>            reg_class_agnostic<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>  <span class="token comment"># 回归是否与类别无关。</span>            loss_cls<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>  <span class="token comment"># 分类分支的损失函数配置</span>                <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'CrossEntropyLoss'</span><span class="token punctuation">,</span>  <span class="token comment"># 分类分支的损失类型，我们也支持 FocalLoss 等。</span>                use_sigmoid<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>  <span class="token comment"># 是否使用 sigmoid。</span>                loss_weight<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 分类分支的损失权重。</span>            loss_bbox<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>  <span class="token comment"># 回归分支的损失函数配置。</span>                <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'L1Loss'</span><span class="token punctuation">,</span>  <span class="token comment"># 损失类型，我们还支持许多 IoU Losses 和 Smooth L1-loss 等。</span>                loss_weight<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 回归分支的损失权重。</span>        mask_roi_extractor<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>  <span class="token comment"># 用于 mask 生成的 RoI 特征提取器。</span>            <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'SingleRoIExtractor'</span><span class="token punctuation">,</span>  <span class="token comment"># RoI 特征提取器的类型，大多数方法使用 SingleRoIExtractor。</span>            roi_layer<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>  <span class="token comment"># 提取实例分割特征的 RoI 层配置</span>                <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'RoIAlign'</span><span class="token punctuation">,</span>  <span class="token comment"># RoI 层的类型，也支持 DeformRoIPoolingPack 和 ModulatedDeformRoIPoolingPack。</span>                output_size<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">,</span>  <span class="token comment"># 特征图的输出大小。</span>                sampling_ratio<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 提取 RoI 特征时的采样率。</span>            out_channels<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span>  <span class="token comment"># 提取特征的输出通道。</span>            featmap_strides<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 多尺度特征图的步幅。</span>        mask_head<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>  <span class="token comment"># mask 预测 head 模型</span>            <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'FCNMaskHead'</span><span class="token punctuation">,</span>  <span class="token comment"># mask head 的类型，更多细节请参考 https://github.com/open-mmlab/mmdetection/blob/master/mmdet/models/roi_heads/mask_heads/fcn_mask_head.py#L21。</span>            num_convs<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span>  <span class="token comment"># mask head 中的卷积层数</span>            in_channels<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span>  <span class="token comment"># 输入通道，应与 mask roi extractor 的输出通道一致。</span>            conv_out_channels<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span>  <span class="token comment"># 卷积层的输出通道。</span>            num_classes<span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">,</span>  <span class="token comment"># 要分割的类别数。</span>            loss_mask<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>  <span class="token comment"># mask 分支的损失函数配置。</span>                <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'CrossEntropyLoss'</span><span class="token punctuation">,</span>  <span class="token comment"># 用于分割的损失类型。</span>                use_mask<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>  <span class="token comment"># 是否只在正确的类中训练 mask。</span>                loss_weight<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># mask 分支的损失权重.</span>    train_cfg <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>  <span class="token comment"># rpn 和 rcnn 训练超参数的配置</span>        rpn<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>  <span class="token comment"># rpn 的训练配置</span>            assigner<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>  <span class="token comment"># 分配器(assigner)的配置</span>                <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'MaxIoUAssigner'</span><span class="token punctuation">,</span>  <span class="token comment"># 分配器的类型，MaxIoUAssigner 用于许多常见的检测器，更多细节请参考 https://github.com/open-mmlab/mmdetection/blob/master/mmdet/core/bbox/assigners/max_iou_assigner.py#L10。</span>                pos_iou_thr<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">,</span>  <span class="token comment"># IoU &gt;= 0.7(阈值) 被视为正样本。</span>                neg_iou_thr<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">,</span>  <span class="token comment"># IoU &lt; 0.3(阈值) 被视为负样本。</span>                min_pos_iou<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">,</span>  <span class="token comment"># 将框作为正样本的最小 IoU 阈值。</span>                match_low_quality<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>  <span class="token comment"># 是否匹配低质量的框(更多细节见 API 文档).</span>                ignore_iof_thr<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 忽略 bbox 的 IoF 阈值。</span>            sampler<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>  <span class="token comment"># 正/负采样器(sampler)的配置</span>                <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'RandomSampler'</span><span class="token punctuation">,</span>  <span class="token comment"># 采样器类型，还支持 PseudoSampler 和其他采样器，更多细节请参考 https://github.com/open-mmlab/mmdetection/blob/master/mmdet/core/bbox/samplers/random_sampler.py#L8。</span>                num<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span>  <span class="token comment"># 样本数量。</span>                pos_fraction<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span>  <span class="token comment"># 正样本占总样本的比例。</span>                neg_pos_ub<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>  <span class="token comment"># 基于正样本数量的负样本上限。</span>                add_gt_as_proposals<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 采样后是否添加 GT 作为 proposal。</span>            allowed_border<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>  <span class="token comment"># 填充有效锚点后允许的边框。</span>            pos_weight<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>  <span class="token comment"># 训练期间正样本的权重。</span>            debug<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 是否设置调试(debug)模式</span>        rpn_proposal<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>  <span class="token comment"># 在训练期间生成 proposals 的配置</span>            nms_across_levels<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>  <span class="token comment"># 是否对跨层的 box 做 NMS。仅适用于 `GARPNHead` ，naive rpn 不支持 nms cross levels。</span>            nms_pre<span class="token operator">=</span><span class="token number">2000</span><span class="token punctuation">,</span>  <span class="token comment"># NMS 前的 box 数</span>            nms_post<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span>  <span class="token comment"># NMS 要保留的 box 的数量，只在 GARPNHHead 中起作用。</span>            max_per_img<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span>  <span class="token comment"># NMS 后要保留的 box 数量。</span>            nms<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span> <span class="token comment"># NMS 的配置</span>                <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'nms'</span><span class="token punctuation">,</span>  <span class="token comment"># NMS 的类别</span>                iou_threshold<span class="token operator">=</span><span class="token number">0.7</span> <span class="token comment"># NMS 的阈值</span>                <span class="token punctuation">)</span><span class="token punctuation">,</span>            min_bbox_size<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 允许的最小 box 尺寸</span>        rcnn<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>  <span class="token comment"># roi head 的配置。</span>            assigner<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>  <span class="token comment"># 第二阶段分配器的配置，这与 rpn 中的不同</span>                <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'MaxIoUAssigner'</span><span class="token punctuation">,</span>  <span class="token comment"># 分配器的类型，MaxIoUAssigner 目前用于所有 roi_heads。更多细节请参考 https://github.com/open-mmlab/mmdetection/blob/master/mmdet/core/bbox/assigners/max_iou_assigner.py#L10。</span>                pos_iou_thr<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span>  <span class="token comment"># IoU &gt;= 0.5(阈值)被认为是正样本。</span>                neg_iou_thr<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span>  <span class="token comment"># IoU &lt; 0.5(阈值)被认为是负样本。</span>                min_pos_iou<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span>  <span class="token comment"># 将 box 作为正样本的最小 IoU 阈值</span>                match_low_quality<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>  <span class="token comment"># 是否匹配低质量下的 box(有关更多详细信息，请参阅 API 文档)。</span>                ignore_iof_thr<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 忽略 bbox 的 IoF 阈值</span>            sampler<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>                <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'RandomSampler'</span><span class="token punctuation">,</span>  <span class="token comment">#采样器的类型，还支持 PseudoSampler 和其他采样器，更多细节请参考 https://github.com/open-mmlab/mmdetection/blob/master/mmdet/core/bbox/samplers/random_sampler.py#L8。</span>                num<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">,</span>  <span class="token comment"># 样本数量</span>                pos_fraction<span class="token operator">=</span><span class="token number">0.25</span><span class="token punctuation">,</span>  <span class="token comment"># 正样本占总样本的比例。.</span>                neg_pos_ub<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>  <span class="token comment"># 基于正样本数量的负样本上限。.</span>                add_gt_as_proposals<span class="token operator">=</span><span class="token boolean">True</span>            <span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 采样后是否添加 GT 作为 proposal。</span>            mask_size<span class="token operator">=</span><span class="token number">28</span><span class="token punctuation">,</span>  <span class="token comment"># mask 的大小</span>            pos_weight<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>  <span class="token comment"># 训练期间正样本的权重。</span>            debug<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 是否设置调试模式。</span>    test_cfg <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>  <span class="token comment"># 用于测试 rnn 和 rnn 超参数的配置</span>        rpn<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>  <span class="token comment"># 测试阶段生成 proposals 的配置</span>            nms_across_levels<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>  <span class="token comment"># 是否对跨层的 box 做 NMS。仅适用于`GARPNHead`，naive rpn 不支持做 NMS cross levels。</span>            nms_pre<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span>  <span class="token comment"># NMS 前的 box 数</span>            nms_post<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span>  <span class="token comment"># NMS 要保留的 box 的数量，只在`GARPNHHead`中起作用。</span>            max_per_img<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span>  <span class="token comment"># NMS 后要保留的 box 数量</span>            nms<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span> <span class="token comment"># NMS 的配置</span>                <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'nms'</span><span class="token punctuation">,</span>  <span class="token comment"># NMS 的类型</span>                iou_threshold<span class="token operator">=</span><span class="token number">0.7</span> <span class="token comment"># NMS 阈值</span>                <span class="token punctuation">)</span><span class="token punctuation">,</span>            min_bbox_size<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># box 允许的最小尺寸</span>        rcnn<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>  <span class="token comment"># roi heads 的配置</span>            score_thr<span class="token operator">=</span><span class="token number">0.05</span><span class="token punctuation">,</span>  <span class="token comment"># bbox 的分数阈值</span>            nms<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>  <span class="token comment"># 第二步的 NMS 配置</span>                <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'nms'</span><span class="token punctuation">,</span>  <span class="token comment"># NMS 的类型</span>                iou_thr<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># NMS 的阈值</span>            max_per_img<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span>  <span class="token comment"># 每张图像的最大检测次数</span>            mask_thr_binary<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># mask 预处的阈值</span>dataset_type <span class="token operator">=</span> <span class="token string">'CocoDataset'</span>  <span class="token comment"># 数据集类型，这将被用来定义数据集。</span>data_root <span class="token operator">=</span> <span class="token string">'data/coco/'</span>  <span class="token comment"># 数据的根路径。</span>img_norm_cfg <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>  <span class="token comment">#图像归一化配置，用来归一化输入的图像。</span>    mean<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">123.675</span><span class="token punctuation">,</span> <span class="token number">116.28</span><span class="token punctuation">,</span> <span class="token number">103.53</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 预训练里用于预训练主干网络模型的平均值。</span>    std<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">58.395</span><span class="token punctuation">,</span> <span class="token number">57.12</span><span class="token punctuation">,</span> <span class="token number">57.375</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 预训练里用于预训练主干网络模型的标准差。</span>    to_rgb<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment">#  预训练里用于预训练主干网络的图像的通道顺序。</span>train_pipeline <span class="token operator">=</span> <span class="token punctuation">[</span>  <span class="token comment"># 训练流程</span>    <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'LoadImageFromFile'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 第 1 个流程，从文件路径里加载图像。</span>    <span class="token builtin">dict</span><span class="token punctuation">(</span>        <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'LoadAnnotations'</span><span class="token punctuation">,</span>  <span class="token comment"># 第 2 个流程，对于当前图像，加载它的注释信息。</span>        with_bbox<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>  <span class="token comment"># 是否使用标注框(bounding box)， 目标检测需要设置为 True。</span>        with_mask<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>  <span class="token comment"># 是否使用 instance mask，实例分割需要设置为 True。</span>        poly2mask<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 是否将 polygon mask 转化为 instance mask, 设置为 False 以加速和节省内存。</span>    <span class="token builtin">dict</span><span class="token punctuation">(</span>        <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Resize'</span><span class="token punctuation">,</span>  <span class="token comment"># 变化图像和其注释大小的数据增广的流程。</span>        img_scale<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1333</span><span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 图像的最大规模。</span>        keep_ratio<span class="token operator">=</span><span class="token boolean">True</span>    <span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 是否保持图像的长宽比。</span>    <span class="token builtin">dict</span><span class="token punctuation">(</span>        <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'RandomFlip'</span><span class="token punctuation">,</span>  <span class="token comment">#  翻转图像和其注释大小的数据增广的流程。</span>        flip_ratio<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 翻转图像的概率。</span>    <span class="token builtin">dict</span><span class="token punctuation">(</span>        <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Normalize'</span><span class="token punctuation">,</span>  <span class="token comment"># 归一化当前图像的数据增广的流程。</span>        mean<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">123.675</span><span class="token punctuation">,</span> <span class="token number">116.28</span><span class="token punctuation">,</span> <span class="token number">103.53</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 这些键与 img_norm_cfg 一致，因为 img_norm_cfg 被</span>        std<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">58.395</span><span class="token punctuation">,</span> <span class="token number">57.12</span><span class="token punctuation">,</span> <span class="token number">57.375</span><span class="token punctuation">]</span><span class="token punctuation">,</span>     <span class="token comment"># 用作参数。</span>        to_rgb<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token builtin">dict</span><span class="token punctuation">(</span>        <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Pad'</span><span class="token punctuation">,</span>  <span class="token comment"># 填充当前图像到指定大小的数据增广的流程。</span>        size_divisor<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 填充图像可以被当前值整除。</span>    <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'DefaultFormatBundle'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 流程里收集数据的默认格式捆。</span>    <span class="token builtin">dict</span><span class="token punctuation">(</span>        <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Collect'</span><span class="token punctuation">,</span>  <span class="token comment"># 决定数据中哪些键应该传递给检测器的流程</span>        keys<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">,</span> <span class="token string">'gt_bboxes'</span><span class="token punctuation">,</span> <span class="token string">'gt_labels'</span><span class="token punctuation">,</span> <span class="token string">'gt_masks'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>test_pipeline <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'LoadImageFromFile'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 第 1 个流程，从文件路径里加载图像。</span>    <span class="token builtin">dict</span><span class="token punctuation">(</span>        <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'MultiScaleFlipAug'</span><span class="token punctuation">,</span>  <span class="token comment"># 封装测试时数据增广(test time augmentations)。</span>        img_scale<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1333</span><span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 决定测试时可改变图像的最大规模。用于改变图像大小的流程。</span>        flip<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>  <span class="token comment"># 测试时是否翻转图像。</span>        transforms<span class="token operator">=</span><span class="token punctuation">[</span>            <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Resize'</span><span class="token punctuation">,</span>  <span class="token comment"># 使用改变图像大小的数据增广。</span>                 keep_ratio<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 是否保持宽和高的比例，这里的图像比例设置将覆盖上面的图像规模大小的设置。</span>            <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'RandomFlip'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 考虑到 RandomFlip 已经被添加到流程里，当 flip=False 时它将不被使用。</span>            <span class="token builtin">dict</span><span class="token punctuation">(</span>                <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Normalize'</span><span class="token punctuation">,</span>  <span class="token comment">#  归一化配置项，值来自 img_norm_cfg。</span>                mean<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">123.675</span><span class="token punctuation">,</span> <span class="token number">116.28</span><span class="token punctuation">,</span> <span class="token number">103.53</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                std<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">58.395</span><span class="token punctuation">,</span> <span class="token number">57.12</span><span class="token punctuation">,</span> <span class="token number">57.375</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                to_rgb<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token builtin">dict</span><span class="token punctuation">(</span>                <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Pad'</span><span class="token punctuation">,</span>  <span class="token comment"># 将配置传递给可被 32 整除的图像。</span>                size_divisor<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token builtin">dict</span><span class="token punctuation">(</span>                <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'ImageToTensor'</span><span class="token punctuation">,</span>  <span class="token comment"># 将图像转为张量</span>                keys<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token builtin">dict</span><span class="token punctuation">(</span>                <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Collect'</span><span class="token punctuation">,</span>  <span class="token comment"># 收集测试时必须的键的收集流程。</span>                keys<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>data <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>    samples_per_gpu<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>  <span class="token comment"># 单个 GPU 的 Batch size</span>    workers_per_gpu<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>  <span class="token comment"># 单个 GPU 分配的数据加载线程数</span>    train<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>  <span class="token comment"># 训练数据集配置</span>        <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'CocoDataset'</span><span class="token punctuation">,</span>  <span class="token comment"># 数据集的类别, 更多细节请参考 https://github.com/open-mmlab/mmdetection/blob/master/mmdet/datasets/coco.py#L19。</span>        ann_file<span class="token operator">=</span><span class="token string">'data/coco/annotations/instances_train2017.json'</span><span class="token punctuation">,</span>  <span class="token comment"># 注释文件路径</span>        img_prefix<span class="token operator">=</span><span class="token string">'data/coco/train2017/'</span><span class="token punctuation">,</span>  <span class="token comment"># 图片路径前缀</span>        pipeline<span class="token operator">=</span><span class="token punctuation">[</span>  <span class="token comment"># 流程, 这是由之前创建的 train_pipeline 传递的。</span>            <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'LoadImageFromFile'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token builtin">dict</span><span class="token punctuation">(</span>                <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'LoadAnnotations'</span><span class="token punctuation">,</span>                with_bbox<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>                with_mask<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>                poly2mask<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Resize'</span><span class="token punctuation">,</span> img_scale<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1333</span><span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">,</span> keep_ratio<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'RandomFlip'</span><span class="token punctuation">,</span> flip_ratio<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token builtin">dict</span><span class="token punctuation">(</span>                <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Normalize'</span><span class="token punctuation">,</span>                mean<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">123.675</span><span class="token punctuation">,</span> <span class="token number">116.28</span><span class="token punctuation">,</span> <span class="token number">103.53</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                std<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">58.395</span><span class="token punctuation">,</span> <span class="token number">57.12</span><span class="token punctuation">,</span> <span class="token number">57.375</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                to_rgb<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Pad'</span><span class="token punctuation">,</span> size_divisor<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'DefaultFormatBundle'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token builtin">dict</span><span class="token punctuation">(</span>                <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Collect'</span><span class="token punctuation">,</span>                keys<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">,</span> <span class="token string">'gt_bboxes'</span><span class="token punctuation">,</span> <span class="token string">'gt_labels'</span><span class="token punctuation">,</span> <span class="token string">'gt_masks'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    val<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>  <span class="token comment"># 验证数据集的配置</span>        <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'CocoDataset'</span><span class="token punctuation">,</span>        ann_file<span class="token operator">=</span><span class="token string">'data/coco/annotations/instances_val2017.json'</span><span class="token punctuation">,</span>        img_prefix<span class="token operator">=</span><span class="token string">'data/coco/val2017/'</span><span class="token punctuation">,</span>        pipeline<span class="token operator">=</span><span class="token punctuation">[</span>  <span class="token comment"># 由之前创建的 test_pipeline 传递的流程。</span>            <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'LoadImageFromFile'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token builtin">dict</span><span class="token punctuation">(</span>                <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'MultiScaleFlipAug'</span><span class="token punctuation">,</span>                img_scale<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1333</span><span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                flip<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>                transforms<span class="token operator">=</span><span class="token punctuation">[</span>                    <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Resize'</span><span class="token punctuation">,</span> keep_ratio<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'RandomFlip'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    <span class="token builtin">dict</span><span class="token punctuation">(</span>                        <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Normalize'</span><span class="token punctuation">,</span>                        mean<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">123.675</span><span class="token punctuation">,</span> <span class="token number">116.28</span><span class="token punctuation">,</span> <span class="token number">103.53</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                        std<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">58.395</span><span class="token punctuation">,</span> <span class="token number">57.12</span><span class="token punctuation">,</span> <span class="token number">57.375</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                        to_rgb<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Pad'</span><span class="token punctuation">,</span> size_divisor<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'ImageToTensor'</span><span class="token punctuation">,</span> keys<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Collect'</span><span class="token punctuation">,</span> keys<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                <span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    test<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>  <span class="token comment"># 测试数据集配置，修改测试开发/测试(test-dev/test)提交的 ann_file</span>        <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'CocoDataset'</span><span class="token punctuation">,</span>        ann_file<span class="token operator">=</span><span class="token string">'data/coco/annotations/instances_val2017.json'</span><span class="token punctuation">,</span>        img_prefix<span class="token operator">=</span><span class="token string">'data/coco/val2017/'</span><span class="token punctuation">,</span>        pipeline<span class="token operator">=</span><span class="token punctuation">[</span>  <span class="token comment"># 由之前创建的 test_pipeline 传递的流程。</span>            <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'LoadImageFromFile'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token builtin">dict</span><span class="token punctuation">(</span>                <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'MultiScaleFlipAug'</span><span class="token punctuation">,</span>                img_scale<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1333</span><span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                flip<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>                transforms<span class="token operator">=</span><span class="token punctuation">[</span>                    <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Resize'</span><span class="token punctuation">,</span> keep_ratio<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'RandomFlip'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    <span class="token builtin">dict</span><span class="token punctuation">(</span>                        <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Normalize'</span><span class="token punctuation">,</span>                        mean<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">123.675</span><span class="token punctuation">,</span> <span class="token number">116.28</span><span class="token punctuation">,</span> <span class="token number">103.53</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                        std<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">58.395</span><span class="token punctuation">,</span> <span class="token number">57.12</span><span class="token punctuation">,</span> <span class="token number">57.375</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                        to_rgb<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Pad'</span><span class="token punctuation">,</span> size_divisor<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'ImageToTensor'</span><span class="token punctuation">,</span> keys<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Collect'</span><span class="token punctuation">,</span> keys<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                <span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>        samples_per_gpu<span class="token operator">=</span><span class="token number">2</span>  <span class="token comment"># 单个 GPU 测试时的 Batch size</span>        <span class="token punctuation">)</span><span class="token punctuation">)</span>evaluation <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>  <span class="token comment"># evaluation hook 的配置，更多细节请参考 https://github.com/open-mmlab/mmdetection/blob/master/mmdet/core/evaluation/eval_hooks.py#L7。</span>    interval<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>  <span class="token comment"># 验证的间隔。</span>    metric<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'bbox'</span><span class="token punctuation">,</span> <span class="token string">'segm'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 验证期间使用的指标。</span>optimizer <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>  <span class="token comment"># 用于构建优化器的配置文件。支持 PyTorch 中的所有优化器，同时它们的参数与 PyTorch 里的优化器参数一致。</span>    <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'SGD'</span><span class="token punctuation">,</span>  <span class="token comment"># 优化器种类，更多细节可参考 https://github.com/open-mmlab/mmdetection/blob/master/mmdet/core/optimizer/default_constructor.py#L13。</span>    lr<span class="token operator">=</span><span class="token number">0.02</span><span class="token punctuation">,</span>  <span class="token comment"># 优化器的学习率，参数的使用细节请参照对应的 PyTorch 文档。</span>    momentum<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">,</span>  <span class="token comment"># 动量(Momentum)</span>    weight_decay<span class="token operator">=</span><span class="token number">0.0001</span><span class="token punctuation">)</span>  <span class="token comment"># SGD 的衰减权重(weight decay)。</span>optimizer_config <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>  <span class="token comment"># optimizer hook 的配置文件，执行细节请参考 https://github.com/open-mmlab/mmcv/blob/master/mmcv/runner/hooks/optimizer.py#L8。</span>    grad_clip<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>  <span class="token comment"># 大多数方法不使用梯度限制(grad_clip)。</span>lr_config <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>  <span class="token comment"># 学习率调整配置，用于注册 LrUpdater hook。</span>    policy<span class="token operator">=</span><span class="token string">'step'</span><span class="token punctuation">,</span>  <span class="token comment"># 调度流程(scheduler)的策略，也支持 CosineAnnealing, Cyclic, 等。请从 https://github.com/open-mmlab/mmcv/blob/master/mmcv/runner/hooks/lr_updater.py#L9 参考 LrUpdater 的细节。</span>    warmup<span class="token operator">=</span><span class="token string">'linear'</span><span class="token punctuation">,</span>  <span class="token comment"># 预热(warmup)策略，也支持 `exp` 和 `constant`。</span>    warmup_iters<span class="token operator">=</span><span class="token number">500</span><span class="token punctuation">,</span>  <span class="token comment"># 预热的迭代次数</span>    warmup_ratio<span class="token operator">=</span>    <span class="token number">0.001</span><span class="token punctuation">,</span>  <span class="token comment"># 用于热身的起始学习率的比率</span>    step<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 衰减学习率的起止回合数</span>runner <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>    <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'EpochBasedRunner'</span><span class="token punctuation">,</span>  <span class="token comment"># 将使用的 runner 的类别 (例如 IterBasedRunner 或 EpochBasedRunner)。</span>    max_epochs<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">)</span> <span class="token comment"># runner 总回合数， 对于 IterBasedRunner 使用 `max_iters`</span>checkpoint_config <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>  <span class="token comment"># Checkpoint hook 的配置文件。执行时请参考 https://github.com/open-mmlab/mmcv/blob/master/mmcv/runner/hooks/checkpoint.py。</span>    interval<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 保存的间隔是 1。</span>log_config <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>  <span class="token comment"># register logger hook 的配置文件。</span>    interval<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span>  <span class="token comment"># 打印日志的间隔</span>    hooks<span class="token operator">=</span><span class="token punctuation">[</span>        <span class="token comment"># dict(type='TensorboardLoggerHook')  # 同样支持 Tensorboard 日志</span>        <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'TextLoggerHook'</span><span class="token punctuation">)</span>    <span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 用于记录训练过程的记录器(logger)。</span>dist_params <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>backend<span class="token operator">=</span><span class="token string">'nccl'</span><span class="token punctuation">)</span>  <span class="token comment"># 用于设置分布式训练的参数，端口也同样可被设置。</span>log_level <span class="token operator">=</span> <span class="token string">'INFO'</span>  <span class="token comment"># 日志的级别。</span>load_from <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># 从一个给定路径里加载模型作为预训练模型，它并不会消耗训练时间。</span>resume_from <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># 从给定路径里恢复检查点(checkpoints)，训练模式将从检查点保存的轮次开始恢复训练。</span>workflow <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'train'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment"># runner 的工作流程，[('train', 1)] 表示只有一个工作流且工作流仅执行一次。根据 total_epochs 工作流训练 12个回合。</span>work_dir <span class="token operator">=</span> <span class="token string">'work_dir'</span>  <span class="token comment"># 用于保存当前实验的模型检查点和日志的目录文件地址。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><ol><li>学习 mmdetection 工具箱</li><li>实现一个项目</li></ol>]]></content>
      
      
      <categories>
          
          <category> 编程 </category>
          
          <category> OpenMMLab </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mmlab </tag>
            
            <tag> mmdetection </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>FFMPEG note</title>
      <link href="/archives/97736837.html"/>
      <url>/archives/97736837.html</url>
      
        <content type="html"><![CDATA[<h1 id="FFMPEG"><a href="#FFMPEG" class="headerlink" title="FFMPEG"></a>FFMPEG</h1><h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><h3 id="01-下载，配置"><a href="#01-下载，配置" class="headerlink" title="01.下载，配置"></a>01.下载，配置</h3><p>用的系统是 Ubuntu 可以直接 apt-get</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> ffmpeg<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>windows 可以去官网下载 <a href="https://www.gyan.dev/ffmpeg/builds/">windows build</a></p><h3 id="02-简介，上手-FFmpeg-FFprobe-FFplay"><a href="#02-简介，上手-FFmpeg-FFprobe-FFplay" class="headerlink" title="02.简介，上手(FFmpeg FFprobe FFplay)"></a>02.简介，上手(FFmpeg FFprobe FFplay)</h3><p>(1) 查看 ffmpeg 的帮助说明，提供的指令。建议将其中的命令大致看看，在本笔记最后附有该帮助说明</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ffmpeg -h<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>(2) 播放媒体的指令</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ffplay video.mp4ffplay music.mp3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>(3) 常用快捷键</p><p>按键”Q”或”Esc”：退出媒体播放<br>键盘方向键：媒体播放的前进后退<br>点击鼠标右键：拖动到该播放位置<br>按键”F”：全屏<br>按键”P”或空格键：暂停<br>按键”W”:切换显示模式</p><p>(4) 查看媒体参数信息</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ffprobe video.mp4<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>输出形如下面的内容</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">Stream <span class="token comment">#0:0[0x1](und): Video: h264 (High) (avc1 / 0x31637661), yuv420p(tv, bt709), 1440x720, 163 kb/s, 30 fps, 30 tbr, 16k tbn (default)</span>    Metadata:      handler_name    <span class="token builtin class-name">:</span> VideoHandler      vendor_id       <span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>Stream <span class="token comment">#0:1[0x2](und): Audio: aac (LC) (mp4a / 0x6134706D), 44100 Hz, stereo, fltp, 128 kb/s (default)</span>    Metadata:      handler_name    <span class="token builtin class-name">:</span> SoundHandler      vendor_id       <span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到视频为 h264 编码，分辨率 1440x720、比特率(码率) 163 kb/s、帧率 30 fps。音频为 acc 编码，音频采样率 44100 Hz，比特率 128 kb/s</p><h3 id="03-转换格式-文件格式-封装格式"><a href="#03-转换格式-文件格式-封装格式" class="headerlink" title="03.转换格式(文件格式,封装格式)"></a>03.转换格式(文件格式,封装格式)</h3><p>(1) 文件名可以是中英文，但不能有空格</p><p>(2) <strong>转换格式</strong></p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ffmpeg -i video.mp4 video_avi.avi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ffmpeg 使用 -i 参数来表示输入文件，也可以用 -f 参数指定输出格式，但为了省事儿好像也可以不用指定，ffmpeg 会根据输出文件名的后缀自动识别</p><h3 id="04-提取音视频"><a href="#04-提取音视频" class="headerlink" title="04.提取音视频"></a>04.提取音视频</h3><p>(1) 单独提取视频（不含音频流）</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ffmpeg -i video.mp4 -vcodec copy -an video_silent.mp4<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>(2) 单独提取音频（不含视频流）</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ffmpeg -i video.mp4 -vn -acodec copy video_novideo.m4a<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>具备多个音频流的，如</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">Stream <span class="token comment">#0:2[0x81]:Audio:ac3,48000Hz,5.1,s16,384kb/s</span>Stream <span class="token comment">#0:3[0x82]:Audio:ac3,48000Hz,5.1,s16,384kb/s</span>Stream <span class="token comment">#0:4[0x80]:Audio:ac3,48000Hz,5.1,s16,448kb/s</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>针对性的单一的提取，例如提取第2条，用指令： -map 0:3</p><p>(3) 合并音视频</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ffmpeg -i video_novideo.m4a -i video_silent.mp4 -c copy video_merge.mp4<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>-c 为 -codec 的缩写，传入参数 copy 即使用原视频/音频编码器，这样会大大加快处理时间而不用重新转码。一般在 codec 前/后有 a/v 即代表音频/视频</p><h3 id="05-截取，连接音视频"><a href="#05-截取，连接音视频" class="headerlink" title="05.截取，连接音视频"></a>05.截取，连接音视频</h3><p>(1) 截取</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ffmpeg -i music.mp3 -ss 00:00:30 -to 00:02:00 -acodec copy music_cutout.mp3<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>输入时间可以是如上的 <code>时:分:秒</code>，也可以是 <code>分:秒</code>，也可以直接输入多少秒，秒可以是浮点数。还可以截取指定长度的音视频，如截取60秒</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ffmpeg -i music.mp3 -ss 00:00:30 -t <span class="token number">60</span> -acodec copy music_cutout60s.mp3<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>-sseof time_offset: 开始时间从媒体末尾开始计算，传入参数为复数</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ffmpeg -i in.mp4 -ss 00:01:00 -to 00:01:10 -c copy out.mp4ffmpeg -ss 00:01:00 -i in.mp4 -to 00:01:10 -c copy out.mp4ffmpeg -ss 00:01:00 -i in.mp4 -to 00:01:10 -c copy -copyts out.mp4<span class="token comment"># 从末尾往前 10s 截取 5s</span>ffmpeg -sseof -10 -t <span class="token number">5</span> -i in.mp4 -c copy out.mp4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>把-ss放到-i之前，启用了关键帧技术，加速操作。但截取的时间段不一定准确。可用最后一条指令，保留时间戳，保证时间准确。</p><p>(2) 连接音视频</p><p>我推荐使用下面的方法</p><ol><li><p>新建一个 list.txt 文件，里面包含了需要连接的音视频。格式如下</p><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">file '/path/to/file1'file '/path/to/file2'file '/path/to/file3'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>可以使用 -f concat，来合并音视频</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ffmpeg -f concat -i mylist.txt -c copy output.mp4<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ol><p>对于精细的音视频连接并不推荐使用 ffmeg</p><h3 id="06-截图，水印，动图-gif"><a href="#06-截图，水印，动图-gif" class="headerlink" title="06.截图，水印，动图 gif"></a>06.截图，水印，动图 gif</h3><p>(1) 截图.</p><p>截取第7秒第1帧的画面</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ffmpeg -i video.mp4 -ss <span class="token number">7</span> -vframes <span class="token number">1</span> video_image.jpg<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>视频分离成图片</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ffmpeg -i input_test.mp4 -r <span class="token number">1</span> -f image2 output_image-%03d.jpeg<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>图片也能合成为视频</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ffmpeg -f image2 -i output_image-%03d.jpeg output_test.mp4<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>(2) 水印</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ffmpeg -i video.mp4 -i qt.png -filter_complex <span class="token string">"overlay=20:80"</span> video_watermark.mp4<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>(3) 截取动图</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ffmpeg -i video.mp4 -ss <span class="token number">7.5</span> -to <span class="token number">8.5</span> -s 640x320 -r <span class="token number">15</span> video_gif.gif<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="补充：视频编码"><a href="#补充：视频编码" class="headerlink" title="补充：视频编码"></a>补充：视频编码</h2><h3 id="01-改变编码-上-编码-音频转码"><a href="#01-改变编码-上-编码-音频转码" class="headerlink" title="01.改变编码 上(编码,音频转码)"></a>01.改变编码 上(编码,音频转码)</h3><p>(1)查看编解码器</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ffmpeg -codecs<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>(2)<strong>网站常用编码</strong></p><p>MP4封装：H264视频编码+ACC音频编码<br>WebM封装：VP8视频编码+Vorbis音频编码<br>OGG封装：Theora视频编码+Vorbis音频编码</p><p>(3)<strong>无损编码格式.flac转换编码</strong></p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ffmpeg -i music_flac.flac -acodec libmp3lame -ar <span class="token number">44100</span> -ab 320k -ac <span class="token number">2</span> music_flac_mp3.mp3<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>说明：</strong></p><ul><li>acodec:audio Coder Decoder 音频编码解码器</li><li>libmp3lame:mp3解码器</li><li>ar:audio rate：音频采样率</li><li><strong>44100:设置音频的采样率44100。若不输入，默认用原音频的采样率</strong></li><li>ab:audio bit rate 音频比特率</li><li><strong>320k：设置音频的比特率。若不输入，默认128K</strong></li><li>ac: aduio channels 音频声道</li><li>2:声道数。若不输入，默认采用源音频的声道数</li></ul><p>概括：设置格式的基本套路-先是指名属性，然后跟着新的属性值</p><p>(4)查看结果属性</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ffprobe music_flac_mp3.mp3<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="02-改变编码-中-视频压制"><a href="#02-改变编码-中-视频压制" class="headerlink" title="02.改变编码 中(视频压制)"></a>02.改变编码 中(视频压制)</h3><p>(1)视频转码</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ffmpeg -i video.mp4 -s 1920x1080 -pix_fmt yuv420p -vcodec libx264 -preset medium -profile:v high -level:v <span class="token number">4.1</span> -crf <span class="token number">23</span> -acodec aac -ar <span class="token number">44100</span> -ac <span class="token number">2</span> -b:a 128k video_avi.avi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>说明:</strong></p><ul><li><strong>-s 1920x1080：缩放视频新尺寸(size)</strong></li><li>-pix_fmt yuv420p：pixel format,用来设置视频颜色空间。参数查询：ffmpeg -pix_fmts</li><li>-vcodec libx264：video Coder Decoder，视频编码解码器</li><li>-preset medium: 编码器预设。参数：ultrafast,superfast,veryfast,faster,fast,medium,slow,slower,veryslow,placebo</li><li>-profile:v high :编码器配置，与压缩比有关。实时通讯-baseline,流媒体-main,超清视频-high</li><li>-level:v 4.1 ：对编码器设置的具体规范和限制，权衡压缩比和画质。</li><li>-crf 23 ：设置码率控制模式。constant rate factor-恒定速率因子模式。范围0~51,默认23。数值越小，画质越高。一般在8~28做出选择。</li><li><strong>-r 30 :设置视频帧率</strong></li><li>-acodec aac :audio Coder Decoder-音频编码解码器</li><li>-b:a 128k :音频比特率.大多数网站限制音频比特率128k,129k<br>其他参考上一个教程</li></ul><h3 id="03-改变编码-下-码率控制模式"><a href="#03-改变编码-下-码率控制模式" class="headerlink" title="03.改变编码 下(码率控制模式)"></a>03.改变编码 下(码率控制模式)</h3><p>ffmpeg支持的码率控制模式：-qp -crf -b</p><p>(1)  -qp :constant quantizer,恒定量化器模式 </p><p>无损压缩的例子（快速编码）</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ffmpeg -i input -vcodec libx264 -preset ultrafast -qp <span class="token number">0</span> output.mkv<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>无损压缩的例子（高压缩比）</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ffmpeg -i input -vcodec libx264 -preset veryslow -qp <span class="token number">0</span> output.mkv<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>(2) -crf :constant rate factor,恒定速率因子模式</p><p>(3) -b ：bitrate,固定目标码率模式。一般不建议使用</p><p>3种模式默认单遍编码</p><p>VBR(Variable Bit Rate/动态比特率) 例子</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ffmpeg -i input -vcodec libx264 -preset veryslow output<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ABR(Average Bit Rate/平均比特率) 例子</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ffmpeg -i input -vcodec libx264 -preset veryslow -b:v 3000k output<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>CBR(Constant Bit Rate/恒定比特率) 例子</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">..</span>. -b:v 4000k -minrate 4000k -maxrate 4000k -bufsize 1835k <span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p>笔记来源：<a href="https://www.bilibili.com/video/av40146374">https://www.bilibili.com/video/av40146374</a></p><p>官方教程： <a href="http://ffmpeg.org/ffmpeg-all.html">http://ffmpeg.org/ffmpeg-all.html</a></p><p>博客：<a href="https://www.jianshu.com/p/f07f0be088d0">https://www.jianshu.com/p/f07f0be088d0</a></p><h2 id="帮助文档，用于查询"><a href="#帮助文档，用于查询" class="headerlink" title="帮助文档，用于查询"></a>帮助文档，用于查询</h2><p>下面是 ffmpeg 的帮助文档，用于查询</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ffmpeg version <span class="token number">2021</span>-09-08-git-5e7e2e5031-full_build-www.gyan.dev Copyright <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token number">2000</span>-2021 the FFmpeg developers  built with gcc <span class="token number">10.3</span>.0 <span class="token punctuation">(</span>Rev5, Built by MSYS2 project<span class="token punctuation">)</span>  configuration: --enable-gpl --enable-version3 --enable-static --disable-w32threads --disable-autodetect --enable-fontconfig --enable-iconv --enable-gnutls --enable-libxml2 --enable-gmp --enable-lzma --enable-libsnappy --enable-zlib --enable-librist --enable-libsrt --enable-libssh --enable-libzmq --enable-avisynth --enable-libbluray --enable-libcaca --enable-sdl2 --enable-libdav1d --enable-libzvbi --enable-librav1e --enable-libsvtav1 --enable-libwebp --enable-libx264 --enable-libx265 --enable-libxvid --enable-libaom --enable-libopenjpeg --enable-libvpx --enable-libass --enable-frei0r --enable-libfreetype --enable-libfribidi --enable-libvidstab --enable-libvmaf --enable-libzimg --enable-amf --enable-cuda-llvm --enable-cuvid --enable-ffnvcodec --enable-nvdec --enable-nvenc --enable-d3d11va --enable-dxva2 --enable-libmfx --enable-libglslang --enable-vulkan --enable-opencl --enable-libcdio --enable-libgme --enable-libmodplug --enable-libopenmpt --enable-libopencore-amrwb --enable-libmp3lame --enable-libshine --enable-libtheora --enable-libtwolame --enable-libvo-amrwbenc --enable-libilbc --enable-libgsm --enable-libopencore-amrnb --enable-libopus --enable-libspeex --enable-libvorbis --enable-ladspa --enable-libbs2b --enable-libflite --enable-libmysofa --enable-librubberband --enable-libsoxr --enable-chromaprint  libavutil      <span class="token number">57</span>.  <span class="token number">4.101</span> / <span class="token number">57</span>.  <span class="token number">4.101</span>  libavcodec     <span class="token number">59</span>.  <span class="token number">7.102</span> / <span class="token number">59</span>.  <span class="token number">7.102</span>  libavformat    <span class="token number">59</span>.  <span class="token number">5.100</span> / <span class="token number">59</span>.  <span class="token number">5.100</span>  libavdevice    <span class="token number">59</span>.  <span class="token number">0.101</span> / <span class="token number">59</span>.  <span class="token number">0.101</span>  libavfilter     <span class="token number">8</span>.  <span class="token number">7.101</span> /  <span class="token number">8</span>.  <span class="token number">7.101</span>  libswscale      <span class="token number">6</span>.  <span class="token number">1.100</span> /  <span class="token number">6</span>.  <span class="token number">1.100</span>  libswresample   <span class="token number">4</span>.  <span class="token number">0.100</span> /  <span class="token number">4</span>.  <span class="token number">0.100</span>  libpostproc    <span class="token number">56</span>.  <span class="token number">0.100</span> / <span class="token number">56</span>.  <span class="token number">0.100</span>Hyper fast Audio and Video encoderusage: ffmpeg <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>infile options<span class="token punctuation">]</span> -i infile<span class="token punctuation">]</span><span class="token punctuation">..</span>. <span class="token punctuation">{</span><span class="token punctuation">[</span>outfile options<span class="token punctuation">]</span> outfile<span class="token punctuation">}</span><span class="token punctuation">..</span>.Getting help:    -h      -- print basic options    -h long -- print <span class="token function">more</span> options    -h full -- print all options <span class="token punctuation">(</span>including all <span class="token function">format</span> and codec specific options, very long<span class="token punctuation">)</span>    -h <span class="token assign-left variable">type</span><span class="token operator">=</span>name -- print all options <span class="token keyword">for</span> the named decoder/encoder/demuxer/muxer/filter/bsf/protocol    See <span class="token function">man</span> ffmpeg <span class="token keyword">for</span> detailed description of the options.Print <span class="token builtin class-name">help</span> / information / capabilities:-L                  show license-h topic            show <span class="token builtin class-name">help</span>-? topic            show <span class="token builtin class-name">help</span>-help topic         show <span class="token builtin class-name">help</span>--help topic        show <span class="token builtin class-name">help</span>-version            show version-buildconf          show build configuration-formats            show available formats-muxers             show available muxers-demuxers           show available demuxers-devices            show available devices-codecs             show available codecs-decoders           show available decoders-encoders           show available encoders-bsfs               show available bit stream filters-protocols          show available protocols-filters            show available filters-pix_fmts           show available pixel formats-layouts            show standard channel layouts-sample_fmts        show available audio sample formats-colors             show available color names-sources device     list sources of the input device-sinks device       list sinks of the output device-hwaccels           show available HW acceleration methodsGlobal options <span class="token punctuation">(</span>affect whole program instead of just one <span class="token function">file</span><span class="token punctuation">)</span>:-loglevel loglevel  <span class="token builtin class-name">set</span> logging level-v loglevel         <span class="token builtin class-name">set</span> logging level-report             generate a report-max_alloc bytes    <span class="token builtin class-name">set</span> maximum size of a single allocated block-y                  overwrite output files-n                  never overwrite output files-ignore_unknown     Ignore unknown stream types-filter_threads     number of non-complex filter threads-filter_complex_threads  number of threads <span class="token keyword">for</span> -filter_complex-stats              print progress report during encoding-max_error_rate maximum error rate  ratio of decoding errors <span class="token punctuation">(</span><span class="token number">0.0</span>: no errors, <span class="token number">1.0</span>: <span class="token number">100</span>% errors<span class="token punctuation">)</span> above <span class="token function">which</span> ffmpeg returns an error instead of success.-bits_per_raw_sample number  <span class="token builtin class-name">set</span> the number of bits per raw sample-vol volume         change audio volume <span class="token punctuation">(</span><span class="token number">256</span><span class="token operator">=</span>normal<span class="token punctuation">)</span>Per-file main options:-f <span class="token function">fmt</span>              force <span class="token function">format</span>-c codec            codec name-codec codec        codec name-pre preset         preset name-map_metadata outfile<span class="token punctuation">[</span>,metadata<span class="token punctuation">]</span>:infile<span class="token punctuation">[</span>,metadata<span class="token punctuation">]</span>  <span class="token builtin class-name">set</span> metadata information of outfile from infile-t duration         record or transcode <span class="token string">"duration"</span> seconds of audio/video-to time_stop       record or transcode stop <span class="token function">time</span>-fs limit_size      <span class="token builtin class-name">set</span> the limit <span class="token function">file</span> size <span class="token keyword">in</span> bytes-ss time_off        <span class="token builtin class-name">set</span> the start <span class="token function">time</span> offset-sseof time_off     <span class="token builtin class-name">set</span> the start <span class="token function">time</span> offset relative to EOF-seek_timestamp     enable/disable seeking by timestamp with -ss-timestamp <span class="token function">time</span>     <span class="token builtin class-name">set</span> the recording timestamp <span class="token punctuation">(</span><span class="token string">'now'</span> to <span class="token builtin class-name">set</span> the current <span class="token function">time</span><span class="token punctuation">)</span>-metadata <span class="token assign-left variable">string</span><span class="token operator">=</span>string  <span class="token function">add</span> metadata-program <span class="token assign-left variable">title</span><span class="token operator">=</span>string:st<span class="token operator">=</span>number<span class="token punctuation">..</span>.  <span class="token function">add</span> program with specified streams-target <span class="token builtin class-name">type</span>        specify target <span class="token function">file</span> <span class="token builtin class-name">type</span> <span class="token punctuation">(</span><span class="token string">"vcd"</span>, <span class="token string">"svcd"</span>, <span class="token string">"dvd"</span>, <span class="token string">"dv"</span> or <span class="token string">"dv50"</span> with optional prefixes <span class="token string">"pal-"</span>, <span class="token string">"ntsc-"</span> or <span class="token string">"film-"</span><span class="token punctuation">)</span>-apad               audio pad-frames number      <span class="token builtin class-name">set</span> the number of frames to output-filter filter_graph  <span class="token builtin class-name">set</span> stream filtergraph-filter_script filename  <span class="token builtin class-name">read</span> stream filtergraph description from a <span class="token function">file</span>-reinit_filter      reinit filtergraph on input parameter changes-discard            discard-disposition        dispositionVideo options:-vframes number     <span class="token builtin class-name">set</span> the number of video frames to output-r rate             <span class="token builtin class-name">set</span> frame rate <span class="token punctuation">(</span>Hz value, fraction or abbreviation<span class="token punctuation">)</span>-fpsmax rate        <span class="token builtin class-name">set</span> max frame rate <span class="token punctuation">(</span>Hz value, fraction or abbreviation<span class="token punctuation">)</span>-s size             <span class="token builtin class-name">set</span> frame size <span class="token punctuation">(</span>WxH or abbreviation<span class="token punctuation">)</span>-aspect aspect      <span class="token builtin class-name">set</span> aspect ratio <span class="token punctuation">(</span><span class="token number">4</span>:3, <span class="token number">16</span>:9 or <span class="token number">1.3333</span>, <span class="token number">1.7777</span><span class="token punctuation">)</span>-bits_per_raw_sample number  <span class="token builtin class-name">set</span> the number of bits per raw sample-vn                 disable video-vcodec codec       force video codec <span class="token punctuation">(</span><span class="token string">'copy'</span> to copy stream<span class="token punctuation">)</span>-timecode hh:mm:ss<span class="token punctuation">[</span>:<span class="token punctuation">;</span>.<span class="token punctuation">]</span>ff  <span class="token builtin class-name">set</span> initial TimeCode value.-pass n             <span class="token keyword">select</span> the pass number <span class="token punctuation">(</span><span class="token number">1</span> to <span class="token number">3</span><span class="token punctuation">)</span>-vf filter_graph    <span class="token builtin class-name">set</span> video filters-ab bitrate         audio bitrate <span class="token punctuation">(</span>please use -b:a<span class="token punctuation">)</span>-b bitrate          video bitrate <span class="token punctuation">(</span>please use -b:v<span class="token punctuation">)</span>-dn                 disable dataAudio options:-aframes number     <span class="token builtin class-name">set</span> the number of audio frames to output-aq quality         <span class="token builtin class-name">set</span> audio quality <span class="token punctuation">(</span>codec-specific<span class="token punctuation">)</span>-ar rate            <span class="token builtin class-name">set</span> audio sampling rate <span class="token punctuation">(</span>in Hz<span class="token punctuation">)</span>-ac channels        <span class="token builtin class-name">set</span> number of audio channels-an                 disable audio-acodec codec       force audio codec <span class="token punctuation">(</span><span class="token string">'copy'</span> to copy stream<span class="token punctuation">)</span>-vol volume         change audio volume <span class="token punctuation">(</span><span class="token number">256</span><span class="token operator">=</span>normal<span class="token punctuation">)</span>-af filter_graph    <span class="token builtin class-name">set</span> audio filtersSubtitle options:-s size             <span class="token builtin class-name">set</span> frame size <span class="token punctuation">(</span>WxH or abbreviation<span class="token punctuation">)</span>-sn                 disable subtitle-scodec codec       force subtitle codec <span class="token punctuation">(</span><span class="token string">'copy'</span> to copy stream<span class="token punctuation">)</span>-stag fourcc/tag    force subtitle tag/fourcc-fix_sub_duration   fix subtitles duration-canvas_size size   <span class="token builtin class-name">set</span> canvas size <span class="token punctuation">(</span>WxH or abbreviation<span class="token punctuation">)</span>-spre preset        <span class="token builtin class-name">set</span> the subtitle options to the indicated preset<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 软件 </category>
          
          <category> FFMPEG </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ffmpeg </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Pr note</title>
      <link href="/archives/d76b900f.html"/>
      <url>/archives/d76b900f.html</url>
      
        <content type="html"><![CDATA[<h1 id="Premiere-note"><a href="#Premiere-note" class="headerlink" title="Premiere note"></a>Premiere note</h1><p>教程资源：<a href="https://www.bilibili.com/video/BV1K64y1r7pp?p=1">基础教程 bilibili</a> </p><h2 id="从界面开始"><a href="#从界面开始" class="headerlink" title="从界面开始"></a>从界面开始</h2><p>关于编码：H.264 编码就是对应 mp4 格式视频</p><h3 id="界面"><a href="#界面" class="headerlink" title="界面"></a>界面</h3><ol><li><strong>素材箱</strong></li><li>工具栏</li><li><strong>序列</strong></li><li>预览窗口</li><li>效果窗口</li><li><strong>参数窗口</strong></li><li><strong>面板</strong>：不同的面板专注处理视频的不同部分，例如：组件面板完成的是对视频的粗剪</li></ol><h2 id="过程中的小技巧"><a href="#过程中的小技巧" class="headerlink" title="过程中的小技巧"></a>过程中的小技巧</h2><ol><li>通过效果面板 -&gt; 特效参数可以进行缩放，或者右键选择缩放为帧大小</li><li>右键选择倍速</li><li>右键取消视频音频链接</li><li>右键波纹删除，或选中空隙直接删除</li><li>右键减少音频增益</li><li>shift + left/right arrow 能够以5帧移，不按 shift 移动1帧</li><li>按住 shift 再拉动时间轴会有吸附效果</li><li>ctrl + k 快速剪裁</li><li>使用嵌套，融合素材</li><li>按住 ctrl 拖动视频，能够不覆盖地移动视频片段</li><li>单击顶部序列菜单 -&gt; 封闭间隙</li><li>ctrl + D 或者 shift + D 进行快速视频过渡</li></ol><h3 id="快捷键"><a href="#快捷键" class="headerlink" title="快捷键"></a>快捷键</h3><p>cut </p><h2 id="标记出入点"><a href="#标记出入点" class="headerlink" title="标记出入点"></a>标记出入点</h2><ol><li>预览工具栏</li></ol><p><img src="/archives/d76b900f/image-20210713213300154.png"></p><ol><li><strong>出入点</strong>在 pr 中以 bracket {} 形式出现</li></ol><p>​    双击素材，对素材进行出入点标记，再将素材拖入序列就能得到剪裁后的    素材</p><ol><li>添加标记点，就是工具栏第一个标志。可以标记视频中的重要时刻</li></ol><h2 id="抽帧卡点"><a href="#抽帧卡点" class="headerlink" title="抽帧卡点"></a>抽帧卡点</h2><p>根据音频的节奏去卡点，可以看到音频上的节奏点上是明显的波峰，把这些点标记出来，对原视频剪裁卡这个点即可</p><p>可以使用插件 beat edit 来帮我们自动找到节奏点</p><h2 id="加载字幕"><a href="#加载字幕" class="headerlink" title="加载字幕"></a>加载字幕</h2><p>如果是想要加大量字幕，推荐使用软件 arctime pro</p><p>TODO: 如何自动识别对话，形成字幕</p><h2 id="鬼畜"><a href="#鬼畜" class="headerlink" title="鬼畜"></a>鬼畜</h2><ol><li><p>鬼畜素材，鬼畜素材，鬼畜素材！</p></li><li><p>按住 alt 拖拽视频就能够复制</p></li><li>右键选择帧速度更改速度，还可以倒放</li></ol><h2 id="转场"><a href="#转场" class="headerlink" title="转场"></a>转场</h2><ol><li>基础的转场，淡入淡出</li><li>使用特效的转场，将特效加在调整图层上，不用修改原图层</li><li>可以使用 preset 转场资源：<a href="https://www.bilibili.com/video/BV1ab411E7EA">预设 bilibili</a> (更多资源请移步 bilibili)</li></ol><h2 id="字体"><a href="#字体" class="headerlink" title="字体"></a>字体</h2><p>推荐的字体</p><ol><li>思源黑体</li><li>台北黑体，适用于繁体字</li><li>花园明朝体</li><li>刻石录明体，令东齐伋复刻体</li><li>OPPO/HarmonyOS SANS</li><li>手书体中文简体</li><li>good hood, maria 以上字体均免费可商用</li><li>gloss and boom</li><li>againts 字体</li><li>Futura, Baskerville(正规),  Trajan(标题)</li></ol><h2 id="调色"><a href="#调色" class="headerlink" title="调色"></a>调色</h2><p>使用 LUT 调色，配合上侧轮进行微调</p><p>教程：<a href="https://www.bilibili.com/video/BV1qE411d7BS">调色 bilibili</a></p><h2 id="动画"><a href="#动画" class="headerlink" title="动画"></a>动画</h2><p><strong>最基础也最常用的就是使用关键帧实现动画，Pr 能够通过关键帧自动实现简单动画</strong></p><p>下面是一些懒人教程，能够通过模板或者预设完成动画</p><p><a href="https://www.bilibili.com/video/BV1JK4y1o712?from=search&amp;seid=15809921384211472980">文字出入动画预设</a>：推荐使用 glitch smooth</p><p><a href="https://www.bilibili.com/video/BV1QJ411578F?from=search&amp;seid=1184998685891370931">快速添加 emoji 表情</a></p><h2 id="常用效果，进阶实战"><a href="#常用效果，进阶实战" class="headerlink" title="常用效果，进阶实战"></a>常用效果，进阶实战</h2><p><a href="https://www.bilibili.com/video/BV1h7411M7pH?from=search&amp;seid=1594445263778267172">简单视频过渡</a></p><p><a href="https://www.bilibili.com/video/BV1tt411w75b?from=search&amp;seid=14224780402575780190">裁剪，旋转</a></p><p><a href="https://www.bilibili.com/video/BV1Kb411M7QD?from=search&amp;seid=14224780402575780190">轨道遮罩教程</a></p><p><a href="https://www.bilibili.com/video/BV1T441177Rz/">不透明度，蒙板遮罩转场</a></p><p><a href="https://www.bilibili.com/medialist/play/ml1093412053/BV1CX4y1373V">绿幕素材教程 超级键</a></p><p><a href="https://www.bilibili.com/video/BV1Kb411M7QD?from=search&amp;seid=14224780402575780190">基础图形变换，玻璃划过效果</a></p><p><a href="https://www.bilibili.com/video/BV1Vb411J7q3?from=search&amp;seid=11560949388583323453">文字书写</a></p><h2 id="vlog-素材库"><a href="#vlog-素材库" class="headerlink" title="vlog 素材库"></a>vlog 素材库</h2><ol><li><p><a href="https://dongmanhuayuan.myheartsite.com/">动漫花园镜像站</a></p></li><li><p><a href="https://mixkit.co/">mixkit</a></p><p>视频，音频，Pr模板资源</p></li><li><p><a href="https://pixabay.com/zh/">pixabay</a></p><p>视频，音频，图片资源</p></li><li><p><a href="https://www.iconfont.cn/">iconfont</a></p></li><li><p>vlog 音乐资源：参考 <a href="https://www.bilibili.com/video/BV1uX4y1G7M8?from=search&amp;seid=14857001846860959682">vlog bgm bilibili</a>，还可以学习一下如何处理 bgm 与人声混合</p><p><a href="https://soundcloud.com/lakeyinspired">sound cloud: lakey inspired</a></p><p>如果想要使用 off vocal music 只需要搜索 歌名 + instrumental 即可</p></li></ol><p>视频、音效素材希望自己要有目的地去寻找，不然资源再多也没用</p>]]></content>
      
      
      <categories>
          
          <category> 软件 </category>
          
          <category> Adobe </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pr </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Manim Kindergarten 教程</title>
      <link href="/archives/84b26b6c.html"/>
      <url>/archives/84b26b6c.html</url>
      
        <content type="html"><![CDATA[<h1 id="Manim-拓展学习"><a href="#Manim-拓展学习" class="headerlink" title="Manim 拓展学习"></a>Manim 拓展学习</h1><p>由于 Manim-Kindergarten 的 <a href="https://www.bilibili.com/video/BV1p54y197cC?from=search&amp;seid=1264961070490764259">视频教程</a> 非常友好，所以根据他们的视频进行整理和学习。但是由于教程中使用的 manim 版本并不是社区版本，所有整理的内容和原教程有所出入</p><h2 id="第一讲-物体的位置与坐标变换"><a href="#第一讲-物体的位置与坐标变换" class="headerlink" title="第一讲 物体的位置与坐标变换"></a>第一讲 物体的位置与坐标变换</h2><p>怎样确定物体的坐标？首先要理解 manim 的坐标体系。</p><ol><li>在 manim 中，使用三维 ndarray 表示一个点的坐标 <code>np.array([x, y, z])</code>，二维场景中设 <code>z = 0</code></li><li>单位长度取决于 constants.py 中的 FRAME_HEIGHT，画面的宽度由高度和长宽比同时决定。FRAME_HEIGHT 默认值为8，y 的变化范围只能是 [-4, 4]</li><li>在 manim 中，二维画面以中心为坐标原点，向右为 x 轴正方向，向上为 y 轴正方向</li></ol><p>manim 中定义了一些常用的单位方向常量比如：</p><p>LEFT = <code>np.array([-1, 0, 0])</code></p><p>RIGHT = <code>np.array([1, 0, 0])</code> </p><p>UP = <code>np.array([0, 1, 0])</code></p><p>DOWN = <code>np.array([0, -1, 0])</code></p><h3 id="shift-move-to"><a href="#shift-move-to" class="headerlink" title="shift+move_to"></a>shift+move_to</h3><p>两个方法都可以根据传入的 vector 移动物体，shift 是相对移动，move_to 是移动到坐标系中的点</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># create a mobject 'mob' first</span>mob<span class="token punctuation">.</span>shift<span class="token punctuation">(</span><span class="token operator">*</span>vectors<span class="token punctuation">)</span>mob<span class="token punctuation">.</span>move_to<span class="token punctuation">(</span><span class="token operator">*</span>vectors<span class="token punctuation">,</span> aligned_egde<span class="token punctuation">,</span> coor_mask<span class="token punctuation">)</span><span class="token comment"># corr_mask 可以屏蔽指定方向的移动</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="scale-amp-stretch-amp-set-width-height"><a href="#scale-amp-stretch-amp-set-width-height" class="headerlink" title="scale &amp; stretch &amp; set_width/height"></a>scale &amp; stretch &amp; set_width/height</h3><p>对物体进行放大</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">mob<span class="token punctuation">.</span>scale<span class="token punctuation">(</span>factor<span class="token punctuation">,</span> about_egde<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> about_point<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>对物体进行拉伸</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">mob<span class="token punctuation">.</span>stretch<span class="token punctuation">(</span>factor<span class="token punctuation">,</span> dim<span class="token punctuation">)</span>mob<span class="token punctuation">.</span>set_width<span class="token punctuation">(</span>width<span class="token punctuation">,</span> stretch<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>mob<span class="token punctuation">.</span>set_height<span class="token punctuation">(</span>height<span class="token punctuation">,</span> stretch<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="rotate"><a href="#rotate" class="headerlink" title="rotate"></a>rotate</h3><p>根据右手定律进行旋转 </p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># angle 需要用 manim 中定义的 DEGREES or PI 进行计算</span>mob<span class="token punctuation">.</span>rotate<span class="token punctuation">(</span>angle<span class="token punctuation">,</span> axis<span class="token operator">=</span>OUT<span class="token punctuation">,</span> about_point<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="flip"><a href="#flip" class="headerlink" title="flip"></a>flip</h3><p>能够指定对称轴进行镜像翻转</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">mob<span class="token punctuation">.</span>flip<span class="token punctuation">(</span><span class="token punctuation">)</span>mob<span class="token punctuation">.</span>flip<span class="token punctuation">(</span>axis<span class="token operator">=</span>vector<span class="token punctuation">,</span> about_point<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="align-to-amp-next-to"><a href="#align-to-amp-next-to" class="headerlink" title="align_to &amp; next_to"></a>align_to &amp; next_to</h3><p>坐标和某个物体对齐，或者在某个物体的相邻位置</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># direction is a vector like LEFT, RIGHT, UL</span>mob<span class="token punctuation">.</span>align_to<span class="token punctuation">(</span>mob_or_point<span class="token punctuation">,</span> direction<span class="token punctuation">)</span>mob<span class="token punctuation">.</span>next_to<span class="token punctuation">(</span>mob_or_point<span class="token punctuation">,</span> direction<span class="token punctuation">,</span> aligned_edge<span class="token punctuation">,</span> buff<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="第二讲-manim常用几何类"><a href="#第二讲-manim常用几何类" class="headerlink" title="第二讲 manim常用几何类"></a>第二讲 manim常用几何类</h2><h3 id="line-amp-arrow"><a href="#line-amp-arrow" class="headerlink" title="line &amp; arrow"></a>line &amp; arrow</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python">line <span class="token operator">=</span> Line<span class="token punctuation">(</span>start_point<span class="token punctuation">,</span> end_point<span class="token punctuation">,</span> buff<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>arrow <span class="token operator">=</span> Aroow<span class="token punctuation">(</span>start_point<span class="token punctuation">,</span> end_point<span class="token punctuation">,</span> buff<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> tip_length<span class="token punctuation">)</span><span class="token comment"># buff 调整的是到目标点的距离</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>还有其他更多的变化，比如 Dashline Vector</p><h3 id="arc"><a href="#arc" class="headerlink" title="arc"></a>arc</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python">arc <span class="token operator">=</span> Arc<span class="token punctuation">(</span>arc_center<span class="token punctuation">,</span> radius<span class="token punctuation">,</span> start_angle<span class="token punctuation">,</span> angle<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="circle-amp-dot-amp-ellipse"><a href="#circle-amp-dot-amp-ellipse" class="headerlink" title="circle &amp; dot &amp; ellipse"></a>circle &amp; dot &amp; ellipse</h3><p>这三类几何图形都是继承于 arc 类，所有参数都有相似之处</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">circle <span class="token operator">=</span> Circle<span class="token punctuation">(</span>arc_center<span class="token punctuation">,</span> radius<span class="token punctuation">,</span> stroke_width<span class="token punctuation">)</span>dot <span class="token operator">=</span> Dot<span class="token punctuation">(</span>arc_center<span class="token punctuation">,</span> radius<span class="token punctuation">)</span>ellipse <span class="token operator">=</span> Ellipse<span class="token punctuation">(</span>arc_center<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="annulus-amp-sector"><a href="#annulus-amp-sector" class="headerlink" title="annulus &amp; sector"></a>annulus &amp; sector</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python">annulus <span class="token operator">=</span> Annulus<span class="token punctuation">(</span>outer_radis<span class="token punctuation">,</span> inner_radius<span class="token punctuation">)</span>sector <span class="token operator">=</span> Sector<span class="token punctuation">(</span>outer_radius<span class="token punctuation">,</span> inner_radius<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="polygon-amp-triangle"><a href="#polygon-amp-triangle" class="headerlink" title="polygon &amp; triangle"></a>polygon &amp; triangle</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python">triangle <span class="token operator">=</span> Polygon<span class="token punctuation">(</span>point_1<span class="token punctuation">,</span> point_2<span class="token punctuation">,</span> point_3<span class="token punctuation">)</span>triangle <span class="token operator">=</span> Triangle<span class="token punctuation">(</span><span class="token punctuation">)</span>Hexagon <span class="token operator">=</span> RegularPolygon<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>对于多边形还有一个特别的方法，将顶点变为圆弧</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># mob is a polygon mobject instance</span>mob<span class="token punctuation">.</span>round_corners<span class="token punctuation">(</span>radius<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="rectangle-amp-square"><a href="#rectangle-amp-square" class="headerlink" title="rectangle &amp; square"></a>rectangle &amp; square</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python">rectangle <span class="token operator">=</span> Rectangle<span class="token punctuation">(</span>height<span class="token punctuation">,</span> width<span class="token punctuation">)</span>square <span class="token operator">=</span> Square<span class="token punctuation">(</span>side_length<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="VGroup"><a href="#VGroup" class="headerlink" title="VGroup"></a>VGroup</h3><p>该方法能够将多个 mobject 放到一个组中，能够实现类似 list 的功能，例如管理成员、嵌套，同时还能使用 mobject 通用方法</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">vgroup <span class="token operator">=</span> VGroup<span class="token punctuation">(</span>mob0<span class="token punctuation">,</span> mob1<span class="token punctuation">,</span> mob2<span class="token punctuation">)</span>vgroup<span class="token punctuation">.</span>add<span class="token punctuation">(</span>mob3<span class="token punctuation">)</span>vgroup<span class="token punctuation">.</span>add_to_back<span class="token punctuation">(</span>mob4<span class="token punctuation">)</span>vgroup<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>mob2<span class="token punctuation">)</span>vgroup<span class="token punctuation">.</span>shift<span class="token punctuation">(</span>UP<span class="token punctuation">)</span><span class="token comment"># 将成员按照某一方向对齐，本质上是实现了 next_to 方法</span>vg<span class="token punctuation">.</span>arrange<span class="token punctuation">(</span>DOWN<span class="token punctuation">,</span> aligned_edge<span class="token operator">=</span>LEFT<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="第三讲-颜色的表示、运算与设置"><a href="#第三讲-颜色的表示、运算与设置" class="headerlink" title="第三讲 颜色的表示、运算与设置"></a>第三讲 颜色的表示、运算与设置</h2><h3 id="颜色的表示"><a href="#颜色的表示" class="headerlink" title="颜色的表示"></a>颜色的表示</h3><p>有三种表示方法</p><ol><li><p>定义的常量，如下图</p></li><li><p>十六进制，形如 #66CCFF</p></li><li><p>RGB数组，形如 np.array([255, 104, 100])</p></li></ol><p><img src="/archives/84b26b6c/image-20210729201211734.png" style="zoom: 20%;"></p><p>但所有的表示方法，在 manim 中最终都会转化为 Color 类</p><p><strong>推荐使用常量或者十六进制来表示颜色</strong></p><h3 id="颜色的运算"><a href="#颜色的运算" class="headerlink" title="颜色的运算"></a>颜色的运算</h3><p>列几个常见的运算</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 反色</span>invert_color<span class="token punctuation">(</span>color<span class="token punctuation">)</span><span class="token comment"># 插值</span>interpolate_color<span class="token punctuation">(</span>color_1<span class="token punctuation">,</span> color_2<span class="token punctuation">,</span> ratio<span class="token punctuation">)</span><span class="token comment"># 平均</span>average_color<span class="token punctuation">(</span><span class="token operator">*</span>colors<span class="token punctuation">)</span><span class="token comment"># 梯度</span>color_gradient<span class="token punctuation">(</span><span class="token punctuation">[</span>color_1<span class="token punctuation">,</span> color_2<span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token comment"># 随机</span>random_color<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/archives/84b26b6c/image-20210729203331953.png" alt="color_gradient" style="zoom:25%;"></p><h3 id="物体颜色设置"><a href="#物体颜色设置" class="headerlink" title="物体颜色设置"></a>物体颜色设置</h3><p>stroke 代表边框着色，fill 代表内部着色</p><div class="table-container"><table><thead><tr><th>stroke</th><th>fill</th></tr></thead><tbody><tr><td>stroke_color</td><td>fill_color</td></tr><tr><td>stroke_opacity</td><td>fill_opacity</td></tr></tbody></table></div><p>上面的属性都可以通过 set_stroke/fill 来更改</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">mob<span class="token punctuation">.</span>set_stroke<span class="token punctuation">(</span>color<span class="token punctuation">,</span> width<span class="token punctuation">)</span>mob<span class="token punctuation">.</span>set_fill<span class="token punctuation">(</span>color<span class="token punctuation">,</span> opacity<span class="token punctuation">)</span>mob<span class="token punctuation">.</span>set_fill<span class="token punctuation">(</span><span class="token punctuation">[</span>color_1<span class="token punctuation">,</span> color_2<span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">,</span> opacity<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="给-VGroup-子物体上色"><a href="#给-VGroup-子物体上色" class="headerlink" title="给 VGroup 子物体上色"></a>给 VGroup 子物体上色</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># vg is a VGroup instance</span>vg<span class="token punctuation">.</span>set_color<span class="token punctuation">(</span>color<span class="token punctuation">)</span>vg<span class="token punctuation">.</span>set_color_by_gradient<span class="token punctuation">(</span><span class="token operator">*</span>colors<span class="token punctuation">)</span>vg<span class="token punctuation">.</span>set_colors_by_radial_gradient<span class="token punctuation">(</span>radius<span class="token punctuation">,</span> inner_color<span class="token punctuation">,</span> outer_color<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>值得一提的是，这些操作都是 <code>VMobject</code> 的内置方法，是一种通用的方法，而且这些方法不仅仅可以设置 <code>stroke</code> 的颜色，也可以设置 <code>width, opacity...</code></p><h2 id="第四讲-插入SVG、图片与文字"><a href="#第四讲-插入SVG、图片与文字" class="headerlink" title="第四讲 插入SVG、图片与文字"></a>第四讲 插入SVG、图片与文字</h2><h3 id="图片"><a href="#图片" class="headerlink" title="图片"></a>图片</h3><p>在 manim 插入图片需要先将图片放在当前文件夹下，或者使用 <code>config.assets_dir</code> 指定素材文件夹。不同的图片类型则使用不同的对象进行存储</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># SVG</span>mob <span class="token operator">=</span> SVGMobject<span class="token punctuation">(</span><span class="token string">'file'</span><span class="token punctuation">)</span><span class="token comment"># image: jpg, png, gif</span>mob <span class="token operator">=</span> ImageMobject<span class="token punctuation">(</span><span class="token string">'file'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>SVGMobject</code> 是 <code>VMobject</code> 的子类，可以使用其所有动画，但 <code>ImageMobject</code> 仅能使用部分动画，如：FadeIn</p><h3 id="文字与公式"><a href="#文字与公式" class="headerlink" title="文字与公式"></a>文字与公式</h3><p>在 manim 中可以使用 <code>Text</code> 创建普通文字对象</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">text <span class="token operator">=</span> Text<span class="token punctuation">(</span><span class="token operator">*</span>strings<span class="token punctuation">,</span> color<span class="token punctuation">,</span> font<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>可以传入多个字符串，同样 <code>Text</code> 也可以使用所有动画。如果想要使用 LaTeX 语法书写文字和公式，则需要使用 <code>Tex, MathTex</code> 类</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">text <span class="token operator">=</span> Tex<span class="token punctuation">(</span><span class="token operator">*</span>raw_strings<span class="token punctuation">)</span>formula <span class="token operator">=</span> MathTex<span class="token punctuation">(</span><span class="token operator">*</span>raw_strings<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>所有的文字和公式都是一个 <code>VGroup</code>，可以通过索引来对每个字符单独操作</p><h2 id="第五讲-坐标系统与方程"><a href="#第五讲-坐标系统与方程" class="headerlink" title="第五讲 坐标系统与方程"></a>第五讲 坐标系统与方程</h2><h3 id="坐标轴"><a href="#坐标轴" class="headerlink" title="坐标轴"></a>坐标轴</h3><p>在 manim 中可以插入坐标轴</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># NumberLine</span><span class="token comment"># x_range 标明数周的范围以及步长</span>line <span class="token operator">=</span> NumberLine<span class="token punctuation">(</span>        numberline <span class="token operator">=</span> NumberLine<span class="token punctuation">(</span>            x_range<span class="token operator">=</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>            length<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>            include_numbers<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>            include_ticks<span class="token operator">=</span><span class="token boolean">False</span>        <span class="token punctuation">)</span><span class="token comment"># Axes</span><span class="token comment"># 分别设置 x, y 坐标轴，具体参数打包为字典，关键字同 NumberLine</span>axes <span class="token operator">=</span> Axes<span class="token punctuation">(</span>            x_range<span class="token operator">=</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>            y_range<span class="token operator">=</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>            axis_config<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>                include_numbers<span class="token operator">=</span><span class="token boolean">True</span>            <span class="token punctuation">)</span>        <span class="token punctuation">)</span><span class="token comment"># NumberPlane</span><span class="token comment"># 注意这里的步长是指数轴的数量</span>number_plane <span class="token operator">=</span> NumberPlane<span class="token punctuation">(</span>            x_range<span class="token operator">=</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>            y_range<span class="token operator">=</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>            background_line_style<span class="token operator">=</span><span class="token punctuation">{</span>                <span class="token string">"stroke_color"</span><span class="token punctuation">:</span> TEAL<span class="token punctuation">,</span>                <span class="token string">"stroke_width"</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>                <span class="token string">"stroke_opacity"</span><span class="token punctuation">:</span> <span class="token number">0.6</span>            <span class="token punctuation">}</span>        <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="方程"><a href="#方程" class="headerlink" title="方程"></a>方程</h3><p>使用 <code>ParametricFunction</code> 可以显示函数</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 单变量方程，返回三维 ndarray</span><span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">return</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>sin<span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> t<span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>sin<span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> t<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">construct</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>    func <span class="token operator">=</span> ParametricFunction<span class="token punctuation">(</span>self<span class="token punctuation">.</span>func<span class="token punctuation">,</span> t_range <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> TAU<span class="token punctuation">]</span><span class="token punctuation">.</span>set_color<span class="token punctuation">(</span>RED<span class="token punctuation">)</span>    self<span class="token punctuation">.</span>add<span class="token punctuation">(</span>func<span class="token punctuation">.</span>scale<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="More"><a href="#More" class="headerlink" title="More"></a>More</h2><p>ManimCE 文档有一个 <a href="https://docs.manim.community/en/stable/reference.html">reference manual</a>，官方描述这个手册的功能：</p><blockquote><p>This reference manual details modules, functions, and variables included in Manim, describing what they are and what they do. </p></blockquote><p>里面包含了各种模块和函数，更多的 <code>VMobject</code> 和更多的动画操作，文档中还有 <a href="https://docs.manim.community/en/stable/examples.html">Example Gallery</a> 提供参考</p>]]></content>
      
      
      <categories>
          
          <category> 编程 </category>
          
          <category> Manim </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 教程 </tag>
            
            <tag> Manim </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Pytorch tutorial</title>
      <link href="/archives/6c437432.html"/>
      <url>/archives/6c437432.html</url>
      
        <content type="html"><![CDATA[<h1 id="Pytorch-Tutorial"><a href="#Pytorch-Tutorial" class="headerlink" title="Pytorch Tutorial"></a>Pytorch Tutorial</h1><p><a href="https://pytorch.org/tutorials/">官方 tutorial</a> <a href="https://pytorch.org/tutorials/beginner/ptcheat.html#">官方 Cheat Sheet</a></p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><p>这部分可以看到整个 pytorch 的 workflow</p><ol><li><p>Working with Data</p><p>pytorch 提供一些小的数据集用于训练和测试。对于计算机视觉领域的模块 <code>TorchVision</code> 包含了一些常用数据集、模型和转换函数等等。装载数据集则使用 dataset, dataloader 类</p></li><li><p>Creating Models</p><p>继承 nn.Module 类，初始化相关模块，写好向前方程</p></li><li><p>Optimizing</p><p>定义损失函数，再使用反向传播算法进行优化</p></li><li><p>Saving &amp; Loading Models</p><p>保存模型，以及训练好的参数，方便之后测试和加载</p></li></ol><h2 id="Tensor"><a href="#Tensor" class="headerlink" title="Tensor"></a>Tensor</h2><blockquote><p>Tensors are similar to <a href="https://numpy.org/">NumPy’s</a> ndarrays, except that tensors can run on GPUs or other hardware accelerators. In fact, tensors and NumPy arrays can often share the same underlying memory, eliminating the need to copy data (see <a href="https://pytorch.org/tutorials/beginner/blitz/tensor_tutorial.html#bridge-to-np-label">Bridge with NumPy</a>). Tensors are also optimized for automatic differentiation</p></blockquote><p>从以上的描述来看 Tensor 数据类型有两个特点：</p><ol><li>能够在 GPU 上进行计算</li><li>能够自动微分</li></ol><p>如果熟悉 Numpy 的话，学习 Tensor 将会变得更加轻松。计划分为三个部分学习 Tensor：</p><ol><li>创建 Tensor</li><li>Tensor 的属性</li><li>Tensor 内置方法</li></ol><h3 id="创建-Tensor"><a href="#创建-Tensor" class="headerlink" title="创建 Tensor"></a>创建 Tensor</h3><p>参考 Cheat Sheet </p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> torch <span class="token keyword">import</span> numpy <span class="token keyword">as</span> npx <span class="token operator">=</span> torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token operator">*</span>size<span class="token punctuation">)</span>              <span class="token comment"># tensor with independent N(0,1) entries</span>x <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token punctuation">[</span>ones<span class="token operator">|</span>zeros<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">*</span>size<span class="token punctuation">)</span>       <span class="token comment"># tensor with all 1's [or 0's]</span>x <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>L<span class="token punctuation">)</span>                 <span class="token comment"># create tensor from [nested] list or ndarray L</span>y <span class="token operator">=</span> x<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span>                       <span class="token comment"># clone of x</span><span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>               <span class="token comment"># code wrap that stops autograd from tracking tensor history</span>requires_grad<span class="token operator">=</span><span class="token boolean">True</span>                  <span class="token comment"># arg, when set to True, tracks computation</span>                                    <span class="token comment"># history for future derivative calculations</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>创建 tensor 和创建 ndarray 是相似的。既可以生成指定分布的 tensor，也可以从 ndarray 中创建。由于 tensor 和 ndarray 关系密切，它们之间的转换也是很方便的。同时 tensor 和 numpy 也是共用内存的</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># tensor 转化为 ndarray</span>x <span class="token operator">=</span> torch<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>n <span class="token operator">=</span> x<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>n<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token comment"># 该操作会改变 x</span><span class="token comment"># ndarray 转化为 tensor</span>n <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span>x <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Tensor-的属性"><a href="#Tensor-的属性" class="headerlink" title="Tensor 的属性"></a>Tensor 的属性</h3><p>主要用3个属性：shape, dtype, deviece</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">tensor <span class="token operator">=</span> torch<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token comment"># f"string" 代表格式化，类似 str.format()</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Shape of tensor: </span><span class="token interpolation"><span class="token punctuation">{</span>tensor<span class="token punctuation">.</span>shape<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Datatype of tensor: </span><span class="token interpolation"><span class="token punctuation">{</span>tensor<span class="token punctuation">.</span>dtype<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Device tensor is stored on: </span><span class="token interpolation"><span class="token punctuation">{</span>tensor<span class="token punctuation">.</span>device<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Tensor-内置方法"><a href="#Tensor-内置方法" class="headerlink" title="Tensor 内置方法"></a>Tensor 内置方法</h3><blockquote><p>Over 100 tensor operations, including arithmetic, linear algebra, matrix manipulation (transposing, indexing, slicing), sampling and more are comprehensively described <a href="https://pytorch.org/docs/stable/torch.html">here</a>.</p></blockquote><p>还是分模块来接招这些内置方法</p><h4 id="Standard-numpy-like-indexing-and-slicing"><a href="#Standard-numpy-like-indexing-and-slicing" class="headerlink" title="Standard numpy-like indexing and slicing"></a>Standard numpy-like indexing and slicing</h4><p>tensor 的索引和 ndarray 的索引是相同的，包括多元索引、布尔索引、花式索引，参考整理的 numpy cheat sheet</p><h4 id="Move-tensors-to-GPU"><a href="#Move-tensors-to-GPU" class="headerlink" title="Move tensors to GPU"></a>Move tensors to GPU</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># We move our tensor to the GPU if available</span><span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    tensor <span class="token operator">=</span> tensor<span class="token punctuation">.</span>to<span class="token punctuation">(</span><span class="token string">'cuda'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h4 id="Dimensionality"><a href="#Dimensionality" class="headerlink" title="Dimensionality"></a>Dimensionality</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python">x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span>                                  <span class="token comment"># return tuple-like object of dimensions</span>x <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>tensor_seq<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>          <span class="token comment"># concatenates tensors along dim</span>y <span class="token operator">=</span> x<span class="token punctuation">.</span>view<span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>                       <span class="token comment"># reshapes x into size (a,b,...)</span>y <span class="token operator">=</span> x<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>a<span class="token punctuation">)</span>                          <span class="token comment"># reshapes x into size (b,a) for some b</span>y <span class="token operator">=</span> x<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span>                      <span class="token comment"># swaps dimensions a and b</span>y <span class="token operator">=</span> x<span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token operator">*</span>dims<span class="token punctuation">)</span>                      <span class="token comment"># permutes dimensions</span>y <span class="token operator">=</span> x<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span>dim<span class="token punctuation">)</span>                      <span class="token comment"># tensor with added axis</span>y <span class="token operator">=</span> x<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>                    <span class="token comment"># (a,b,c) tensor -&gt; (a,b,1,c) tensor</span>y <span class="token operator">=</span> x<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token punctuation">)</span>                           <span class="token comment"># removes all dimensions of size 1 (a,1,b,1) -&gt; (a,b)</span>y <span class="token operator">=</span> x<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>                      <span class="token comment"># removes specified dimension of size 1 (a,1,b,1) -&gt; (a,b,1)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="Algebra"><a href="#Algebra" class="headerlink" title="Algebra"></a>Algebra</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python">ret <span class="token operator">=</span> A<span class="token punctuation">.</span>mm<span class="token punctuation">(</span>B<span class="token punctuation">)</span>       <span class="token comment"># matrix multiplication</span>ret <span class="token operator">=</span> A<span class="token punctuation">.</span>mv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>       <span class="token comment"># matrix-vector multiplication</span>ret <span class="token operator">=</span> y<span class="token punctuation">.</span>dot<span class="token punctuation">(</span>x<span class="token punctuation">)</span>      <span class="token comment"># Computes the dot product of two 1D tensors</span>x <span class="token operator">=</span> x<span class="token punctuation">.</span>t<span class="token punctuation">(</span><span class="token punctuation">)</span>           <span class="token comment"># matrix transpose</span><span class="token comment"># This computes the element-wise product</span>z1 <span class="token operator">=</span> tensor_1 <span class="token operator">*</span> tensor_2<span class="token comment"># convert one element tensor to a Python numerical value</span>x<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="GPU-Usage"><a href="#GPU-Usage" class="headerlink" title="GPU Usage"></a>GPU Usage</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python">torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token comment"># check for cuda</span>x <span class="token operator">=</span> x<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># move x's data from CPU to GPU and return new object</span>x <span class="token operator">=</span> x<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># move x's data from GPU to CPU and return new object</span><span class="token keyword">if</span> <span class="token keyword">not</span> args<span class="token punctuation">.</span>disable_cuda <span class="token keyword">and</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>     <span class="token comment"># device agnostic code and modularity</span>    args<span class="token punctuation">.</span>device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">'cuda'</span><span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>                                                           args<span class="token punctuation">.</span>device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">'cpu'</span><span class="token punctuation">)</span>                       net<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token comment"># recursively convert their parameters and buffers to device specific tensors</span>x <span class="token operator">=</span> x<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token comment"># copy your tensors to a device (gpu, cpu)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Datasets-amp-DataLoader"><a href="#Datasets-amp-DataLoader" class="headerlink" title="Datasets &amp; DataLoader"></a>Datasets &amp; DataLoader</h2><blockquote><p>Code for processing data samples can get messy and hard to maintain; we ideally want our dataset code to be decoupled from our model training code for better readability and modularity. PyTorch provides two data primitives: <code>torch.utils.data.DataLoader</code> and <code>torch.utils.data.Dataset</code> that allow you to use pre-loaded datasets as well as your own data. </p></blockquote><p>Dataset 类存储了数据集的路径，并且定义了 <code>__getitem__</code> 方法来获取单个数据集及其对应标签。而 DataLoder 则将数据集打包形成一个可迭代对象，方便不同方式的遍历</p><h3 id="载入-torchvision-中的数据集"><a href="#载入-torchvision-中的数据集" class="headerlink" title="载入 torchvision 中的数据集"></a>载入 torchvision 中的数据集</h3><p>先介绍如何从 <code>torchvision</code> 中载入官方数据集 <code>Fashion-MNIST</code></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> torchvision <span class="token keyword">import</span> datasets<span class="token keyword">from</span> torchvision<span class="token punctuation">.</span>transforms <span class="token keyword">import</span> ToTensortraining_data <span class="token operator">=</span> datasets<span class="token punctuation">.</span>FashionMNIST<span class="token punctuation">(</span>    root<span class="token operator">=</span><span class="token string">"data"</span><span class="token punctuation">,</span>    train<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>    download<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>    transform<span class="token operator">=</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>test_data <span class="token operator">=</span> datasets<span class="token punctuation">.</span>FashionMNIST<span class="token punctuation">(</span>    root<span class="token operator">=</span><span class="token string">"data"</span><span class="token punctuation">,</span>    train<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>    download<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>    transform<span class="token operator">=</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>参数的说明如下：</p><ul><li><code>root</code> is the path where the train/test data is stored,</li><li><code>train</code> specifies training or test dataset,</li><li><code>download=True</code> downloads the data from the internet if it’s not available at <code>root</code>.</li><li><code>transform</code> and <code>target_transform</code> specify the feature and label transformations</li></ul><p>用 <code>matplotlib</code> 来展示数据集中的部分图像，看能不能正常工作</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> pltlabels_map <span class="token operator">=</span> <span class="token punctuation">{</span>    <span class="token number">0</span><span class="token punctuation">:</span> <span class="token string">"T-Shirt"</span><span class="token punctuation">,</span>    <span class="token number">1</span><span class="token punctuation">:</span> <span class="token string">"Trouser"</span><span class="token punctuation">,</span>    <span class="token number">2</span><span class="token punctuation">:</span> <span class="token string">"Pullover"</span><span class="token punctuation">,</span>    <span class="token number">3</span><span class="token punctuation">:</span> <span class="token string">"Dress"</span><span class="token punctuation">,</span>    <span class="token number">4</span><span class="token punctuation">:</span> <span class="token string">"Coat"</span><span class="token punctuation">,</span>    <span class="token number">5</span><span class="token punctuation">:</span> <span class="token string">"Sandal"</span><span class="token punctuation">,</span>    <span class="token number">6</span><span class="token punctuation">:</span> <span class="token string">"Shirt"</span><span class="token punctuation">,</span>    <span class="token number">7</span><span class="token punctuation">:</span> <span class="token string">"Sneaker"</span><span class="token punctuation">,</span>    <span class="token number">8</span><span class="token punctuation">:</span> <span class="token string">"Bag"</span><span class="token punctuation">,</span>    <span class="token number">9</span><span class="token punctuation">:</span> <span class="token string">"Ankle Boot"</span><span class="token punctuation">,</span><span class="token punctuation">}</span>figure <span class="token operator">=</span> plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>cols<span class="token punctuation">,</span> rows <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> cols <span class="token operator">*</span> rows <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    sample_idx <span class="token operator">=</span> torch<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>training_data<span class="token punctuation">)</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>    img<span class="token punctuation">,</span> label <span class="token operator">=</span> training_data<span class="token punctuation">[</span>sample_idx<span class="token punctuation">]</span>    figure<span class="token punctuation">.</span>add_subplot<span class="token punctuation">(</span>rows<span class="token punctuation">,</span> cols<span class="token punctuation">,</span> i<span class="token punctuation">)</span>    plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span>labels_map<span class="token punctuation">[</span>label<span class="token punctuation">]</span><span class="token punctuation">)</span>    plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">"off"</span><span class="token punctuation">)</span>    plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>img<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cmap<span class="token operator">=</span><span class="token string">"gray"</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>结果形如下面的图片</p><p><img src="/archives/6c437432/sphx_glr_data_tutorial_001.png" style="zoom: 50%;"></p><h3 id="载入自定义数据集"><a href="#载入自定义数据集" class="headerlink" title="载入自定义数据集"></a>载入自定义数据集</h3><blockquote><p>A custom Dataset class must implement three functions: <code>__init__</code>, <code>__len__</code>, and <code>__getitem__</code>. </p></blockquote><ol><li><p><code>__init__</code></p><p>初始化包含图像、注释文件的目录，以及对数据集的 transform </p></li><li><p><code>__len__</code></p><p>返回数据集样本个数</p></li><li><p><code>__getitem__</code></p><p>该函数返回数据集中索引为 idx 的样本及其对应标签</p></li></ol><p>下面通过一段代码来具体看看这些函数的实现</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> os<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd<span class="token keyword">from</span> torchvision<span class="token punctuation">.</span>io <span class="token keyword">import</span> read_image<span class="token keyword">class</span> <span class="token class-name">CustomImageDataset</span><span class="token punctuation">(</span>Dataset<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> annotations_file<span class="token punctuation">,</span> img_dir<span class="token punctuation">,</span> transform<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> target_transform<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>img_labels <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>annotations_file<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>img_dir <span class="token operator">=</span> img_dir        self<span class="token punctuation">.</span>transform <span class="token operator">=</span> transform        self<span class="token punctuation">.</span>target_transform <span class="token operator">=</span> target_transform    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>img_labels<span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">:</span>        img_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>img_dir<span class="token punctuation">,</span> self<span class="token punctuation">.</span>img_labels<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>idx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        image <span class="token operator">=</span> read_image<span class="token punctuation">(</span>img_path<span class="token punctuation">)</span>        label <span class="token operator">=</span> self<span class="token punctuation">.</span>img_labels<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>idx<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>        <span class="token keyword">if</span> self<span class="token punctuation">.</span>transform<span class="token punctuation">:</span>            image <span class="token operator">=</span> self<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>image<span class="token punctuation">)</span>        <span class="token keyword">if</span> self<span class="token punctuation">.</span>target_transform<span class="token punctuation">:</span>            label <span class="token operator">=</span> self<span class="token punctuation">.</span>target_transform<span class="token punctuation">(</span>label<span class="token punctuation">)</span>        <span class="token keyword">return</span> image<span class="token punctuation">,</span> label<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看出主要思路就是继承原 <code>Dataset</code> 类，然后改写了上面提到的三个方法，这也体现了面向对象的多态性</p><h3 id="Transforms"><a href="#Transforms" class="headerlink" title="Transforms"></a>Transforms</h3><blockquote><p> We use <strong>transforms</strong> to perform some manipulation of the data and make it suitable for training. The <a href="https://pytorch.org/vision/stable/transforms.html">torchvision.transforms</a> module offers several commonly-used transforms out of the box.</p></blockquote><p>数据增强是提升表现的常用手段，可以通过对数据集进行 transform 完成。文档举了两个非常简单的 transform 例子，更多的应用还是需要结合具体论文具体实践：</p><ol><li><a href="https://pytorch.org/vision/stable/transforms.html#torchvision.transforms.ToTensor">ToTensor</a> converts a PIL image or NumPy <code>ndarray</code> into a <code>FloatTensor</code>. and scales the image’s pixel intensity values in the range [0., 1.]</li><li>Lambda transforms apply any user-defined lambda function. Here, we define a function to turn the integer into a one-hot encoded tensor. </li></ol><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> torch<span class="token keyword">from</span> torchvision <span class="token keyword">import</span> datasets<span class="token keyword">from</span> torchvision<span class="token punctuation">.</span>transforms <span class="token keyword">import</span> ToTensor<span class="token punctuation">,</span> Lambdads <span class="token operator">=</span> datasets<span class="token punctuation">.</span>FashionMNIST<span class="token punctuation">(</span>    root<span class="token operator">=</span><span class="token string">"data"</span><span class="token punctuation">,</span>    train<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>    download<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>    transform<span class="token operator">=</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    target_transform<span class="token operator">=</span>Lambda<span class="token punctuation">(</span><span class="token keyword">lambda</span> y<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">.</span>scatter_<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="使用-DataLoader-进行迭代"><a href="#使用-DataLoader-进行迭代" class="headerlink" title="使用 DataLoader 进行迭代"></a>使用 DataLoader 进行迭代</h3><p>将 dataset 传入 DataLoader 当中，形成可迭代对象</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">import</span> DataLoadertrain_dataloader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>training_data<span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>如果需要更复杂的取样，则需要 <a href="https://pytorch.org/docs/stable/data.html#data-loading-order-and-sampler">Samplers</a>，下面举一个 sampler 的子类进行说明</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>sampler <span class="token keyword">import</span> SubsetRandomSamplerNUM_TRAIN <span class="token operator">=</span> <span class="token number">5000</span>sampler <span class="token operator">=</span> SubsetRandomSampler<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span>NUM_TRAIN<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># 仅采样前 5000 个样本作为训练集</span>train_dataloader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>training_data<span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> sampler<span class="token operator">=</span>sampler<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在创建好 dataloader 实例过后，由于其是迭代器对象，以通过循环进行迭代。迭代器返回对象为一个元组，元组成员为数据集列表和其对应的标签列表。下面用 <code>next &amp; iter</code> 查看迭代器返回的第一个对象</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">train_features<span class="token punctuation">,</span> train_labels <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span><span class="token builtin">iter</span><span class="token punctuation">(</span>train_dataloader<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Feature batch shape: </span><span class="token interpolation"><span class="token punctuation">{</span>train_features<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Labels batch shape: </span><span class="token interpolation"><span class="token punctuation">{</span>train_labels<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>img <span class="token operator">=</span> train_features<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token punctuation">)</span>label <span class="token operator">=</span> train_labels<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>img<span class="token punctuation">,</span> cmap<span class="token operator">=</span><span class="token string">"gray"</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Label: </span><span class="token interpolation"><span class="token punctuation">{</span>label<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token comment"># Output</span><span class="token comment"># Feature batch shape: torch.Size([64, 1, 28, 28])</span><span class="token comment"># Labels batch shape: torch.Size([64])</span><span class="token comment"># Label: 9</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/archives/6c437432/sphx_glr_data_tutorial_002.png" style="zoom:72%;"></p><h2 id="Build-Models"><a href="#Build-Models" class="headerlink" title="Build Models"></a>Build Models</h2><blockquote><p>Neural networks comprise of layers/modules that perform operations on data. The <a href="https://pytorch.org/docs/stable/nn.html">torch.nn</a> namespace provides all the building blocks you need to build your own neural network. </p><p>Every module in PyTorch subclasses the <a href="https://pytorch.org/docs/stable/generated/torch.nn.Module.html">nn.Module</a>. A neural network is a module itself that consists of other modules (layers). This nested structure allows for building and managing complex architectures easily.</p></blockquote><p>建造网络模型的逻辑主要为：</p><ol><li>继承 <code>nn.Module</code> 类，这是所有网络的基类。让自定义的模型能够使用基类的方法，便于管理模型框架，例如：执行向前路径、管理模型参数及梯度、打印模型模块、模型嵌套等等</li><li>重写 <code>__init__</code> 方法，在方法中定义需要的模块</li><li>重写 <code>forward</code> 方法，在方法中定义向前计算的路径</li></ol><p>下面举一个简单的神经网络为例，看看具体实现</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> torch<span class="token keyword">from</span> torch <span class="token keyword">import</span> nndevice <span class="token operator">=</span> <span class="token string">'cuda'</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">'cpu'</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Using {} device'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># 定义网络模型</span><span class="token keyword">class</span> <span class="token class-name">NeuralNetwork</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>flatten <span class="token operator">=</span> nn<span class="token punctuation">.</span>Flatten<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>linear_relu_stack <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">28</span><span class="token operator">*</span><span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>        x <span class="token operator">=</span> self<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span>x<span class="token punctuation">)</span>         x <span class="token operator">=</span> self<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span>x<span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>        logits <span class="token operator">=</span> self<span class="token punctuation">.</span>linear_relu_stack<span class="token punctuation">(</span>x<span class="token punctuation">)</span>        <span class="token keyword">return</span> logits<span class="token comment"># 将模型放到 GPU 上 </span>model <span class="token operator">=</span> NeuralNetwork<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token comment"># 打印模型模块</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Model structure: "</span><span class="token punctuation">,</span> model<span class="token punctuation">,</span> <span class="token string">"\n\n"</span><span class="token punctuation">)</span><span class="token keyword">for</span> name<span class="token punctuation">,</span> param <span class="token keyword">in</span> model<span class="token punctuation">.</span>named_parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Layer: </span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string"> | Size: </span><span class="token interpolation"><span class="token punctuation">{</span>param<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> | Values : </span><span class="token interpolation"><span class="token punctuation">{</span>param<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token format-spec">2]</span><span class="token punctuation">}</span></span><span class="token string"> \n"</span></span><span class="token punctuation">)</span><span class="token comment"># 简单测试</span>X <span class="token operator">=</span> torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>logits <span class="token operator">=</span> model<span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'logits: </span><span class="token interpolation"><span class="token punctuation">{</span>logits<span class="token punctuation">.</span>shape<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>pred_probab <span class="token operator">=</span> nn<span class="token punctuation">.</span>Softmax<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span>logits<span class="token punctuation">)</span>y_pred <span class="token operator">=</span> pred_probab<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Predicted class: </span><span class="token interpolation"><span class="token punctuation">{</span>y_pred<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其中一些模块的功能就不再这里里描述了，例如：<code>nn.Sequential, nn.Flatten</code>，请直接参考 <a href="https://pytorch.org/tutorials/beginner/basics/buildmodel_tutorial.html#build-the-neural-network">文档</a></p><h2 id="Automatic-Differentiation"><a href="#Automatic-Differentiation" class="headerlink" title="Automatic Differentiation"></a>Automatic Differentiation</h2><blockquote><p>To compute those gradients, PyTorch has a built-in differentiation engine called <code>torch.autograd</code>. It supports automatic computation of gradient for any computational graph.</p></blockquote><p>实际上在自己写代码时，并没有显式地调用 <code>torch.autograd</code>，这个模块更多地是做背后功臣。在了解自动微分之前，需要了解如何使用反向传播算法来系统地计算参数的梯度。反向传播算法的核心就在于：通过计算图和向前计算时存储的中间结果，从 root (根节点) 计算到 leaf (叶节点)，反向逐层得到各个节点的梯度。了解反向传播算法，官方文档也推荐了 <a href="https://www.bilibili.com/video/BV16x411V7Qg?from=search&amp;seid=15593528008565591695&amp;spm_id_from=333.337.0.0">3Blue1Brown 视频</a>，3b1b nb！</p><h3 id="自动微分"><a href="#自动微分" class="headerlink" title="自动微分"></a>自动微分</h3><p>下面举一个例子来实现简单的自动微分</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> torch<span class="token comment"># 使用随机种子</span>torch<span class="token punctuation">.</span>manual_seed<span class="token punctuation">(</span><span class="token number">1998</span><span class="token punctuation">)</span>x <span class="token operator">=</span> torch<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>  <span class="token comment"># input tensor</span>y <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>  <span class="token comment"># expected output</span>w <span class="token operator">=</span> torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> requires_grad<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>b <span class="token operator">=</span> torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> requires_grad<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>z <span class="token operator">=</span> torch<span class="token punctuation">.</span>matmul<span class="token punctuation">(</span>x<span class="token punctuation">,</span> w<span class="token punctuation">)</span><span class="token operator">+</span>bloss <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional<span class="token punctuation">.</span>binary_cross_entropy_with_logits<span class="token punctuation">(</span>z<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以上构建了一个简单的计算流程，将需要计算的梯度的参数设为 <code>requires_grad=True</code>，或者用 <code>x.requires_grad_(True)</code>，说明一下：方法名后缀带下划线 <code>_</code> 则代表该方法为 <code>in place</code> 方法，会直接修改变量 </p><p>用公式来表示以上的计算过程</p><script type="math/tex; mode=display">z = x * w + b \\loss = -\frac{1}{N}\sum{y_i*ln(\sigma(z_i)) + (1-y_i)*ln(1 - \sigma(z_i))}</script><p>用计算图表示以上的计算过程</p><p><img src="/archives/6c437432/comp-graph.png" style="zoom: 50%;"></p><p>可以看到 tensor 在计算过程中在不断生成计算图</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token comment"># tensor([1., 1., 1., 1., 1.])</span><span class="token keyword">print</span><span class="token punctuation">(</span>z<span class="token punctuation">)</span><span class="token comment"># tensor([-2.9086,  0.8690,  1.4758], grad_fn=&lt;AddBackward0&gt;)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>因为 z 是计算得到的 tensor，可以看到其中还包含一个 <code>grad_fn</code>，这是 pytorch 中 <code>Function</code> 类的一个对象，可以把其看作计算图的具体实现。接下来只需要一行代码，就可以计算计算图中所有需要的梯度</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>grad<span class="token punctuation">)</span><span class="token comment"># tensor([0.0172, 0.2348, 0.2713])</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><strong>注意事项：</strong></p><ol><li><p>每个计算图只能计算一次，之后所有的中间结果将会被清除，但可以使用 <code>loss.backward(retain_graph=True)</code> 保留中间结果，举个简单例子说明（以下例子均沿用之前自动微分例子中的变量）</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 第一次 loss 反向传播计算梯度</span>loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># 基于 loss 创建一个新的 loss_2</span>loss_2  <span class="token operator">=</span> loss <span class="token operator">**</span> <span class="token number">2</span>loss_2<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># 在第二次反向传播计算中，显然会重新进行第一次的反向传播的计算流程</span><span class="token comment"># RuntimeError: Trying to backward through the graph a second time, but the buffers have already been freed. Specify retain_graph=True when calling backward the first time.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>一般只对标量进行 <code>backward</code> 操作。对矢量进行 <code>backward</code> 操作，即对矢量进行求导，会得到雅可比矩阵</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># w.shape=(5, 3) w.requires_grad=True</span>z <span class="token operator">=</span> w <span class="token operator">**</span> <span class="token number">2</span>z<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># RuntimeError: grad can be implicitly created only for scalar outputs</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>对于中间变量（即非叶节点变量），由于在反向传播时需要计算其梯度，在自动微分时会标记其 <code>requires_grad=True</code>，但一般在反向传播计算完成之后，不保留这些中间结果的梯度，如需要则要调用方法 <code>x.retain_grad()</code></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># z.retain_grad()</span>loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>z<span class="token punctuation">.</span>grad<span class="token punctuation">)</span><span class="token comment"># warnings.warn("The .grad attribute of a Tensor that is not a leaf Tensor is being accessed. Its .grad "</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li></ol><h3 id="禁用自动微分"><a href="#禁用自动微分" class="headerlink" title="禁用自动微分"></a>禁用自动微分</h3><p>禁用自动微分主要应用在两个场景：</p><ol><li>Freeze parameters，将参数从计算图中剔除，gradient flow 不会经过该参数</li><li>仅计算向前路径，不跟踪所有梯度，加快计算</li></ol><p>针对以上的场景，有两种方法能够禁用自动微分：</p><ol><li><code>x.detach_()</code>：将 x 变量 <code>requires_grad=False</code></li><li><code>with torch.no_grad()</code>：在该模块内的所有运算，都不会跟踪计算图，即所有变量 <code>requires_grad=False</code></li></ol><p>下面仅对 <code>detach</code> 方法进行重点说明</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># detach</span><span class="token keyword">import</span> torchmode <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'no_detach'</span><span class="token punctuation">,</span> <span class="token string">'detach'</span><span class="token punctuation">]</span><span class="token keyword">for</span> mode_ <span class="token keyword">in</span> mode<span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'MODE: </span><span class="token interpolation"><span class="token punctuation">{</span>mode_<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>    x <span class="token operator">=</span> torch<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> requires_grad<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    y <span class="token operator">=</span> x <span class="token operator">**</span> <span class="token number">2</span>    z <span class="token operator">=</span> x <span class="token operator">**</span> <span class="token number">3</span>    <span class="token keyword">if</span> mode_ <span class="token operator">==</span> <span class="token string">'detach'</span><span class="token punctuation">:</span>        z<span class="token punctuation">.</span>detach_<span class="token punctuation">(</span><span class="token punctuation">)</span>    loss <span class="token operator">=</span> <span class="token punctuation">(</span>y<span class="token operator">+</span>z<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'parameter z:\n</span><span class="token interpolation"><span class="token punctuation">{</span>z<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>    loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'x_grad:\n</span><span class="token interpolation"><span class="token punctuation">{</span>x<span class="token punctuation">.</span>grad<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">,</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token triple-quoted-string string">''' resultMODE: no_detachparameter z:tensor([1., 1., 1., 1., 1., 1., 1., 1., 1., 1.], grad_fn=&lt;PowBackward0&gt;)x_grad:tensor([5., 5., 5., 5., 5., 5., 5., 5., 5., 5.]) MODE: detachparameter z:tensor([1., 1., 1., 1., 1., 1., 1., 1., 1., 1.])x_grad:tensor([2., 2., 2., 2., 2., 2., 2., 2., 2., 2.])  '''</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到将 b 节点从计算图中剔除之后，x 的梯度减少了，因为 gradient flow 不从 b 节点流过，前后计算图如下</p><p><img src="/archives/6c437432/attached.png" alt="attached graph" style="zoom: 67%;"></p><p><img src="/archives/6c437432/detached.png" alt="detached graph" style="zoom:67%;"></p><p>值得注意的是在计算图建立之后，对变量进行 detach 并不会影响反向传播</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> torchx <span class="token operator">=</span> torch<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> requires_grad<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>y <span class="token operator">=</span> x <span class="token operator">**</span> <span class="token number">2</span>z <span class="token operator">=</span> x <span class="token operator">**</span> <span class="token number">3</span>loss <span class="token operator">=</span> <span class="token punctuation">(</span>y<span class="token operator">+</span>z<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'parameter z:\n</span><span class="token interpolation"><span class="token punctuation">{</span>z<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span><span class="token comment"># tensor([1., 1., 1., 1., 1., 1., 1., 1., 1., 1.], grad_fn=&lt;PowBackward0&gt;)</span>z<span class="token punctuation">.</span>detach_<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'parameter z_detached:\n</span><span class="token interpolation"><span class="token punctuation">{</span>z<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span><span class="token comment">#tensor([1., 1., 1., 1., 1., 1., 1., 1., 1., 1.])</span>loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'x_grad:\n</span><span class="token interpolation"><span class="token punctuation">{</span>x<span class="token punctuation">.</span>grad<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">,</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token comment"># tensor([5., 5., 5., 5., 5., 5., 5., 5., 5., 5.]) </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这是为什么呢？我的理解是计算图在构建完成之后，仅进行 detach 不会对已经生成的计算图进行修改，且 tensor 本身的值没有发生改，计算图就可以使用该值进行梯度计算。而之前的 for 循环每一次循环都重新创建了计算图</p><h2 id="Optimization"><a href="#Optimization" class="headerlink" title="Optimization"></a>Optimization</h2><p>这里将是整个深度学习耗时最长的部分，需要将之前的数据集送入到模型之中，使用优化算法改进模型。这一部分沿用之前的 <code>Fashion-MNIST</code> 数据集和神经网络，完整代码参考 <a href="https://pytorch.org/tutorials/beginner/basics/optimization_tutorial.html#prerequisite-codehttps://pytorch.org/tutorials/beginner/basics/optimization_tutorial.html#prerequisite-code">prerequisite code</a></p><h3 id="优化循环"><a href="#优化循环" class="headerlink" title="优化循环"></a>优化循环</h3><p>在整个循环过程中，除了之前提到的数据集和模型，还有两个重要元素：损失函数和优化器。Pytorch 中的损失函数在 <code>nn</code> 模块下，优化器在 <code>optim</code> 模块下</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn<span class="token keyword">import</span> torch<span class="token punctuation">.</span>optim <span class="token keyword">as</span> optimloss_fn <span class="token operator">=</span> nn<span class="token punctuation">.</span>X<span class="token punctuation">(</span><span class="token punctuation">)</span>                            <span class="token comment"># where X is L1Loss, MSELoss, CrossEntropyLoss...</span>opt <span class="token operator">=</span> optim<span class="token punctuation">.</span>X<span class="token punctuation">(</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>      <span class="token comment"># where X is SGD, Adadelta, Adagrad, Adam...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>整体的优化逻辑分为两步，首先使用反向传播算法计算出参数的梯度，然后根据这些梯度采用不同的优化算法进行迭代优化 <code>opt.step()</code> 。下面的代码实现了 <code>train_loop</code> 和 <code>teat_loop</code> 分别实现训练和测试模型</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">train_loop</span><span class="token punctuation">(</span>dataloader<span class="token punctuation">,</span> model<span class="token punctuation">,</span> loss_fn<span class="token punctuation">,</span> optimizer<span class="token punctuation">)</span><span class="token punctuation">:</span>    size <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>dataloader<span class="token punctuation">.</span>dataset<span class="token punctuation">)</span>    <span class="token keyword">for</span> batch<span class="token punctuation">,</span> <span class="token punctuation">(</span>X<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>dataloader<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># Compute prediction and loss</span>        pred <span class="token operator">=</span> model<span class="token punctuation">(</span>X<span class="token punctuation">)</span>        loss <span class="token operator">=</span> loss_fn<span class="token punctuation">(</span>pred<span class="token punctuation">,</span> y<span class="token punctuation">)</span>        <span class="token comment"># Backpropagation</span>        optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>        loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>        optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> batch <span class="token operator">%</span> <span class="token number">100</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>            loss<span class="token punctuation">,</span> current <span class="token operator">=</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> batch <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>X<span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"loss: </span><span class="token interpolation"><span class="token punctuation">{</span>loss<span class="token punctuation">:</span><span class="token format-spec">&gt;7f</span><span class="token punctuation">}</span></span><span class="token string">  [</span><span class="token interpolation"><span class="token punctuation">{</span>current<span class="token punctuation">:</span><span class="token format-spec">&gt;5d</span><span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{</span>size<span class="token punctuation">:</span><span class="token format-spec">&gt;5d</span><span class="token punctuation">}</span></span><span class="token string">]"</span></span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">test_loop</span><span class="token punctuation">(</span>dataloader<span class="token punctuation">,</span> model<span class="token punctuation">,</span> loss_fn<span class="token punctuation">)</span><span class="token punctuation">:</span>    size <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>dataloader<span class="token punctuation">.</span>dataset<span class="token punctuation">)</span>    num_batches <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>dataloader<span class="token punctuation">)</span>    test_loss<span class="token punctuation">,</span> correct <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>    <span class="token comment"># Will not build computational graph</span>    <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">for</span> X<span class="token punctuation">,</span> y <span class="token keyword">in</span> dataloader<span class="token punctuation">:</span>            pred <span class="token operator">=</span> model<span class="token punctuation">(</span>X<span class="token punctuation">)</span>            test_loss <span class="token operator">+=</span> loss_fn<span class="token punctuation">(</span>pred<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>            correct <span class="token operator">+=</span> <span class="token punctuation">(</span>pred<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> y<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>    test_loss <span class="token operator">/=</span> num_batches    correct <span class="token operator">/=</span> size    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Test Error: \n Accuracy: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">*</span>correct<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token format-spec">&gt;0.1f</span><span class="token punctuation">}</span></span><span class="token string">%, Avg loss: </span><span class="token interpolation"><span class="token punctuation">{</span>test_loss<span class="token punctuation">:</span><span class="token format-spec">&gt;8f</span><span class="token punctuation">}</span></span><span class="token string"> \n"</span></span><span class="token punctuation">)</span>model <span class="token operator">=</span> NeuralNetwork<span class="token punctuation">(</span><span class="token punctuation">)</span>    loss_fn <span class="token operator">=</span> nn<span class="token punctuation">.</span>CrossEntropyLoss<span class="token punctuation">(</span><span class="token punctuation">)</span>learning_rate <span class="token operator">=</span> <span class="token number">1e</span><span class="token operator">-</span><span class="token number">3</span>optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>SGD<span class="token punctuation">(</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>learning_rate<span class="token punctuation">)</span>epochs <span class="token operator">=</span> <span class="token number">10</span><span class="token keyword">for</span> t <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Epoch </span><span class="token interpolation"><span class="token punctuation">{</span>t<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">\n-------------------------------"</span></span><span class="token punctuation">)</span>    train_loop<span class="token punctuation">(</span>train_dataloader<span class="token punctuation">,</span> model<span class="token punctuation">,</span> loss_fn<span class="token punctuation">,</span> optimizer<span class="token punctuation">)</span>    test_loop<span class="token punctuation">(</span>test_dataloader<span class="token punctuation">,</span> model<span class="token punctuation">,</span> loss_fn<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Done!"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>最终结果也请直接查看 <a href="https://pytorch.org/tutorials/beginner/basics/optimization_tutorial.html#optimization-loop">optimization loop</a></p><h2 id="Save-and-Load-the-Model"><a href="#Save-and-Load-the-Model" class="headerlink" title="Save and Load the Model"></a>Save and Load the Model</h2><h3 id="保存模型参数"><a href="#保存模型参数" class="headerlink" title="保存模型参数"></a>保存模型参数</h3><p>模型的参数存储在其内部的一个字典当中，使用 <code>model.state_dict()</code> 方法可以返回该字典。使用 <code>torch.save</code> 方法即可存储</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> torch<span class="token keyword">import</span> torchvision<span class="token punctuation">.</span>models <span class="token keyword">as</span> modelsmodel <span class="token operator">=</span> models<span class="token punctuation">.</span>vgg16<span class="token punctuation">(</span>pretrained<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'model_weights.pth'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这样就将模型参数保存到当前文件夹下，如果需要加载模型参数，则必须要先创建一个模型实例</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">model <span class="token operator">=</span> models<span class="token punctuation">.</span>vgg16<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># we do not specify pretrained=True, i.e. do not load default weights</span>model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">'model_weights.pth'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong>注意：</strong>一定要在推理之前调用 <code>model.eval()</code> 方法，以将 dropout 和 batch_norm 层设置为评估模式。不这样做会产生不一致的推理结果</p><h3 id="保存模型参数及其结构"><a href="#保存模型参数及其结构" class="headerlink" title="保存模型参数及其结构"></a>保存模型参数及其结构</h3><p>如果想要同时保存其结构，则直接传入模型本身</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>model<span class="token punctuation">,</span> <span class="token string">'model.pth'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>加载模型虽然不需要先实例化模型，但仍需要有模型的定义</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># Model class must be defined somewhere</span>model <span class="token operator">=</span> torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">'model.pth'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="模型导出为-ONNX"><a href="#模型导出为-ONNX" class="headerlink" title="模型导出为 ONNX"></a>模型导出为 ONNX</h3><blockquote><p><strong>ONNX is an open format built to represent machine learning models.</strong> ONNX defines a common set of operators - the building blocks of machine learning and deep learning models - and a common file format to enable AI developers to use models with a variety of frameworks, tools, runtimes, and compilers.</p></blockquote><p>Pytorch 支持将模型转为 ONNX 格式，更多信息就不打算整理了 <a href="https://pytorch.org/tutorials/beginner/basics/saveloadrun_tutorial.html#exporting-model-to-onnx">Exporting Model to ONNX</a> <a href="https://github.com/onnx/tutorials">ONNX tutorial</a></p><h2 id="整体复习"><a href="#整体复习" class="headerlink" title="整体复习"></a>整体复习</h2><blockquote><p>Congratulations! You have completed the PyTorch beginner tutorial! Try <a href="https://pytorch.org/tutorials/beginner/basics/quickstart_tutorial.html">revisting the first page</a> to see the tutorial in its entirety again. We hope this tutorial has helped you get started with deep learning on PyTorch. Good luck!</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 编程 </category>
          
          <category> Pytorch </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 教程 </tag>
            
            <tag> Pytorch </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>这本书能让你睡好</title>
      <link href="/archives/dead6afd.html"/>
      <url>/archives/dead6afd.html</url>
      
        <content type="html"><![CDATA[<h1 id="这本书能让你睡好"><a href="#这本书能让你睡好" class="headerlink" title="这本书能让你睡好"></a>这本书能让你睡好</h1><p>总体来讲分为几个大方面：睡眠观念，睡眠和锻炼的时间，光线影响，饮食影响，温度影响，身心放松技巧</p><h2 id="第一章-了解睡眠的价值（观念）"><a href="#第一章-了解睡眠的价值（观念）" class="headerlink" title="第一章 了解睡眠的价值（观念）"></a>第一章 了解睡眠的价值（观念）</h2><p>永远记住失眠的价值。当获得必须的睡眠，你会表现得更出色，做出更明智的决定，拥有更健康的身体。睡眠不是我们需要逾越的障碍，它是一种身体所需的自然状态，可以增强激素作用，治愈肌肉、组织和器官，让身体免受疾病侵害，让理智达到最优水平。重新调配你的睡眠，不要把睡眠视为需要克服的障碍，把睡眠看成对自己的特殊款待！</p><h2 id="第二章-白天多晒太阳（光线）"><a href="#第二章-白天多晒太阳（光线）" class="headerlink" title="第二章 白天多晒太阳（光线）"></a>第二章 白天多晒太阳（光线）</h2><p>晨光是如何改善睡眠的呢？光纤其实是在发信号给下丘脑及所有相关器官和腺体，提醒它们该醒了。最近，一项研究考察了日班办公室人员的睡眠质量，相比直接靠窗的人员，不靠窗人员接收的自然光会少173%，并因此平均没晚少睡46分钟。想要获得完美的睡眠，褪黑素真实扮演者明星级的角色。褪黑素是由人体中的松果腺和其他组织生成的，当室外变暗时，身体就会自然分泌褪黑素。但是如果不能在正确的时间获得适当的光线，我们的身体就会出现问题。皮质醇和褪黑素算是呈你相关的一对激素。白天接收阳光照射之所以重要，还有一个原因是可以刺激皮质醇的生成。获得更多阳光照射，可以为正常的皮质醇节律和褪黑素节律控制节奏。阳光中含有许多影响身体的波长，我们最需要了解UVA和UVB，UV代表紫外线，对UVA的不健康接触也是不行的(例如太阳暴晒)，UVB对人体健康的价值最大，因为它是唯一会刺激人体生成维生素D的波长。</p><h2 id="第三章-睡前远离电子屏幕（光线）"><a href="#第三章-睡前远离电子屏幕（光线）" class="headerlink" title="第三章 睡前远离电子屏幕（光线）"></a>第三章 睡前远离电子屏幕（光线）</h2><p>想要立刻改善睡眠，第一步就是减少晚间看电子屏幕的时间。蓝光会严重影响睡眠，因为会刺激人体生成更多的白天激素，误导原本准备睡觉的人。我们使用电子设备的文化传统不过刚刚几十年，在几百万年的进化历程与几十年熬夜习惯的对抗中，我们的能力也没进化得快适应。如果你想根据身体需求，进入深度睡眠，在睡前90分钟，你要关闭所有屏幕，让褪黑素激素和皮质醇水平回复正常。</p><h2 id="第四章-建立咖啡因宵禁（饮食）"><a href="#第四章-建立咖啡因宵禁（饮食）" class="headerlink" title="第四章 建立咖啡因宵禁（饮食）"></a>第四章 建立咖啡因宵禁（饮食）</h2><p>咖啡因是一种强大的神经兴奋剂。由于咖啡因摄入导致睡眠不足，必然会让我们感觉更加疲惫，疲惫之后我们会期待更多的咖啡因，这会让我们的睡眠问题雪上加霜。咖啡因的半衰期为5~8小时，半衰期本质上是指，人体系统中的物质最高浓度降低一般所需的时间。设定一个必须遵守的咖啡因小金，确保在你睡觉前，可以排除体系中的大部分咖啡因，对于大部分人来说，那个时间通常是下午2：00前。</p><h2 id="第五章-让自己凉快点（温度）"><a href="#第五章-让自己凉快点（温度）" class="headerlink" title="第五章 让自己凉快点（温度）"></a>第五章 让自己凉快点（温度）</h2><p>当身体该休息时，人体核心温度会自动下降，帮助人们启动睡眠状态。如果外界温度过高，身体想进入理想的舒适睡眠，就会面临一点生理上的挑战。研究表明，最佳的睡眠温度是15°~20°。如果你有睡眠障碍，试着睡前花1.5~2小时，洗个热水澡。</p><h2 id="第六章-选择正确的入睡时间（时间）"><a href="#第六章-选择正确的入睡时间（时间）" class="headerlink" title="第六章 选择正确的入睡时间（时间）"></a>第六章 选择正确的入睡时间（时间）</h2><p>人类在晚10点到凌晨2点处于睡眠状态，可以获得最佳的激素分泌和恢复效果。如果有人熬到晚上10点或11点，进入精力恢复状态后，通常觉得想睡觉更难入睡。精力恢复状态跟锻炼的过程区别不大，做过耐力训练的人都直到，只要坚持一段时间，即便你感觉累了，身体也会进入恢复状态，再次感觉精力满满，继续坚持下去。</p><h2 id="第十章-调暗光线（时间）"><a href="#第十章-调暗光线（时间）" class="headerlink" title="第十章 调暗光线（时间）"></a>第十章 调暗光线（时间）</h2><p>卧室里任何的光源都会打乱睡眠模式，即使戴上眼罩也不是100%有效的。你知道皮肤上其实有光感器吗？如果卧室里有光源，你的身体会接收光线，向大脑和器官发送信息从而干扰睡眠。</p><h2 id="第十一章-讲究方法，好好锻炼（时间）"><a href="#第十一章-讲究方法，好好锻炼（时间）" class="headerlink" title="第十一章 讲究方法，好好锻炼（时间）"></a>第十一章 讲究方法，好好锻炼（时间）</h2><p>关键问题不在于锻炼本身，而在于锻炼的时间和方式。为了优化睡眠，你活动时需要遵循几个原则：1.晚上不适合锻炼，早晨锻炼的好处不能忽视；2.长跑不利于好的睡眠；3.为了获得最佳的激素反应，需要做些举重练习</p><h2 id="第十四章-喝酒悠着点（饮食）"><a href="#第十四章-喝酒悠着点（饮食）" class="headerlink" title="第十四章 喝酒悠着点（饮食）"></a>第十四章 喝酒悠着点（饮食）</h2><p>晚上喝酒有利于快速入睡，但是快速眼动睡眠会被身体中的酒精严重干扰，你将无法进入深度的、持续的快速眼动睡眠，大脑和身体也无法完全恢复。</p><h2 id="第十六章-让心里话停下来-（冥想-腹式呼吸-技巧）"><a href="#第十六章-让心里话停下来-（冥想-腹式呼吸-技巧）" class="headerlink" title="第十六章 让心里话停下来 （冥想 腹式呼吸 技巧）"></a>第十六章 让心里话停下来 （冥想 腹式呼吸 技巧）</h2><h2 id="第十八章-早点起床（时间）"><a href="#第十八章-早点起床（时间）" class="headerlink" title="第十八章 早点起床（时间）"></a>第十八章 早点起床（时间）</h2><h2 id="第十九章-选择合适的纤体方法-（渐进式肌肉放松-按摩-技巧）"><a href="#第十九章-选择合适的纤体方法-（渐进式肌肉放松-按摩-技巧）" class="headerlink" title="第十九章 选择合适的纤体方法 （渐进式肌肉放松 按摩 技巧）"></a>第十九章 选择合适的纤体方法 （渐进式肌肉放松 按摩 技巧）</h2>]]></content>
      
      
      <categories>
          
          <category> 生活 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 睡眠 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python 3 面向对象</title>
      <link href="/archives/59bf225c.html"/>
      <url>/archives/59bf225c.html</url>
      
        <content type="html"><![CDATA[<h1 id="python-面向对象"><a href="#python-面向对象" class="headerlink" title="python 面向对象"></a>python 面向对象</h1><h2 id="面向对象编程"><a href="#面向对象编程" class="headerlink" title="面向对象编程"></a>面向对象编程</h2><p>什么是面向对象编程？用一段话描述面向对象的思想：</p><blockquote><p>把一组数据结构和处理它们的方法组成对象（object），把相同行为的对象归纳为类（class），通过类的封装（encapsulation）隐藏内部细节，通过继承（inheritance）实现类的特化（specialization）和泛化（generalization），通过多态（polymorphism）实现基于对象类型的动态分派</p></blockquote><p>这一段话我在之前是看得云里雾里，这样高度的概括过于抽象。现在看过了一些代码过后，再回头看这段话才没那么迷惑</p><h2 id="类和对象"><a href="#类和对象" class="headerlink" title="类和对象"></a>类和对象</h2><p>类是对象的模板，对象是类的实例。在面向对象的世界中，一切皆为对象。下面来创建一个类</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name        self<span class="token punctuation">.</span>age <span class="token operator">=</span> age        <span class="token keyword">def</span> <span class="token function">introduce</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"My name is %s. I'm %d."</span> <span class="token operator">%</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>name<span class="token punctuation">,</span> self<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>之前提到过 <code>__init__()</code> 方法在类中属于特殊方法，会在创建对象的时候自动调用。通过这个方法可以给对象绑定 <code>name</code> &amp; <code>age</code> 两个属性，这样在其他方法里就能够随意调用这些属性，而不需要再次传入这些参数。下面来创建 <code>Student</code> 类的对象，并使用其内部函数</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">student_1 <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token string">'Declan'</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">)</span>student_1<span class="token punctuation">.</span>introduce<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># My name is Declan. I'm 23.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>创建对象，就是将类实例化，具体一点来说：给类传入一些参数，让其从模板称为了一个具体的对象。可以看到在创建的对象的代码里，并没有显式使用，也不能显式使用特殊方法 <code>__init__()</code> </p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># try this</span>student_2 <span class="token operator">=</span> Student<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token string">'Declan'</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>这样做一定是会报错的。所以正确的理解是，<code>Student(name, age)</code> 中的参数 <code>name</code> &amp; <code>age</code> 就是给 <code>__init__()</code> 的参数，并在创建对象的时候自动运行 <code>__init__()</code> 方法</p><h3 id="访问可见性问题"><a href="#访问可见性问题" class="headerlink" title="访问可见性问题"></a>访问可见性问题</h3><p>在很多面向对象编程语言中，我们通常会将对象的属性设置为私有的（private）或受保护的（protected），简单的说就是不允许外界访问，而对象的方法通常都是公开的（public），在 Python 中，属性和方法的访问权限只有两种，也就是公开的和私有的，如果希望属性是私有的，在给属性命名时可以用两个下划线作为开头</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Test</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>__private <span class="token operator">=</span> <span class="token string">'private'</span>        self<span class="token punctuation">.</span>__func<span class="token punctuation">(</span><span class="token punctuation">)</span>                    <span class="token keyword">def</span> <span class="token function">__func</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>__private<span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'this function is private'</span><span class="token punctuation">)</span>test <span class="token operator">=</span> Test<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># private</span><span class="token comment"># this function is private</span><span class="token keyword">print</span><span class="token punctuation">(</span>test<span class="token punctuation">.</span>__private<span class="token punctuation">)</span><span class="token comment"># AttributeError: 'Test' object has no attribute '__private'</span><span class="token comment"># 直接访问被阻拦，但拐个弯还是有方法能够访问</span><span class="token keyword">print</span><span class="token punctuation">(</span>test<span class="token punctuation">.</span>_Test__private<span class="token punctuation">)</span><span class="token comment"># private</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看在类的内部调用这些私有变量和函数是没有问题的，但是想要在函数之外直接访问这些变量和函数是被禁止的。在实际开发中，我们并不建议将属性设置为私有的，因为这会导致子类无法访问（后面会讲到）。所以大多数 Python 程序员会遵循一种命名惯例就是让属性名以单下划线开头如 <code>_name</code>，来表示属性是受保护的，本类之外的代码在访问这样的属性时应该要保持慎重</p><h2 id="类的方法"><a href="#类的方法" class="headerlink" title="类的方法"></a>类的方法</h2><h3 id="self"><a href="#self" class="headerlink" title="self"></a>self</h3><p>类的方法与普通的函数只有一个特别的区别——它们必须有一个额外的<strong>第一个参数名称</strong>，按照惯例它的名称是 self，当然也可以叫其它名字，下面看看这个 self 到底代表了什么</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Test</span><span class="token punctuation">:</span><span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>SELF<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">print</span><span class="token punctuation">(</span>SELF<span class="token punctuation">.</span>__class__<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">pointer_self</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">print</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span>test <span class="token operator">=</span> Test<span class="token punctuation">(</span><span class="token punctuation">)</span>test<span class="token punctuation">.</span>pointer_self<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># &lt;class '__main__.Test'&gt;</span><span class="token comment"># &lt;__main__.Test object at 0x000001B64F611040&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>从执行结果可以很明显的看出，self 代表的是类的实例，代表当前对象的地址，而 self.class 则指向类</p><h2 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h2><p>如果一种语言不支持继承，类就没有什么意义。子类会继承父类（也叫基类）的属性和方法，而且还可以定义自己的属性和方法，所以子类比父类拥有更多的能力，下面看一个简短的代码，理解继承机制的逻辑</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 这是之前写的学生类</span><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name        self<span class="token punctuation">.</span>age <span class="token operator">=</span> age        self<span class="token punctuation">.</span>log <span class="token operator">=</span> <span class="token string">'this is a student'</span>        <span class="token keyword">def</span> <span class="token function">introduce</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"My name is %s. I'm %d."</span> <span class="token operator">%</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>name<span class="token punctuation">,</span> self<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment"># 现在建立一个本科生类</span><span class="token keyword">class</span> <span class="token class-name">Undergraduate</span><span class="token punctuation">(</span>Student<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> grade<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># 在子类中调用父类的方法</span>        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>grade <span class="token operator">=</span> grade    <span class="token keyword">def</span> <span class="token function">which_grade</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'My grade is %d.'</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>grade<span class="token punctuation">)</span>        <span class="token comment"># 在多态的时候取消注释</span>    <span class="token comment"># def introduce(self):</span>    <span class="token comment">#     print("Hello! My name is %s. I'm %d." % (self.name, self.age))</span>student_1 <span class="token operator">=</span> Undergraduate<span class="token punctuation">(</span><span class="token string">'Declan'</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>student_1<span class="token punctuation">.</span>which_grade<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># My grade is 1.</span><span class="token comment"># 子类实例直接使用父类的属性和方法</span><span class="token keyword">print</span><span class="token punctuation">(</span>student_1<span class="token punctuation">.</span>log<span class="token punctuation">)</span>student_1<span class="token punctuation">.</span>introduce<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># this is a student</span><span class="token comment"># My name is Declan. I'm 18.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>重点的几个逻辑：</p><ol><li>声明父类，在定义的类名后传入父类名即可，如 <code>class Undergraduate(Student)</code></li><li>调用父类，通过 <code>super()</code> 函数调用父类中的属性、方法，如果是 python 2.x 的话需要使用 <code>super(子类名, self)</code> 调用</li><li>实例使用父类，子类实例可以直接使用父类中的属性、方法</li></ol><h2 id="多态"><a href="#多态" class="headerlink" title="多态"></a>多态</h2><p>子类在继承了父类的方法后，可以对父类已有的方法给出新的实现版本，这个动作称之为方法重写（override），父类的方法可以被多个子类进行重写得到多个不同的实现版本，这个就是多态（poly-morphism）</p><p>把上一节中关于多态的代码取消注释，再调用 <code>introduce()</code> 方法</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">student_1<span class="token punctuation">.</span>introduce<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># Hello! My name is Declan. I'm 18.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>发现比之前父类的 <code>introduce()</code> 多打印了 <code>Hello!</code> 重写成功！ </p><h2 id="补充：类的特殊方法"><a href="#补充：类的特殊方法" class="headerlink" title="补充：类的特殊方法"></a>补充：类的特殊方法</h2><p>这些类的特殊方法也叫魔术方法，在特殊条件下被调用，下面列举一些</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">-</span> <span class="token operator">**</span>__init__ <span class="token punctuation">:</span><span class="token operator">**</span> 构造函数，在生成对象时调用<span class="token operator">-</span> <span class="token operator">**</span>__del__ <span class="token punctuation">:</span><span class="token operator">**</span> 析构函数，释放对象时使用<span class="token operator">-</span> <span class="token operator">**</span>__repr__ <span class="token punctuation">:</span><span class="token operator">**</span> 打印对象时调用<span class="token operator">-</span> <span class="token operator">**</span>__setitem__ <span class="token punctuation">:</span><span class="token operator">**</span> 按照索引赋值<span class="token operator">-</span> <span class="token operator">**</span>__getitem__<span class="token punctuation">:</span><span class="token operator">**</span> 按照索引获取值<span class="token operator">-</span> <span class="token operator">**</span>__len__<span class="token punctuation">:</span><span class="token operator">**</span> 获得长度<span class="token operator">-</span> <span class="token operator">**</span>__cmp__<span class="token punctuation">:</span><span class="token operator">**</span> 比较运算<span class="token operator">-</span> <span class="token operator">**</span>__call__<span class="token punctuation">:</span><span class="token operator">**</span> 让对象变为可调用对象<span class="token comment"># 下面的魔术方法可以进行算符重载</span><span class="token operator">-</span> <span class="token operator">**</span>__add__<span class="token punctuation">:</span><span class="token operator">**</span> 加运算<span class="token operator">-</span> <span class="token operator">**</span>__sub__<span class="token punctuation">:</span><span class="token operator">**</span> 减运算<span class="token operator">-</span> <span class="token operator">**</span>__mul__<span class="token punctuation">:</span><span class="token operator">**</span> 乘运算<span class="token operator">-</span> <span class="token operator">**</span>__truediv__<span class="token punctuation">:</span><span class="token operator">**</span> 除运算<span class="token operator">-</span> <span class="token operator">**</span>__mod__<span class="token punctuation">:</span><span class="token operator">**</span> 求余运算<span class="token operator">-</span> <span class="token operator">**</span>__pow__<span class="token punctuation">:</span><span class="token operator">**</span> 乘方<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>实验一下 <code>__repr__, __call__</code></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name        self<span class="token punctuation">.</span>age <span class="token operator">=</span> age    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">"My name is {}. I'm {}."</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>name<span class="token punctuation">,</span> self<span class="token punctuation">.</span>age<span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> grade<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">'grade {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>grade<span class="token punctuation">)</span>name <span class="token operator">=</span> <span class="token string">'Declan'</span>age <span class="token operator">=</span> <span class="token number">23</span>stu <span class="token operator">=</span> Student<span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>stu<span class="token punctuation">)</span><span class="token comment"># My name is Declan. I'm 23.</span><span class="token keyword">print</span><span class="token punctuation">(</span>stu<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># grade 2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="补充：装饰器"><a href="#补充：装饰器" class="headerlink" title="补充：装饰器"></a>补充：装饰器</h2><p>参考 <a href="https://www.cnblogs.com/auguse/articles/9922257.html">博客</a> 进行整理。装饰器本质上是一个 Python 函数或类，它可以让其他函数或类在不需要做任何代码修改的前提下增加额外功能。由于在学习 mmdetection 中发现 <code>registry</code> 类的实现就需要装饰器的帮忙，所以接下来将“花费”一些篇幅来了解装饰器的内部逻辑</p><h3 id="装饰器基本原理"><a href="#装饰器基本原理" class="headerlink" title="装饰器基本原理"></a>装饰器基本原理</h3><p>下面先看看不用 python 装饰器，怎样实现其类似的功能</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 原函数</span><span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"My name is {}, and I'm {}."</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># 定义一个装饰器来包装原函数</span><span class="token keyword">def</span> <span class="token function">decorate</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">wrap</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'This is my introduction.'</span><span class="token punctuation">)</span>        func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>    <span class="token comment"># 返回新的函数名</span>    <span class="token keyword">return</span> wrap<span class="token comment"># 将原函数包装，并将原函数指向装饰后的函数</span>test  <span class="token operator">=</span> decorate<span class="token punctuation">(</span>test<span class="token punctuation">)</span>name <span class="token operator">=</span> <span class="token string">'Declan'</span>age <span class="token operator">=</span> <span class="token number">23</span>test<span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token comment"># This is my introduction.</span><span class="token comment"># My name is Declan, and I'm 23.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这样就实现了一个简单的装饰器，该装饰器的功能就是在原函数之前打印一句话 <code>This is my introduction</code></p><p>python 使用 <code>@</code> 关键字来实现装饰器，具体来说 <code>@</code> 关键字实现的是上面代码中的注释“将原函数包装，并将原函数指向装饰后的函数”。将之前的装饰器，用 <code>@</code> 重新实现</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 定义一个装饰器来包装原函数</span><span class="token keyword">def</span> <span class="token function">decorate</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">wrap</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'This is my introduction.'</span><span class="token punctuation">)</span>        func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>    <span class="token comment"># 返回新的函数名</span>    <span class="token keyword">return</span> wrap<span class="token comment"># 原函数+装饰器</span><span class="token decorator annotation punctuation">@decorate</span><span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"My name is {}, and I'm {}."</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># test  = decortate(test)</span>name <span class="token operator">=</span> <span class="token string">'Declan'</span>age <span class="token operator">=</span> <span class="token number">23</span>test<span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token comment"># This is my introduction.</span><span class="token comment"># My name is Declan, and I'm 23</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>test<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># &lt;class 'function'&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到，就是在原函数之前加上 <code>@decorate</code> 就实现了对原函数的装饰，替代了 <code>test  = decorate(test)</code> 这一步。换句话说 <code>@</code> 关键字将下一行的函数/类，作为参数传给了 <code>decorate</code> 函数，这就是装饰器的关键之一。之前的装饰器只接受了原函数 <code>test</code> 作为参数，那如果想要实现传入多个参数，例如 <code>@decorate(*args)</code> 应该怎么办呢？接下来实现一个带参数的装饰器</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">name <span class="token operator">=</span> <span class="token string">'Declan'</span>age <span class="token operator">=</span> <span class="token number">23</span><span class="token keyword">def</span> <span class="token function">param_decorate</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"It's running without test()"</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">wrap</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'This is a introduction.'</span><span class="token punctuation">)</span>        func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token boolean">None</span>    <span class="token keyword">return</span> wrap<span class="token decorator annotation punctuation">@param_decorate</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"My name is {}, and I'm {}."</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># 使没有运行 test() 以上代码能够输出内容</span><span class="token comment"># It's running without test()</span><span class="token comment"># This is a introduction.</span><span class="token comment"># My name is Declan, and I'm 23</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>test<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># &lt;class 'NoneType'&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用以上代码会发现，即使没有运行 <code>test</code> 函数也输出了内容。这是因为给装饰器添加参数过后，那么 <code>@</code> 后跟随的就是一个执行函数，python 就会真实地执行该函数的内容。执行 <code>param_decorate</code> 函数返回的是一个函数名 <code>wrap</code>，那么此时相当于 <code>@wrap</code>，也即 <code>test</code> 函数会被作为参数传入到 <code>wrap()</code> 函数当中，此时 <code>test  = wrap(test)</code> 的返回对象是 <code>NoneType</code>，而之前 <code>test = decorate(test)</code> 返回对象是一个函数名</p><p>还有一个方法来学习装饰器的内部逻辑，就是直接对代码 debug，一步步看程序是如何运行的</p><h3 id="python-内置装饰器"><a href="#python-内置装饰器" class="headerlink" title="python 内置装饰器"></a>python 内置装饰器</h3><p>内置的装饰器和普通的装饰器原理是一样的，只不过一般用于类的方法当中，让类变得更灵活</p><h4 id="property"><a href="#property" class="headerlink" title="@property"></a>@property</h4><p>参考 <a href="https://www.runoob.com/python/python-func-property.html">菜鸟教程</a> <a href="https://www.liaoxuefeng.com/wiki/897692888725344/923030547069856">廖雪峰教程 </a>进行整理。<code>@property</code> 能够用于管理类的私有属性，方便读取属性、修改属性。下面看看如何使用该装饰器</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">:</span>    <span class="token decorator annotation punctuation">@property</span>    <span class="token keyword">def</span> <span class="token function">get_the_score</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""I'm the 'score' property."""</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_score     <span class="token decorator annotation punctuation">@get_the_score<span class="token punctuation">.</span>setter</span>    <span class="token keyword">def</span> <span class="token function">score</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>_score <span class="token operator">=</span> value     <span class="token decorator annotation punctuation">@get_the_score<span class="token punctuation">.</span>deleter</span>    <span class="token keyword">def</span> <span class="token function">score</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">del</span> self<span class="token punctuation">.</span>_scorestudent <span class="token operator">=</span> Student<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># setter不仅可以更改属性值，也可以创建该属性</span>student<span class="token punctuation">.</span>get_the_score <span class="token operator">=</span> <span class="token number">60</span><span class="token comment"># 查看属性</span><span class="token keyword">print</span><span class="token punctuation">(</span>student<span class="token punctuation">.</span>get_the_score<span class="token punctuation">)</span><span class="token comment"># 60</span><span class="token comment"># 也使用原属性名称更改和访问</span>student<span class="token punctuation">.</span>score <span class="token operator">=</span> <span class="token number">100</span><span class="token keyword">print</span><span class="token punctuation">(</span>student<span class="token punctuation">.</span>score<span class="token punctuation">)</span><span class="token comment"># 100</span><span class="token comment"># 删除属性</span><span class="token comment"># del student.score</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>@property</code> 的实现比较复杂，我感觉我是真没理解，这里直接引用一下廖雪峰教程中的话：</p><blockquote><p>把一个 <code>get_the_score</code> 方法变成属性，只需要加上 <code>@property</code> 就可以了。此时，<code>@property</code>本身又创建了另一个装饰器 <code>@get_the_score.setter</code>，负责把一个 setter 方法变成属性赋值，于是，我们就拥有一个可控的属性操作</p></blockquote><p>我自己理解，如果需要只读属性，则只使用 <code>@property</code> 装饰器就可以了，如果还需要对属性进行进一步操控则加上其他 <code>setter, deleter</code> 装饰器</p><p>而且，如果使用了 <code>property</code> 装饰器，必须要使用单下划线变量，不然会报错，具体原因参考 <a href="https://zhuanlan.zhihu.com/p/53469919">知乎链接</a></p><h4 id="classmethod"><a href="#classmethod" class="headerlink" title="@classmethod"></a>@classmethod</h4><p>参考 <a href="https://zhuanlan.zhihu.com/p/35643573">知乎链接</a> 进行整理，<code>classmethod</code> 又被叫做类方法。<code>__init__()</code> 作为类的构造函数，能够在生成对象时调用，但如果想要使用其他构造函数时，可以使用<code>@classmethod</code> 实现，下面看如何使用类方法创建一个对象（为方便，把静态方法 <code>staticmethod</code> 的代码也写在这儿）</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Date</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> year<span class="token punctuation">,</span> month<span class="token punctuation">,</span> day<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>year <span class="token operator">=</span> year        self<span class="token punctuation">.</span>month <span class="token operator">=</span> month        self<span class="token punctuation">.</span>day <span class="token operator">=</span> day        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'{}年{}月{}日'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>year<span class="token punctuation">,</span> self<span class="token punctuation">.</span>month<span class="token punctuation">,</span> self<span class="token punctuation">.</span>day<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token decorator annotation punctuation">@classmethod</span>    <span class="token keyword">def</span> <span class="token function">create_from_string</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> string<span class="token punctuation">)</span><span class="token punctuation">:</span>        year<span class="token punctuation">,</span> month<span class="token punctuation">,</span> day <span class="token operator">=</span> <span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span>string<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> cls<span class="token punctuation">(</span>year<span class="token punctuation">,</span> month<span class="token punctuation">,</span> day<span class="token punctuation">)</span>    <span class="token decorator annotation punctuation">@staticmethod</span>    <span class="token keyword">def</span> <span class="token function">is_leap</span><span class="token punctuation">(</span>year<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> year <span class="token operator">%</span> <span class="token number">4</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">and</span> year <span class="token operator">%</span> <span class="token number">100</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token boolean">True</span>        <span class="token keyword">elif</span> year <span class="token operator">%</span> <span class="token number">400</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token boolean">True</span>        <span class="token keyword">else</span><span class="token punctuation">:</span> <span class="token keyword">return</span> <span class="token boolean">False</span><span class="token comment"># 普通构造</span>date <span class="token operator">=</span> Date<span class="token punctuation">(</span><span class="token number">2020</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">)</span><span class="token comment"># 2020年7月31日</span><span class="token comment"># 通过类方法构造</span>date <span class="token operator">=</span> Date<span class="token punctuation">.</span>create_from_string<span class="token punctuation">(</span><span class="token string">'2020-7-31'</span><span class="token punctuation">)</span><span class="token comment"># 2020年7月31日</span><span class="token comment"># 使用静态方法</span><span class="token keyword">print</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>is_leap<span class="token punctuation">(</span><span class="token number">1900</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># True</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>重点需要注意的是类方法的第一个参数，其表示调用当前的类名，默认名称为 <code>cls</code>，有点类似于 <code>self</code> 表示类的实例。那么类方法最后的返回值 <code>return cls(year, month, day)</code> 也就不难理解了，相当于 <code>return Data(year, month, day)</code> 重新创建了对象</p><p>类方法能够在不改变原本构造函数的情况下，给类的构造方法增加一些额外功能，例如对于传入参数做一些不同的处理等等</p><h4 id="staticmethod"><a href="#staticmethod" class="headerlink" title="@staticmethod"></a>@staticmethod</h4><p>参考 <a href="https://www.cnblogs.com/Meanwey/p/9788713.html">博客</a> 的说法：<code>@staticmethod</code> 静态方法只是名义上归属类管理，但是不能使用类变量和实例变量，是类的工具包。因为该函数不传入self或者cls，所以不能访问类属性和实例属性。静态方法的一个好处是，不用创建类的实例也能够调用该方法，具体调用方法参考上面代码</p>]]></content>
      
      
      <categories>
          
          <category> 编程 </category>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 教程 </tag>
            
            <tag> Python </tag>
            
            <tag> 面向对象 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python 4 拓展</title>
      <link href="/archives/c19cb72c.html"/>
      <url>/archives/c19cb72c.html</url>
      
        <content type="html"><![CDATA[<h1 id="python-拓展"><a href="#python-拓展" class="headerlink" title="python 拓展"></a>python 拓展</h1><h2 id="format输出"><a href="#format输出" class="headerlink" title="format输出"></a>format输出</h2><p>这里总结一下 format 输出的形式，主要以 <code>{position:format}</code> 形式对变量进行引用</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">name <span class="token operator">=</span> <span class="token string">'Declan'</span>age <span class="token operator">=</span> <span class="token number">23</span><span class="token comment"># 按照顺序引用</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"{0} {1} {0}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># Declan 23 Declan</span><span class="token comment"># 按照关键字引用</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"{name} {age}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token operator">=</span>name<span class="token punctuation">,</span> age<span class="token operator">=</span>age<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># Declan 23</span><span class="token comment"># 数字格式化</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"{:.2f}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># 23.00</span><span class="token comment"># 输出左右对齐</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"{:0&gt;10d}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment"># 向右对齐，默认宽度为10，不够以0补位</span><span class="token comment"># 0000000023</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"{:x&lt;10b}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment"># 向左对齐，默认宽度为10，不够以x补位</span><span class="token comment"># 10111xxxxx</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="读写文件"><a href="#读写文件" class="headerlink" title="读写文件"></a>读写文件</h2><p>Python open() 方法用于打开一个文件，并返回文件对象，在对文件进行处理过程都需要使用到这个函数，如果该文件无法被打开，会抛出 OSError。<strong>注意：</strong>使用 open() 方法一定要保证关闭文件对象，即调用 close() 方法</p><p>open() 函数常用形式是接收两个参数：文件名(file)和模式(mode)，更多参数查询  <a href="https://www.runoob.com/python/file-methods.html">菜鸟教程</a>。现在介绍一下常用的 <code>mode</code> 参数：</p><ol><li><code>r</code>，只读模式，为默认设置</li><li><code>w</code>，写入模式，会擦除文件中之前的内容，重新写入。如果没有文件会自动创建</li><li><code>a</code>，附加模式，会在文件末尾加入新内容</li><li><code>r+</code>，读写模式，指针位于文件开头</li></ol><p>下面介绍操作文件的基本功能：读和写。我们先在 python 脚本所在文件夹新建一个文本文档 <code>test.txt</code> 内容为 <code>a, b, c</code></p><h3 id="读文件"><a href="#读文件" class="headerlink" title="读文件"></a>读文件</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python">f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'test.txt'</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'r'</span><span class="token punctuation">)</span><span class="token comment"># 使用 read(size) 输出</span><span class="token comment"># 如果不传入输出字符数量，则全部输出</span><span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># a, b, c</span><span class="token comment"># 读完文件过后需要移动指针到文件开头才能重新再读一遍</span><span class="token comment"># 使用 seek(offset)，默认0位置从文件开头算起</span>f<span class="token punctuation">.</span>seek<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment"># 使用 readlines() 逐行输出</span><span class="token comment"># 该方法返回值是由每一行内容组成的一个列表</span><span class="token keyword">for</span> i <span class="token keyword">in</span> f<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token comment"># a, b, c</span>f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="写文件"><a href="#写文件" class="headerlink" title="写文件"></a>写文件</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python">f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'test.txt'</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token comment"># 使用 write(str) 在指针处写入内容</span>f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">'\nadd something'</span><span class="token punctuation">)</span><span class="token comment"># a, b, c</span><span class="token comment"># add something</span>f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果需要写入中文，建议设置编码为 utf-8，<code>open(filename, mode, encoding='utf-8')</code></p><h3 id="with-关键字"><a href="#with-关键字" class="headerlink" title="with 关键字"></a>with 关键字</h3><p>一些对象定义了标准的清理行为，无论系统是否成功的使用了它，一旦不需要它了，那么这个标准的清理行为就会执行。只需要该对象定义了 <code>__enter__ &amp; __exit__</code> 魔术方法，关键字 with 就可以保证诸如文件之类的对象在使用完之后一定会正确的执行他的清理方法</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>    <span class="token comment"># statement</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="os-amp-sys-模块"><a href="#os-amp-sys-模块" class="headerlink" title="os &amp; sys 模块"></a>os &amp; sys 模块</h2><h3 id="os"><a href="#os" class="headerlink" title="os"></a>os</h3><p><strong>os</strong> 模块提供了非常丰富的方法用来处理文件和目录。关于 os 模块更多操作可以查询 <a href="https://www.runoob.com/python3/python3-os-file-methods.html">菜鸟教程</a>，这里列举一些常用的部分。由于返回的这些路径多为字符串类型，所以字符串的操作在这里也会经常使用</p><h4 id="系统相关"><a href="#系统相关" class="headerlink" title="系统相关"></a>系统相关</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> os<span class="token keyword">print</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>name<span class="token punctuation">)</span>  <span class="token comment"># 操作系统名称</span><span class="token keyword">print</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">)</span>   <span class="token comment"># 环境变量，返回一个“字典”</span><span class="token keyword">print</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>sep<span class="token punctuation">,</span> os<span class="token punctuation">.</span>pathsep<span class="token punctuation">)</span>   <span class="token comment"># 路径分割符号，windows 为 \ ;</span><span class="token comment"># 查看一下 PATH 环境变量</span><span class="token comment"># PATH一般为系统指定可执行文件的搜索路径</span>PATH <span class="token operator">=</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">'PATH'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">';'</span><span class="token punctuation">)</span><span class="token keyword">for</span> path <span class="token keyword">in</span> PATH<span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="文件和目录"><a href="#文件和目录" class="headerlink" title="文件和目录"></a>文件和目录</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> ospath <span class="token operator">=</span> <span class="token string">'.'</span>  <span class="token comment"># 当前文件夹</span>os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span><span class="token string">'folder'</span><span class="token punctuation">)</span>os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span><span class="token string">'folder\subfolder'</span><span class="token punctuation">)</span>os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>path<span class="token punctuation">)</span>   <span class="token comment"># 删除文件</span>os<span class="token punctuation">.</span>removedirs<span class="token punctuation">(</span>path<span class="token punctuation">)</span>   <span class="token comment"># 删除空文件夹</span>os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>path<span class="token punctuation">)</span>    <span class="token comment"># 返回文件列表</span>os<span class="token punctuation">.</span>getcwd<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 返回当前路径</span><span class="token comment"># os.path 是一个常用模块，重点介绍</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>path<span class="token punctuation">)</span>   <span class="token comment"># 返回绝对路径</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>path<span class="token punctuation">)</span>   <span class="token comment"># 返回路径的 dirname</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>basename<span class="token punctuation">(</span>path<span class="token punctuation">)</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>split<span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token comment"># 把路径分割成 dirname 和 basename，返回一个元组</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>splittext<span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token comment"># 将路径的扩展名分离出来</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>path<span class="token punctuation">)</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isdir<span class="token punctuation">(</span>path<span class="token punctuation">)</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token operator">*</span>path<span class="token punctuation">)</span><span class="token comment"># 将多个名称合成为一个路径名</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="sys"><a href="#sys" class="headerlink" title="sys"></a>sys</h3><p>sys 即 system，该模块提供了一些接口，用于访问 Python 解释器自身使用和维护的变量。下面列举一些常用成员</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> syssys<span class="token punctuation">.</span>version <span class="token comment"># 版本号</span>sys<span class="token punctuation">.</span>path    <span class="token comment"># python 解释器搜索路径</span>sys<span class="token punctuation">.</span>argv    <span class="token comment"># 传入当前 python 文件的参数列表</span>sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment"># 退出状态码</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="错误和异常"><a href="#错误和异常" class="headerlink" title="错误和异常"></a>错误和异常</h2><p>当 Python 脚本发生异常时我们需要捕获处理它，否则程序会终止执行</p><h3 id="try相关"><a href="#try相关" class="headerlink" title="try相关"></a>try相关</h3><p>异常处理的方法</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">try</span><span class="token punctuation">:</span>    statement<span class="token keyword">except</span> Exception<span class="token punctuation">:</span>    <span class="token comment"># 发生异常时执行的代码</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Something Wrong!'</span><span class="token punctuation">)</span>    statement<span class="token comment"># 可以有多个 exception 表示面对不同异常的处理</span><span class="token keyword">except</span> Excepthion_2<span class="token punctuation">:</span>    <span class="token comment"># 发生异常时执行的代码</span>    statement<span class="token keyword">else</span><span class="token punctuation">:</span>    <span class="token comment"># 没有异常时执行的代码</span>    statement<span class="token keyword">finally</span><span class="token punctuation">:</span>    <span class="token comment"># 无论有没有异常都会执行的代码</span>    statement<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="raise"><a href="#raise" class="headerlink" title="raise"></a>raise</h3><p>Python 使用 raise 语句抛出一个指定的异常。更多 python 内置异常查看 <a href="https://www.runoob.com/python/python-exceptions.html">菜鸟教程</a></p><h3 id="assert"><a href="#assert" class="headerlink" title="assert"></a>assert</h3><p>Python assert（断言）用于判断一个表达式，在表达式条件为 false 的时候触发异常。其基本语法为</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">assert</span> expression <span class="token punctuation">[</span><span class="token punctuation">,</span> arguments<span class="token punctuation">]</span><span class="token comment"># 与以下代码等价</span><span class="token keyword">if</span> <span class="token keyword">not</span> expression<span class="token punctuation">:</span>    <span class="token keyword">raise</span> AssertionError<span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>之后的参数为抛出异常的补充信息，也可以不用加。下面举一个例子</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">assert</span> <span class="token number">1</span><span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'Somenthing Wrong!'</span><span class="token comment"># 以下为异常</span>Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>  File <span class="token string">"d:/..."</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">&gt;</span>    <span class="token keyword">assert</span> <span class="token number">1</span><span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'Somenthing Wrong!'</span>AssertionError<span class="token punctuation">:</span> Somenthing Wrong!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="argparse-模块"><a href="#argparse-模块" class="headerlink" title="argparse 模块"></a>argparse 模块</h2><p>argsparse 是 python 的命令行解析的标准模块，内置于python，不需要安装。这个库可以让我们<strong>直接在命令行中就可以向程序中传入参数</strong>，同时argparse会自动生成帮助文档，传入参数 <code>-h</code> 显示。下面写一个 python 脚本</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># arg.py</span><span class="token keyword">import</span> argparse<span class="token comment"># 创建 parser 并添加描述，通常为该脚本的用途</span>parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">'this is a parser'</span><span class="token punctuation">)</span><span class="token comment"># 添加参数</span>parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'params'</span><span class="token punctuation">)</span><span class="token comment"># 解析参数</span>args <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'show the params:'</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span>params<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>由于 argparse 模块是从命令行向文件传入参数，所以现在在 cmd 下给文件名后面传入参数 123 得到结果如下</p><pre class="line-numbers language-cmd" data-language="cmd"><code class="language-cmd">(base) D:\VScodeProjects\LearnManim&gt;python arg.py 123show the params: 123# 参数 123 传入到了文件中 parser 的位置参数 params 中<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>从 <code>arg.py</code> 中看出使用 argparse 模块的步骤：</p><ol><li>创建 <code>ArgumentParser</code> 对象</li><li>给对象中加入参数 <code>add_argument</code></li><li>解析对象，也即将命令行中的参数传给 <code>args</code>，之后能够像类的属性一样调用这些参数 <code>args.params</code></li></ol><p>下面来详细了解一下方法 <code>add_argument</code>，该方法能够方便我们从命令行输入参数。先来看看该函数自己的参数</p><ol><li><p>位置参数：不带 <code>-</code> 的参数。从命令行传入的参数会按照顺序传给 parser 添加的参数，比如上面的例子中，传入的第一个参数为 123，而 parser 中添加的第一个参数是 <code>params</code>，所以 123 传给了 <code>params</code>。正如 python 自身函数传参规则一样，位置参数是必须要传入的参数，如果不传入则会报错</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">(</span>base<span class="token punctuation">)</span> D<span class="token punctuation">:</span>\VScodeProjects\LearnManim<span class="token operator">&gt;</span>python arg<span class="token punctuation">.</span>py         usage<span class="token punctuation">:</span> arg<span class="token punctuation">.</span>py <span class="token punctuation">[</span><span class="token operator">-</span>h<span class="token punctuation">]</span> paramsarg<span class="token punctuation">.</span>py<span class="token punctuation">:</span> error<span class="token punctuation">:</span> the following arguments are required<span class="token punctuation">:</span> params<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>可选参数：带 <code>-</code> 的参数。可选参数有两种方式，</p><ul><li><code>-</code> 指定短参数，如 <code>-h</code></li><li><code>--</code> 指定长参数，如 <code>--help</code></li></ul><p>两种参数可以同时存在，可选参数就像 python 函数中使用关键字传参一样。修改一下上面的 python 脚本</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># arg.py</span><span class="token keyword">import</span> argparseparser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">'this is a parser'</span><span class="token punctuation">)</span>parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--params'</span><span class="token punctuation">,</span> <span class="token string">'-p'</span><span class="token punctuation">)</span>args <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'show the params:'</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span>params<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用短参数和长参数都可以，不传入参数也不会报错</p><pre class="line-numbers language-cmd" data-language="cmd"><code class="language-cmd">(base) D:\VScodeProjects\LearnManim&gt;python arg.py -p 1show the params: 1(base) D:\VScodeProjects\LearnManim&gt;python arg.py --params 1show the params: 1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>类型 <code>type</code>：指定输入参数的类型</p></li><li><p>默认值 <code>default</code>：指定默认值</p></li><li><p>帮助 <code>help</code>：描述该参数的功能</p></li><li><p>必须参数 <code>required</code>：该参数是否为必须传入的参数</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--params'</span><span class="token punctuation">,</span> <span class="token string">'-p'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'optional number'</span><span class="token punctuation">,</span> required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>动作 <code>action</code>：不需要在命令行传入参数。常用值为 <code>action='store_true'</code> 也即当传入关键字时，该参数值为 <code>True</code> </p><pre class="line-numbers language-python" data-language="python"><code class="language-python">parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--params'</span><span class="token punctuation">,</span> <span class="token string">'-p'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-cmd" data-language="cmd"><code class="language-cmd">(base) D:\VScodeProjects\LearnManim&gt;python arg.py -p  show the params: True<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ol><p>当然还有更多的参数，就不列举了，遇到了就去查文档</p><h2 id="re-模块"><a href="#re-模块" class="headerlink" title="re 模块"></a>re 模块</h2><p>re 为正则表达式的缩写，所以需要了解正则表达式的一些基础知识。正则表达式可以匹配某些特定模式的数据，在编辑文件、爬虫等方面有着广泛应用，以下内容参考 <a href="https://www.bilibili.com/video/BV19t4y1y7qP/">bilibili</a> &amp; <a href="https://www.runoob.com/regexp/regexp-syntax.html">菜鸟教程</a> 学习，这里记录一些基本的语法规则，仅供复习</p><h3 id="正则化"><a href="#正则化" class="headerlink" title="正则化"></a>正则化</h3><h4 id="字符组"><a href="#字符组" class="headerlink" title="字符组"></a>字符组</h4><p><code>[]</code>，字符组，匹配集合中的任意字符，如果想表示特殊字符则需要转义字符 <code>\</code></p><p> <code>^</code>，在字符组内表示取反，在字符组外表示匹配开头 <code>$</code>，匹配字符串的末尾</p><h4 id="快捷表示"><a href="#快捷表示" class="headerlink" title="快捷表示"></a>快捷表示</h4><p><code>\d</code>，数字</p><p><code>\s</code>，空格</p><p><code>\w</code>，字符（字母、数字、下划线）</p><p>大写为其取反 <code>\D</code> <code>\S</code> <code>\W</code> 表示非数字、非空格、非字符</p><p><code>.</code>，为任意单个字符，换行符除外</p><h4 id="限定符（控制重复次数）"><a href="#限定符（控制重复次数）" class="headerlink" title="限定符（控制重复次数）"></a>限定符（控制重复次数）</h4><p><code>{n}</code>，<code>{n,}</code>，<code>{n, m}</code> n, m 为非负整数，表示匹配重复次数或者重复区间</p><p><code>+</code>，匹配前面的子表达式一次或多次，相当于 <code>{1,}</code></p><p><code>*</code>，匹配前面的子表达式零次或多次，相当于 <code>{0,}</code></p><p><code>?</code> 可选字符，匹配0次或1次。也可表示非贪婪模式（最小匹配），常用于 <code>+ or *</code> 之后。例如需要匹配 <code>&lt;mark&gt;.*&lt;mark&gt;</code> 这样的模式，如果遇到字符串 <code>&lt;mark&gt;1&lt;mark&gt; &lt;mark&gt;2&lt;mark&gt;</code> 将会匹配整个字符串，而不能分 <code>&lt;mark&gt;1&lt;mark&gt;</code> 和 <code>&lt;mark&gt;2&lt;mark&gt;</code>，这时使用最小匹配即可完成 <code>&lt;mark&gt;.*？&lt;mark&gt;</code></p><h4 id="定位符"><a href="#定位符" class="headerlink" title="定位符"></a>定位符</h4><p><code>$</code>，匹配字符串的末尾</p><p><code>^</code>，匹配字符串的开头，但当 <code>^</code> 和 <script type="math/tex">` 同时出现时不代表开头和末尾分别匹配，而是代表整个字符串必须匹配该表达式，例如 `^python</script> 仅能匹配 python 这个字符串，而不能匹配开头末尾为 python 的字符串，像 python … python 是不被匹配的</p><p><code>\b</code>，匹配单词边界，即字与空格的位置</p><h4 id="分组"><a href="#分组" class="headerlink" title="分组"></a>分组</h4><p><code>()</code>，表示捕获分组，<code>()</code> 会把每个分组里的匹配的值保存起来， 多个匹配值可以通过转义符+数字 n 来查看，举个例子 <code>(expression_1)(expression_2)\2\1</code></p><p><code>(?:)</code>，不捕获，只使用分组功能</p><p><code>(express_1|express_2|express_3)</code>，选择，满足任一表达式即匹配</p><p><code>(?=express)</code>，正向先行断言，顺序从左往右看，判断在该位置的字符是否匹配表达式，如满足表达式则匹配整个表达式，如 <code>re(?=gular)</code> 只匹配 regular 中的 re 而不匹配其他单词中的 re</p><p><code>(?&lt;=express)</code>，正向后行断言，顺序从右往左，如 <code>(?&lt;=re)open</code> 只匹配 reopen 中的 open，不匹配其他单词中的 open</p><p><code>(?!express)</code>，逆向先行断言，不满足表达式则匹配</p><p><code>(?&lt;!express)</code>，逆向后行断言</p><h3 id="模块方法"><a href="#模块方法" class="headerlink" title="模块方法"></a>模块方法</h3><ol><li><p><code>re.match(pattern, string, flags=0)</code>，尝试从字符串的起始位置匹配一个模式，如果不是起始位置匹配成功的话，match()就返回none，匹配成功则返回匹配对象 MatchObject</p><p><code>flags</code> 为标志位，用于控制正则表达式的匹配方式，如：是否区分大小写，多行匹配等等，参考 <a href="https://www.runoob.com/python/python-reg-expressions.html#flags">正则表达式修饰符 - 可选标志</a></p><p>使用 group(num) 或 groups() 匹配对象函数来获取匹配表达式中的分组，即表达式中要有括号</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> reline <span class="token operator">=</span> <span class="token string">"Cats are smarter than dogs"</span> a <span class="token operator">=</span> re<span class="token punctuation">.</span>match<span class="token punctuation">(</span> <span class="token string">r'(.*) are (.*?) .*'</span><span class="token punctuation">,</span> line<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># Cats smarter</span><span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>groups<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># ('Cats', 'smarter')</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>group() 也可以一次输入多个组号，在这种情况下它将返回一个包含那些组所对应值的元组</p><p>如果没有分组，则直接使用 group() 调用，不用传参，默认传入0</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> reline <span class="token operator">=</span> <span class="token string">"Cats are smarter than dogs"</span> a <span class="token operator">=</span> re<span class="token punctuation">.</span>match<span class="token punctuation">(</span> <span class="token string">r'.* are .*? .*'</span><span class="token punctuation">,</span> line<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># print(a.group(0)) is the same</span><span class="token comment"># Cats are smarter than dogs</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>re.search(pattern, string, flags=0)</code>，扫描整个字符串并返回第一个成功的匹配对象 MatchObject</p></li><li><p><code>re.findall(pattern, string, flags=0)</code>，在字符串中找到正则表达式所匹配的所有<strong>子串</strong>，并返回一个列表，如果没有找到匹配的，则返回空列表</p></li><li><p><code>re.sub(pattern, repl, string, count=0, flags=0)</code> 用于替换字符串中的匹配项</p></li><li><p><code>re.compile(pattern, flags=0)</code> ，根据一个模式字符串和可选的标志参数生成一个正则表达式对象，该对象能够调用一系列的方法用于正则表达式匹配和替换</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> reline <span class="token operator">=</span> <span class="token string">"re short for regular expression"</span> pattern <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span> <span class="token string">r're'</span><span class="token punctuation">)</span>all_list <span class="token operator">=</span> pattern<span class="token punctuation">.</span>findall<span class="token punctuation">(</span>line<span class="token punctuation">)</span>sub <span class="token operator">=</span> pattern<span class="token punctuation">.</span>sub<span class="token punctuation">(</span><span class="token string">'RE'</span><span class="token punctuation">,</span> line<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>all_list<span class="token punctuation">)</span><span class="token comment"># ['re', 're', 're']</span><span class="token keyword">print</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span><span class="token comment"># RE short for REgular expREssion</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><h3 id="时间和日期"><a href="#时间和日期" class="headerlink" title="时间和日期"></a>时间和日期</h3><h3 id="进程、线程"><a href="#进程、线程" class="headerlink" title="进程、线程"></a>进程、线程</h3><h3 id="Python-爬虫"><a href="#Python-爬虫" class="headerlink" title="Python 爬虫"></a>Python 爬虫</h3>]]></content>
      
      
      <categories>
          
          <category> 编程 </category>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 教程 </tag>
            
            <tag> Python </tag>
            
            <tag> 拓展 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python 2 数据结构</title>
      <link href="/archives/760ade0a.html"/>
      <url>/archives/760ade0a.html</url>
      
        <content type="html"><![CDATA[<h1 id="Python-String-amp-Data-Structure"><a href="#Python-String-amp-Data-Structure" class="headerlink" title="Python String &amp; Data Structure"></a>Python String &amp; Data Structure</h1><h2 id="String-字符串"><a href="#String-字符串" class="headerlink" title="String 字符串"></a>String 字符串</h2><p>python 用单引号 <code>''</code> 或者双引号 <code>""</code> 来表示字符串，三引号 <code>'''</code> 允许跨多行的字符串</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">s1 <span class="token operator">=</span> <span class="token string">'hello, world!'</span>s2 <span class="token operator">=</span> <span class="token string">"hello, world!"</span><span class="token comment"># 以三个双引号或单引号开头的字符串可以折行</span>s3 <span class="token operator">=</span> <span class="token triple-quoted-string string">"""hello, world!"""</span><span class="token keyword">print</span><span class="token punctuation">(</span>s1<span class="token punctuation">,</span> s2<span class="token punctuation">,</span> s3<span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>字符串中可以使用反斜杠 <code>\</code> 表示转义，如 <code>\n, \t</code> 等转义字符，如果希望输入原字符串可在引号前加 r 字母</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">s1 <span class="token operator">=</span> <span class="token string">'\n\\hello, world!\\\n'</span>s2 <span class="token operator">=</span> <span class="token string">r'\n\\hello, world!\\\n'</span><span class="token keyword">print</span><span class="token punctuation">(</span>s1<span class="token punctuation">,</span> s2<span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="字符串运算"><a href="#字符串运算" class="headerlink" title="字符串运算"></a>字符串运算</h3><p>字符串接受 <code>+, *, [:], in</code> 等运算，对字符串内容进行合并、重复、截取、成员运算</p><h3 id="字符串格式化"><a href="#字符串格式化" class="headerlink" title="字符串格式化"></a>字符串格式化</h3><p>当字符串中需要表示变量时，格式化表示将会非常有用，基本用法如下</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">num<span class="token punctuation">,</span> pai <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3.1415926</span>s <span class="token operator">=</span> <span class="token string">'here is a number %d, and pai is %.2f'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>num<span class="token punctuation">,</span> pai<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>基本逻辑就是，一个萝卜一个坑，想要在字符串中插入变量，就在需要插入的地方用相应的符号替代，然后在字符串后用 <code>%</code> 指明变量</p><p>这里列几个常用的替代符号：<code>%d, %f, %s, %e</code>，最后一个 <code>%e</code> 表示科学计数</p><h3 id="字符串内建函数"><a href="#字符串内建函数" class="headerlink" title="字符串内建函数"></a>字符串内建函数</h3><p>字符串自带了很多方便的方法，这里列举几个常用的，string 代表某个字符串</p><ol><li><p><code>sting.count(str)</code>，字符串中有多少个 str</p></li><li><p><code>string.find(str)</code>，str 在字符串中的哪个位置，如不存在返回-1</p></li><li><p><code>string.format(*args, **kwargs)</code>，<strong>增强版格式化方法，非常推荐使用该函数来格式化字符串</strong>，参考 <a href="https://www.runoob.com/python/att-string-format.html">菜鸟教程</a></p></li><li><p><code>string.split(str)</code>，<strong>按照 str 分隔字符串，返回一个列表</strong></p></li><li><p><code>string.replace(str1, str2)</code>，将 str1 替换为 str2</p></li></ol><h2 id="List-列表"><a href="#List-列表" class="headerlink" title="List 列表"></a>List 列表</h2><p>列表是最基本的数据结构，可以顺序存储不同的对象。在 python 中创建列表：</p><ol><li>直接赋值 <code>LIST = []</code></li><li>类型转换 <code>list(tuple)</code></li></ol><h3 id="列表运算"><a href="#列表运算" class="headerlink" title="列表运算"></a>列表运算</h3><p>列表也接受：<code>+, *, [:], in</code> 等运算符</p><h3 id="python-内置函数操作列表"><a href="#python-内置函数操作列表" class="headerlink" title="python 内置函数操作列表"></a>python 内置函数操作列表</h3><ol><li><code>len(list)</code></li><li><code>max(list)</code> &amp; <code>min(list)</code></li><li><code>for i in list</code> &amp; <code>for index, value in enumerate(list)</code>，对列表进行循环遍历</li></ol><h3 id="列表内建函数"><a href="#列表内建函数" class="headerlink" title="列表内建函数"></a>列表内建函数</h3><ol><li><code>list.append(obj)</code> &amp; <code>list.insert(index, obj)</code></li><li><code>list.remove(obj)</code> &amp; <code>list.pop()</code></li><li><code>list.sort(reverse=False)</code>，将列表按照上升值排列，返回 None</li><li><code>list.copy()</code></li></ol><h2 id="Tuple-元组"><a href="#Tuple-元组" class="headerlink" title="Tuple 元组"></a>Tuple 元组</h2><p>元组和列表类似，也是线性表的一种，不过在元组建立过后，其成员是不能够被修改的，增加和删除成员也是不支持的，在 python 中创建元组：</p><ol><li>直接赋值 <code>TUPLE = (1,)</code></li><li>类型转换 <code>tuple(list)</code></li></ol><h3 id="元组运算"><a href="#元组运算" class="headerlink" title="元组运算"></a>元组运算</h3><p>元组支持 <code>+, *, [:], in</code> 等运算符，但注意，由于元组成员不能被修改的性质，所以不能够对索引值进行新的赋值。虽然不能增加成员，但是仍可以使用 <code>+</code> 运算，将两个元组合并</p><h3 id="python-内置函数操作元组"><a href="#python-内置函数操作元组" class="headerlink" title="python 内置函数操作元组"></a>python 内置函数操作元组</h3><p>在列表当中能用的操作也能用作元组，毕竟元组可以看作不可修改成员的列表</p><h3 id="元组内建函数"><a href="#元组内建函数" class="headerlink" title="元组内建函数"></a>元组内建函数</h3><p>元组的内建函数就不如列表的丰富了，可以说元组有的，列表都有。下面列举两个</p><ol><li><p><code>tuple.count(obj)</code></p></li><li><p><code>tuple.index(obj)</code>，返回 obj 在元组中的索引数，若元组中不存在 obj 则报错</p></li></ol><p>最后提一句，为什么有了列表还需要有元组这样的数据类型呢？部分原因是元组可以用于保护一些数据，让其不被修改，并且创建元组在时间和空间上的代价更小</p><h2 id="Dict-字典"><a href="#Dict-字典" class="headerlink" title="Dict 字典"></a>Dict 字典</h2><p>字典也是一种可变容器，其不是通过 index 索引获得容器内的对象，而是通过 key: value 对，将 key 映射到其对应的 value。换句话说就是通过 key 来获得容器内的对象。很明显这样的映射性质需要 key 是唯一的，同时 python 也要求 key 是不可变的，如数字，字符串，元组。创建字典的方式：</p><ol><li><p>直接赋值 <code>DICT = {key_1：value_1}</code></p></li><li><p>通过内置函数 <code>dict()</code> 创建：</p><ul><li><p><code>dict(**kwargs)</code>，传入 key=value 对，例如 <code>DICT = dict(a=1, b=2)</code>，注意这里 key 不用转化为字符串形式</p></li><li><p><code>dict(iterable, **kwargs)</code>，传入可迭代对象，其中可迭代对象中的成员必须为二元元组，同时也可任意传入 key=value 对，下面举一个例子</p></li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python">ITER <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token comment"># ITER 也可以通过 python 内置函数 zip() 生成</span><span class="token comment"># ITER = zip(['a', 'b'], [1, 2])</span>DICT <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>ITER<span class="token punctuation">,</span> c<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>dict.fromkeys(iterable, value)</code>，传入可迭代对象，比如列表、元组都可以，将这些顺序表的成员作为 key 创建字典，并且所有的 value 都统一初始化</li></ul></li></ol><h3 id="字典运算"><a href="#字典运算" class="headerlink" title="字典运算"></a>字典运算</h3><p>字典支持 <code>[], in</code> 运算，显然 <code>+, *</code> 运算对于字典是没有意义的。而 <code>[]</code> 运算区别于列表和元组，索引值不是数字而是 key</p><h3 id="python-内置函数操作字典"><a href="#python-内置函数操作字典" class="headerlink" title="python 内置函数操作字典"></a>python 内置函数操作字典</h3><ol><li><p><code>len(dict)</code></p></li><li><p><code>for i in dict</code>，注意这样形式的循环只会对字典中的 key 进行循环遍历。如果想要同时对 key 和 value 循环遍历则需要调用字典内建函数 <code>dict.items()</code> 返回可遍历的 (key, value) 元组数组</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">DICT <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>a<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> b<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> DICT<span class="token punctuation">:</span><span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token comment"># result: a b</span><span class="token keyword">for</span> key<span class="token punctuation">,</span>value <span class="token keyword">in</span> DICT<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s:%d'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># result: a:1 b:2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><h3 id="字典内建函数"><a href="#字典内建函数" class="headerlink" title="字典内建函数"></a>字典内建函数</h3><ol><li><code>dict.get(key, default=None)</code>，返回指定键的值，如果 key 值不在字典中则自动添加 key 并返回 default 值作为其 value。这既是一种获取 value 的方法，也是创建新 key 的方法。比较类似的，如果字典中不存在某个 key，那么使用 <code>dict[key] = value</code> 也会自动在字典中创建 key, value 对</li><li><code>dict.items()</code> 返回可遍历的 (key, value) 元组组成的列表</li><li><p><code>dict.keys()</code> &amp; <code>dict.values()</code> 返回 key/value 列表</p></li><li><p><code>dict.pop(key, default)</code> &amp; <code>dict.clear()</code> 前者删除 key 值，并返回该 key 对应 value，若不存在该 key 则返回 default。后者清空字典所有内容</p></li><li><code>dict.update(dict_new)</code> 将新字典里的 (key, value) 更新到本字典中</li><li><code>dict.copy()</code></li></ol><h2 id="Set-集合"><a href="#Set-集合" class="headerlink" title="Set 集合"></a>Set 集合</h2><p>集合是一个无序的不重复元素序列，且元素性质是不可变的，如数字，字符串，元组。创建集合有如下方法：</p><ol><li><p>直接赋值 <code>SET = {1, 2, 3}</code> 这里必须有元素，如果没有则会创建一个字典</p></li><li><p>类型转换 <code>set(iterable)</code>，传入可迭代对象，可以是列表、元组，也可以不传参数以创建空集合</p></li></ol><h3 id="集合运算"><a href="#集合运算" class="headerlink" title="集合运算"></a>集合运算</h3><p>集合运算相比于前面的数据结构就要更多了，除了基础的 <code>[], in</code> 这样的索引和成员运算，还有 <code>&amp;, |, -, ^</code> 交集、并集、差集、异或（对称差集）</p><h3 id="python-内置函数操作集合"><a href="#python-内置函数操作集合" class="headerlink" title="python 内置函数操作集合"></a>python 内置函数操作集合</h3><p>在列表当中能用的操作也能用作集合，毕竟集合可以粗略看作要求元素唯一的列表</p><h3 id="集合内建函数"><a href="#集合内建函数" class="headerlink" title="集合内建函数"></a>集合内建函数</h3><ol><li><code>set.add()</code></li><li><code>set.remove(obj)</code> &amp; <code>set.clear()</code> 前者删除指定元素，后者清空所有</li><li><code>set.issubset(set_new)</code> &amp; <code>set.issuperset(set_new)</code> &amp; <code>set.isdisjoint(set_new)</code> 判断是否是集合的子集、超集，以及是否是不相交的</li></ol><h2 id="补充：迭代器，生成式，生成器"><a href="#补充：迭代器，生成式，生成器" class="headerlink" title="补充：迭代器，生成式，生成器"></a>补充：迭代器，生成式，生成器</h2><p>这一部分将会涉及到部分面向对象的内容，以及 python 的特殊方法。之前就是因为缺少这两部分的内容的了解，一直对迭代器、生成器不理解，现在进行整理。参考资料：<a href="https://www.runoob.com/python3/python3-iterator-generator.html">迭代器与生成器</a> <a href="https://www.runoob.com/w3cnote/python-yield-used-analysis.html">浅析 yield</a> </p><h3 id="iterator-迭代器"><a href="#iterator-迭代器" class="headerlink" title="iterator 迭代器"></a>iterator 迭代器</h3><p>其实在之前就已经见到了迭代器了，列表、元组、字典这些数据结构都能够在 for-in 循环的时候自动生成迭代器对象。在一个类中如何实现迭代器对象？python 提供了特殊方法 <code>__iter__()</code> 和 <code>__next__()</code> 实现创造迭代器对象，当类中有 <code>__iter__()</code> 方法时，就意味着这个类的实例不是一个普通的对象，而是一个迭代器对象</p><p>这里提一下 python 类中 <code>__function__()</code> 形式的函数被成为称为特殊函数，在特定条件发生时运行，而 <code>__iter__()</code> 和 <code>__next__()</code> 则会在 for-in 循环中被调用。下面通过迭代器实现一个简单 <code>ListDemo</code> 了解其内部逻辑</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">ListDemo</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>args <span class="token operator">=</span> args        self<span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">__iter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># 函数内可以做一些初始化操作</span>        self<span class="token punctuation">.</span>index <span class="token operator">=</span> <span class="token number">0</span>        <span class="token comment"># 最后必须返回迭代器对象本身</span>        <span class="token keyword">return</span> self    <span class="token keyword">def</span> <span class="token function">__next__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> self<span class="token punctuation">.</span>index <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>count<span class="token punctuation">:</span>            result <span class="token operator">=</span> self<span class="token punctuation">.</span>args<span class="token punctuation">[</span>self<span class="token punctuation">.</span>index<span class="token punctuation">]</span>            self<span class="token punctuation">.</span>index <span class="token operator">+=</span> <span class="token number">1</span>            <span class="token keyword">return</span> result        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token comment"># 循环结束的标志</span>            <span class="token keyword">raise</span> StopIteration<span class="token comment"># 运行一下</span>LIST <span class="token operator">=</span>  ListDemo<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> LIST<span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>整个迭代器在循环中到底在怎么运行呢？首先 <code>ListDemo</code> 先运行了 <code>__iter__()</code> 进行了初始化，返回迭代器对象本身。在循环当中， <code>ListDemo</code> 类在重复调用 <code>__next__()</code> 函数，并返回结果给 <code>i</code>，最后遇到 <code>StopIteration</code> 结束循环</p><p>python 还有内置函数 <code>iter()</code>  &amp; <code>next()</code> 用于直接调用 <code>__iter__()</code> &amp; <code>__next__()</code> 而不需要遇到循环才触发</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">LIST <span class="token operator">=</span>  ListDemo<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span>iterator <span class="token operator">=</span> <span class="token builtin">iter</span><span class="token punctuation">(</span>LIST<span class="token punctuation">)</span><span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">next</span><span class="token punctuation">(</span>iterator<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">except</span> StopIteration<span class="token punctuation">:</span>        <span class="token keyword">break</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="generator-生成器"><a href="#generator-生成器" class="headerlink" title="generator 生成器"></a>generator 生成器</h3><p>如果说迭代器是定义在类当中的，那么生成器就是可以直接定义在普通函数中的迭代器。通过 <code>yield</code> 关键字能够将普通函数变为生成器，它将实现之前的  <code>__iter__()</code> 和 <code>__next__()</code> 功能。每次遇到 yield 时函数会暂停并保存当前所有的运行信息，并返回一个 <code>yield</code> 的值, 并在下一次执行 next() 方法时从当前 <code>yield</code> 位置继续运行。下面实现一个斐波那契数列函数，来进一步理解其内部逻辑</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>    a<span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span>    count <span class="token operator">=</span> <span class="token number">0</span>     <span class="token keyword">while</span> count <span class="token operator">&lt;</span> n<span class="token punctuation">:</span>        <span class="token keyword">yield</span> a        a_ <span class="token operator">=</span> a        a <span class="token operator">=</span> b        b <span class="token operator">=</span> a_ <span class="token operator">+</span> b        count <span class="token operator">+=</span> <span class="token number">1</span>iterator <span class="token operator">=</span> fibonacci<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> iterator<span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>类比一下类中的迭代器，能够更快速的理解。通过 <code>yield</code> 声明这是一个生成器，这样会在遇到 for-in 循环的时候不断地调用 next() 方法并返回 <code>yield</code> 值 <code>a</code> 赋给 <code>i</code>。区别于类中的 <code>__next__()</code>  方法是重复 <code>__next__()</code> 函数内的代码，生成器运行 <code>next()</code> 函数，则会从当前 <code>yield</code> 处继续运行，直到碰到下一个 <code>yield</code> </p><h3 id="生成式"><a href="#生成式" class="headerlink" title="生成式"></a>生成式</h3><p>生成式是生成器的一个简单应用，可以用于生成列表、字典</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 使用生成式创建列表和字典</span>f <span class="token operator">=</span> <span class="token punctuation">[</span>x<span class="token operator">**</span><span class="token number">2</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">]</span>f <span class="token operator">=</span> <span class="token punctuation">[</span>x <span class="token operator">+</span> y <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token string">'ABCDE'</span> <span class="token keyword">for</span> y <span class="token keyword">in</span> <span class="token string">'1234567'</span><span class="token punctuation">]</span>f <span class="token operator">=</span> <span class="token punctuation">{</span>x<span class="token punctuation">:</span>x<span class="token operator">**</span><span class="token number">2</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment"># 生成式本质上是一个生成器</span>f <span class="token operator">=</span> x <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> f<span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 编程 </category>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 教程 </tag>
            
            <tag> Python </tag>
            
            <tag> 数据结构 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python 1 基础</title>
      <link href="/archives/2bc936a0.html"/>
      <url>/archives/2bc936a0.html</url>
      
        <content type="html"><![CDATA[<h1 id="Python-Basic"><a href="#Python-Basic" class="headerlink" title="Python Basic"></a>Python Basic</h1><p>在进行深度学习的实践中，越发感觉到自己的 python 理论不足，想要重新快速整理一下 python，建立一个比较完整但不细致的框架供自己之后复习。整理资源来自于 <a href="https://github.com/jackfrued/Python-100-Days">python 100 days</a> 和 <a href="https://www.runoob.com/python3/python3-tutorial.html">菜鸟教程</a> </p><h2 id="什么是-python"><a href="#什么是-python" class="headerlink" title="什么是 python?"></a>什么是 python?</h2><p>一种编程语言，以缩进分块，有着活跃的社区和丰富的三方库，在人工智能、网络爬虫、自动运维、Web开发等领域都有广泛应用</p><p>在我的狭隘理解当中 python = python.exe。当我在使用 anaconda 时，会有不同的环境，一般每一个环境都有自己的 python.exe，如果我想要运行一个 python 脚本，那么需要选择一个 python.exe/解释器 /interpreter 来执行这个脚本</p><h2 id="安装-python"><a href="#安装-python" class="headerlink" title="安装 python"></a>安装 python</h2><p>强烈建议直接安装 anaconda，简称 conda。这是一个流行的包管理工具，其管理奥义就是创建”环境“。环境中可以下载包，管理包，且每个环境都可以安装自己的 python 解释器。这就意味着如果你想要使用不同版本 python 解释器，conda 可以做到，只需要创建多个 conda 环境，想用哪个版本就切到哪个版本的 conda 环境，同时不同的环境可以下载不同的包，实现不一样的功能</p><h2 id="python-开发工具"><a href="#python-开发工具" class="headerlink" title="python 开发工具"></a>python 开发工具</h2><ol><li>python.exe，直接双击打开就可以开始写 python 代码了，最原生的交互式开发工具，懂我意思？</li><li>ipython，比原生开发工具好一点</li><li>pycharm，专业软件，非常好用</li><li>vscode，宇宙第一开发工具，懂？</li></ol><h2 id="变量与类型"><a href="#变量与类型" class="headerlink" title="变量与类型"></a>变量与类型</h2><p>现在正式开始对 python 脚本进行了解</p><p>介绍几个基础数据类型：</p><ol><li>int </li><li>float</li><li>string</li><li>bool</li><li>complex，很少用</li></ol><h3 id="变量命名"><a href="#变量命名" class="headerlink" title="变量命名"></a>变量命名</h3><p>规则：以字母，下划线，数字构成，数字不能开头，字母大小写敏感</p><p>PEP 8要求：</p><ul><li>一般用小写字母拼写，多个单词用下划线连接</li><li>受保护的实例属性用单个下划线开头（后面会讲到）</li><li>私有的实例属性用两个下划线开头（后面会讲到）</li></ul><h3 id="变量的使用"><a href="#变量的使用" class="headerlink" title="变量的使用"></a>变量的使用</h3><p>python 中变量的创建不需要声明，直接赋值即创建。<strong>还可以使用内置函数，对变量类型进行转换：int(), float(), str()…使用 type() 查看变量类型</strong></p><p><strong>再介绍两个基础函数，print() &amp; input()，前者用于打印，后者用于接收键盘输入字符串</strong></p><h4 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h4><p>下表大致按照优先级从高到低的顺序列出了所有的运算符</p><p><img src="/archives/2bc936a0/image-20210828224442524.png" style="zoom: 67%;"></p><p>比较陌生的是位运算符，身份运算符，成员运算符，需要重点理解一下，参考 <a href="https://www.runoob.com/python/python-operators.html">菜鸟教程</a></p><h2 id="分支与循环"><a href="#分支与循环" class="headerlink" title="分支与循环"></a>分支与循环</h2><p>分支使用 if…elif…else 形式实现分支</p><p>循环有两种形式：for-in 和 while，重点提一下 for-in，用来对一个容器进行迭代非常方便，这个容器可以是列表，字典，元组等具有迭代功能的容器。使用 <code>break &amp; continue</code> 来跳出循环</p><h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><p>python 使用 def 关键字声明函数，以 return 结束，如果没有 return 默认返回 None。在 python 中，函数的参数可以有默认值，也支持使用可变参数 *args, **kwargs</p><h3 id="函数参数"><a href="#函数参数" class="headerlink" title="函数参数"></a>函数参数</h3><h4 id="可更改对象与不可更改对象"><a href="#可更改对象与不可更改对象" class="headerlink" title="可更改对象与不可更改对象"></a>可更改对象与不可更改对象</h4><p>由于 python 中的变量不像 C 语言一样需要声明，所以 python 函数参数是传值还是引用，也和 C 语言不一样。由于 python 的变量不需要声明，那么 python 的变量与 C 语言变量有着本质的区别，举个例子</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">a <span class="token operator">=</span> <span class="token number">1</span>b <span class="token operator">=</span> <span class="token number">1</span><span class="token keyword">print</span><span class="token punctuation">(</span>a <span class="token keyword">is</span> b<span class="token punctuation">)</span><span class="token comment"># True</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>可以看到 a 和 b 其实是来自同一个对象，更改了 a 的值，b 也一起被更改了，就好像 a 和 b 的“指针”都指向了1</p><p>参考这个 <a href="http://winterttr.me/2015/10/24/python-passing-arguments-as-value-or-reference/">博客</a>， “类型是属于对象的，而不是变量的”，python 中的变量更像是一个“指针”，是对对象的引用，一个变量可以指向任意的对象。1是属于 int 对象的，而不是属于 a, b 变量的</p><p>现在回到参数传递这个话题，我认为可以认为是“引用”传递，但情况分为两种：</p><ol><li>传递参数为可更改对象 (mutable)，例如 list, dict, np.array，在函数中<strong>修改</strong>参数值时，会改变原变量；<strong>赋值</strong>新值时，不会改变原变量</li><li>传递参数为不可更改对象 (immutable)，例如 strings, numbers, tuples，在函数中<strong>赋值</strong>新值时，不会改变原变量，即原变量所指对象不变</li></ol><p>举个例子来理解一下</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">a <span class="token operator">=</span> <span class="token number">1</span>b <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>c <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'this is c'</span><span class="token punctuation">]</span><span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">:</span>    a <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>    b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>    c <span class="token operator">=</span> <span class="token number">0</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token comment"># -1 [-1, 2, 3] 0</span>    test<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token comment"># 1 [-1, 2, 3] ['this is c']</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="参数类型"><a href="#参数类型" class="headerlink" title="参数类型"></a>参数类型</h4><p>这里参考 <a href="https://cloud.tencent.com/developer/article/1640717">python 参数，腾讯云</a> 进行整理。python 函数的形参分为四种：</p><ul><li>必需参数：平时最常用的，必传确定数量的参数</li><li>缺省参数：在调用函数时可以传也可以不传，如果不传将使用默认值</li><li>可变参数：可变长度参数，通常用 <code>*args</code> 表示</li><li>关键字参数：长度可变，但需要以 key=value 对形式传递，通常用 <code>**kwargs</code> 表示</li></ul><p>对于定义函数时，参数位置的强制要求有以下两点：</p><ol><li>缺省参数必须在必须参数之后</li><li>关键字参数必须在最后</li></ol><p>在给函数传入参数时，可以传入两种类型：</p><ul><li>位置参数：直接传入实参，传入位置与函数定义时的参数位置相同</li><li>关键字参数：以 <code>param=value</code> 形式出现，可以忽略函数定义时参数的位置</li></ul><p>python 强制要求位置参数必须在关键字参数之前</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span>a<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> b<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> c<span class="token operator">=</span><span class="token string">'c'</span><span class="token punctuation">,</span> d<span class="token operator">=</span><span class="token string">'d'</span><span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'必须参数: %s, %s'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'缺省参数: %s, %s'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>c<span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'可变参数:'</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'关键字参数:'</span><span class="token punctuation">,</span> kwargs<span class="token punctuation">)</span>    test<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> e<span class="token operator">=</span><span class="token string">'e'</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'--------------------------'</span><span class="token punctuation">)</span>test<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> b<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> c<span class="token operator">=</span><span class="token string">'C'</span><span class="token punctuation">,</span> e<span class="token operator">=</span><span class="token string">'e'</span><span class="token punctuation">)</span><span class="token comment"># 上面过早传入了关键字参数，导致无法传入可变参数 *args</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面冒号 <code>:</code> 之后表示的是作者建议的传入参数类型，箭头 <code>-&gt;</code> 之后为建议的函数返回类型</p><h3 id="解包"><a href="#解包" class="headerlink" title="解包"></a>解包</h3><p>当需要传入的多个参数被打包在了一个元组/字典中，可以通过解包的方式，直接把元组/字典作为可变参数/关键字参数，传入到函数当中</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">args <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>kwargs <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>b<span class="token operator">=</span><span class="token string">'b'</span><span class="token punctuation">,</span> a<span class="token operator">=</span><span class="token string">'a'</span><span class="token punctuation">,</span> c<span class="token operator">=</span><span class="token string">'c'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span>test<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token comment"># 1 2 3</span>test<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token comment"># a b c</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>从上面的代码中可以看到，解包元组用  <code>*</code>，解包字典用 <code>**</code></p><h3 id="lambda-匿名函数"><a href="#lambda-匿名函数" class="headerlink" title="lambda 匿名函数"></a>lambda 匿名函数</h3><p>所谓匿名，意即不再使用 def 语句这样标准的形式定义一个函数。lambda 只是一个表达式，函数体比 def 简单很多，所以只能封装有限的逻辑。lambda 函数的语法只有一句</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">lambda</span> <span class="token punctuation">[</span>args_list<span class="token punctuation">]</span><span class="token punctuation">:</span> expression<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><code>expression</code> 可以是表达式，也可以是一个函数。下面举一个例子来使用 lambda 函数</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">add <span class="token operator">=</span> <span class="token keyword">lambda</span> a<span class="token punctuation">,</span> b<span class="token punctuation">:</span> a <span class="token operator">+</span> b<span class="token keyword">print</span><span class="token punctuation">(</span>add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> a<span class="token operator">**</span>b<span class="token comment"># expression can be a function</span>exp_of_2 <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> exp<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>exp_of_2<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="模块化管理"><a href="#模块化管理" class="headerlink" title="模块化管理"></a>模块化管理</h3><p>通过模块管理 python 文件/函数将会变得非常方便，需要使用的函数，使用关键字 <code>import</code> 导入即可，导入方法有如下：</p><ol><li><code>import module</code>：导入模块，以 <code>module.func</code> 使用模块中的函数等内容</li><li><code>import module ad md</code>：导入模块，命名为 md，使用方法类似1</li><li><code>from module import func</code>：直接从模块中导入函数，可直接使用 func()</li></ol><p>当我们使用 import 语句的时候，Python解释器是怎样找到对应的文件的呢？这就涉及到 Python 的搜索路径，搜索路径是由一系列目录名组成的，Python 解释器就依次从这些目录中去寻找所引入的模块。搜索路径被存储在 sys 模块中的 path 变量，此变量为一个列表</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> sys<span class="token keyword">for</span> path <span class="token keyword">in</span> sys<span class="token punctuation">.</span>path<span class="token punctuation">:</span><span class="token keyword">print</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token comment"># d:\VScodeProjects\TestProj</span><span class="token comment"># D:\LenovoSoftstore\Anaconda\python38.zip</span><span class="token comment"># D:\LenovoSoftstore\Anaconda\lib\site-packages</span><span class="token comment"># ...MORE</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>一般 <code>sys.path</code> 列表的第一个即为当前文件所在文件夹</p><h4 id="if-name-‘-main-‘"><a href="#if-name-‘-main-‘" class="headerlink" title="if __name__ = ‘__main__‘"></a>if __name__ = ‘__main__‘</h4><p>需要说明的是，如果导入的模块中有可执行的代码，那么在导入模块时就会执行。但事实上，我们可能不希望执行这些代码，只想要导入这个函数，例如下面的模块</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># module.py</span><span class="token keyword">def</span> <span class="token function">module_func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'this is a module'</span><span class="token punctuation">)</span>module_func<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>此时如果在另一个 python 文件中 <code>import module</code> 将会看到输出 <code>this is a module</code>。为了避免这种情况，需要在模块中限定这些可执行代码，仅在该模块直接运行的时候运行，而不在导入的时候运行。可采取如下形式</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># module.py</span><span class="token keyword">def</span> <span class="token function">module_func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'this is a module'</span><span class="token punctuation">)</span><span class="token comment"># __name__是Python中一个隐含的变量它代表了模块的名字</span><span class="token comment"># 只有被Python解释器直接执行的模块的名字才是__main__</span><span class="token keyword">if</span> __name__ <span class="token operator">=</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>module_func<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里提到了一个隐含变量 <code>__name__</code>，是由 python 自动生成的变量，不需要人为定义。在 python 中有其他的隐含变量，例如 <code>__doc__</code> 用于保存对象的说明性文档，通过关键字 <code>?</code> 就能调出文档，<a href="https://blog.csdn.net/u011699626/article/details/107981264">CSDN doc参考</a></p>]]></content>
      
      
      <categories>
          
          <category> 编程 </category>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 教程 </tag>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windows 软件推荐</title>
      <link href="/archives/c92482f1.html"/>
      <url>/archives/c92482f1.html</url>
      
        <content type="html"><![CDATA[<h2 id="Windows-的软件"><a href="#Windows-的软件" class="headerlink" title="Windows 的软件"></a>Windows 的软件</h2><ol><li>Listary，搜索神器</li><li>potplayer + 简洁皮肤定制</li><li>bandzip</li><li>bilibili 直播姬，OBS，对于 OBS 的简要教程放在文末</li><li>clash</li><li>滴答清单</li><li>chrome</li><li>印象笔记</li><li>typora</li><li>latex</li><li>vs code</li><li>zotero</li><li>git</li><li>QQ 微信 百度网盘 阿里云盘</li><li>ps pr</li><li><p>youtube-dl，支持 pip 下载，该软件可以下载 youtube 视频。通过更改其 option 文件可以改一些默认的 option</p><ol><li>更改了下载默认路径，参考靠 <a href="https://stackoverflow.com/questions/32482230/how-to-set-up-default-download-location-in-youtube-dl/34958672">StackOverflow</a> 将 <code>--output</code> 的 default 改为 <code>r'D:\Downloads\%(title)s-%(id)s.%(ext)s'</code></li><li>更改了 <code>--proxy</code> 加速下载</li></ol></li><li>bilibili-evolved，这是一个 github 项目能够更改 bilibili 网页分布，并且能下载 bilibili 视频，如果批量下载的话需要进行一些设置，参考 <a href="https://www.xstui.com/read/942">link</a></li><li>arctime，添加字幕</li><li>WinSCP，Xshell</li><li>SpaceSniffer，查看存储空间</li><li>utorrent</li><li>LinuxReader，方便双系统在 Win 中获取 Linux 系统的文件</li></ol><h2 id="OBS-简要教程"><a href="#OBS-简要教程" class="headerlink" title="OBS 简要教程"></a>OBS 简要教程</h2><p>主要根据 <a href="https://www.bilibili.com/video/BV1wt4y1Q7rV?p=1">bilibili</a> 进行学习</p><h3 id="界面介绍"><a href="#界面介绍" class="headerlink" title="界面介绍"></a>界面介绍</h3><p><img src="/archives/c92482f1/image-20210916200411505.png" alt="image-20210916200411505" style="zoom:80%;"></p><ol><li><p>来源</p><p>首先 OBS 最基本的功能就是录制电脑屏幕/窗口。我们需要告诉 OBS 需要添加哪些信息源，这就是<strong>来源</strong>窗口的功能。比如上图中添加了<strong>显示器采集</strong>，这个来源就能够记录你的屏幕内所显示的内容</p></li><li><p>场景</p><p><strong>OBS 在一个场景中可以添加多个来源</strong>，并且调整这些来源如何显示各个来源，比如我们希望最终的画面左边为<strong>显示器采集</strong>内容，右边为<strong>游戏源</strong>。我们也可以创建多个场景，在直播的时候可以直接选择某个场景，或者在场景之间切换</p></li><li><p>混音器</p><p>用于采集电脑声音和麦克风声音</p></li></ol><h3 id="设置"><a href="#设置" class="headerlink" title="设置"></a>设置</h3><p>掌握以上逻辑就能很好地使用 OBS 了，当然进一步使用肯定要对<strong>设置</strong>进行调整，以下为我的设置</p><p><img src="/archives/c92482f1/image-20210916201726253.png" alt="image-20210916201726253" style="zoom: 67%;"></p><p>比较重要的就是输出设置，串流代表你直播时采集画面的质量，录像即代表录制画面的质量。下面看看这几个参数</p><ol><li>码率，越高视频质量越高，一般推荐 2k-8k 之间</li><li><p>编码器，一般有两个选项，x264 代表用 CPU 进行编码，其他硬件则多为 GPU</p></li><li><p>音频比特率，一般为160或320</p></li></ol><p>面板中的其他设置，例如：推流用于设置直播平台服务器，视频还可以进一步设置视频的分辨率、帧数</p>]]></content>
      
      
      <categories>
          
          <category> 生活 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 推荐 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MMDetection Quick Run</title>
      <link href="/archives/6f4f5bd8.html"/>
      <url>/archives/6f4f5bd8.html</url>
      
        <content type="html"><![CDATA[<h1 id="MMDetection-Quick-Run"><a href="#MMDetection-Quick-Run" class="headerlink" title="MMDetection Quick Run"></a>MMDetection Quick Run</h1><p>整理自 <a href="https://mmdetection.readthedocs.io/en/latest/index.html">MMDetection 官方文档</a></p><h2 id="Part-1-Inference-and-train-with-existing-models-and-standard-datasets"><a href="#Part-1-Inference-and-train-with-existing-models-and-standard-datasets" class="headerlink" title="Part 1, Inference and train with existing models and standard datasets"></a>Part 1, Inference and train with existing models and standard datasets</h2><blockquote><p>MMDetection provides hundreds of existing and existing detection models in <a href="https://mmdetection.readthedocs.io/en/latest/model_zoo.html">Model Zoo</a>, and supports multiple standard datasets, including Pascal VOC, COCO, CityScapes, LVIS, etc.</p></blockquote><p>这一部分将简要介绍，如何使用 MMDetection 对 Model zoo 中的模型进行测试和训练</p><h3 id="Inference-with-existing-models"><a href="#Inference-with-existing-models" class="headerlink" title="Inference with existing models"></a>Inference with existing models</h3><blockquote><p>By inference, we mean using trained models to detect objects on images. In MMDetection, a model is defined by a configuration file and existing model parameters are save in a checkpoint file.</p></blockquote><p>这里介绍了 MMDetection 模型表示的基本逻辑：<code>configuration file</code>+ <code>checkpoint file</code> </p><p>文档以 Faster R-CNN 为例子，如何进行目标检测推理</p><blockquote><p>To start with, we recommend <a href="https://github.com/open-mmlab/mmdetection/tree/master/configs/faster_rcnn">Faster RCNN</a> with this <a href="https://github.com/open-mmlab/mmdetection/blob/master/configs/faster_rcnn/faster_rcnn_r50_fpn_1x_coco.py">configuration file</a> and this <a href="https://download.openmmlab.com/mmdetection/v2.0/faster_rcnn/faster_rcnn_r50_fpn_1x_coco/faster_rcnn_r50_fpn_1x_coco_20200130-047c8118.pth">checkpoint file</a>. It is recommended to download the checkpoint file to <code>checkpoints</code> directory.</p></blockquote><p>Q: config files 名字的意义是什么？在 config 对应的文件夹中有 markdown 文档进行说明，例如 <a href="https://github.com/open-mmlab/mmdetection/tree/master/configs/faster_rcnn">faster rcnn</a> </p><h4 id="High-level-APIs-for-inference"><a href="#High-level-APIs-for-inference" class="headerlink" title="High-level APIs for inference"></a>High-level APIs for inference</h4><p>在之前也见到过这个代码，现在再来看一看</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> mmdet<span class="token punctuation">.</span>apis <span class="token keyword">import</span> init_detector<span class="token punctuation">,</span> inference_detector<span class="token keyword">import</span> mmcv<span class="token comment"># Specify the path to model config and checkpoint file</span>config_file <span class="token operator">=</span> <span class="token string">'configs/faster_rcnn/faster_rcnn_r50_fpn_1x_coco.py'</span>checkpoint_file <span class="token operator">=</span> <span class="token string">'checkpoints/faster_rcnn_r50_fpn_1x_coco_20200130-047c8118.pth'</span><span class="token comment"># build the model from a config file and a checkpoint file</span>model <span class="token operator">=</span> init_detector<span class="token punctuation">(</span>config_file<span class="token punctuation">,</span> checkpoint_file<span class="token punctuation">,</span> device<span class="token operator">=</span><span class="token string">'cuda:0'</span><span class="token punctuation">)</span><span class="token comment"># test a single image and show the results</span>img <span class="token operator">=</span> <span class="token string">'test.jpg'</span>  <span class="token comment"># or img = mmcv.imread(img), which will only load it once</span>result <span class="token operator">=</span> inference_detector<span class="token punctuation">(</span>model<span class="token punctuation">,</span> img<span class="token punctuation">)</span><span class="token comment"># visualize the results in a new window</span>model<span class="token punctuation">.</span>show_result<span class="token punctuation">(</span>img<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token comment"># or save the visualization results to image files</span>model<span class="token punctuation">.</span>show_result<span class="token punctuation">(</span>img<span class="token punctuation">,</span> result<span class="token punctuation">,</span> out_file<span class="token operator">=</span><span class="token string">'result.jpg'</span><span class="token punctuation">)</span><span class="token comment"># test a video and show the results</span>video <span class="token operator">=</span> mmcv<span class="token punctuation">.</span>VideoReader<span class="token punctuation">(</span><span class="token string">'video.mp4'</span><span class="token punctuation">)</span><span class="token keyword">for</span> frame <span class="token keyword">in</span> video<span class="token punctuation">:</span>    result <span class="token operator">=</span> inference_detector<span class="token punctuation">(</span>model<span class="token punctuation">,</span> frame<span class="token punctuation">)</span>    model<span class="token punctuation">.</span>show_result<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> result<span class="token punctuation">,</span> wait_time<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面的代码中用到了是这三个 API:</p><ol><li>异步推理 <code>async_inference_detector</code></li><li>绘制 <code>show_result</code></li><li>推理 <code>inference_detector</code></li></ol><p>这里 <code>show_result</code> 的参数请查看 <a href="https://github.com/open-mmlab/mmdetection/blob/a1cecf63c713c53941b8dcf8a9d762baf8511f2c/mmdet/models/detectors/base.py">原代码</a>，如果需要显示的话要添加参数 <code>show=True</code>。但在用 vscode 连接远程服务器的情况下，即使设置了 <code>show=True</code> 也不会展示结果，可能因为服务器不支持 GUI，替代的方法就是在 Jupyter notebook 或者 interactive window 中运行</p><h4 id="Asynchronous-interface-supported-for-Python-3-7"><a href="#Asynchronous-interface-supported-for-Python-3-7" class="headerlink" title="Asynchronous interface - supported for Python 3.7+"></a>Asynchronous interface - supported for Python 3.7+</h4><p>这一节没有理解清楚，只稍微留了点印象：使用异步接口理论上能够加速推理/训练过程</p><h5 id="异步"><a href="#异步" class="headerlink" title="异步"></a>异步</h5><p>首先什么是 <a href="https://blog.csdn.net/lemon4869/article/details/107145903">异步思维</a>，在链接中的理解来说：异步就是不必等待推理结束才开始下一张图像的预处理。但看原代码说的异步到底是什么意思，我也不太理解，以后再回来整理 asyncio 相关知识吧</p><h5 id="async-amp-await"><a href="#async-amp-await" class="headerlink" title="async &amp; await"></a>async &amp; await</h5><p>什么是 Asynchronous interface <a href="https://zhuanlan.zhihu.com/p/353857526">知乎链接</a></p><p>什么是 asyncio <a href="https://blog.csdn.net/permike/article/details/110821246">知乎链接</a></p><p>Q: 这里需要更多的 python 知识，我得回去补充，比如 with 关键字什么意思？整个异步的过程是怎么样的，能否把整个时间与事件弄清楚？</p><h4 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h4><p>文档给了3个demo：</p><ol><li>Image Demo</li><li>Webcam Demo</li><li>Video Demo</li></ol><p>简单看了一下代码，看来还需要补充总结 OpenCV 的一些基础知识</p><h3 id="Test-existing-models-on-standard-datasets"><a href="#Test-existing-models-on-standard-datasets" class="headerlink" title="Test existing models on standard datasets"></a>Test existing models on standard datasets</h3><blockquote><p>MMDetection supports multiple public datasets including COCO, Pascal VOC, CityScapes, and <a href="https://github.com/open-mmlab/mmdetection/tree/master/configs/_base_/datasets">more</a>. This section will show how to test existing models on supported datasets.</p></blockquote><h4 id="Prepare-datasets"><a href="#Prepare-datasets" class="headerlink" title="Prepare datasets"></a>Prepare datasets</h4><p>推荐在项目之外建立数据集，然后以软链接的形式放到项目中，且目录结构要根据 config files 规放置（或者你自己修改 config files），举个几个例子</p><pre class="line-numbers language-none"><code class="language-none">mmdetection├── mmdet├── tools├── configs├── data│   ├── coco│   │   ├── annotations│   │   ├── train2017│   │   ├── val2017│   │   ├── test2017│   ├── cityscapes│   │   ├── annotations│   │   ├── leftImg8bit│   │   │   ├── train│   │   │   ├── val│   │   ├── gtFine│   │   │   ├── train│   │   │   ├── val│   ├── VOCdevkit│   │   ├── VOC2007│   │   ├── VOC2012<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="Test-existing-models"><a href="#Test-existing-models" class="headerlink" title="Test existing models"></a>Test existing models</h4><blockquote><p>We provide testing scripts for evaluating an existing model on the whole dataset (COCO, PASCAL VOC, Cityscapes, etc.). </p></blockquote><p>可以在单个 GPU 上测试，也可以在多个 GPU 上进行分布测试</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token comment"># single-gpu testing</span>python tools/test.py <span class="token punctuation">\</span>    <span class="token variable">${CONFIG_FILE}</span> <span class="token punctuation">\</span>    <span class="token variable">${CHECKPOINT_FILE}</span> <span class="token punctuation">\</span>    <span class="token punctuation">[</span>--out <span class="token variable">${RESULT_FILE}</span><span class="token punctuation">]</span> <span class="token punctuation">\</span>    <span class="token punctuation">[</span>--eval <span class="token variable">${EVAL_METRICS}</span><span class="token punctuation">]</span> <span class="token punctuation">\</span>    <span class="token punctuation">[</span>--show<span class="token punctuation">]</span><span class="token comment"># multi-gpu testing</span><span class="token function">bash</span> tools/dist_test.sh <span class="token punctuation">\</span>    <span class="token variable">${CONFIG_FILE}</span> <span class="token punctuation">\</span>    <span class="token variable">${CHECKPOINT_FILE}</span> <span class="token punctuation">\</span>    <span class="token variable">${GPU_NUM}</span> <span class="token punctuation">\</span>    <span class="token punctuation">[</span>--out <span class="token variable">${RESULT_FILE}</span><span class="token punctuation">]</span> <span class="token punctuation">\</span>    <span class="token punctuation">[</span>--eval <span class="token variable">${EVAL_METRICS}</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>mmdetection 提供对无标记数据集进行测试，但数据集需要符合 COCO format，如果不是 COCO format 例如 VOC 数据集，需要使用 <a href="https://github.com/open-mmlab/mmdetection/tree/master/tools/dataset_converters/pascal_voc.py">script in tools</a> 转化</p><p>mmdetection 提供 batch inference，能够一次推理多个样本，在 config files 中修改 <code>sample_per_gpu</code> 即可，或者使用 <code>--cfg-options data.test.samples_per_gpu=2</code></p><p>还有很多参数可以调整，具体请看源代码，文档也给出了很多 <a href="https://mmdetection.readthedocs.io/en/latest/1_exist_data_model.html#examples">例子</a></p><h3 id="Train-predefined-models-on-standard-datasets"><a href="#Train-predefined-models-on-standard-datasets" class="headerlink" title="Train predefined models on standard datasets"></a>Train predefined models on standard datasets</h3><blockquote><p>This section will show how to train <em>predefined</em> models (under <a href="https://github.com/open-mmlab/mmdetection/tree/master/configs">configs</a>) on standard datasets i.e. COCO.</p><p><strong>Important</strong>: 训练的默认学习率的配置为 8个 GPU 和 2 img/gpu，也就是 batch size 为16，如果使用不同的 batch size 那么就要按照线性缩放原则更改学习率 e.g., <code>lr=0.01</code> for 4 GPUs <em> 2 imgs/gpu and <code>lr=0.08</code> for 16 GPUs </em> 4 imgs/gpu.</p></blockquote><h4 id="Prepare-datasets-1"><a href="#Prepare-datasets-1" class="headerlink" title="Prepare datasets"></a>Prepare datasets</h4><p>准备过程和上一节 Test 部分是一致的。建议先将模型下载好，以防网不好导致报错</p><h4 id="Training-on-a-single-GPU"><a href="#Training-on-a-single-GPU" class="headerlink" title="Training on a single GPU"></a>Training on a single GPU</h4><p>在单个 GPU 上训练，基本使用方法</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">python tools/train.py <span class="token punctuation">\</span>    <span class="token variable">${CONFIG_FILE}</span> <span class="token punctuation">\</span>    <span class="token punctuation">[</span>optional arguments<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>训练过程中的 log 和 checkpoints 都会被存放到 <code>work_dir</code> 当中，也可以用 <code>--work-dir</code> 重新指定</p><p>默认每12个 epoch 使用验证集对模型进行一次评估 evaluation，train.py 还接受一些常用参数：</p><ul><li><code>--no-validate</code> (<strong>not suggested</strong>): Disable evaluation during training.</li><li><code>--work-dir ${WORK_DIR}</code>: Override the working directory.</li><li><code>--resume-from ${CHECKPOINT_FILE}</code>: Resume from a previous checkpoint file.</li><li><code>--options 'Key=value'</code>: Overrides other settings in the used config.</li></ul><p>文档提到两个参数的区别：<code>--resume-from &amp; --load-from</code> 前者不仅加载参数权重，也加载 optimizer 的状态，主要用于训练被突然打断后接着训练。后者只加载参数权重，主要用于 finetuning</p><h4 id="Training-on-multiple-GPUs"><a href="#Training-on-multiple-GPUs" class="headerlink" title="Training on multiple GPUs"></a>Training on multiple GPUs</h4><p>同样，基本用法</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">bash</span> ./tools/dist_train.sh <span class="token punctuation">\</span>    <span class="token variable">${CONFIG_FILE}</span> <span class="token punctuation">\</span>    <span class="token variable">${GPU_NUM}</span> <span class="token punctuation">\</span>    <span class="token punctuation">[</span>optional arguments<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>可选参数和上面训练单个 GPU 是一样的</p><h5 id="Launch-multiple-jobs-simultaneously"><a href="#Launch-multiple-jobs-simultaneously" class="headerlink" title="Launch multiple jobs simultaneously"></a>Launch multiple jobs simultaneously</h5><p>在训练当中，通常会有多任务的存在，mmdetection 也可以实现，但现在能力有限，实在不能理解具体的实现逻辑，留个 <a href="https://mmdetection.readthedocs.io/en/latest/1_exist_data_model.html#training-on-multiple-gpus">原文档链接</a></p><p>提到了很多新东西，nodes, port, slurm, pytorch launch utility…如果能够在实践中理解这些概念更好了</p><h2 id="Part-2-Train-with-customized-datasets"><a href="#Part-2-Train-with-customized-datasets" class="headerlink" title="Part 2, Train with customized datasets"></a>Part 2, Train with customized datasets</h2><blockquote><p> We use the <a href="https://github.com/matterport/Mask_RCNN/tree/master/samples/balloon">balloon dataset</a> as an example to describe the whole process.</p></blockquote><p>基本步骤为：</p><ol><li>Prepare the customized dataset</li><li>Prepare a config</li><li>Train, test, inference models on the customized dataset.</li></ol><h3 id="Prepare-the-customized-dataset"><a href="#Prepare-the-customized-dataset" class="headerlink" title="Prepare the customized dataset"></a>Prepare the customized dataset</h3><p>mmdetection 支持对 COCO format 数据集进行训练，将不同格式的数据集转化为 COCO format 即可。可能也可以对 config file 进行配置，来适配不同格式的数据集，但这一部分文档没有提及</p><h4 id="COCO-annotation-format"><a href="#COCO-annotation-format" class="headerlink" title="COCO annotation format"></a>COCO annotation format</h4><blockquote><p>The necessary keys of COCO format for instance segmentation is as below, for the complete details, please refer <a href="https://cocodataset.org/#format-data">here</a>.</p></blockquote><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"images"</span><span class="token operator">:</span> <span class="token punctuation">[</span>image<span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token property">"annotations"</span><span class="token operator">:</span> <span class="token punctuation">[</span>annotation<span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token property">"categories"</span><span class="token operator">:</span> <span class="token punctuation">[</span>category<span class="token punctuation">]</span><span class="token punctuation">}</span>image = <span class="token punctuation">{</span>    <span class="token property">"id"</span><span class="token operator">:</span> int<span class="token punctuation">,</span>    <span class="token property">"width"</span><span class="token operator">:</span> int<span class="token punctuation">,</span>    <span class="token property">"height"</span><span class="token operator">:</span> int<span class="token punctuation">,</span>    <span class="token property">"file_name"</span><span class="token operator">:</span> str<span class="token punctuation">,</span><span class="token punctuation">}</span>annotation = <span class="token punctuation">{</span>    <span class="token property">"id"</span><span class="token operator">:</span> int<span class="token punctuation">,</span>    <span class="token property">"image_id"</span><span class="token operator">:</span> int<span class="token punctuation">,</span>    <span class="token property">"category_id"</span><span class="token operator">:</span> int<span class="token punctuation">,</span>    <span class="token property">"segmentation"</span><span class="token operator">:</span> RLE or <span class="token punctuation">[</span>polygon<span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token property">"area"</span><span class="token operator">:</span> float<span class="token punctuation">,</span>    <span class="token property">"bbox"</span><span class="token operator">:</span> <span class="token punctuation">[</span>x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>width<span class="token punctuation">,</span>height<span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token property">"iscrowd"</span><span class="token operator">:</span> <span class="token number">0</span> or <span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">}</span>categories = <span class="token punctuation">[</span><span class="token punctuation">{</span>    <span class="token property">"id"</span><span class="token operator">:</span> int<span class="token punctuation">,</span>    <span class="token property">"name"</span><span class="token operator">:</span> str<span class="token punctuation">,</span>    <span class="token property">"supercategory"</span><span class="token operator">:</span> str<span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>balloon dataset format 形如下</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>'base64_img_data'<span class="token operator">:</span> ''<span class="token punctuation">,</span> 'file_attributes'<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> 'filename'<span class="token operator">:</span> '34020010494_e5cb88e1c4_k.jpg'<span class="token punctuation">,</span> 'fileref'<span class="token operator">:</span> ''<span class="token punctuation">,</span> 'regions'<span class="token operator">:</span> <span class="token punctuation">{</span>'<span class="token number">0</span>'<span class="token operator">:</span> <span class="token punctuation">{</span>'region_attributes'<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>   'shape_attributes'<span class="token operator">:</span> <span class="token punctuation">{</span>'all_points_x'<span class="token operator">:</span> <span class="token punctuation">[</span>...<span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    'all_points_y'<span class="token operator">:</span> <span class="token punctuation">[</span>...<span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    'name'<span class="token operator">:</span> 'polygon'<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> 'size'<span class="token operator">:</span> <span class="token number">1115004</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>文档提供了函数将 balloon dataset JSON 格式转化为 COCO format，<a href="https://mmdetection.readthedocs.io/en/latest/2_new_data_model.html#coco-annotation-format">原文档</a></p><h3 id="Prepare-a-config"><a href="#Prepare-a-config" class="headerlink" title="Prepare a config"></a>Prepare a config</h3><blockquote><p>The second step is to prepare a config thus the dataset could be successfully loaded. </p></blockquote><p>假设以 balloon dataset 训练 Mask R-CNN with FPN，config 在 <code>configs/balloon</code> 命名为  <code>mask_rcnn_r50_caffe_fpn_mstrain-poly_1x_balloon.py</code></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># The new config inherits a base config to highlight the necessary modification</span>_base_ <span class="token operator">=</span> <span class="token string">'mask_rcnn/mask_rcnn_r50_caffe_fpn_mstrain-poly_1x_coco.py'</span><span class="token comment"># We also need to change the num_classes in head to match the dataset's annotation</span>model <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>    roi_head<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>        bbox_head<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>num_classes<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        mask_head<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>num_classes<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># Modify dataset related settings</span>dataset_type <span class="token operator">=</span> <span class="token string">'COCODataset'</span>classes <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'balloon'</span><span class="token punctuation">,</span><span class="token punctuation">)</span>data <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>    train<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>        img_prefix<span class="token operator">=</span><span class="token string">'balloon/train/'</span><span class="token punctuation">,</span>        classes<span class="token operator">=</span>classes<span class="token punctuation">,</span>        ann_file<span class="token operator">=</span><span class="token string">'balloon/train/annotation_coco.json'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    val<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>        img_prefix<span class="token operator">=</span><span class="token string">'balloon/val/'</span><span class="token punctuation">,</span>        classes<span class="token operator">=</span>classes<span class="token punctuation">,</span>        ann_file<span class="token operator">=</span><span class="token string">'balloon/val/annotation_coco.json'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    test<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>        img_prefix<span class="token operator">=</span><span class="token string">'balloon/val/'</span><span class="token punctuation">,</span>        classes<span class="token operator">=</span>classes<span class="token punctuation">,</span>        ann_file<span class="token operator">=</span><span class="token string">'balloon/val/annotation_coco.json'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># We can use the pre-trained Mask RCNN model to obtain higher performance</span>load_from <span class="token operator">=</span> <span class="token string">'checkpoints/mask_rcnn_r50_caffe_fpn_mstrain-poly_3x_coco_bbox_mAP-0.408__segm_mAP-0.37_20200504_163245-42aa3d00.pth'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Train-amp-Test-Model"><a href="#Train-amp-Test-Model" class="headerlink" title="Train &amp; Test Model"></a>Train &amp; Test Model</h3><p>配置好了数据集过后，基本上就和 Part 1 中的训练和测试方法一样</p><p>To train a model with the new config, you can simply run</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">python tools/train.py configs/balloon/mask_rcnn_r50_caffe_fpn_mstrain-poly_1x_balloon.py<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>To test the trained model, you can simply run</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">python tools/test.py configs/balloon/mask_rcnn_r50_caffe_fpn_mstrain-poly_1x_balloon.py <span class="token punctuation">\</span>work_dirs/mask_rcnn_r50_caffe_fpn_mstrain-poly_1x_balloon.py/latest.pth <span class="token punctuation">\</span>--eval bbox segm<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="Part-3-Train-with-customized-models-and-standard-datasets"><a href="#Part-3-Train-with-customized-models-and-standard-datasets" class="headerlink" title="Part 3, Train with customized models and standard datasets"></a>Part 3, Train with customized models and standard datasets</h2><blockquote><p>In this note, you will know how to train, test and inference your own customized models under standard datasets.</p></blockquote><p>使用 cityscapes dataset 训练个性化 Cascade Mask R-CNN R50 model，使用 <a href="https://github.com/Gus-Guo/AugFPN"><code>AugFPN</code></a> 替代 <code>FPN</code> 作为 neck，并且加上 <code>Rotate</code> or <code>Translate</code> 作为数据增强</p><p>基本步骤比 Part 2 多一个准备 customized model:</p><ol><li>Prepare the standard dataset</li><li>Prepare your own customized model</li><li>Prepare a config</li><li>Train, test, and inference models on the standard dataset</li></ol><h3 id="Prepare-the-standard-dataset"><a href="#Prepare-the-standard-dataset" class="headerlink" title="Prepare the standard dataset"></a>Prepare the standard dataset</h3><p>基本流程，也是需要将 cityscapes dataset 转为 COCO format，mmdetection 也提供转化脚本 <code>tools/dataset_converters/cityscapes.py</code></p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">pip <span class="token function">install</span> cityscapesscriptspython tools/dataset_converters/cityscapes.py ./data/cityscapes --nproc <span class="token number">8</span> --out-dir ./data/cityscapes/annotations<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="Prepare-your-own-customized-model"><a href="#Prepare-your-own-customized-model" class="headerlink" title="Prepare your own customized model"></a>Prepare your own customized model</h3><h4 id="1-Define-a-new-neck-e-g-AugFPN"><a href="#1-Define-a-new-neck-e-g-AugFPN" class="headerlink" title="1. Define a new neck (e.g. AugFPN)"></a>1. Define a new neck (e.g. AugFPN)</h4><p>首先新建一个文件 <code>mmdet/models/necks/augfpn.py</code></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> <span class="token punctuation">.</span><span class="token punctuation">.</span>builder <span class="token keyword">import</span> NECKS@NECKS<span class="token punctuation">.</span>register_module<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">AugFPN</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>                in_channels<span class="token punctuation">,</span>                out_channels<span class="token punctuation">,</span>                num_outs<span class="token punctuation">,</span>                start_level<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>                end_level<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>                add_extra_convs<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">pass</span>    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> inputs<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># implementation is ignored        pass</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>注意这里用了一个装饰器，复习 python 的时候可以联系起来</p><h4 id="2-Import-the-module"><a href="#2-Import-the-module" class="headerlink" title="2. Import the module"></a>2. Import the module</h4><p>导入模块有两种方法：</p><ol><li><p>在  <code>mmdet/models/necks/__init__.py</code> 导入</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> <span class="token punctuation">.</span>augfpn <span class="token keyword">import</span> AugFPN<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>在 config 文件中更改</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">custom_imports <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>    imports<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'mmdet.models.necks.augfpn.py'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    allow_failed_imports<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>这样就避免去更改原文件</p></li></ol><h4 id="3-Modify-the-config-file"><a href="#3-Modify-the-config-file" class="headerlink" title="3. Modify the config file"></a>3. Modify the config file</h4><p>将 neck 加入到 config file 中</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">neck<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>    <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'AugFPN'</span><span class="token punctuation">,</span>    in_channels<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">2048</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    out_channels<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span>    num_outs<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看出，如果想要更改别人的模型，mmdetection 都是以 config file 为核心，而不去更改原文件</p><p>如果要完成 AugFPN, Rotate, Translate 三个修改的话，在文档中给出了参考的 <a href="https://mmdetection.readthedocs.io/en/latest/3_exist_data_new_model.html#prepare-a-config">config file</a></p><h3 id="Train-amp-Test-Model-1"><a href="#Train-amp-Test-Model-1" class="headerlink" title="Train &amp; Test Model"></a>Train &amp; Test Model</h3><p>训练和测试基本使用方法在之前已经介绍过，这部分也一样</p><p>To train a model with the new config, you can simply run</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">python tools/train.py configs/cityscapes/cascade_mask_rcnn_r50_augfpn_autoaug_10e_cityscapes.py<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>To test the trained model, you can simply run</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">python tools/test.py configs/cityscapes/cascade_mask_rcnn_r50_augfpn_autoaug_10e_cityscapes.py <span class="token punctuation">\</span>work_dirs/cascade_mask_rcnn_r50_augfpn_autoaug_10e_cityscapes.py/latest.pth --eval bbox segm<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h2><h3 id="pth文件里有什么"><a href="#pth文件里有什么" class="headerlink" title=".pth文件里有什么"></a>.pth文件里有什么</h3><p>要回答一个问题，什么是 <a href="https://zhuanlan.zhihu.com/p/84797438">.pth 文件 知乎</a>，在 mmdetection 框架中可以看到 pth 文件包含了两个部分 <code>meta &amp; state_dict</code></p><p>其中 <code>meta</code> 保存了模型的配置信息，列出其 key：</p><ol><li>mmdet_version</li><li><strong>config</strong></li><li>CLASSES</li><li>epoch</li><li>iter</li><li>mmcv_version</li><li>time</li></ol><p>而 <code>state_dict</code> 保存了模型参数值，列出部分 key：</p><p>backbone.conv1.weight<br>backbone.bn1.weight<br>backbone.bn1.bias<br>backbone.bn1.running_mean<br>backbone.bn1.running_var<br>backbone.bn1.num_batches_tracked<br>backbone.layer1.0.conv1.weight<br>backbone.layer1.0.bn1.weight<br>backbone.layer1.0.bn1.bias<br>backbone.layer1.0.bn1.running_mean<br>backbone.layer1.0.bn1.running_var<br>backbone.layer1.0.bn1.num_batches_tracked</p><p>…….</p><h3 id="如何理解-Registry"><a href="#如何理解-Registry" class="headerlink" title="如何理解 Registry"></a>如何理解 Registry</h3><p>在学习 mmdetection 过程中一直又一个问题：如何使用 config + registry 返回一个 nn.Module 类的模型，这些模型是如何被注册到 Registry 类当中的？</p><p>阅读资源：</p><ol><li><p><a href="https://blog.csdn.net/sinat_29963957">mmdetection 源码阅读笔记</a></p></li><li><p><a href="https://zhuanlan.zhihu.com/p/337375549">mmdetection 整体构建流程</a></p></li><li><p><a href="https://blog.csdn.net/wulele2/article/details/114139512">mmdetection之model构建</a></p></li><li><p><a href="https://mmtracking.readthedocs.io/en/latest/">MMCV 官方文档</a>，这个文档相当有用，是 mmlab 的通用基础库，要好好学习一下</p></li><li><p><a href="https://www.cnblogs.com/hester/p/10546235.html#:~:text=Python%E4%B8%AD%E4%B8%80%E4%B8%AApy%E6%96%87%E4%BB%B6%E5%B0%B1%E6%98%AF%E4%B8%80%E4%B8%AA%E6%A8%A1%E5%9D%97%EF%BC%8C%E2%80%9C__all__%E2%80%9D%E5%8F%98%E9%87%8F%E6%98%AF%E4%B8%80%E4%B8%AA%E7%89%B9%E6%AE%8A%E7%9A%84%E5%8F%98%E9%87%8F%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%9C%A8py%E6%96%87%E4%BB%B6%E4%B8%AD%EF%BC%8C%E4%B9%9F%E5%8F%AF%E4%BB%A5%E5%9C%A8%E5%8C%85%E7%9A%84__init__.py%E4%B8%AD%E5%87%BA%E7%8E%B0%E3%80%82%20%E5%A6%82%EF%BC%9A%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%EF%BC%8C%E5%87%BD%E6%95%B0%EF%BC%8C%E7%B1%BB%E3%80%82%20%E5%A6%82%E4%B8%8B%EF%BC%8Ctest1.py%E5%92%8Cmain.py,%3F%20%3F%20%E4%B8%A4%E4%B8%AA%E6%96%87%E4%BB%B6%E5%9C%A8%E5%90%8C%E4%B8%80%E4%B8%AA%E7%9B%AE%E5%BD%95%E4%B8%8B%E3%80%82%20%E9%82%A3%E4%B9%88%E5%9C%A8%E6%A8%A1%E5%9D%97%E4%B8%AD%E7%9A%84__all__%E5%8F%98%E9%87%8F%E5%B0%B1%E6%98%AF%E4%B8%BA%E4%BA%86%E9%99%90%E5%88%B6%E6%88%96%E8%80%85%E6%8C%87%E5%AE%9A%E8%83%BD%E8%A2%AB%E5%AF%BC%E5%85%A5%E5%88%B0%E5%88%AB%E7%9A%84%E6%A8%A1%E5%9D%97%E7%9A%84%E5%87%BD%E6%95%B0%EF%BC%8C%E7%B1%BB%EF%BC%8C%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%E7%AD%89%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%8C%87%E5%AE%9A%E4%BA%86%E9%82%A3%E4%B9%88%E5%8F%AA%E8%83%BD%E6%98%AF%E6%8C%87%E5%AE%9A%E7%9A%84%E9%82%A3%E4%BA%9B%E5%8F%AF%E4%BB%A5%E8%A2%AB%E5%AF%BC%E5%85%A5%EF%BC%8C%E6%B2%A1%E6%9C%89%E6%8C%87%E5%AE%9A%E9%BB%98%E8%AE%A4%E5%B0%B1%E6%98%AF%E5%85%A8%E9%83%A8%E5%8F%AF%E4%BB%A5%E5%AF%BC%E5%85%A5%EF%BC%8C%E5%BD%93%E7%84%B6%E7%A7%81%E6%9C%89%E5%B1%9E%E6%80%A7%E5%BA%94%E8%AF%A5%E9%99%A4%E5%A4%96%E3%80%82">python _<em>all_</em>变量</a></p></li><li>在 B 站上找到了一个官方 <a href="https://space.bilibili.com/630319191/channel/detail?cid=179690&amp;ctype=0">学习讲座系列</a>，这个讲座不太和我胃口，又在 B 站上找了一个西交的 <a href="https://www.bilibili.com/video/BV1Jb4y1r7ir?p=1">教学视频</a>，这个视频就比较友好，对我帮助更大</li></ol><p>我一直都很不理解这些类是怎么注册的，为什么有的代码似乎没有“明显”地运行，但是这些模块就已经被注册到 Registry 当中了？看完 MMCV 文档之后才大概明白了，重点就在于 <code>__init__.py</code> 文件以及 <code>__all__</code> 变量。可以看到在许多文件夹下都有 <code>__init__.py</code> 文件，例如 <code>mmdet/models/__init__.py</code>, <code>mmdet/models/backbones/__init__.py</code></p><p>如果 import 文件夹/模块下又 init.py 文件，那么就会在 import 该模块之前先运行 init.py 文件，就是在这个文件之中完成了各个模块的注册，其中 <code>__all__</code> 变量包含了需要导入的模块列表</p><p>具体看一下其中的内容</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> <span class="token punctuation">.</span>backbones <span class="token keyword">import</span> <span class="token operator">*</span>  <span class="token comment"># noqa: F401,F403</span><span class="token keyword">from</span> <span class="token punctuation">.</span>builder <span class="token keyword">import</span> <span class="token punctuation">(</span>BACKBONES<span class="token punctuation">,</span> DETECTORS<span class="token punctuation">,</span> HEADS<span class="token punctuation">,</span> LOSSES<span class="token punctuation">,</span> NECKS<span class="token punctuation">,</span>                      ROI_EXTRACTORS<span class="token punctuation">,</span> SHARED_HEADS<span class="token punctuation">,</span> build_backbone<span class="token punctuation">,</span>                      build_detector<span class="token punctuation">,</span> build_head<span class="token punctuation">,</span> build_loss<span class="token punctuation">,</span> build_neck<span class="token punctuation">,</span>                      build_roi_extractor<span class="token punctuation">,</span> build_shared_head<span class="token punctuation">)</span><span class="token keyword">from</span> <span class="token punctuation">.</span>dense_heads <span class="token keyword">import</span> <span class="token operator">*</span>  <span class="token comment"># noqa: F401,F403</span><span class="token keyword">from</span> <span class="token punctuation">.</span>detectors <span class="token keyword">import</span> <span class="token operator">*</span>  <span class="token comment"># noqa: F401,F403</span><span class="token keyword">from</span> <span class="token punctuation">.</span>losses <span class="token keyword">import</span> <span class="token operator">*</span>  <span class="token comment"># noqa: F401,F403</span><span class="token keyword">from</span> <span class="token punctuation">.</span>necks <span class="token keyword">import</span> <span class="token operator">*</span>  <span class="token comment"># noqa: F401,F403</span><span class="token keyword">from</span> <span class="token punctuation">.</span>plugins <span class="token keyword">import</span> <span class="token operator">*</span>  <span class="token comment"># noqa: F401,F403</span><span class="token keyword">from</span> <span class="token punctuation">.</span>roi_heads <span class="token keyword">import</span> <span class="token operator">*</span>  <span class="token comment"># noqa: F401,F403</span>__all__ <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token string">'BACKBONES'</span><span class="token punctuation">,</span> <span class="token string">'NECKS'</span><span class="token punctuation">,</span> <span class="token string">'ROI_EXTRACTORS'</span><span class="token punctuation">,</span> <span class="token string">'SHARED_HEADS'</span><span class="token punctuation">,</span> <span class="token string">'HEADS'</span><span class="token punctuation">,</span> <span class="token string">'LOSSES'</span><span class="token punctuation">,</span>    <span class="token string">'DETECTORS'</span><span class="token punctuation">,</span> <span class="token string">'build_backbone'</span><span class="token punctuation">,</span> <span class="token string">'build_neck'</span><span class="token punctuation">,</span> <span class="token string">'build_roi_extractor'</span><span class="token punctuation">,</span>    <span class="token string">'build_shared_head'</span><span class="token punctuation">,</span> <span class="token string">'build_head'</span><span class="token punctuation">,</span> <span class="token string">'build_loss'</span><span class="token punctuation">,</span> <span class="token string">'build_detector'</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Bug-amp-vscode-debugger"><a href="#Bug-amp-vscode-debugger" class="headerlink" title="Bug  &amp; vscode debugger"></a>Bug  &amp; vscode debugger</h3><p>捣鼓了一天了在服务器，怎么都不能够搞好 xrdp，还差点把电脑弄出点毛病…最后用 <code>sudo dpkg --purge xrdp</code> 删除了没有下载完全的包才弄好了。我认为实验室的服务器需要一个大更新，一个是系统升级，另一个是清理内存，现在大概还有350G的空间剩余，最重要的是服务器的网络是个大问题！很多资源都无法直接下载，有些资源下载起来非常吃力</p><p>放一个 <a href="https://www.jianshu.com/p/ceb3c020e06b">nvidia-smi讲解链接</a>，理解一下各个指标是在说什么</p><h4 id="vscode-debugger"><a href="#vscode-debugger" class="headerlink" title="vscode debugger"></a>vscode debugger</h4><p>在使用 vscode debug 的时候发现有的代码并不会 step in，后来发现这些代码都是通过 pip/conda install 下载的库中的代码。而 vscode 的 debugger 会默认设定只在 ‘MyCode’ 中进行 debug，简单的说，如果不是“自己”写的代码，vscode debugger 是不会 step in 的</p><p>解决办法：在 debugger 的 json 文件中设置 <code>"justMyCode: false"</code></p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token comment">// Use IntelliSense to learn about possible attributes.</span>    <span class="token comment">// Hover to view descriptions of existing attributes.</span>    <span class="token comment">// For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387</span>    <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"0.2.0"</span><span class="token punctuation">,</span>    <span class="token property">"configurations"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token punctuation">{</span>            <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Python: Current File"</span><span class="token punctuation">,</span>            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"python"</span><span class="token punctuation">,</span>            <span class="token property">"request"</span><span class="token operator">:</span> <span class="token string">"launch"</span><span class="token punctuation">,</span>            <span class="token property">"program"</span><span class="token operator">:</span> <span class="token string">"${file}"</span><span class="token punctuation">,</span>            <span class="token property">"console"</span><span class="token operator">:</span> <span class="token string">"integratedTerminal"</span><span class="token punctuation">,</span>            <span class="token comment">// add the next line into your .json file</span>            <span class="token property">"justMyCode"</span><span class="token operator">:</span> <span class="token boolean">false</span>        <span class="token punctuation">}</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><ol><li><p>还需要整理 MMCV 以了解整个 OpenMMLab 的运行逻辑 </p></li><li><p>对于如何训练自己的网络还要继续看文档中的 Tutorial 部分</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> 编程 </category>
          
          <category> OpenMMLab </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MMDetection </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>安装 MMDetection 笔记</title>
      <link href="/archives/54605061.html"/>
      <url>/archives/54605061.html</url>
      
        <content type="html"><![CDATA[<h1 id="安装-MMDetection-笔记"><a href="#安装-MMDetection-笔记" class="headerlink" title="安装 MMDetection 笔记"></a>安装 MMDetection 笔记</h1><p>想法：通过这种标准化的算法框架，来进行组合实验</p><p>但是目前 SE-SSD 没有支持，可以尝试组合一下</p><h2 id="OpenMMLab"><a href="#OpenMMLab" class="headerlink" title="OpenMMLab"></a>OpenMMLab</h2><p>官网：<a href="https://openmmlab.com/">https://openmmlab.com/</a></p><p>github: <a href="https://github.com/open-mmlab">https://github.com/open-mmlab</a></p><p>子项目官方文档：<a href="https://mmdetection.readthedocs.io/zh_CN/latest/">MMDetection</a> <a href="https://mmdetection3d.readthedocs.io/zh_CN/latest/index.html">MMDetection3D</a></p><p>什么是 OpenMMLab？什么是 MMDdetction？</p><blockquote><p>OpenMMLab 是一个计算机视觉开源算法体系和框架，涉及超过10种研究方向，开放超过100种算法、800种预训练模型</p><p>MMDetection is an open source object detection toolbox based on PyTorch. It is a part of the OpenMMLab project.</p></blockquote><h2 id="安装环境"><a href="#安装环境" class="headerlink" title="安装环境"></a>安装环境</h2><p>我打算先熟悉 MMDetection，因为这个项目在 github 上 star 是相对较多的，然后再进一步学习 mmdetection 3D，下面来安装 MMDetection 环境</p><p>首先看看依赖的要求</p><ul><li>Linux 和 macOS （Windows 理论上支持）</li><li>Python 3.6+</li><li>PyTorch 1.3+</li><li>CUDA 9.2+ （如果基于 PyTorch 源码安装，也能够支持 CUDA 9.0）</li><li>GCC 5+</li><li><a href="https://mmcv.readthedocs.io/en/latest/#installation">MMCV</a></li></ul><p>之后下载的依赖版本参考要求来</p><ol><li><p>创建 conda 环境 <code>conda create -n mmlab python=3.7</code></p></li><li><p>安装 pytorch</p><p>在 <a href="https://pytorch.org/get-started/previous-versions/">pytorch previous versions</a> 中查找你想要的版本，我选择如下</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">conda <span class="token function">install</span> <span class="token assign-left variable">pytorch</span><span class="token operator">==</span><span class="token number">1.5</span>.1 <span class="token assign-left variable">torchvision</span><span class="token operator">==</span><span class="token number">0.6</span>.1 <span class="token assign-left variable">cudatoolkit</span><span class="token operator">=</span><span class="token number">10.1</span> -c pytorch<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>但我电脑上安装的 CUDA 版本为10.0，之后看看这样做有什么区别</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">nvcc: NVIDIA <span class="token punctuation">(</span>R<span class="token punctuation">)</span> Cuda compiler driverCopyright <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token number">2005</span>-2018 NVIDIA CorporationBuilt on Sat_Aug_25_21:08:01_CDT_2018Cuda compilation tools, release <span class="token number">10.0</span>, V10.0.130<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li></ol><h2 id="安装-MMDetection"><a href="#安装-MMDetection" class="headerlink" title="安装 MMDetection"></a>安装 MMDetection</h2><p>官方推荐使用 <a href="https://github.com/open-mmlab/mim">MIM</a> 安装 MMDetection</p><blockquote><p>MIM provides a unified interface for launching and installing OpenMMLab projects and their extensions, and managing the OpenMMLab model zoo.</p></blockquote><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">pip <span class="token function">install</span> openmimmim <span class="token function">install</span> mmdet<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>MIM 自动下载了 mmdet 及其对应依赖</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token comment"># mim list</span>Package    Version    Source---------  ---------  -----------------------------------------mmcv-full  <span class="token number">1.3</span>.10     https://github.com/open-mmlab/mmcvmmdet      <span class="token number">2.15</span>.0     https://github.com/open-mmlab/mmdetection<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><p>将 MMDetection 仓库克隆到本地，运行如下代码</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> mmdet<span class="token punctuation">.</span>apis <span class="token keyword">import</span> inference_detector<span class="token punctuation">,</span> init_detectorconfig_file <span class="token operator">=</span> <span class="token string">'configs/faster_rcnn/faster_rcnn_r50_fpn_1x_coco.py'</span><span class="token comment"># 从 model zoo 下载 checkpoint 并放在 `checkpoints/` 文件下</span><span class="token comment"># 网址为: http://download.openmmlab.com/mmdetection/v2.0/faster_rcnn/faster_rcnn_r50_fpn_1x_coco/faster_rcnn_r50_fpn_1x_coco_20200130-047c8118.pth</span>checkpoint_file <span class="token operator">=</span> <span class="token string">'checkpoints/faster_rcnn_r50_fpn_1x_coco_20200130-047c8118.pth'</span>device <span class="token operator">=</span> <span class="token string">'cuda:0'</span><span class="token comment"># 初始化检测器</span>model <span class="token operator">=</span> init_detector<span class="token punctuation">(</span>config_file<span class="token punctuation">,</span> checkpoint_file<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span><span class="token comment"># 推理演示图像</span>img <span class="token operator">=</span> <span class="token string">'demo/demo.jpg'</span>result <span class="token operator">=</span> inference_detector<span class="token punctuation">(</span>model<span class="token punctuation">,</span> img<span class="token punctuation">)</span><span class="token comment"># 绘制结果图</span>model<span class="token punctuation">.</span>show_result<span class="token punctuation">(</span>img<span class="token punctuation">,</span> result<span class="token punctuation">,</span> wait_time<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 编程 </category>
          
          <category> OpenMMLab </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MMDetection </tag>
            
            <tag> 安装教程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>猫头鹰先生催眠录音文本</title>
      <link href="/archives/11812369.html"/>
      <url>/archives/11812369.html</url>
      
        <content type="html"><![CDATA[<p><a href="https://www.bilibili.com/video/BV16f4y1S72h">bilibili link</a></p><p>my name is Mr. Owl</p><p>I will shortly lead you through a guided hypnosis</p><p>please don’t listen to this while driving or operating machinery</p><p>you may also want to have a glass of water nearby</p><p>it can help ground you after a recession</p><p>I would like you to start by simply lying down in a comfortable position </p><p>perhaps on some cushions</p><p>or on a couch</p><p>and just take a few moments to relax your mind</p><p>(a moment …)</p><p>in a moment</p><p>I’m going to ask you to imagine a place</p><p>a special place</p><p>you may see it</p><p>feel it</p><p>imagine it or experience it</p><p>in any way you want</p><p>and you might find your mind wondering quite a bit</p><p>but that doesn’t matter to you</p><p>the sound of my voice will continue to relax you</p><p>and it doesn’t matter if you don’t hear a word I say</p><p>because very soon now</p><p>you are going to be relaxed</p><p>more than you have ever known</p><p>imagine now that you are in that place</p><p>that place you know well</p><p>a hotel by a lake</p><p>and you are here </p><p>at the top of a gorgeous staircase</p><p>in a large open hallway</p><p>a really beautiful old hotel</p><p>it’s such a comfortable temperature here</p><p>daylight streams in through the window</p><p>slightly warm</p><p>such a peaceful place to be</p><p>and at the bottom of those stairs</p><p>an open doorway</p><p>leading to a garden</p><p>in a few moments</p><p>I will count</p><p>from 1 to 10</p><p>and count you down each step</p><p>let each number</p><p>represent a step</p><p>and each step takes you deeper and deeper</p><p>into relaxation</p><p>so that by the time I get to ten</p><p>you can allow yourself</p><p>to be as deeply relaxed</p><p>as you ever can be</p><p>and you’ll still hear</p><p>the sound of my voice</p><p>and as you look down</p><p>you can glimpse</p><p>through the open door</p><p>that intriguing garden</p><p>it’s so interesting to you</p><p>to explore and discover</p><p>this special place</p><p>the sunlight to the windows on your skin</p><p>there’s no one around</p><p>that needs anything from you</p><p>no one around</p><p>to bother you</p><p>1</p><p>when you are ready</p><p>take your first step now</p><p>relaxing letting go</p><p>2</p><p>take another step</p><p>feeling more at ease</p><p>and at peace with yourself</p><p>3</p><p>perhaps noticing</p><p>heavy</p><p>restful feeling</p><p>spreading down your legs</p><p>with every step</p><p>4</p><p>just drifting deeper</p><p>and deeper down</p><p>5</p><p>another step</p><p>becoming calmer</p><p>and even calmer still</p><p>continuing to relax</p><p>continuing to let go</p><p>and feeling so good</p><p>6</p><p>perhaps beginning to notice</p><p>any sounds becoming part of your experience of comfort</p><p>relaxation</p><p>and anything you notice</p><p>becoming part of your experience</p><p>7</p><p>sinking deeper and deeper</p><p>drifting</p><p>further</p><p>into this welcoming</p><p>relaxed state</p><p>8</p><p>enjoying those feelings</p><p>half awake</p><p>half asleep</p><p>9</p><p>noticing way of growing relaxation</p><p>and spreading comfort</p><p>10</p><p>an now</p><p>at the bottom of the stairs</p><p>and wandering through that open door</p><p>how into the gardon beyond</p><p>soak up those feelings of</p><p>tranquility</p><p>see</p><p>hear</p><p>feel sense or imagine this</p><p>beautiful garden</p><p>the greens</p><p>the flowers</p><p>the trees</p><p>the brown</p><p>the clear blue sky</p><p>feel the warmth of the sun</p><p>on your head and shoulders</p><p>enjoy a moment here</p><p>and peace</p><p>inhale the sense of the garden</p><p>there is no one around</p><p>wanting anything from you</p><p>needing anything from you</p><p>no one expecting anything</p><p>so enjoy this</p><p>peace</p><p>and quiet</p><p>for a few moments more</p><p>notice now</p><p>at the end of this garden</p><p>a set of steps</p><p>leading down to a sturdy pier</p><p>at the edge of lake</p><p>so now</p><p>take the steps now</p><p>sinking further and further into relaxation</p><p>as you do</p><p>more and more relaxed with each step</p><p>until you step onto the wooden pier</p><p>then stepping forward</p><p>towards that beautiful crystal blue water</p><p>the sun on your skin</p><p>and gentle breeze</p><p>and here</p><p>at the end of the pier</p><p>a fishing rod</p><p>You take it in your hand</p><p>feel a comforting weight of it</p><p>not too heavy to hold</p><p>but you know that it’s strong and sturdy</p><p>it will not struggle with the weight of today’s catch</p><p>slowly and deliberately</p><p>you unravel some of the line</p><p>you pull back the rod</p><p>and cast that line into that crystal</p><p>clear</p><p>blue water</p><p>it sits in that water for a moment</p><p>and soon you feel a gentle pull on the fishing rod</p><p>you’ve caught something</p><p>you gently crank back the handle</p><p>pulling your catch out of the water</p><p>what have you caught</p><p>it’s a white cube</p><p>so square and perfect on every side</p><p>a little water drips from it</p><p>as you gently swing it back onto the pier beside you</p><p>you lower the fishing rod to your side</p><p>and you take</p><p>the white cube from the line</p><p>what’s inside this cube</p><p>it’s a memory</p><p>a good memory</p><p>a memory from your life</p><p>a memory of a time when you were happy</p><p>and strong</p><p>and confident</p><p>you pick up the cube</p><p>you hold it close to your face</p><p>and now you can see this memory</p><p>you see it in a vivid wide screen</p><p>The colors are rich</p><p>the image is bright</p><p>the sound is clear and strong and vibrant</p><p>so strong and vibrant that you step into this memory</p><p>you are inside</p><p>let those feelings grow inside you</p><p>feeling happy and strong and confident and bright</p><p>take a moment to enjoy this</p><p>to live in it</p><p>to breathe</p><p>this beautiful positive memory from the white cube</p><p>feeling strong and confident</p><p>and bright and happy</p><p>now</p><p>slowly</p><p>and with care</p><p>you move out of the memory</p><p>and you lower the cube</p><p>from in front of your face</p><p>and se t it down gently on the pier beside you</p><p>take a moment now</p><p>look out</p><p>onto the lake</p><p>at the cool blue water</p><p>the peace</p><p>tranquility of it</p><p>you kneel down and lower the white cube</p><p>into the peaceful water</p><p>and as the ripples slow and stop</p><p>you catch sight of your own reflection</p><p>and you see how beautiful you are</p><p>how strong you are</p><p>you can see positivity in your eye</p><p>like jewels</p><p>you stand and look out at that lake</p><p>calm serene and full of power</p><p>breathe it in gently</p><p>and then breathe it out gently</p><p>all that power that’s within you</p><p>I let you enjoy those feelings for a few moments more</p><p>allow you time to bask in that life</p><p>but soon</p><p>soon I’ll start count from one up to five</p><p>when I reach five</p><p>you will be back in the room</p><p>1</p><p>starting to come back</p><p>become aware of your breathing</p><p>your body and the space around you</p><p>2</p><p>moving your legs start to wiggle your toes and feet</p><p>a lovely grounding energy, traveling up your legs</p><p>3</p><p>moving your arms starting to stretch, feel the energy moving through your body again</p><p>4 </p><p>your eyes starting to open</p><p>And on the next count your eyes fully open </p><p>5</p><p>eyes fully open, feeling refreshed and recharged and being fully aware of being in the space</p><p>welcome back</p>]]></content>
      
      
      <categories>
          
          <category> 生活 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 睡眠 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>校友访谈(纪录片)培训</title>
      <link href="/archives/c8ed5799.html"/>
      <url>/archives/c8ed5799.html</url>
      
        <content type="html"><![CDATA[<h1 id="校友访谈-纪录片-培训"><a href="#校友访谈-纪录片-培训" class="headerlink" title="校友访谈(纪录片)培训"></a>校友访谈(纪录片)培训</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><ol><li><p>认识纪录片和口述史</p><p>什么是真实，什么是好的纪录片</p></li><li><p>没有绝对的真实，让故事有逻辑，人物有发展，让观众感到真实，是一个好的纪录片的条件</p></li></ol><h2 id="前期调研"><a href="#前期调研" class="headerlink" title="前期调研"></a>前期调研</h2><ol><li>个人维度：生平，行业信息，突出成就，家庭情况</li><li>历史维度：经历过哪些重大的历史事件，与其他人物在历史上的交集</li><li>事件叙述：起因，过程，结果，历史意义</li><li>最终形成一个人物小传</li></ol><h3 id="案例分享《南大创业者的时代脉搏》"><a href="#案例分享《南大创业者的时代脉搏》" class="headerlink" title="案例分享《南大创业者的时代脉搏》"></a>案例分享《南大创业者的时代脉搏》</h3><h2 id="故事撰写"><a href="#故事撰写" class="headerlink" title="故事撰写"></a>故事撰写</h2><ol><li>一句话概括你的故事 logline</li><li>故事的介绍与结构，关于影片的故事结构，开头、过程、结尾、重要节点</li><li>人物的塑造需要有成长，有套路，从平凡到不平凡的循环过程</li></ol><h2 id="撰写采访问题"><a href="#撰写采访问题" class="headerlink" title="撰写采访问题"></a>撰写采访问题</h2><ol><li>撰写问题按照时间线的顺序，帮助被采访人回忆</li><li>有必须完成的固定动作：重要历程的回顾，重要时间点的讲述，关于主题的必然联系，所有人都希望被理解、被尊重</li><li><p>固定动作之外的惊喜问题：有一些尖锐深刻的话题，在心里拟定好，在现场找点切入</p></li><li><p>多人物采访时的问题思路：采访者之间的共性、特性问题，以及相应的惊喜问题</p></li></ol><h2 id="确定视觉与文字展现形式"><a href="#确定视觉与文字展现形式" class="headerlink" title="确定视觉与文字展现形式"></a>确定视觉与文字展现形式</h2><ol><li>阐述式：有旁白、有采访</li><li>观察式：观察人物</li><li>参与式：类似于 互动vlog</li><li>扮演式：找演员扮演</li><li>资料式：用资料和人物还原</li><li>动画纪录片</li></ol><p>阐述 + 资料为常见组合</p><h2 id="现场拍摄"><a href="#现场拍摄" class="headerlink" title="现场拍摄"></a>现场拍摄</h2><p>摄像机、三脚架、话筒、灯</p><p>注意事项：</p><ol><li>受访者知晓拍摄内容、用途、签文件</li><li>调整环境，让受访者感到舒适，但同时可能需要牺牲画质</li><li>开始前先聊聊家常，同时调整声音和构图，调整画面水平</li><li>采访时，一定不要打断受访者，始终保持眼神交流，不要使用语气词“嗯，啊”之类的</li><li>随即调整采访的顺序</li></ol><h2 id="跟拍"><a href="#跟拍" class="headerlink" title="跟拍"></a>跟拍</h2><ol><li>镜头稳定</li><li>镜头表现</li><li>素材保管，一定要双备份，甚至三备份！因为素材是很“贵”的，不要用剪切！</li><li>保持“记录感”，让镜头持续开机，有比没有强</li></ol><h2 id="Transcription-amp-paper-cut"><a href="#Transcription-amp-paper-cut" class="headerlink" title="Transcription &amp; paper cut"></a>Transcription &amp; paper cut</h2><ol><li>将视频中的文字对话导出</li><li>完成影片脚本，这个脚本是剪辑的根据与逻辑</li></ol><h2 id="剪辑与后期"><a href="#剪辑与后期" class="headerlink" title="剪辑与后期"></a>剪辑与后期</h2><ol><li>剪辑主要故事线</li><li>增加资料、素材、特效包装</li><li>声音制作、调色</li></ol>]]></content>
      
      
      <categories>
          
          <category> 生活 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 纪录片 </tag>
            
            <tag> 培训 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>conda 笔记</title>
      <link href="/archives/c8895fc.html"/>
      <url>/archives/c8895fc.html</url>
      
        <content type="html"><![CDATA[<h1 id="Conda-Cheat-Sheet"><a href="#Conda-Cheat-Sheet" class="headerlink" title="Conda Cheat Sheet"></a>Conda Cheat Sheet</h1><p>记录一些常用的 conda 命令帮助快速管理环境，整理自官方 <a href="https://docs.conda.io/projects/conda/en/4.6.0/_downloads/52a95608c49671267e40c689e0bc00ca/conda-cheatsheet.pdf">CONDA CHEAT SHEET</a></p><h2 id="Basic"><a href="#Basic" class="headerlink" title="Basic"></a>Basic</h2><h3 id="conda-info"><a href="#conda-info" class="headerlink" title="conda info"></a>conda info</h3><p>这个命令非常管用，基本上能够看到所有的 conda 配置信息</p><h3 id="conda-install"><a href="#conda-install" class="headerlink" title="conda install"></a>conda install</h3><p><code>conda install PACKAGENAME</code> 下载指定包</p><h3 id="conda-update"><a href="#conda-update" class="headerlink" title="conda update"></a>conda update</h3><p><code>conda update PACKAGENAME</code> 更新指定包 </p><h2 id="Environment"><a href="#Environment" class="headerlink" title="Environment"></a>Environment</h2><h3 id="conda-create-n"><a href="#conda-create-n" class="headerlink" title="conda create -n"></a>conda create -n</h3><p><code>conda create -n py36 python=3.6</code> 创造一个 python 3.6 的环境 py36</p><p>注意：一般都要加上 <code>python=x.x</code> 否则使用的是 base 环境的 python 解释器</p><h3 id="conda-env-list"><a href="#conda-env-list" class="headerlink" title="conda env list"></a>conda env list</h3><p>列出目前有的环境</p><h3 id="conda-env-remove"><a href="#conda-env-remove" class="headerlink" title="conda env remove"></a>conda env remove</h3><p><code>conda env remove -n env_name</code> 移除环境</p><h3 id="conda-activate-deactivate"><a href="#conda-activate-deactivate" class="headerlink" title="conda activate/deactivate"></a>conda activate/deactivate</h3><p><code>conda activate/deactivate env_name</code> 激活/退出环境</p><h2 id="Package"><a href="#Package" class="headerlink" title="Package"></a>Package</h2><h3 id="conda-install-1"><a href="#conda-install-1" class="headerlink" title="conda install"></a>conda install</h3><p><code>conda install PACKAGENAME</code> 下载包</p><p><code>conda install --file requirements.txt</code> 通过 requirements 文件下载包</p><h3 id="conda-remove"><a href="#conda-remove" class="headerlink" title="conda remove"></a>conda remove</h3><p><code>conda remove PACKAGENAME</code> 移除包</p><h3 id="conda-list"><a href="#conda-list" class="headerlink" title="conda list"></a>conda list</h3><p><code>conda list PACKAGENAME</code> 查看环境的某个包，如果不加 PACKAGENAME 则列出所有环境</p><h3 id="conda-clean"><a href="#conda-clean" class="headerlink" title="conda clean"></a>conda clean</h3><p>如果不清理的话，anaconda 还是很吃存储的，会逐渐积累很多下载包</p><p><code>conda clean --all</code>  Remove index cache, lock files, unused cache packages, and tarballs.</p><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><h3 id="禁用自动启动-base-环境"><a href="#禁用自动启动-base-环境" class="headerlink" title="禁用自动启动 base 环境"></a>禁用自动启动 base 环境</h3><p>每次打开新的 shell 都会自动进入 base 环境，用下面的命令行禁用</p><p><code>conda config --set auto_activate_base false</code></p><h3 id="镜像源设置"><a href="#镜像源设置" class="headerlink" title="镜像源设置"></a>镜像源设置</h3><p>编辑 <code>~/.condarc</code> 文件，设置镜像源</p><p><a href="https://mirrors.bfsu.edu.cn/help/anaconda/">北外镜像源官方帮助文档</a></p><pre class="line-numbers language-.condarc" data-language=".condarc"><code class="language-.condarc">channels:  - defaultsshow_channel_urls: truedefault_channels:  - https://mirrors.bfsu.edu.cn/anaconda/pkgs/main  - https://mirrors.bfsu.edu.cn/anaconda/pkgs/r  - https://mirrors.bfsu.edu.cn/anaconda/pkgs/msys2custom_channels:  conda-forge: https://mirrors.bfsu.edu.cn/anaconda/cloud  msys2: https://mirrors.bfsu.edu.cn/anaconda/cloud  bioconda: https://mirrors.bfsu.edu.cn/anaconda/cloud  menpo: https://mirrors.bfsu.edu.cn/anaconda/cloud  pytorch: https://mirrors.bfsu.edu.cn/anaconda/cloud  simpleitk: https://mirrors.bfsu.edu.cn/anaconda/cloud<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 编程 </category>
          
          <category> Conda </category>
          
      </categories>
      
      
        <tags>
            
            <tag> conda </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Manim 教程</title>
      <link href="/archives/5654e2fe.html"/>
      <url>/archives/5654e2fe.html</url>
      
        <content type="html"><![CDATA[<h1 id="Manim-note"><a href="#Manim-note" class="headerlink" title="Manim note"></a>Manim note</h1><p>官方 <a href="https://github.com/3b1b/manim">github 项目</a></p><blockquote><p>Note, there are two versions of manim. This repository began as a personal project by the author of <a href="https://www.3blue1brown.com/">3Blue1Brown</a> for the purpose of animating those videos, with video-specific code available <a href="https://github.com/3b1b/videos">here</a>. In 2020 a group of developers forked it into what is now the <a href="https://github.com/ManimCommunity/manim/">community edition</a>, with a goal of being more stable, better tested, quicker to respond to community contributions, and all around friendlier to get started with. See <a href="https://docs.manim.community/en/stable/installation/versions.html?highlight=OpenGL#which-version-to-use">this page</a> for more details.</p></blockquote><p>这里提到有两个版本的 manim，推荐使用 community edition，这个版本更稳定，更容易上手，下面是两个参考链接</p><ol><li><p><a href="https://github.com/ManimCommunity/manim/">ManimCE github</a></p></li><li><p><a href="https://www.manim.community/">ManimCE documentation</a></p></li></ol><p>强烈推荐根据官方文档进行学习，因为网上的很多资源都是过时的，包括我这篇笔记也会可能会很快过时。这篇笔记主要记录如何安装 ManimCE，以及其代码逻辑，更多实用的动画方法另外再做整理</p><h2 id="Install"><a href="#Install" class="headerlink" title="Install"></a>Install</h2><h3 id="Install-dependencies"><a href="#Install-dependencies" class="headerlink" title="Install dependencies"></a>Install dependencies</h3><p>官方给出了一个<a href="https://hub.gke2.mybinder.org/user/behackl-725d956-b7bf9b4aef40b78-cns6ckcq/notebooks/basic%20example%20scenes.ipynb"> jupyter notebook</a> 预先装载好了 manim 环境，如果你现在不想安装的话，可以在这个 notebook 里面进行小实验</p><p>ManimCE 需要预先下载两个软件 ffmpeg 和 LaTex。文档中建议使用 Scoop, Chocolatey 等包管理软件来下载 dependencies，但我太懒了，不想再下一个包管理软件，而且我自己的电脑上本来就安装了 LaTex 和 ffmpeg 所以只要确保 ManimCE  能够调用这些 dependencies 即可，具体来说就是让 ffmpeg 和 LaTex 命令加入环境变量</p><p>给两个参考链接：<a href="https://zhuanlan.zhihu.com/p/118362010">ffmpeg 知乎教程</a>  <a href="https://www.bilibili.com/video/BV11h41127FD?from=search&amp;seid=5330798070960440671">LaTex简介 bilibili</a></p><p>最后在命令行窗口输入 <code>ffmpeg -version</code> 和  <code>tex -version</code> 检查看看能否成功运行</p><h3 id="Install-ManimCE"><a href="#Install-ManimCE" class="headerlink" title="Install ManimCE"></a>Install ManimCE</h3><blockquote><p>Manim Community runs on Python 3.7+. If you’d like to just use the library, you can install it from PyPI via pip:</p></blockquote><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">pip <span class="token function">install</span> manim<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>因为习惯了用 conda，所以我选择在 conda 中创建一个 Manim 环境，然后再 pip install</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">conda create -n manim <span class="token assign-left variable">python</span><span class="token operator">=</span><span class="token number">3.8</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>(然而最终却稀里糊涂的安装在了 base 环境)</p><p>使用 <code>conda list manim</code> 检查是否安装成功，通过 <a href="https://docs.manim.community/en/stable/tutorials/quickstart.html">Quickstart</a> 简单运行一个程序，检查整个流程是否能够运行</p><h2 id="Tutorials"><a href="#Tutorials" class="headerlink" title="Tutorials"></a>Tutorials</h2><h3 id="Quickstart"><a href="#Quickstart" class="headerlink" title="Quickstart"></a>Quickstart</h3><p>下面是一段简单的代码，能够实现从矩形到圆形的变换</p><p><img src="/archives/5654e2fe/SquareToCircle_ManimCE_v0.8.0.gif" alt="SquareToCircle_ManimCE_v0.8.0" style="zoom: 25%;"></p><p>代码如下</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># scene.py</span><span class="token keyword">from</span> manim <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">class</span> <span class="token class-name">SquareToCircle</span><span class="token punctuation">(</span>Scene<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">construct</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        circle <span class="token operator">=</span> Circle<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># create a circle</span>        circle<span class="token punctuation">.</span>set_fill<span class="token punctuation">(</span>PINK<span class="token punctuation">,</span> opacity<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span>  <span class="token comment"># set color and transparency</span>        square <span class="token operator">=</span> Square<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># create a square</span>        square<span class="token punctuation">.</span>rotate<span class="token punctuation">(</span>PI <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">)</span>  <span class="token comment"># rotate a certain amount</span>        self<span class="token punctuation">.</span>play<span class="token punctuation">(</span>Create<span class="token punctuation">(</span>square<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># animate the creation of the square</span>        self<span class="token punctuation">.</span>play<span class="token punctuation">(</span>Transform<span class="token punctuation">(</span>square<span class="token punctuation">,</span> circle<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># interpolate the square into the circle</span>        self<span class="token punctuation">.</span>play<span class="token punctuation">(</span>FadeOut<span class="token punctuation">(</span>square<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># fade out animation</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在 terminal 中执行文件</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">manim -pql scene.py SquareToCircle<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>从上面的代码能够看出 Manim 的一些基本框架，首先要有 class 类别作为场景 Scene，在这个 class 中定义 construct() 函数来实现动画效果，然后通过命令行渲染出动画。文档中提到的 Tip:</p><blockquote><p>Every animation must be contained within the <a href="https://docs.manim.community/en/stable/reference/manim.scene.scene.Scene.html#manim.scene.scene.Scene.construct"><code>construct()</code></a> method of a class that derives from <a href="https://docs.manim.community/en/stable/reference/manim.scene.scene.Scene.html#manim.scene.scene.Scene"><code>Scene</code></a>. Other code, for example auxiliary or mathematical functions, may reside outside the class.</p></blockquote><h3 id="A-deeper-look"><a href="#A-deeper-look" class="headerlink" title="A deeper look"></a>A deeper look</h3><p>主要来分析一下上面的命令</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">manim -pql scene.py SquareToCircle<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>文档中解释</p><blockquote><p>First, this command executes manim on the file <code>scene.py</code>, which contains our animation code. Further, this command tells manim exactly which <code>Scene</code> is to be rendered, in this case, it is <code>SquareToCircle</code>. This is necessary because a single scene file may contain more than one scene. Next, the flag -p tells manim to play the scene once it’s rendered, and the -ql flag tells manim to render the scene in low quality.</p></blockquote><p>下面是几个常见的参数：</p><ol><li><code>-ql, -qm, -qh, -qk</code> 分别代表不同分辨率，从低到高，再到4k</li><li><code>-a</code> 渲染所有的 Scene</li><li><code>-i</code> 输出为 gif 格式</li><li><code>-f</code> 渲染完成后打开所在文件夹</li></ol><h3 id="Manim’s-building-blocks"><a href="#Manim’s-building-blocks" class="headerlink" title="Manim’s building blocks"></a>Manim’s building blocks</h3><p>Manim 中有3个重要概念</p><ol><li><strong>mathematical object</strong> (or <strong>mobject</strong> for short)</li><li><strong>animation</strong></li><li><strong>scene</strong>.</li></ol><blockquote><p>As we will see in the following sections, each of these three concepts is implemented in manim as a separate class: the <a href="https://docs.manim.community/en/stable/reference/manim.mobject.mobject.Mobject.html#manim.mobject.mobject.Mobject"><code>Mobject</code></a>, <a href="https://docs.manim.community/en/stable/reference/manim.animation.animation.Animation.html#manim.animation.animation.Animation"><code>Animation</code></a>, and <a href="https://docs.manim.community/en/stable/reference/manim.scene.scene.Scene.html#manim.scene.scene.Scene"><code>Scene</code></a> classes.</p></blockquote><h4 id="Mobject"><a href="#Mobject" class="headerlink" title="Mobject"></a>Mobject</h4><blockquote><p>Any object that can be displayed on the screen is a <code>mobject</code>, even if it is not necessarily <em>mathematical</em> in nature.</p></blockquote><p>通过 scene 类中的方法 add(), remove() 来在场景中加入 mobject</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> manim <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">class</span> <span class="token class-name">CreatingMobjects</span><span class="token punctuation">(</span>Scene<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">construct</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        circle <span class="token operator">=</span> Circle<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>add<span class="token punctuation">(</span>circle<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>circle<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>对于 mobject 属性的调整，是通过调 mobject 类的方法来完成</p><ol><li><p>Placing mobject location. 选择在哪里加入物体</p><p>.shift()  .move_to()  .next_to()  .align_to()</p></li><li><p>Styling mobjects. 对物体进行风格渲染</p><p>.set_stroke()  .set_fill()</p></li><li><p>Mobject on-screen order. 添加入场景的 mobject 是有顺序的，后添加的物体会覆盖到图层的上方</p></li></ol><h4 id="Animation"><a href="#Animation" class="headerlink" title="Animation"></a>Animation</h4><blockquote><p>At the heart of manim is animation. Generally, you can add an animation to your scene by calling the <code>play()</code> method.</p></blockquote><p>一般来讲通过 play() 方法来加入动画</p><blockquote><p>Animations are procedures that interpolate between two mobjects.</p></blockquote><p>动画的基本原理可以理解为，使用不同的函数在两个关键帧之间进行插值，然后使用 play() 方法进行播放，比如在 Quickstart 中的动画</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">self<span class="token punctuation">.</span>play<span class="token punctuation">(</span>Create<span class="token punctuation">(</span>square<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># animate the creation of the square</span>self<span class="token punctuation">.</span>play<span class="token punctuation">(</span>Transform<span class="token punctuation">(</span>square<span class="token punctuation">,</span> circle<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># interpolate the square into the circle</span>self<span class="token punctuation">.</span>play<span class="token punctuation">(</span>FadeOut<span class="token punctuation">(</span>square<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># fade out animation</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>只要可变的属性，都可以使用动画，通过 <code>Mobject.aminate</code> 实现</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> manim <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">class</span> <span class="token class-name">ApplyMethodExample</span><span class="token punctuation">(</span>Scene<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">construct</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        square <span class="token operator">=</span> Square<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>set_fill<span class="token punctuation">(</span>RED<span class="token punctuation">,</span> opacity<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>add<span class="token punctuation">(</span>square<span class="token punctuation">)</span>        <span class="token comment"># animate the change of color</span>        self<span class="token punctuation">.</span>play<span class="token punctuation">(</span>square<span class="token punctuation">.</span>animate<span class="token punctuation">.</span>set_fill<span class="token punctuation">(</span>WHITE<span class="token punctuation">)</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token comment"># animate the change of position</span>        self<span class="token punctuation">.</span>play<span class="token punctuation">(</span>square<span class="token punctuation">.</span>animate<span class="token punctuation">.</span>shift<span class="token punctuation">(</span>UP<span class="token punctuation">)</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/archives/5654e2fe/ApplyMethodExample_ManimCE_v0.8.0.gif" alt="ApplyMethodExample_ManimCE_v0.8.0" style="zoom: 25%;"></p><h4 id="Scene"><a href="#Scene" class="headerlink" title="Scene"></a>Scene</h4><blockquote><p>The <a href="https://docs.manim.community/en/stable/reference/manim.scene.scene.Scene.html#manim.scene.scene.Scene"><code>Scene</code></a> class is the connective tissue of manim. </p></blockquote><p>所有的 mobject 和 animation 都必须加入到 scene 中才能被展现出来，并且 scene 中必须包含 construct() 方法</p><h3 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h3><blockquote><p>Manim provides an extensive configuration system that allows it to adapt to many different use cases. There are many configuration options that can be configured at different times during the scene rendering process. </p></blockquote><p>在渲染动画的过程中还可以设置更多的参数，比如视频渲染质量的高低 <code>-ql, -qh</code></p><p>能够设置 Configuration 的方法有几种</p><ol><li><p>The ManimConfig class</p><blockquote><p>The most direct way of configuring manim is via the global <code>config</code> object, which is an instance of <a href="https://docs.manim.community/en/stable/reference/manim._config.utils.ManimConfig.html#manim._config.utils.ManimConfig"><code>ManimConfig</code></a>.</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> manim <span class="token keyword">import</span> <span class="token operator">*</span>config<span class="token punctuation">.</span>background_color <span class="token operator">=</span> WHITEconfig<span class="token punctuation">[</span><span class="token string">"background_color"</span><span class="token punctuation">]</span> <span class="token operator">=</span> WHITE<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>Command-line arguments</p><blockquote><p>The following example specifies the output file name (with the <code>-o</code> flag), renders only the first ten animations (<code>-n</code> flag) with a white background (<code>-c</code> flag), and saves the animation as a .gif instead of as a .mp4 file (<code>-i</code> flag). It uses the default quality and does not try to open the file after it is rendered.</p></blockquote><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">manim -o myscene -i -n <span class="token number">0,10</span> -c WHITE <span class="token operator">&lt;</span>file.py<span class="token operator">&gt;</span> SceneName<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>The config files</p><blockquote><p>Manim can also be configured using a configuration file. A configuration file is a file ending with the suffix <code>.cfg</code>. To use a configuration file when rendering your scene, you must create a file with name <code>manim.cfg</code> in the same directory as your scene code.</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">[</span>CLI<span class="token punctuation">]</span><span class="token comment"># my config file</span>output_file <span class="token operator">=</span> myscenesave_as_gif <span class="token operator">=</span> <span class="token boolean">True</span>background_color <span class="token operator">=</span> WHITE<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><h4 id="A-list-of-all-config-options"><a href="#A-list-of-all-config-options" class="headerlink" title="A list of all config options"></a>A list of all config options</h4><pre class="line-numbers language-config" data-language="config"><code class="language-config">     aspect_ratio              assets_dir        background_color       background_opacity           bottom          custom_folders         disable_caching                 dry_run  ffmpeg_loglevel             flush_cache            frame_height              frame_rate       frame_size             frame_width          frame_x_radius          frame_y_radiusfrom_animation_number          fullscreen              images_dir              input_file        left_side                 log_dir             log_to_file        max_files_cached        media_dir             media_width       movie_file_extension    notify_outdated_version      output_file       partial_movie_dir            pixel_height             pixel_width          plugins                 preview            progress_bar                 quality       right_side             save_as_gif         save_last_frame               save_pngs      scene_names       show_in_file_browser                sound                 tex_dir     tex_template       tex_template_file                text_dir                     top      transparent       upto_animation_number   use_opengl_renderer     use_webgl_renderer        verbosity               video_dir       webgl_renderer_path       window_position   window_monitor             window_size               write_all          write_to_movie<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Using-Text"><a href="#Using-Text" class="headerlink" title="Using Text"></a>Using Text</h3><p>There are two different ways by which you can render <strong>Text</strong> in videos:</p><ol><li>Using Pango (<a href="https://docs.manim.community/en/stable/reference/manim.mobject.svg.text_mobject.html#module-manim.mobject.svg.text_mobject"><code>text_mobject</code></a>)</li><li>Using LaTeX (<a href="https://docs.manim.community/en/stable/reference/manim.mobject.svg.tex_mobject.html#module-manim.mobject.svg.tex_mobject"><code>tex_mobject</code></a>)</li></ol><p>一般如果不用公式的话，直接使用 text_mobject 就可以了</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> manim <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">class</span> <span class="token class-name">HelloWorld</span><span class="token punctuation">(</span>Scene<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">construct</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        text <span class="token operator">=</span> Text<span class="token punctuation">(</span><span class="token string">'Hello world'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>scale<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>add<span class="token punctuation">(</span>text<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/archives/5654e2fe/image-20210729160507790.png" style="zoom:25%;"></p><p>使用 tex_mobject 的话，如下</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> manim <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">class</span> <span class="token class-name">HelloLaTeX</span><span class="token punctuation">(</span>Scene<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">construct</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        tex <span class="token operator">=</span> Tex<span class="token punctuation">(</span><span class="token string">r"\LaTeX"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>scale<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>add<span class="token punctuation">(</span>tex<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/archives/5654e2fe/image-20210729160532548.png" style="zoom: 33%;"></p><p>注意需要使用 raw string <code>r('...')</code> 因为 Latex 中很多特殊字符需要进行转义</p><p>还有不同的方法都能返回 text_mobject &amp; tex_mobject，比如 MarkupText, MathTex </p><p>这篇笔记就到这里了，还有好多好玩的功能就请自行探索吧 😎</p>]]></content>
      
      
      <categories>
          
          <category> 编程 </category>
          
          <category> Manim </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 教程 </tag>
            
            <tag> Manim </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Faster RCNN 笔记</title>
      <link href="/archives/2ad8fafc.html"/>
      <url>/archives/2ad8fafc.html</url>
      
        <content type="html"><![CDATA[<h1 id="Faster-RCNN-note"><a href="#Faster-RCNN-note" class="headerlink" title="Faster RCNN note"></a>Faster RCNN note</h1><p>本文总结自知乎链接<a href="https://zhuanlan.zhihu.com/p/31426458">https://zhuanlan.zhihu.com/p/31426458</a></p><h2 id="整体思路"><a href="#整体思路" class="headerlink" title="整体思路"></a>整体思路</h2><p>Faster RCNN其实可以分为4个主要内容：</p><ol><li><p>Conv layers </p><p>Faster RCNN首先使用一组基础的conv+relu+pooling层提取image的feature maps。该feature maps被共享用于后续RPN层和全连接层。</p></li><li><p>Region Proposal Networks</p><p>该层通过softmax判断anchors属于positive或者negative，再利用bounding box regression修正anchors获得精确的proposals。</p></li><li><p>Roi Pooling</p><p>该层收集输入的feature maps和proposals，综合这些信息后提取proposal feature maps，送入后续全连接层判定目标类别。</p></li><li><p>Classification</p><p>利用proposal feature maps计算proposal的类别，同时再次bounding box regression获得检测框最终的精确位置。</p></li></ol><p><img src="/archives/2ad8fafc/image-20210614151135341.png" style="zoom: 67%;"></p><h2 id="Conv-Layers"><a href="#Conv-Layers" class="headerlink" title="Conv Layers"></a>Conv Layers</h2><p>Conv layers部分共有13个conv层，13个relu层，4个pooling层 </p><ol><li>所有的conv层都是：kernel_size=3，pad=1，stride=1</li><li>所有的pooling层都是：kernel_size=2，pad=0，stride=2</li></ol><p>那么，一个MxN大小的矩阵经过Conv layers固定变为(M/16)x(N/16)</p><h2 id="Region-Proposal-Networks"><a href="#Region-Proposal-Networks" class="headerlink" title="Region Proposal Networks"></a>Region Proposal Networks</h2><h3 id="Anchors"><a href="#Anchors" class="headerlink" title="Anchors"></a>Anchors</h3><p>提到RPN网络，就不能不说anchors。所谓anchors，实际上就是一组由程序生成的矩形。直接运行作者demo中的generate_anchors.py可以得到以下输出 (不要被这些数字吓到了，没有具体意义)</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token operator">-</span><span class="token number">84</span><span class="token punctuation">.</span>  <span class="token operator">-</span><span class="token number">40</span><span class="token punctuation">.</span>   <span class="token number">99</span><span class="token punctuation">.</span>   <span class="token number">55</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">176</span><span class="token punctuation">.</span>  <span class="token operator">-</span><span class="token number">88</span><span class="token punctuation">.</span>  <span class="token number">191</span><span class="token punctuation">.</span>  <span class="token number">103</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">360</span><span class="token punctuation">.</span> <span class="token operator">-</span><span class="token number">184</span><span class="token punctuation">.</span>  <span class="token number">375</span><span class="token punctuation">.</span>  <span class="token number">199</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token punctuation">[</span> <span class="token operator">-</span><span class="token number">56</span><span class="token punctuation">.</span>  <span class="token operator">-</span><span class="token number">56</span><span class="token punctuation">.</span>   <span class="token number">71</span><span class="token punctuation">.</span>   <span class="token number">71</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">120</span><span class="token punctuation">.</span> <span class="token operator">-</span><span class="token number">120</span><span class="token punctuation">.</span>  <span class="token number">135</span><span class="token punctuation">.</span>  <span class="token number">135</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">248</span><span class="token punctuation">.</span> <span class="token operator">-</span><span class="token number">248</span><span class="token punctuation">.</span>  <span class="token number">263</span><span class="token punctuation">.</span>  <span class="token number">263</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token punctuation">[</span> <span class="token operator">-</span><span class="token number">36</span><span class="token punctuation">.</span>  <span class="token operator">-</span><span class="token number">80</span><span class="token punctuation">.</span>   <span class="token number">51</span><span class="token punctuation">.</span>   <span class="token number">95</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token punctuation">[</span> <span class="token operator">-</span><span class="token number">80</span><span class="token punctuation">.</span> <span class="token operator">-</span><span class="token number">168</span><span class="token punctuation">.</span>   <span class="token number">95</span><span class="token punctuation">.</span>  <span class="token number">183</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">168</span><span class="token punctuation">.</span> <span class="token operator">-</span><span class="token number">344</span><span class="token punctuation">.</span>  <span class="token number">183</span><span class="token punctuation">.</span>  <span class="token number">359</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>每行有4个值，代表了矩形左上角和右下角两个点$(x_1, y_1, x_2, y_2)$ </p><p>一共9个矩形，来组于不同长宽比和不同大小的组合：长宽比有3种，1:1, 1:2, 2:1</p><p><img src="/archives/2ad8fafc/image-20210614152512944.png" style="zoom:50%;"></p><p>那么这9个anchors是做什么的呢？借用Faster RCNN论文中的原图，如图7，遍历Conv layers计算获得的feature maps，为每一个点都配备这9种anchors作为初始的检测框</p><p><img src="/archives/2ad8fafc/v2-c93db71cc8f4f4fd8cfb4ef2e2cef4f4_720w.jpg" style="zoom:80%;"></p><p>简单解释一下上图：</p><ol><li><p>conv feature map中，每一个点都是256-dimensions</p></li><li><p>intermidiate layer为 3x3 卷积，out put dimension为256，得到新的conv feature map</p></li><li><p>在新的conv feature map上，我们对每一个点预先设定的k个anchor做bounding box regression和softmax分类(positive, nagetive两类)，分别对应4k coordinates，2k scores</p><p>换句话说，就是把某一anchor区域中的特征向量拿去做prediction，预测内容为该点的分类和该点/anchor对应的bounding box参数</p></li><li><p>由于anchor数量是巨大的，训练程序会在合适的anchors中<strong>随机</strong>选取128个postive anchors+128个negative anchors进行训练</p></li></ol><h3 id="Bounding-box-regression原理"><a href="#Bounding-box-regression原理" class="headerlink" title="Bounding box regression原理"></a>Bounding box regression原理</h3><p>怎样在anchor的基础上回归得到ground truth标签呢？</p><p>给定anchor $(A_x, A_y, A_w, A_h)$ ，给定ground truth $(G_x, G_y, G_w, G_h)$</p><p>我们只要去预测中心点的位置偏移，以及矩形长宽的缩放即可</p><p>个人觉得这样的回归方法有点麻烦，这样来看CenterNet中的bounding box回归是相当直接的</p><h3 id="Proposal"><a href="#Proposal" class="headerlink" title="Proposal"></a>Proposal</h3><ol><li>生成anchors，得到对应的confidence score &amp; bounding box regression，形成最初的proposal</li><li>对所有anchors，根据positive score进行排序，取前6000个anchor proposals</li><li>去除较小和超出边界的proposal</li><li>NMS</li></ol><h2 id="ROI-Pooling"><a href="#ROI-Pooling" class="headerlink" title="ROI Pooling"></a>ROI Pooling</h2><p>Rol pooling层有2个输入：</p><ol><li>原始feature maps</li><li>RPN输出的proposals</li></ol><p>这一个Pooling操作还要有一个功能，就是需要处理不同大小的proposal (kernel)。经典的pooing操作是使用相同大小的kernel，这里我们要预先对 proposal (region of interest) 进行统一的分割，使得pooling结果是相同的表示(如下图)</p><p><img src="/archives/2ad8fafc/image-20210614164103022.png" style="zoom: 67%;"></p><h2 id="Classification"><a href="#Classification" class="headerlink" title="Classification"></a>Classification</h2><p>Classification部分利用已经获得的proposal feature maps，通过full connect层与softmax计算每个proposal具体属于那个类别（如人，车，电视等），输出cls_prob概率向量；同时再次利用bounding box regression获得每个proposal的位置偏移量bbox_pred，用于回归更加精确的目标检测框</p><p><img src="/archives/2ad8fafc/image-20210614164211554.png" style="zoom:80%;"></p><h2 id="Training"><a href="#Training" class="headerlink" title="Training"></a>Training</h2><p>Faster R-CNN的训练，是在已经训练好的model（如VGG，ZF）的基础上继续进行训练，实际训练过程为以下：</p><ol><li>在已经训练好的model(e.g. VGG)，训练RPN</li><li>用步骤1中得到的RPN提出proposal</li><li>用提出的Proposal训练Fast RCNN</li><li>用步骤4中训练好的Fast RCNN继续训练RPN</li><li>重复2</li><li>重复3</li></ol><p>可以看出这是一种类似迭代的过程，但只循环了2次，文章提出更多的循环并不会带来相应的提升</p>]]></content>
      
      
      <categories>
          
          <category> papers </category>
          
      </categories>
      
      
        <tags>
            
            <tag> faster rcnn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vs code 教程</title>
      <link href="/archives/ca50f614.html"/>
      <url>/archives/ca50f614.html</url>
      
        <content type="html"><![CDATA[<h1 id="vscode-note"><a href="#vscode-note" class="headerlink" title="vscode note"></a>vscode note</h1><p>学习视频 <a href="https://www.bilibili.com/video/BV1ty4y1S7mC?p=1">bilibili</a></p><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>直接在官网一键下载，宇宙第一开发工具，而且还是免费的<span class="github-emoji"><span>😆</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f606.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> 使用最新版本的 vscode，有时出现一些莫名其妙的 bug<span class="github-emoji"><span>😢</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f622.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>，可以使用前几个版本的，如果用熟了某一个版本那暂时不要更新了吧。如果想要完整卸载的话需要删除 <code>usr/.vscode</code> 和 <code>AppData/Code</code> 文件，感觉整体来看 vscode 依然是在发展当中的开发工具</p><h3 id="Getting-started"><a href="#Getting-started" class="headerlink" title="Getting started"></a>Getting started</h3><ol><li><p>vscode 支持更换主题皮肤</p></li><li><p>vscode 支持插件扩展，能够实现多种功能来提高编程效率，如下载不同语言，高亮代码等等，推荐的插件：Python, Gitlens, Remote SSH</p></li><li><p>通过快捷键 palette 查找文件 Ctrl + P，查找命令 Ctrl + Shift + P</p><p>可以修改一些你常用命令的快捷键，我修改了如下命令：</p><ol><li>Run in python file: Ctrl + enter</li><li>Start debugging: Shift +enter</li><li>Close panels: Ctrl + Alt + P</li><li>Insert Line Above/Below: Ctrl + Shifg + \ or Enter</li></ol></li><li><p>设置面板快捷键 Ctrl + ,</p></li><li><p>新建一个文件 Ctrl + N</p></li></ol><h2 id="交互式演练场-Interactive-Playground"><a href="#交互式演练场-Interactive-Playground" class="headerlink" title="交互式演练场 Interactive Playground"></a>交互式演练场 Interactive Playground</h2><p>一些编辑的小技巧</p><ol><li><p>同时选中同名字段 Ctrl + Shift + L，但这个功能没有 Refactoring 智能</p></li><li><p>IntelliSense 自动补全 api 功能 Ctrl + space</p></li><li><p>行操作</p><ol><li>复制行，在没有任何东西选中的时候直接 Ctrl + C</li><li>上下移动行，Alt + 上下键</li><li>删除行 Ctrl + Shift + K</li></ol></li><li><p>Formatting 规范代码，需要自己定义 format</p></li></ol><h2 id="一些推荐的设置"><a href="#一些推荐的设置" class="headerlink" title="一些推荐的设置"></a>一些推荐的设置</h2><p>打开 settings</p><ol><li>在熟悉之后关闭 welcome/startup 界面</li><li>建议使用英文界面</li><li>设置字体 JetBrains Mono，还可以顺便设置一下字号。安装字体<a href="https://blog.csdn.net/HUSTHY/article/details/104023077">教程</a></li><li>设置是否显示缩略图 minimap</li><li><p>设置 restore windows 是否直接恢复上一次的项目</p></li><li><p>设置开启 Trims final newlines 自动消除文件末尾多余的空行</p></li></ol><h2 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h2><p>下载 Python 插件</p><h3 id="Get-Started"><a href="#Get-Started" class="headerlink" title="Get Started"></a>Get Started</h3><ol><li><p>在底部的 status bar 添加 python 解释器，也可以使用 palette 来添加 interpreter。会自动检测到电脑上的 python interpreter (包括 anaconda 中创建的环境)</p></li><li><p>建立 debug 环境 craete a launch.json file，直接使用默认值就好，详细说明在 <a href="https://zhuanlan.zhihu.com/p/142642410">知乎链接</a></p><p>补充：默认配置只 debug 当前 folder 下的代码（“自己”的代码），如果是 pip/conda install 安装的代码（“别人”的代码），是不会进行 debug 的。如果想要 debug 所有代码则配置文件需要加上 <code>"justMyCode": false</code> <a href="https://blog.csdn.net/g534441921/article/details/102743393">CSDN 参考链接</a></p></li><li><p>Jupyter notebook 是插件里自带的功能，直接打开 ipynb 文件就可以运行代码块！通过选择 notebook 中的 kernel (具体一点说就是选择 conda 中的环境) 就能在你想要的环境中运行了，非常方便</p></li></ol><h3 id="连接到远程服务器"><a href="#连接到远程服务器" class="headerlink" title="连接到远程服务器"></a>连接到远程服务器</h3><p>由于要跑一些模型，自己的电脑显卡根本跑不动，那就<del>白嫖</del>连接到实验室的服务器​</p><p>通过 vscode Extensions: <code>Remote-SSH</code> 完成，<a href="https://zhuanlan.zhihu.com/p/141205262">知乎教程</a></p><p>在 Remote Expolorer -&gt; SSH TARGETS -&gt; config 中添加配置</p><pre class="line-numbers language-config" data-language="config"><code class="language-config"># Read more about SSH config files: https://linux.die.net/man/5/ssh_configHost random_name    HostName host_ip    User user_name<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>遇到了报错 <code>Resolver error: Error: Running the contributed command: '_workbench.downloadResource' failed.</code> 无法连接到服务器。原因可能在于服务器是在内网，没有办法在服务器上自动下载好 vscode-server，于是只能本地下载，然后上传</p><p>参考 <a href="https://blog.csdn.net/ibless/article/details/118610776">CSDN 链接</a> 解决问题</p>]]></content>
      
      
      <categories>
          
          <category> 编程 </category>
          
          <category> VScode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 教程 </tag>
            
            <tag> vscode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CenterPoint 复现笔记</title>
      <link href="/archives/ba7995ee.html"/>
      <url>/archives/ba7995ee.html</url>
      
        <content type="html"><![CDATA[<h1 id="CenterPoint-复现笔记"><a href="#CenterPoint-复现笔记" class="headerlink" title="CenterPoint 复现笔记"></a>CenterPoint 复现笔记</h1><h2 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h2><ol><li><p>pytorch下载如果很慢，请采用镜像！</p></li><li><p>下载cmake使用apt，但要更新下载源为阿里云，这样版本才够新</p></li><li><p>安装spconv时报错</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">The following packages have unmet dependencies: gsettings-desktop-schemas <span class="token builtin class-name">:</span> Breaks: mutter <span class="token punctuation">(</span><span class="token operator">&lt;</span> <span class="token number">3.31</span>.4<span class="token punctuation">)</span> but <span class="token number">3.28</span>.4+git20200505-0ubuntu18.04.2 is to be installedE: Error, pkgProblemResolver::Resolve generated breaks, this may be caused by held packages.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>网络上一个解决方案是使用aptitude</p><pre class="line-numbers language-SHell" data-language="SHell"><code class="language-SHell"># download aptitudesudo apt install aptitudesudo aptitude install &lt;packagename&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>血泪教训，不要轻易使用aptitude，系统很多东西都被改写了，经过一番折腾升级到了ubuntu 20.04，也不知道之前安装的东西有没有被动</p><p>印象中提到”held packages”，应该按照那种方式解决</p></li><li><p>在下载 spconv 报错</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">CMake Error at CMakeLists.txt:2 <span class="token punctuation">(</span>project<span class="token punctuation">)</span>:  No CMAKE_CUDA_COMPILER could be found.  raise CalledProcessError<span class="token punctuation">(</span>retcode, cmd<span class="token punctuation">)</span>subprocess.CalledProcessError: Command <span class="token string">'['</span>cmake<span class="token string">', '</span>/home/declan/CenterPoint/spconv<span class="token string">', '</span>-DCMAKE_PREFIX_PATH<span class="token operator">=</span>/home/declan/anaconda3/envs/centerpoint/lib/python3.6/site-packages/torch<span class="token string">', '</span>-DPYBIND11_PYTHON_VERSION<span class="token operator">=</span><span class="token number">3.6</span><span class="token string">', '</span>-DSPCONV_BuildTests<span class="token operator">=</span>OFF<span class="token string">', '</span>-DCMAKE_CUDA_FLAGS<span class="token operator">=</span><span class="token string">"--expt-relaxed-constexpr"</span><span class="token string">', '</span>-DCMAKE_LIBRARY_OUTPUT_DIRECTORY<span class="token operator">=</span>/home/declan/CenterPoint/spconv/build/lib.linux-x86_64-3.6/spconv<span class="token string">', '</span>-DCMAKE_BUILD_TYPE<span class="token operator">=</span>Release<span class="token string">']'</span> returned non-zero <span class="token builtin class-name">exit</span> status <span class="token number">1</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>尝试设置 CUDA 路径</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token builtin class-name">export</span> <span class="token assign-left variable">PYTHONPATH</span><span class="token operator">=</span><span class="token string">"<span class="token variable">${PYTHONPATH}</span>:/home/declan/CenterPoint"</span><span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span>/usr/local/cuda-10.0/bin:<span class="token environment constant">$PATH</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">CUDA_PATH</span><span class="token operator">=</span>/usr/local/cuda-10.0<span class="token builtin class-name">export</span> <span class="token assign-left variable">CUDA_HOME</span><span class="token operator">=</span>/usr/local/cuda-10.0<span class="token builtin class-name">export</span> <span class="token assign-left variable">LD_LIBRARY_PATH</span><span class="token operator">=</span>/usr/local/cuda-10.0/lib64:<span class="token variable">$LD_LIBRARY_PATH</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>没有效果。#241 issues和我问题一模一样 <a href="https://github.com/traveller59/spconv/issues/241">https://github.com/traveller59/spconv/issues/241</a></p><p>尝试增加路径 </p><p>try adding ‘-DCMAKE_CUDA_COMPILER=/usr/local/cuda-10.1/bin/nvcc’ in cmake_args</p><p>依旧失败</p><p>尝试使用不同版本的g++ sudo apt install g++-7，显示已经下载，我们需要切换版本</p><p>ls name* 可以列出所有name开头的包</p><p><a href="https://blog.csdn.net/FontThrone/article/details/104279224">https://blog.csdn.net/FontThrone/article/details/104279224</a></p><p>—slave 使得g++ gcc版本保持一致 70 90为重要权重priority</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">sudo</span> update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-7 <span class="token number">70</span> --slave /usr/bin/g++ g++ /usr/bin/g++-7<span class="token function">sudo</span> update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-9 <span class="token number">90</span> --slave /usr/bin/g++ g++ /usr/bin/g++-9<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>对g++和gcc进行管理</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">  Selection    Path            Priority   Status------------------------------------------------------------* <span class="token number">0</span>            /usr/bin/gcc-9   <span class="token number">90</span>        auto mode  <span class="token number">1</span>            /usr/bin/gcc-7   <span class="token number">70</span>        manual mode  <span class="token number">2</span>            /usr/bin/gcc-9   <span class="token number">90</span>        manual mode<span class="token function">sudo</span> update-alternatives --config gcc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>成功</p></li><li><p>选择了 nuScenes mini 数据集</p></li><li><p>运行测试</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">python ./tools/dist_test.py infos_val_10sweeps_withvelo_filter_True.json  --work_dir work_dirs/CONFIG_NAME --checkpoint work_dirs/CONFIG_NAME/latest.pth --speed_test <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>报错</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ModuleNotFoundError: No module named <span class="token string">'torchie'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>尝试将torchie文档直接加入到PYTHONPATH当中</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token builtin class-name">export</span> <span class="token assign-left variable">PYTHONPATH</span><span class="token operator">=</span><span class="token variable">$PYTHONPATH</span>:/home/delcan/CenterPoint/det3d<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>新报错</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span>:  File <span class="token string">"./tools/dist_test.py"</span>, line <span class="token number">211</span>, <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">&gt;</span>    main<span class="token punctuation">(</span><span class="token punctuation">)</span>  File <span class="token string">"./tools/dist_test.py"</span>, line <span class="token number">102</span>, <span class="token keyword">in</span> main    logger <span class="token operator">=</span> get_root_logger<span class="token punctuation">(</span>cfg.log_level<span class="token punctuation">)</span>  File <span class="token string">"/home/declan/CenterPoint/det3d/torchie/utils/config.py"</span>, line <span class="token number">146</span>, <span class="token keyword">in</span> __getattr__    <span class="token builtin class-name">return</span> getattr<span class="token punctuation">(</span>self._cfg_dict, name<span class="token punctuation">)</span>  File <span class="token string">"/home/declan/CenterPoint/det3d/torchie/utils/config.py"</span>, line <span class="token number">29</span>, <span class="token keyword">in</span> __getattr__    raise exAttributeError: <span class="token string">'ConfigDict'</span> object has no attribute <span class="token string">'log_level'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>可能是因为 nuscenes_mini 测试集原因</p><p><a href="https://github.com/tianweiy/CenterPoint/issues/106">https://github.com/tianweiy/CenterPoint/issues/106</a></p><p>我根据上面的内容对源码进行了修改，先尝试 train 一下</p><p>依旧报错，再检查可能是因为配置文件没有对的原因</p><p><a href="https://github.com/open-mmlab/mmdetection/issues/3093">https://github.com/open-mmlab/mmdetection/issues/3093</a></p><p>通过正确配置 <code>nusc_centerpoint_voxelnet_0075voxel_fix_bn_z.py</code> 文件解决上面报错</p><p><code>./configs/nusc/voxelnet/nusc_centerpoint_voxelnet_0075voxel_fix_bn_z.py</code></p><p>由于没有完整的 nuScenes 数据集，又有新的错误报错</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">FileNotFoundError: <span class="token punctuation">[</span>Errno <span class="token number">2</span><span class="token punctuation">]</span> No such <span class="token function">file</span> or directory: <span class="token string">'nuScenes/samples/LIDAR_TOP/n008-2018-08-27-11-48-51-0400__LIDAR_TOP__1535385105950634.pcd.bin'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>跳过这里，尝试跑一个 demo</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">python ./tools/dist_test.py ./configs/nusc/voxelnet/nusc_centerpoint_voxelnet_0075voxel_fix_bn_z.py --work_dir work_dirs/nusc_centerpoint_voxelnet_0075voxel_fix_bn_z --checkpoint work_dirs/nusc_centerpoint_voxelnet_0075voxel_fix_bn_z/latest.pth --speed_test <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>上面的报错</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">FileNotFoundError: <span class="token punctuation">[</span>Errno <span class="token number">2</span><span class="token punctuation">]</span> No such <span class="token function">file</span> or directory: <span class="token string">'nuScenes/samples/LIDAR_TOP/n015-2018-10-02-10-50-40+0800__LIDAR_TOP__1538448754047572.pcd.bin'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>查找目录发现这个文件其实是存在的，说明路径没有对，在 CentePoint 目录下添加 nuScenes 的软链接就可以解决了</p></li><li><p>最终 RuntimeError: CUDA out of memory 即使 batch_size = 1 也直接炸了，放弃！</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> papers </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CenterPoint </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>阿里云服务器部署 Hexo 博客教程</title>
      <link href="/archives/d547a647.html"/>
      <url>/archives/d547a647.html</url>
      
        <content type="html"><![CDATA[<h1 id="阿里云服务器ECS"><a href="#阿里云服务器ECS" class="headerlink" title="阿里云服务器ECS"></a>阿里云服务器ECS</h1><p>参考链接：</p><p><a href="https://www.bilibili.com/video/BV177411K7bH">狂神说_bilibili</a></p><p>官方链接：</p><p><a href="https://developer.aliyun.com/plan/grow-up">阿里云开发者成长计划</a></p><p><a href="https://developer.aliyun.com/adc/student?spm=a2c6h.19776329.J_4403085560.4.658b3d804yW1UU#J_3120529270">ECS训练营</a></p><p><a href="https://www.aliyun.com/product/ecs?spm=5176.224200.J_8058803260.52.1401586cYUB7hI">云服务器ECS</a></p><h2 id="学生机"><a href="#学生机" class="headerlink" title="学生机"></a>学生机</h2><p>如果是学生/新用户，一定要去看看有哪些优惠，比如<a href="https://developer.aliyun.com/plan/grow-up">阿里云开发者成长计划</a>。此刻阿里云提供的学生优惠是免费使用2个月的服务器资源。如果购买的话，一个1核2G的服务器就足够了</p><p><img src="/archives/d547a647/image-20210717163630430-1627213118656.png" style="zoom: 25%;"></p><h2 id="设置安全组"><a href="#设置安全组" class="headerlink" title="设置安全组"></a>设置安全组</h2><p>进入控制台开启端口，否则外部无法访问。除了默认的三个端口，通过“快速添加”，我再添加了 http(80) &amp; https(443) 两个端口。由于现在我对计算机网络一窍不通，所以先就这样吧</p><p><img src="/archives/d547a647/image-20210717155930905-1627213118658.png" style="zoom: 33%;"></p><h2 id="重置实例密码"><a href="#重置实例密码" class="headerlink" title="重置实例密码"></a>重置实例密码</h2><p>修改密码之后实例就会自动重启</p><p>然后就可以通过 <code>ssh root@ip</code> 连接到服务器，其中 ip 是你服务器的公网 ip</p><p><img src="/archives/d547a647/image-20210717162311907-1627213118658.png" style="zoom: 33%;"></p><h2 id="Enjoy"><a href="#Enjoy" class="headerlink" title="Enjoy"></a>Enjoy</h2><p>之后就可以像操作 Linux 一样，操作自己的服务器啦！</p><h2 id="将博客部署到服务器上"><a href="#将博客部署到服务器上" class="headerlink" title="将博客部署到服务器上"></a>将博客部署到服务器上</h2><p>几个参考教程：<a href="https://developer.aliyun.com/article/775005">阿里云教程</a> <a href="https://blog.csdn.net/weixin_41154636/article/details/99685965">csdn 教程</a> <a href="https://cloud.tencent.com/developer/article/1632020">腾讯云教程</a> <a href="https://zhuanlan.zhihu.com/p/120743882">知乎教程</a></p><p>在开始之前，先根据之前的 Linux 安装教程简单设置一下自己的服务器：添加新用户，更改主机名</p><p>现在本地配置好 hexo 环境，具体配置过程在之前的博客有详细记录</p><h3 id="在服务器上安装-git"><a href="#在服务器上安装-git" class="headerlink" title="在服务器上安装 git"></a>在服务器上安装 git</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">sudo</span> yum <span class="token function">install</span> -y <span class="token function">git</span><span class="token comment"># 安装成功后查看 git version</span><span class="token function">git</span> --version <span class="token function">git</span> version <span class="token number">2.27</span>.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>因为之前在 Ubuntu 上使用的是 apt 包管理，在 CentOS 上则换为 yum 包管理。我试验了一下，如果不加 sudo 是不能下载成功的</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">Error: This <span class="token builtin class-name">command</span> has to be run under the root user.<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>所以我认为 yum 和 apt 一样需要 sudo 权限</p><h3 id="安装-nginx"><a href="#安装-nginx" class="headerlink" title="安装 nginx"></a>安装 nginx</h3><p>什么是 nginx？下面是官网描述</p><blockquote><p>NGINX is a high‑performance, highly scalable, highly available web server, reverse proxy server, and web accelerator (combining the features of an HTTP load balancer, content cache, and more).</p></blockquote><p>在我理解看来，部署网站的过程中 nginx 就是用来提供网页服务的服务器。这里就要更进一步理解什么是广义上的服务器</p><blockquote><p>从广义上讲，服务器是指网络中能对其它机器提供某些服务的计算机系统。从狭义上讲，服务器是专指某些高性能计算机，能通过网络，对外提供服务。</p></blockquote><p>使用以下命令安装</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">sudo</span> yum <span class="token function">install</span> -y nginx<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="建立-git-仓库"><a href="#建立-git-仓库" class="headerlink" title="建立 git 仓库"></a>建立 git 仓库</h3><p>Hexo 可以使用 git 来部署，这样每次写完之后就都可以使用git来一键部署了，比较方便。我们先为系统添加一个 git 用户</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">useradd</span> -m <span class="token function">git</span> <span class="token comment"># 添加一个新用户</span><span class="token function">passwd</span> <span class="token function">git</span> <span class="token comment"># 设置git用户密码</span><span class="token function">su</span> <span class="token function">git</span> <span class="token comment"># 切换用户进行后续操作</span><span class="token builtin class-name">cd</span> /home/git/<span class="token function">mkdir</span> -p projects/blog <span class="token comment"># 把项目目录建立起来</span><span class="token function">mkdir</span> repos <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> repos<span class="token function">git</span> init --bare blog.git <span class="token comment"># 创建仓库</span><span class="token builtin class-name">cd</span> blog.git/hooks<span class="token function">vim</span> post-receive <span class="token comment"># 创建一个钩子</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>post-receive文件的内容如下：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token shebang important">#!/bin/sh</span><span class="token function">git</span> --work-tree<span class="token operator">=</span>/home/git/projects/blog --git-dir<span class="token operator">=</span>/home/git/repos/blog.git checkout -f<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>给 post-receive 添加执行权限</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">chmod</span> +x post-receive<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>git init —bare 和 git init 有什么区别？ <a href="https://blog.csdn.net/sinat_34349564/article/details/52487860">csdn 链接</a></p><p>hooks有什么作用？ <a href="https://blog.csdn.net/weixin_41154636/article/details/99685965">csdn 链接</a></p><p>该钩子的意思是当本地有提交到服务器时，会将文件放在/home/hexo下</p><p><code>-f</code>这个参数如果在多人协作的博客中可能会引发不好的结果，因为他是强制更新的意思，会将本地版本覆盖掉远程服务器的版本，但是是个人的博客系统就无所谓了</p><h3 id="将公钥配置到服务器上"><a href="#将公钥配置到服务器上" class="headerlink" title="将公钥配置到服务器上"></a>将公钥配置到服务器上</h3><p>可以通过建立SSH信任关系，来免去登陆服务器时输入密码的步骤</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ssh-copy-id -i ~/.ssh/id_rsa.pub git@server_ip<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>我尝试了一下自己手动复制 id_rsa.pub 到 authorized_keys 文件中，但是不能实现免密登陆，可能时复制时的字符串出现了问题，之前在 github 时也遇到了类似问题，直接复制公钥无法识别的情况</p><h3 id="更改-git-用户默认-shell"><a href="#更改-git-用户默认-shell" class="headerlink" title="更改 git 用户默认 shell"></a>更改 git 用户默认 shell</h3><p>为了安全，我们最好禁用 git 用户的 shell 登录权限。从而只能用 git clone，git push 等 git 操作访问服务器</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">cat</span> /etc/shells <span class="token comment"># 查看 git-shell 是否在登录方式里面</span><span class="token function">which</span> git-shell <span class="token comment"># 找到git-shell的路径，记下来</span><span class="token function">sudo</span> <span class="token function">vim</span> /etc/shells <span class="token comment"># 把 git-shell 路径添加到文件末尾</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>然后更改 git 用户 shell</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">sudo</span> <span class="token function">vim</span> /etc/passwd<span class="token comment"># 将原来的 /bin/bash 改为 /usr/bin/git-shell</span><span class="token comment"># git:x:1001:1001::/home/git:/usr/bin/git-shell</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p> 这样当你再次用 ssh 连接 git 用户时就会出现以下信息</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">fatal: Interactive <span class="token function">git</span> shell is not enabled.hint: ~/git-shell-commands should exist and have <span class="token builtin class-name">read</span> and execute access.Connection to your_ip closed.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="部署上线"><a href="#部署上线" class="headerlink" title="部署上线"></a>部署上线</h3><p>我们修改<strong>本地</strong> hexo 配置文件 _config.yml</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">deploy</span><span class="token punctuation">:</span>  <span class="token key atrule">type</span><span class="token punctuation">:</span> git  <span class="token key atrule">repo</span><span class="token punctuation">:</span> git@your_ip<span class="token punctuation">:</span>/home/git/repos/blog.git<span class="token comment"># repo: git@github.com:name/name.github.io.git</span>  <span class="token key atrule">branch</span><span class="token punctuation">:</span> master<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>配置好后就是 hexo 三连一键部署：<code>hexo clean &amp;&amp; hexo g &amp;&amp; hexo d</code></p><h3 id="配置-nginx"><a href="#配置-nginx" class="headerlink" title="配置 nginx"></a>配置 nginx</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token builtin class-name">cd</span> /etc/nginx<span class="token function">cp</span> nginx.conf nginx_backup.conf <span class="token comment"># 备份配置文件</span><span class="token function">vim</span> nginx.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>有两个需要修改的地方：</p><ol><li><p>开头的 <code>user nginx</code> 要改为 <code>user root</code> </p></li><li><p>server 部分</p><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">server</span></span><span class="token punctuation">{</span>        <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">80</span></span><span class="token punctuation">;</span> <span class="token comment">#监听80端口</span>        <span class="token directive"><span class="token keyword">server_name</span> 139.159.245.212</span><span class="token punctuation">;</span> <span class="token comment">#你的服务器名，通常是域名，如果是域名，你就需要监听80端口</span>        <span class="token directive"><span class="token keyword">root</span>       /home/git/projects/blog</span><span class="token punctuation">;</span> <span class="token comment">#网站的根目录</span>        <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><p>配置好后 <code>nginx -s reload</code> 重新加载配置信息，如果是第一次进行加载，则还需要先运行命令 <code>nginx -c /etc/nginx/nginx.conf</code></p><p>现在你就可以通过 ip 地址访问你的网页啦！</p><p>我发现由于我的网站封面太大(有6M)，打开时加载比较慢。所以我需要压缩一下封面图片的大小，推荐两个压缩图片网站</p><p><a href="https://compressjpeg.com/">https://compressjpeg.com/</a></p><p><a href="https://tinypng.com/">https://tinypng.com/</a></p><h2 id="域名"><a href="#域名" class="headerlink" title="域名"></a>域名</h2><p>什么是域名？参考链接：<a href="https://www.bilibili.com/video/BV1kE411i7Jo?from=search&amp;seid=2556702162224412196">CodeSheep bilibili</a></p><p>建议阅读官方文档：<a href="https://help.aliyun.com/product/35473.html?spm=a2c4g.11186623.6.540.5b09689epNroGg">阿里云域名服务</a> <a href="https://help.aliyun.com/document_detail/61257.html?spm=a2c4g.11174283.2.6.36904c070bCdBM">什么是阿里云域名服务</a></p><p>根据官方文档 <a href="https://help.aliyun.com/document_detail/54068.htm?spm=a2c4g.11186623.2.13.5ff0689efHL52u#task-1830383">注册通用域名</a>，花费79元巨资注册了3年域名 hongkun.space</p><p><img src="/archives/d547a647/image-20210717235130445-1627213118658.png" style="zoom:50%;"></p><p>完成购买过后还需要进行：</p><ol><li><a href="https://help.aliyun.com/document_detail/35881.htm?spm=a2c4g.11186623.2.14.275a689e1pnnCW#concept-uhk-w5v-12b">实名认证</a>：一般3天左右审核通过</li><li><a href="https://beian.aliyun.com/pcContainer/formpage?page=selfBa&amp;pageAction=init&amp;orderType=100">域名备案</a>：初审1-2天，完整备案审核过程大概十多天</li></ol><p>注意需要先进行实名认证，然后才能完成备案</p><p>这里我还遇到一个问题，我通过学生优惠免费领取的服务器不能进行域名备案，因为至少需要有3个月的服务器使用权才能备案。看来还是得自己购买一个服务器，我再次花费巨资96元（新用户优惠）购买了一年的轻量应用服务器</p><h3 id="轻量应用服务器"><a href="#轻量应用服务器" class="headerlink" title="轻量应用服务器"></a>轻量应用服务器</h3><p><a href="https://www.aliyun.com/product/swas?spm=5176.8789780.J_8058803260.52.578945b5xsNx3V">轻量应用服务器</a>有单独的<a href="https://account.aliyun.com/login/login.htm?spm=5176.161059.J_5253785160.3.2c9ea505nvWZQs&amp;oauth_callback=https%3A%2F%2Fswas.console.aliyun.com%2F%3Fspm%3D5176.161059.J_835498.2.3e9f7fdaKmYuj7&amp;lang=zh#/servers">控制台</a>，用来部署网站性价比非常不错，配置过程和上面的云服务器一样</p><p>在轻量应用服务器的控制台中，域名解析和备案就在概览页面当中，根据流程进行即可</p><p><img src="/archives/d547a647/image-20210725173426850.png" style="zoom: 33%;"></p><h2 id="部署-SSL-证书-https"><a href="#部署-SSL-证书-https" class="headerlink" title="部署 SSL 证书 (https)"></a>部署 SSL 证书 (https)</h2><p>网站现在可以访问了，但是如下图可见，登陆网站会提示 <strong>Not Secure!!!</strong></p><p><img src="/archives/d547a647/image-20210802105224250.png" style="zoom: 50%;"></p><p>这可不能忍，于是我根据 <a href="https://blog.csdn.net/qq_33505555/article/details/106046616">CSDN 教程</a> 给阿里云服务器配置 SSL 证书，使用的是 FreeSSL 一个提供免费 https 证书申请的网站</p><h3 id="使用-FreeSSL-申请证书"><a href="#使用-FreeSSL-申请证书" class="headerlink" title="使用 FreeSSL 申请证书"></a>使用 FreeSSL 申请证书</h3><p>老规矩，先看看 <a href="https://blog.freessl.cn/tag/ssl-apply/">官网教程</a></p><ol><li><p>生成 CSR <a href="https://cloud.tencent.com/document/product/400/5367">什么是 CSR ? 腾讯云文档</a></p><p>教程中推荐使用 Keymanager 生成</p></li><li><p>在阿里云服务器中配置 DNS 解析，并对配置进行检测和验证</p><p>验证成功后可以在 FreeSSL 控制台中查看证书</p><p><img src="/archives/d547a647/image-20210802141326078.png" style="zoom:33%;"></p><p>在“更多操作”中可以下载证书，一个 pem 文件，一个 private.key</p><p><img src="/archives/d547a647/image-20210802141919162.png" style="zoom:33%;"></p></li><li><p>然后将证书 .pem 文件导入到 keymanager 中</p><p><img src="/archives/d547a647/image-20210802170924734.png" style="zoom: 25%;"></p></li><li><p>进行一键部署。基于你自己的框架，选择不同的部署方法，我选择部署到 Nginx 上。这里的“一键部署”实质上就是上传你的证书到服务器上</p><p><img src="/archives/d547a647/image-20210802171457165.png" style="zoom: 33%;"></p><p>部署成功过后，使用 <a href="https://myssl.com/">myssl.com </a> 检查网站的安全性。但是如果你的 Nginx 配置不对的话，</p></li><li><p>配置 Nginx</p><p>现在我们希望通过 https 443 端口来打开网站，与之前监听 http 80 端口，我们监听 443 端口，然后将 80 端口重定向</p><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>      <span class="token comment">#listen 80;</span>      <span class="token directive"><span class="token keyword">listen</span> <span class="token number">443</span></span><span class="token punctuation">;</span>      <span class="token directive"><span class="token keyword">ssl</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>      <span class="token directive"><span class="token keyword">ssl_certificate</span> /etc/ssl/cert.pem</span><span class="token punctuation">;</span>      <span class="token directive"><span class="token keyword">ssl_certificate_key</span> /etc/ssl/key.pem</span><span class="token punctuation">;</span>      <span class="token directive"><span class="token keyword">server_name</span>  hongkun.space</span><span class="token punctuation">;</span>      <span class="token directive"><span class="token keyword">root</span>         /home/git/blog</span><span class="token punctuation">;</span>  ...  <span class="token punctuation">}</span>  <span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>      <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span>      <span class="token directive"><span class="token keyword">server_name</span> hongkun.space      <span class="token comment"># permenant redirect to https</span>      return <span class="token number">301</span> https://hongkun.space<span class="token variable">$request_uri</span></span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>配置好过后重启 <code>nginx -s reload</code></p></li><li><p>现在访问网站，旁边就有高贵的<span class="github-emoji"><span>🔒</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f512.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></p><p><img src="/archives/d547a647/image-20210802173016910.png" style="zoom:50%;"></p><p>部署成功过后，还可以使用 <a href="https://myssl.com/">myssl.com </a> 检查网站的安全性</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> 软件 </category>
          
          <category> Hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
            <tag> 阿里云 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>cs231n assignment2 笔记</title>
      <link href="/archives/407bb789.html"/>
      <url>/archives/407bb789.html</url>
      
        <content type="html"><![CDATA[<h1 id="cs231n-2021-Assignment-2-note"><a href="#cs231n-2021-Assignment-2-note" class="headerlink" title="cs231n 2021 Assignment 2 note"></a>cs231n 2021 Assignment 2 note</h1><h2 id="资源"><a href="#资源" class="headerlink" title="资源"></a>资源</h2><p>assignment 模板: <a href="https://github.com/cs231n/cs231n.github.io">github</a> </p><p>官方: <a href="https://cs231n.github.io/assignments2021/assignment2/">课程链接</a></p><p>assignment 参考链接: <a href="https://github.com/amanchadha/stanford-cs231n-assignments-2020">2020</a></p><p>发现了一种新的模式: pycharm + git + anaconda &amp; jupyter</p><p>上面的组合能够帮助写代码的效率提升，pycharm 能够帮助调试，git 用于版本管理，conda 用于环境管理。jupyter 在测试代码块上有很大的优势，并且很多 cs231n 的作业形式都是以 ipynb 的文件类型发布，更适合在 jupyter 上打开，而且 jupyter 能够直接使用创建好的 conda 环境，特别方便</p><p>经过一番折腾，最终决定使用 vs code 替换 pycharm，原因是 vs code 有 jupyter notebook 插件，可以直接显示在 editor 内，比 Pycharm 更方便而且以后想要学习其他语言 vs code 优势更大</p><h2 id="过程中的编程复习"><a href="#过程中的编程复习" class="headerlink" title="过程中的编程复习"></a>过程中的编程复习</h2><ol><li><p>重新复习了 numpy 的一些用法，一个重要思想就是尽量少考虑使用循环解决，要以 index 索引思想来解决数据的操作问题。</p><p>reshape已经存在的shape</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">a<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>b<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>当接受参数是元组而是可变参数 <em>args 的时候，可以用 </em>tuple 来将参数变为 *args</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token operator">*</span>a<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>要学会善用矩阵点乘 A * B，是将对应元素相乘，在计算模的时候，或者当其中一个是 indication function 时很有用</p></li><li><p>重新复习了字典的用法，核心是创造字典，dict(), dict.fromkeys()</p><p>字典的 key, val 迭代器，如果不用 items，则只有 key</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">for</span> key<span class="token punctuation">,</span> val <span class="token keyword">in</span> <span class="token builtin">dict</span><span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>pas<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>对于格式化字符串有新的认知，下面例子</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">self<span class="token punctuation">.</span>params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>self<span class="token punctuation">.</span>params<span class="token punctuation">[</span><span class="token string">'b%d'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> weight_scale <span class="token operator">*</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>hd<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>可以用这样的形式来调用 key</p></li></ol><h2 id="Fully-Connected-Networks"><a href="#Fully-Connected-Networks" class="headerlink" title="Fully Connected Networks"></a>Fully Connected Networks</h2><ol><li>对于网络的认知有了更新。要把层(layer, w)和点(node, x)分开来看，这样网络结构才更清晰。一般隐藏层不包含输出层</li><li><strong>反向传播熟悉 back propagation，尤其是矩阵相乘的反向传播，只需要记住结论就行了。对于广播过后的结果，需要将广播的矩阵作 sum 处理，得到广播前的对应元素梯度</strong></li><li>5 layers 和 3 layers 网络优化时比较，差异在哪里？5 layer 更难优化，对于初始值敏感</li><li><strong>对于优化算法进行了进一步了解，由三个核心点：AdaGrad, Momentum, EWA 最后自然推出 Adam 优化算法</strong></li><li><strong>在编写代码的时候重要的版本需要保存，这就需要使用 git</strong></li></ol><h2 id="Batch-normalization"><a href="#Batch-normalization" class="headerlink" title="Batch normalization"></a>Batch normalization</h2><p>进一步清晰了 bn 的过程与作用，可以回看自己的笔记了解详情</p><h3 id="Inline-Question-1"><a href="#Inline-Question-1" class="headerlink" title="Inline Question 1"></a>Inline Question 1</h3><p><strong>How does the scale of weight initialization affect models with/without batch normalization differently, and why?</strong></p><p>You should find that using batch normalization helps the network to converge much faster. </p><p>使用 batch normalization 会让网络在训练集上收敛更快。这和普通的 normalization 是一个道理，减少 zigzag 拐弯</p><p>还有几个需要知道和理解的点是：</p><ol><li>batch normalization 帮助缓解梯度消失/爆炸的问题，这将减缓因为 weight initialization 过大或过小而产生梯度消失/爆炸的问题</li><li>batch normalization 有一定的正则化效果，避免过拟合</li></ol><p><img src="/archives/407bb789/image-20210707160726541.png" style="zoom: 67%;"></p><h3 id="Inline-Question-2"><a href="#Inline-Question-2" class="headerlink" title="Inline Question 2"></a>Inline Question 2</h3><p><strong>hat does this imply about the relationship between batch normalization and batch size? Why is this relationship observed?</strong></p><p>一般规律是：batch size 越大训练集上收敛越快。当 batch size 比较小的时候，比 baseline 速度更慢，原因在于过少的样本带来的偏差太大，这样的噪音会影响训练和测试表现</p><p><img src="/archives/407bb789/image-20210707164225500.png" style="zoom: 67%;"></p><p>在训练和测试时均会用到 bn layer，测试时用的 $\mu,\sigma$  参数是训练过程中的指数加权平均 EWA</p><h3 id="Layer-Normalization"><a href="#Layer-Normalization" class="headerlink" title="Layer Normalization"></a>Layer Normalization</h3><p>用在 RNN 中更多，如果以后接触 NLP 领域的话再深入整理。简单的解释 <a href="https://zhuanlan.zhihu.com/p/74516930">知乎链接</a> </p><p>假设我们有 10行 3列 的数据，即我们的batchsize = 10，每一行数据有三个特征，这是一种“列缩放”。</p><p>而layer方向相反，它针对的是每一行进行缩放。即只看一笔数据，算出这笔所有特征的均值与方差再缩放。这是一种“行缩放”。</p><p>Q: 为什么 gamma 和 beta 还是原来的 (D, ) 形状？Layer normalization 在 RNN 中有什么作用？</p><p><img src="/archives/407bb789/image-20210707200112133.png" style="zoom: 67%;"></p><p>看得出 layer normalization 在训练上也是有一定作用的，但在图像方面相比于 batch normalization 效果差一点，另一个比较自然的结果是，对于 layer normalization 来说 hidden dimension 取较大值较好</p><h2 id="Drop-out"><a href="#Drop-out" class="headerlink" title="Drop out"></a>Drop out</h2><p>两行代码解决 (inverted) dropout layer 核心</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">mask <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">input</span><span class="token punctuation">.</span>shape<span class="token punctuation">)</span> <span class="token operator">&lt;</span> poutput <span class="token operator">=</span> <span class="token builtin">input</span> <span class="token operator">*</span> mask <span class="token operator">/</span> p<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>vallina dropout 是在 test 时将输出乘以 p 使得输出是一个合理期望值。但如果我们在训练的时候已经除以 p 了，在测试时就不需要作任何操作。下图为正则化效果 regularization</p><p><img src="/archives/407bb789/image-20210708160433242.png" style="zoom:67%;"></p><h2 id="Convolutional-Neural-Networks"><a href="#Convolutional-Neural-Networks" class="headerlink" title="Convolutional Neural Networks"></a>Convolutional Neural Networks</h2><ol><li><p>用嵌套循环实现了最原始的卷积操作，使用 np.pad 函数能实现 padding 操作，感觉这个函数的参数不是那么灵活</p></li><li><p>返回最大值坐标 np.argmax，如果想要返回多元坐标还需要使用 np.unravel_index 转化</p><p><code>np.unravel(indices, shape)</code></p></li><li><p>assignment 提供了 fast_layers.py 来实现快速卷积操作，比我自己写的循环代码要快 1000 多倍，使用了 im2col 技巧以及 Cpython extension</p></li><li><p>为什么在正则化的时候正则项中不包括偏差 b? 个人理解认为 b 对于正则化的贡献并不大，而 w 参数则占据了绝大部分的参数。</p></li></ol><h3 id="Spatial-Batch-Normalization"><a href="#Spatial-Batch-Normalization" class="headerlink" title="Spatial Batch Normalization"></a>Spatial Batch Normalization</h3><p>这是卷积神经网络特有的 batch normalization。之前使用的 batch normalization 面对的是 (N, D) 形状的数据，但卷积过后得到的输出是类似 (N, C, H, W) 这样的多维数据。那我们应该怎样去计算这一批数据的统计量 $\mu, \sigma$ 呢？</p><p>如果沿着之前的思维，我们只沿着样本数据轴 N 去计算 $\mu, \sigma$ </p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># data.shape = (N, C, H, W)</span>mean <span class="token operator">=</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>data<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>var  <span class="token operator">=</span> np<span class="token punctuation">.</span>var<span class="token punctuation">(</span>data<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>这将会得到 (C, H, W) 形状的统计量，其中每一个值 (c, h, w)，其样本来自于 N 个像素点（同一 channel，同一位置）。但我们希望样本的数量更广泛一些，具体一点来说，我们希望样本来自于 N 个 feature map (H, W)，用 numpy 表示为</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># data.shape = (N, C, H, W)</span>mean <span class="token operator">=</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>data<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>var <span class="token operator">=</span> np<span class="token punctuation">.</span>var<span class="token punctuation">(</span>data<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>这将会得到 (C,) 形状的统计量，即：得到了对于某一个 channel 的统计量，这是合理的，因为同一个 channel 我们使用的是同一个 kernel。这样我们不仅得到了更广泛样本的统计量，还减少了参数数量</p><p>如果要使用之前写的 batch_norm 函数的话可以将数据转化为 (N <em> H </em> W, C) ，在 numpy 中使用 transpose + reshape 就可以完成</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">data<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> C<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="Spatial-Group-Normalization"><a href="#Spatial-Group-Normalization" class="headerlink" title="Spatial Group Normalization"></a>Spatial Group Normalization</h3><p>一张图展示Batch Norm， Layer Norm ，Group Norm的区别</p><p><img src="/archives/407bb789/image-20210710193505933.png" alt="image-20210710193505933"></p><p>Group Norm可以理解为在layer Norm的基础上，输入维度为 (N, C, H, W)，对C进行分组，即 (N, G, C//G, H, W)。为了完成这一部分，重新思考了如何基于系统计算 back propagation</p><p><strong>可以以重要的中间变量为节点，根据计算图逐步推导梯度。难点在于有矩阵参与的计算，经常伴随着矩阵形状的改变，在进行 back propagation 中一定要让梯度跟着这些计算进行升维和降维，可以想象为梯度会随着这些节点形状的变化进行复杂的流动，有分流(例如降维度)，也有汇合(例如 broadcast)</strong></p><p>例如，在 forward pass 中 broadcast 会将矩阵升维，sum 会将矩阵降维，如果在 backward pass 中遇到 broadcast 操作时，则需要将 upper_grad 根据对应维度求和，举个例子，如果我们要求下面 X 的梯度的话，代码应该时这样的</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># input: X, X.shape = (N, D)</span><span class="token comment"># f(X) = X - np.mean(X)</span><span class="token comment"># upper_grad = dout, dout.shape = (N, D)</span>dmean <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>dout<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment"># sum broadcast dimension</span>dmean <span class="token operator">=</span> dmean <span class="token operator">/</span> N<span class="token comment"># mean operation back prop</span>dX <span class="token operator">=</span> dout <span class="token operator">-</span> dmean<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果想不使用计算图直接按照一般的矩阵梯度计算，遇到对矩阵/向量求导时，就会出现张量，也就是说维度会增加，需要熟悉张量的运算及其思维。还是借用上面的例子，但我们把平均值作为 (N, D) 形状来看待</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># input: X, X.shape = (N, D)</span><span class="token comment"># f(X) = X - np.mean(X) * np.ones(X.shape)</span><span class="token comment"># upper_grad = dout, dout.shape = (N, D)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><script type="math/tex; mode=display">\frac{\partial{loss}}{\partial{f(x)}} = dout，\ f(x)=x-\mu\\\frac{\partial{f(x)}}{\partial{\mu}} = a\ ((N\times D) \times (N\times D))\ shape\ tensor\\\frac{\partial{loss}}{\partial{\mu}}=\frac{\partial{loss}}{\partial{f(x)}} ·\frac{\partial{f(x)}}{\partial{\mu}}=dout\\\frac{\partial{\mu}}{\partial{x}} = a\ ((N\times D) \times (N\times D))\ shape\ tensor\\\frac{\partial{loss}}{\partial{x}}=\frac{\partial{loss}}{\partial{f(x)}}·\frac{\partial{f(x)}}{\partial{x}} - \frac{\partial{loss}}{\partial{f(x)}}·\frac{\partial{f(x)}}{\partial{\mu}}·\frac{\partial{\mu}}{\partial{x}}=dout -dout·\frac{\partial{\mu}}{\partial{x}}</script><p>这将是一种普适的方法，更加抽象化，能够处理任何的矩阵求导，但不推荐实际中使用。</p><p>不论使用哪种方法，最核心的还是要理解梯度流动的本质——某一个变量的变动能够引起输出多少变动</p><h2 id="BUG"><a href="#BUG" class="headerlink" title="BUG"></a>BUG</h2><h3 id="Fully-Connected-Layer"><a href="#Fully-Connected-Layer" class="headerlink" title="Fully Connected Layer"></a>Fully Connected Layer</h3><p>现在卡在了 solver 上</p><p>不能得到 overfitting 的结果</p><ol><li><p>尝试更换 solver 看能否得到不一样的结果</p><p>失败了</p></li><li><p>尝试使用2016的所有答案，看是否是自己的代码出问题了</p><p>失败了</p><p>小技巧 Ctrl+r 能够更换 pycharm 相同字段</p></li><li><p>尝试更改 colab 本身的文件，使用2016年的colab文件</p><p>成功，原因在于 learning rate 太小了，不能找到全局最优</p></li></ol><h3 id="Batch-normalization-1"><a href="#Batch-normalization-1" class="headerlink" title="Batch normalization"></a>Batch normalization</h3><ol><li><p>卡在了计算 back prop 上</p><p>最后出现的失误还是在于每一个公式必须要精确才行</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">norm_x <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> sample_mean<span class="token punctuation">)</span> <span class="token operator">/</span> np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>sample_var <span class="token operator">+</span> eps<span class="token punctuation">)</span>norm_x <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> sample_mean<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>sample_var<span class="token punctuation">)</span> <span class="token operator">+</span> eps<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>上面两个式子虽然在计算结果上相差不多，但是在网络的计算中，一点点的误差传播过后会变得越来越大</p></li><li><p>尝试使用 jupyter 进行编程，遇到问题：The kernel appears to have died. It will restart automatically</p><p>以为是 jupyter 的问题，但测试了不同的软件都出错了，最终发现是自己代码的问题！当找了一圈没有找到答案时，可能就要怀疑自己了，而不是怀疑软件出了问题！不过这也有好处，让我决定放弃使用 pycharm 转战 vs code</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> 课程 </category>
          
          <category> cs231n </category>
          
      </categories>
      
      
        <tags>
            
            <tag> cs231n </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux 安装笔记</title>
      <link href="/archives/53e3a160.html"/>
      <url>/archives/53e3a160.html</url>
      
        <content type="html"><![CDATA[<h1 id="安装Linux笔记"><a href="#安装Linux笔记" class="headerlink" title="安装Linux笔记"></a>安装Linux笔记</h1><h2 id="安装过程"><a href="#安装过程" class="headerlink" title="安装过程"></a>安装过程</h2><ol><li><p>如何安装双系统：移步 bilibili（建议安装最新版，美观且体验更友好）</p></li><li><p>设置 root 密码。然后创建新用户，并设置新用户密码以及 sudo 权限</p></li><li><p>修改 /etc/hostname，reboot 后永久更改主机名</p></li><li><p>可能出现启动 windows 的时候有 bitlocker，禁用 bitlocker 安全协议</p></li><li><p>配置代理 clash，从 youtube 上学的（迷途小书童），要点就是将配置文件 config.yaml 和 Country.mmdb 移动到 ~/.config/clash 文件夹下面，配置文件通过 clash for windows 生成，文件目录为 User/.config/clash(/profiles) 。通过 clash dashboard 切换节点 <a href="http://clash.razord.top/">http://clash.razord.top/</a></p><p>让Terminal走代理的方法(desktop上的settings中设定会改写terminal端，使用export改写则不会影响desktop)，参考 <a href="https://zhuanlan.zhihu.com/p/46973701">知乎链接</a></p></li><li><p>官网下载git anaconda chrome typora chrome baiduyun vscode软件并安装</p><p>conda install, pip install 下载速度慢时，请使用国内镜像源，例如：</p><ol><li><a href="https://mirrors.bfsu.edu.cn/help/anaconda/">北京外国语大学镜像源</a>（截至2021/6/15下载速度很快）</li><li><a href="https://mirror.tuna.tsinghua.edu.cn/help/anaconda/">清华大学镜像源</a></li><li><a href="https://mirror.nju.edu.cn/help/anaconda">南京大学镜像源</a>（自家的镜像源，当然要推荐一下😎）</li></ol></li><li><p>配置nvidia driver: 根据 <a href="https://zhuanlan.zhihu.com/p/59618999">知乎链接</a> ，在命令行里下载推荐的driver。如果在配置nvidia driver的过程中出现连接不上显卡，可能需要关闭 security boot。参考 <a href="https://zhuanlan.zhihu.com/p/336429888">稚晖君</a> 的教程，下载安装CUDA，选择runfile。</p><p>如果想移除所有cuda, cudnn, nvidia driver</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">sudo</span> <span class="token function">apt-get</span> remove --purge nvidia*<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>设置 cuda path</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token builtin class-name">export</span> <span class="token assign-left variable">CUDA_HOME</span><span class="token operator">=</span>/usr/local/cuda<span class="token builtin class-name">export</span> <span class="token assign-left variable">LD_LIBRARY_PATH</span><span class="token operator">=</span><span class="token variable">${CUDA_HOME}</span>/lib64<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token variable">${CUDA_HOME}</span>/bin:<span class="token variable">${<span class="token environment constant">PATH</span>}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>教程里还教了如何更新apt source为阿里云镜像，里面的软件会更新而且下载更快。同时也设置了 sudo，让每一次 sudo 都不需要输入密码</p></li><li><p>pip install 遇到问题 enter your password to unlock your login keyring</p><p>解决方法，直接cancel，或者在passwd and key中更改密码</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> 编程 </category>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 安装教程 </tag>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Git 教程</title>
      <link href="/archives/2121b11b.html"/>
      <url>/archives/2121b11b.html</url>
      
        <content type="html"><![CDATA[<h1 id="Git-reorganiszed-note"><a href="#Git-reorganiszed-note" class="headerlink" title="Git reorganiszed note"></a>Git reorganiszed note</h1><p>重新整理了 git 的常用操作命令，能够覆盖大部分版本管理场景，适合作为提纲进行复习</p><p>整理来自：<a href="https://www.bilibili.com/video/BV1FE411P7B3?from=search&amp;seid=1905221215711628694">bilibili</a> <a href="https://www.liaoxuefeng.com/wiki/896043488029600">廖雪峰教程</a></p><h2 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h2><p>当遇到国外资源下载很慢的时候，可以考虑使用镜像资源</p><p>视频里使用了淘宝镜像安装 windows 版本 <a href="https://npm.taobao.org/mirrors/">https://npm.taobao.org/mirrors/</a></p><p>ubuntu 直接使用 apt install git 使用阿里云镜像</p><h2 id="Git-配置"><a href="#Git-配置" class="headerlink" title="Git 配置"></a>Git 配置</h2><p>首先要理解的是，在windows 中 git bash 的基本操作命令和 Linux  terminal 是一样的。在 Linux 中 git 是集成到 terminal 当中的</p><h3 id="git-config"><a href="#git-config" class="headerlink" title="git  config"></a>git  config</h3><p>配置用户名和邮箱</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">git</span> config --global user.name <span class="token string">'your_name'</span><span class="token function">git</span> config --global user.email <span class="token string">'***@qq.com'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>之后的所有提交都会使用你的用户和邮箱</p><p>还可以根据需求配置代理</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token comment"># 设置代理</span><span class="token function">git</span> config --global http.proxy http://127.0.0.1:1080<span class="token comment"># 查看代理</span><span class="token function">git</span> config --global --get http.proxy<span class="token comment"># 取消代理</span><span class="token function">git</span> config --global --unset http.proxy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Git-基本理论"><a href="#Git-基本理论" class="headerlink" title="Git 基本理论"></a>Git 基本理论</h2><p>直接上图，重点关注左侧命令</p><p><img src="/archives/2121b11b/image-20210628141830141.png" style="zoom:80%;"></p><p>从工作区 -&gt; 暂存区：git add</p><p>从暂存区 -&gt; 本地仓库：git commit</p><p>从本地仓库 -&gt; 远程仓库：git push</p><p>这三个命令就能够让你感受到 git 版本控制的基本流程</p><h2 id="Git-仓库搭建"><a href="#Git-仓库搭建" class="headerlink" title="Git 仓库搭建"></a>Git 仓库搭建</h2><h3 id="git-init-amp-git-clone"><a href="#git-init-amp-git-clone" class="headerlink" title="git init &amp; git clone"></a>git init &amp; git clone</h3><p>生成仓库(master 分支)的两种方法</p><ol><li><p>git init 初始化，生成 .git 文件</p></li><li><p>git clone url 克隆远程仓库</p></li></ol><p>删除仓库则只需要删除 .git 文件夹即可</p><h2 id="Git-文件基本操作"><a href="#Git-文件基本操作" class="headerlink" title="Git 文件基本操作"></a>Git 文件基本操作</h2><h3 id="git-status"><a href="#git-status" class="headerlink" title="git status"></a>git status</h3><p>git status 查看 git 文件状态，git status file_name 可指定文件</p><p>文件的几种状态：</p><ol><li>untracked 文件在文件夹中，从没有 add 过</li><li>unmodify 文件已经 commit 且库中最新版本和当前文件是一致的，可以通过 git rm 将其移出版本库管理</li><li>modified 文件在 commit 或者 add 过后有过修改，可以使用 git checkout 丢弃修改</li><li>staged (文件在之前 commit 过后有过修改) 经过 add，没有 commit</li></ol><h3 id="gitignore"><a href="#gitignore" class="headerlink" title=".gitignore"></a>.gitignore</h3><p>有些时候我们不想把某些文件纳入版本控制中，可在主目录下建立 .gitignore 文件，例如你不详把 txt 类型文件进行版本控制，则在 .gitignore 文件中写入 *.txt 即可，其他具体规则不作介绍，也比较简单。</p><h3 id="git-add"><a href="#git-add" class="headerlink" title="git add"></a>git add</h3><p>git add file_name 将文件加入暂存区，文件成为 staged 状态</p><p>git add . 将当前文件夹 add，比较方便快捷</p><h3 id="git-commit"><a href="#git-commit" class="headerlink" title="git commit"></a>git commit</h3><p>git commit -m ‘massage you want to say’ 将暂存区所有文件加入到版本库中，并留下此次提交的 message</p><h3 id="git-rm"><a href="#git-rm" class="headerlink" title="git rm"></a>git rm</h3><p>将已经 commit 的文件从版本库中移除变为 untracked 文件</p><p>git rm —cached file_name</p><h2 id="Git-版本回退"><a href="#Git-版本回退" class="headerlink" title="Git 版本回退"></a>Git 版本回退</h2><h3 id="git-log-amp-git-reflog"><a href="#git-log-amp-git-reflog" class="headerlink" title="git log &amp; git reflog"></a>git log &amp; git reflog</h3><p>git log 查看 commit 历史记录，id，作者等信息</p><p>git reflog 查看所有的操作</p><h3 id="git-reset"><a href="#git-reset" class="headerlink" title="git reset"></a>git reset</h3><p>回退到某一个 commit 版本，id 只用写前几位，git 自动识别</p><p>git reset —hard commit_id</p><p>回退到上一个 commit 版本，如果回退两个则是 HEAD^^</p><p>git reset —hard HEAD^</p><p>—hard 参数其实代表回退到某个 commit 后，该 commit 之后的记录都会被丢弃。但 git 永远都有后悔药吃，如果回退到以前的版本想要再回来，使用 git reflog 查看所有命令</p><h3 id="git-checkout"><a href="#git-checkout" class="headerlink" title="git checkout"></a>git checkout</h3><p>git checkout 能够让文件回到最近一次 add 或者 commit 时的状态</p><p>git checkout file_name</p><h2 id="分支与冲突"><a href="#分支与冲突" class="headerlink" title="分支与冲突"></a>分支与冲突</h2><h3 id="git-branch"><a href="#git-branch" class="headerlink" title="git branch"></a>git branch</h3><p>从这里我们可以更加深入理解 git 的工作形象，working tree</p><p>除了 master 分支，我们还可以创建其他分支，HEAD 所指的就是 working tree “生长”的地方，然后我们将分支合并，也即让 master “赶上来”，再删除 dev 分支。git 分支还有一个一般规则是，master 分支永远是最稳定的分支，开发都在 dev 或其他分支上进行</p><p><img src="/archives/2121b11b/branch_1.png" style="zoom: 50%;"></p><p><img src="/archives/2121b11b/branch_2.png" style="zoom: 50%;"></p><p><img src="/archives/2121b11b/branch_3.png" style="zoom:50%;"></p><p>使用 git branch 查看分支情况，也可用于删除分支</p><p>git branch -d branch_name</p><h3 id="git-switch"><a href="#git-switch" class="headerlink" title="git switch"></a>git switch</h3><p>使用 git swich 来创建和切换分支</p><p>git switch -c branch_name</p><p># 复制远程的分支到本地</p><p>git switch -c branch_name origin/branch_name</p><p>git switch branch_name</p><h3 id="git-merge"><a href="#git-merge" class="headerlink" title="git merge"></a>git merge</h3><p>将某个分支合并到当前分支</p><p>git merge branch_name</p><p>如果发生了冲突：两个 branch 中在同一个文件中有不同的修改而无法合并，那么需要解决冲突。（判断文件是否有修改，是根据 commit id 之类的标记节点来判断的，但是否存在冲突则是根据文件的内容）</p><p><img src="/archives/2121b11b/branch_4.png" style="zoom:50%;"></p><p>先使用 git status 查看哪个文件发生冲突，然后使用 vim 编辑，git 会自动在文档中标明冲突的地方。怎样修改无所谓，只要你 add &amp; commit 过后，git 就会默认冲突解决，并将你的文件作为最新的版本加入版本库中，更新 working tree</p><p>如果对于 git 中 recursive 3-way merge 算法感兴趣，可以参看<a href="https://en.wikipedia.org/wiki/Merge_(version_control">维基百科</a></p><h2 id="远程仓库"><a href="#远程仓库" class="headerlink" title="远程仓库"></a>远程仓库</h2><h3 id="添加远程仓库-github-or-gitee"><a href="#添加远程仓库-github-or-gitee" class="headerlink" title="添加远程仓库 github or gitee"></a>添加远程仓库 github or gitee</h3><p>gitee 为国内网站，传输速度更快。通过以下步骤将本机与远程连接（以 github 为例）：</p><ol><li><p>注册 github 账号</p></li><li><p>生成 ssh 公钥</p><ol><li><p>在本机 user 目录下找到 ssh 文件夹（安装 git 过后这个文件夹会自动生成）</p></li><li><p>在 shell 中运行以下命令生成 ssh 密钥，其中 rsa 是一种加密算法 </p><p><code>ssh-keygen -t rsa</code></p><p>之后你就能在 .ssh 文件中找到 id_rsa 和 id_rsa.pub 文件</p></li></ol></li><li><p>添加 id_rsa.pub 到 github 账户设置中</p></li></ol><p>这样就把本机和远程仓库连接起来了，具体的说是将本机与你的 github 账号通过 ssh 连接起来了</p><h3 id="git-remote"><a href="#git-remote" class="headerlink" title="git remote"></a>git remote</h3><p>你的账号里可以有很多的仓库，我们想要将本地仓库与某一个指定仓库链接使用以下命令即可</p><p>git remote add origin [url]</p><p>远程仓库的名字叫 origin，这是 git 的默认叫法，url 是仓库的 https 或者 ssh</p><h3 id="git-push"><a href="#git-push" class="headerlink" title="git push"></a>git push</h3><p>把本地库的内容推送到远程仓库，使用下面命令</p><p>git push -u orgin master</p><p>这样就把本地 master 分支内容推送到了远程新的 master 分支。-u 参数为 set upstream 的意思，在推送的同时将我们的本地 master 分支和远程 master 分支联系起来（相当于作了 <code>git branch -u origin</code> ），今后则可以直接输入 git push 来简化推送命令，强烈建议在第一次 push 的时候带上 -u 参数</p><p>其他本地分支与远程分支的 push 和连接也是一样的，把上面命令的 master 改为对应分支的名字（例如：dev 分支）即可，前提是本地要切换到那个分支，且远程存在同名的分支。</p><p>个人认为 git push 一般是在同名的本地分支和远程分支之间进行</p><h3 id="git-pull"><a href="#git-pull" class="headerlink" title="git pull"></a>git pull</h3><p>文件冲突不仅出现在本地的 merge 当中，也存在在 push 操作当中。push 的本质也是将本地和远程这两个 branch 进行融合。当这个远程仓库只有你一个人在 push 时，是不会有冲突的，因为远程的 working tree 只会一直往前延伸；当有多个人都在对某一个文件进行修改，working tree 就相当于有了多个分支，在 push 的时候就会形成冲突。如果有远端的冲突形成，就需要使用 git pull</p><p>git pull 有两个作用，一个是拉取代码到本地，另一个是尝试与本地代码合并，如果不能使用 fast forward 合并，则需要自己来修改冲突部分，这部分和 git merge 是一样的</p><h2 id="Git-IDE"><a href="#Git-IDE" class="headerlink" title="Git + IDE"></a>Git + IDE</h2><p>现在 git 和很多 IDE 都有联动，可以直接在 IDE 中方便的操作 git！</p><p>以 pycharm 为例，只需要在你的项目文件夹下 git init 就可以 </p>]]></content>
      
      
      <categories>
          
          <category> 编程 </category>
          
          <category> Git </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Git </tag>
            
            <tag> 教程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hexo-theme-matery 教程</title>
      <link href="/archives/b129f5ae.html"/>
      <url>/archives/b129f5ae.html</url>
      
        <content type="html"><![CDATA[<h1 id="hexo-theme-matery-note"><a href="#hexo-theme-matery-note" class="headerlink" title="hexo-theme-matery note"></a>hexo-theme-matery note</h1><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>参考原 github 项目进行整理：<a href="https://github.com/blinkfox/hexo-theme-matery">https://github.com/blinkfox/hexo-theme-matery</a></p><h3 id="config-yml-的修改建议"><a href="#config-yml-的修改建议" class="headerlink" title="_config.yml 的修改建议"></a>_config.yml 的修改建议</h3><p>在 hexo 根目录下的 _config.yml 文件中：</p><ol><li><p>切换 theme 为 hexo-theme-matery</p></li><li><p>url 改为网站 url (如：<a href="http://xxx.github.io">http://xxx.github.io</a>)</p></li><li><p>per_page 数值改为6及6的倍数，这样文章列表在各个屏幕下都能较好显示</p></li><li><p>插入图片（有点复杂，可以先跳过）。根据 <a href="https://zhuanlan.zhihu.com/p/265077468">知乎链接</a> 配置好 post_asset_folder，里面提到的 typora 技巧也很实用，建议采用。且一般来讲链接中提到的 hexo-renderer-marked 插件都是已经内置好的，不然你的博客不会渲染成功。</p><p>但是这个方法不能控制图片大小，而且配置过 typora 后还要再改图片的路径。我再下载了 hexo-asset-image 插件过后，直接用 typora 中的 html 方法 <code>&lt;img src='post_name/img.jpg'&gt;</code>引用图片，不需要二次更改路径</p></li></ol><h3 id="新建分类-categories-页"><a href="#新建分类-categories-页" class="headerlink" title="新建分类 categories 页"></a>新建分类 categories 页</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">sudo</span> hexo new page <span class="token string">'categories'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>categories 页是用来展示所有分类的页面</p><p>修改 <code>/source/categories/index.md</code> 文件的 front-matter (Front-matter 是文件最上方以 —- 分隔的区域，用于指定个别文件的变量)</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">---title: categoriesdate: <span class="token number">2018</span>-09-30 <span class="token number">17</span>:25:30type: <span class="token string">"categories"</span>layout: <span class="token string">"categories"</span>---<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>关于 page 和 post 的区别：两者其实很相似，你可以把 page 看作是特殊的 post，用来放置一些特殊内容：如分类、标签等等。</p><p>hexo 的分类是有等级关系的，我们以下面的 post front-matter 为例</p><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">title: 我的博客搭建笔记date: 2021-06-29 15:26:41tags:<span class="token list punctuation">-</span> hexo<span class="token list punctuation">-</span> 博客搭建categories:<span class="token list punctuation">-</span> 软件基础<span class="token list punctuation">-</span> hexo<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个文件在分类时会被分配到所有提到的 categories 中，这些 categories 的路径是逐渐往下的 <code>/categories/软件基础/hexo/</code>，它们都有自己的 page 来收纳属于自己类别的文章。</p><h3 id="新建标签-tags-页"><a href="#新建标签-tags-页" class="headerlink" title="新建标签 tags 页"></a>新建标签 tags 页</h3><p>新建 page</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">hexo new page <span class="token string">"tags"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>修改对应 index.md</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">---title: tagsdate: <span class="token number">2018</span>-09-30 <span class="token number">18</span>:23:38type: <span class="token string">"tags"</span>layout: <span class="token string">"tags"</span>---<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>给 post 指定 tags 只需要在 front-matter 中写好就行了，如上面 categories 的例子。</p><h3 id="新建关于我-about-页"><a href="#新建关于我-about-页" class="headerlink" title="新建关于我 about 页"></a>新建关于我 about 页</h3><h3 id="新建留言板-contact-页"><a href="#新建留言板-contact-页" class="headerlink" title="新建留言板 contact 页"></a>新建留言板 contact 页</h3><h3 id="新建友情链接-friends-页"><a href="#新建友情链接-friends-页" class="headerlink" title="新建友情链接 friends 页"></a>新建友情链接 friends 页</h3><p>新建方法都是和上面的方法一样的</p><h2 id="菜单导航配置"><a href="#菜单导航配置" class="headerlink" title="菜单导航配置"></a>菜单导航配置</h2><h3 id="名称、路径、图标"><a href="#名称、路径、图标" class="headerlink" title="名称、路径、图标"></a>名称、路径、图标</h3><p>配置菜单导航的名称、路径url、和图标icon，配置文件在 <code>themes/hexo-theme-matery/._config.yml</code></p><p>更改 menu 部分即可</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">menu:  <span class="token comment"># 把 Index 改为 Home</span>  Home:    url: /    icon: fas fa-home  Tags:    url: /tags    icon: fas fa-tags<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可该的部分：</p><ol><li>名称可以是中文</li><li>图标可以在 <a href="https://fontawesome.com/icons">Font Awesome</a> 中查找</li><li>还可以使用二级菜单。二级菜单在实现上可以理解为创建了一个软链接，到你指定的 page 上。</li></ol><p>由于我对于这个导航还是比较满意，就不作过多修改</p><h3 id="修改页脚"><a href="#修改页脚" class="headerlink" title="修改页脚"></a>修改页脚</h3><p>页脚信息可能需要做定制化修改，修改的地方在主题文件的 <code>/layout/_partial/footer.ejs</code> 文件中，包括站点、使用的主题、访问量等。</p><p>由于代码看不明白，找到了一个比较详细的教程</p><p><a href="https://sunhwee.com/posts/6e8839eb.html">https://sunhwee.com/posts/6e8839eb.html</a></p><p>根据上面的链接修改了版权信息，增加了网站运行时间，访问人数的代码目前不需要修改</p><h3 id="代码高亮"><a href="#代码高亮" class="headerlink" title="代码高亮"></a>代码高亮</h3><p>修改 Hexo 根目录下 <code>_config.yml</code> 文件中 <code>highlight.enable</code> 的值为 <code>false</code>，并将 <code>prismjs.enable</code> 的值设置为 <code>true</code></p><p>以上的设置并不管用，没有高亮也没有行号</p><p>但是我下载了 hexo-prism-plugin 又卸载掉这个插件，就有高亮了，但依旧没有行号</p><p>考虑是 matery.css 文件中 pre 下 paddidng 不够大的问题，增加 padding 但依然没能解决</p><p>考虑是不是本身 prism 文件出了问题，重新到官网上下载了 prism.js 和 prism.css 替换原来系统中对应的文件，同时调整上面提到的 padding 参数，最后成功！</p><p>prism.js 文件位置在 <code>node_modules/prismjs</code></p><p>prism.css 文件位置在 <code>themes/hexo-theme-matery/source/libs/prism</code></p><p>现在想要去除隔离的那条竖线，尝试重复下面链接的操作，操作过后竖线没有去除，不过稍微调整了一下代码位置，也挺好看</p><p><a href="https://github.com/blinkfox/hexo-theme-matery/issues/103">https://github.com/blinkfox/hexo-theme-matery/issues/103</a></p><p>最终，我通过修改 prism.css 中 border-right 为 0px，去除了行号和代码之间的分隔线！</p><pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">.line-numbers .line-numbers-rows</span> <span class="token punctuation">{</span><span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span><span class="token property">pointer-events</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span><span class="token property">top</span><span class="token punctuation">:</span> -0.2em<span class="token punctuation">;</span><span class="token property">font-size</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span><span class="token property">left</span><span class="token punctuation">:</span> -3.8em<span class="token punctuation">;</span><span class="token property">width</span><span class="token punctuation">:</span> 3em<span class="token punctuation">;</span> <span class="token comment">/* works for line-numbers below 1000 lines */</span><span class="token property">letter-spacing</span><span class="token punctuation">:</span> -1px<span class="token punctuation">;</span><span class="token property">border-right</span><span class="token punctuation">:</span> 0px solid #999<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>现在解决标号和 code 没对齐的问题，修改 prism.css 文件中 <code>.line-numbers .line-numbers-rows</code> 下 top 参数为 -0.2em，微调成功！治好了强迫症！</p><h2 id="配置-theme-中的-config-yml"><a href="#配置-theme-中的-config-yml" class="headerlink" title="配置 theme 中的 _config.yml"></a>配置 theme 中的 _config.yml</h2><ol><li><p>根据配置文件中的注释，简单修改了下面的设置</p><p>dream, music, video, recommend, github &amp; social link, reward, clicklove, myProjects, mySkills, subtitle, banner</p></li><li><p>取消 rainbow 特效</p><pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">.bg-cover:after</span> <span class="token punctuation">{</span>    <span class="token property">-webkit-animation</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>    <span class="token property">animation</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>在 hexo d 时遇到问题</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">err: Error: Spawn failed<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>第二天自动好了，根本原因是网络没有走通的问题，之后可能再次遇到，到时候再解决，建议在 github 上搜索</p><p>现在发现了，由于我使用的是 root 用户下的 git 配置，而我 root 用户下 git config 没有设置好参数所以部署失败。我在 root 目录的 .gitconfig 和 .ssh 下配置好了 user.name ssh 等必要 git 配置就成功了。这说明了在 linux 下不同的用户都需要自己去配置 git</p></li><li><p>修改博客 feature image 只选用1张简单图来代表。原来有 24 张图，我把24个路径全部改为同1张图。</p></li><li><p>因为之后需要写入数学公式，将 mathjax 改为 true。但发现显示公式渲染不正常，而且小括号显示不出来。根据 <a href="https://github.com/blinkfox/hexo-theme-matery/issues/119">github issue</a> 解决无法换行问题，将渲染器换为 hexo-renderer-kramed 而且代码高亮插件似乎并没受到影响。根据 <a href="https://adaning.github.io/posts/33457.html">MathJax常见问题</a> 解决小括号无法显示问题。</p></li></ol><h2 id="配置-matery-css"><a href="#配置-matery-css" class="headerlink" title="配置 matery.css"></a>配置 matery.css</h2><p>为了进一步设置我们的网页，让其更具有个性化，就需要进一步调整 matery.css 文件。</p><ol><li><p>设置 导航颜色</p><pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">.bg-color</span> <span class="token punctuation">{</span>    <span class="token property">background-image</span><span class="token punctuation">:</span> <span class="token function">linear-gradient</span><span class="token punctuation">(</span>to right<span class="token punctuation">,</span> #BEBEBE 0%<span class="token punctuation">,</span> #708090 100%<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>查询颜色代码网址：<a href="https://tool.oschina.net/commons?type=3">https://tool.oschina.net/commons?type=3</a></p></li><li><p>由于刚开始加载时 banner 图片没有迅速加载，会默认先加载橙色，我改成灰色</p><p>修改“\Hexo\themes\hexo-theme-matery\layout\ _partial\index-cover.ejs”文件中的第63行即可。</p><pre class="line-numbers language-ejs" data-language="ejs"><code class="language-ejs"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>carousel-item red white-text bg-cover about-cover<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>把“red”修改为其他颜色即可。我改为 slate gray</p></li><li><p>改变 progress-bar 颜色</p></li><li><p>改变回到顶部按钮颜色 top-scroll</p></li><li><p>改变封面打字效果的文字大小、颜色 .bg-cover .description</p></li><li><p>修改了打字效果的颜色过后，我发现文章标题的颜色也跟着改了。解决方法是在下面的 .bg-cover .description 增加属性 color: #color_code，这样就能分别调整它们的颜色。</p></li><li><p>修改 about 页面链接颜色 aboutme</p></li><li><p>修改 archive 页面时间线颜色 cd-timeline</p></li></ol><h2 id="插件优化"><a href="#插件优化" class="headerlink" title="插件优化"></a>插件优化</h2><h3 id="文章-url-优化"><a href="#文章-url-优化" class="headerlink" title="文章 url 优化"></a>文章 url 优化</h3><p>我没有使用项目中主要介绍的转拼音方法，那样生成的链接太长了，而是使用 hexo-abbrlink 插件</p><pre class="line-numbers language-sehll" data-language="sehll"><code class="language-sehll">npm install hexo-abbrlink --save<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>在根目录 _config.yml 文件中修改</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">permalink</span><span class="token punctuation">:</span> archives/<span class="token punctuation">:</span>abbrlink.html<span class="token key atrule">abbrlink</span><span class="token punctuation">:</span>    <span class="token key atrule">alg</span><span class="token punctuation">:</span> crc32   <span class="token comment">#算法： crc16(default) and crc32</span>    <span class="token key atrule">rep</span><span class="token punctuation">:</span> hex     <span class="token comment">#进制： dec(default) and hex</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>在 hexo 三连时遇到报错</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">FATAL YAMLException: duplicated mapping key <span class="token punctuation">(</span><span class="token number">111</span>:1<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>说明有原配置文件中已经有 permalink 的定义，我们需要把里本身的 permalink 代码注释掉，完美运行！现在我们的文章 url 最后是特殊的数字id <code>/archives/48732.html</code></p><h3 id="文章字数统计插件"><a href="#文章字数统计插件" class="headerlink" title="文章字数统计插件"></a>文章字数统计插件</h3><h3 id="添加-emoji-表情支持"><a href="#添加-emoji-表情支持" class="headerlink" title="添加 emoji 表情支持"></a>添加 emoji 表情支持</h3><h3 id="搜索"><a href="#搜索" class="headerlink" title="搜索"></a>搜索</h3><p>上面三个部分都是按照 hexo-thme-matery github 项目配置的</p><h3 id="评论插件utterance"><a href="#评论插件utterance" class="headerlink" title="评论插件utterance"></a>评论插件utterance</h3><p>matery 在配置文件中告诉我们，有的评论软件有安全隐患，推荐使用 utterance</p><p>尝试 utterance，如果成功，则返回卸载 valine，注销 lean cloud</p><p>也尝试了 livere 安装也很不友好</p><p>成功在 contact 页面下展示了 utterance，方法是在 contact.ejs 文档下找了一个地方插入下面的代码（记得改为 r自己的 github repo，形式为 <owner>/<name> ），</name></owner></p><pre class="line-numbers language-ejs" data-language="ejs"><code class="language-ejs"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://utteranc.es/client.js<span class="token punctuation">"</span></span><span class="token attr-name">repo</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>[ENTER REPO HERE]<span class="token punctuation">"</span></span><span class="token attr-name">issue-term</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>pathname<span class="token punctuation">"</span></span><span class="token attr-name">theme</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>github-light<span class="token punctuation">"</span></span><span class="token attr-name">crossorigin</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>anonymous<span class="token punctuation">"</span></span><span class="token attr-name">async</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript"></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我插入在 <code>&lt;div class="card"&gt;</code> 后面，是管用的。因为原项目说，插入到你的 layout 需要出现的地方，我不懂前端的代码，只能胡乱插入了，管用就行！我猜测这是一个“卡片类”能够存放你的内容，以白色卡片在页面中展示出来。</p><p>用同样的方法在 post 下添加评论。找到 <code>/hexo-theme-matery/layout/_partial/post-detail.ejs</code> 文件，找到评论的布局之处（搜索主题自带的评论插件如 gittalk，就能找到）插入上面的代码即可。但是渲染过后背景是透明的，不太好看，我希望想 contact 一样有白色背景，那就复制一下 contact.ejs 中的“卡片类”评论区就行了。</p><h3 id="分类优化"><a href="#分类优化" class="headerlink" title="分类优化"></a>分类优化</h3><p>matery 主题的分类没有多层分类，在 categories 页面只有像 tag 一样标签，这样的分类又有什么用呢？根据 <a href="https://notes.zhangxiaocai.cn/posts/5a99eb4d.html#toc-heading-8">Hexo Matery 主题添加多级分类</a> 进行设置，可以得到更好的分类页，类别之间将有层次关系</p><p>具体来讲，采用了博客里最新更新的代码，又作了以下改动：</p><ol><li><p>给 category-item, category-count 等增加 color 属性，改为自己喜欢的颜色</p></li><li><p>给 category-title 增加 font-size 属性，修改标题大小</p></li><li><p>由于每次进入目录默认要展开一个类别，改动下方代码，让所有类别初始状态默认折叠</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">/* origin code: &lt;li  class="&lt;%= subCats.length &gt; 0 ? 'active' : '' %&gt;" &gt; */</span><span class="token operator">&lt;</span>li  <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"&lt;%= subCats.length &gt; 10000 ? 'active' : '' %&gt;"</span> <span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>删除箭头变化 <code>category-item-action col s11 m11</code></p></li></ol><h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><h3 id="网站SEO优化"><a href="#网站SEO优化" class="headerlink" title="网站SEO优化"></a>网站SEO优化</h3><p>Search Engine Optimization</p><p>将自己的网站提交给搜索引擎</p><h3 id="不断更新"><a href="#不断更新" class="headerlink" title="不断更新"></a>不断更新</h3><p>持续更新博客内容，完善分类</p>]]></content>
      
      
      <categories>
          
          <category> 软件 </category>
          
          <category> Hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
            <tag> 博客搭建 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>我的博客搭建笔记</title>
      <link href="/archives/4984.html"/>
      <url>/archives/4984.html</url>
      
        <content type="html"><![CDATA[<h1 id="个人博客搭建-hexo"><a href="#个人博客搭建-hexo" class="headerlink" title="个人博客搭建 hexo"></a>个人博客搭建 hexo</h1><p>整体参考过程为 CodeSheep 视频：<a href="https://www.bilibili.com/video/BV1Yb411a7ty">https://www.bilibili.com/video/BV1Yb411a7ty</a></p><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h3 id="Node-js-amp-npm"><a href="#Node-js-amp-npm" class="headerlink" title="Node.js &amp; npm"></a>Node.js &amp; npm</h3><p>参考链接：<a href="https://developer.aliyun.com/article/760687">https://developer.aliyun.com/article/760687</a></p><p>我选择了 apt 安装</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">sudo</span> <span class="token function">apt</span> update<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> nodejs <span class="token function">npm</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>版本信息</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">nodejs --versionv10.19.0<span class="token function">npm</span> --version<span class="token number">6.14</span>.4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>版本还是有点老旧</p><h3 id="淘宝镜像-cnpm"><a href="#淘宝镜像-cnpm" class="headerlink" title="淘宝镜像 cnpm"></a>淘宝镜像 cnpm</h3><p>cnpm 的官方介绍是：cnpm是一个完整 npmjs.or 镜像，你可以用此代替官方版本(只读)，同步频率目前为 <strong>10分钟</strong> 一次以保证尽量与官方服务同步。</p><p>安装了 cnpm 就可以使用镜像资源下载包，如果不希望使用镜像资源则换回 npm 命令即可。使用如下命令安装</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">sudo</span> <span class="token function">npm</span> <span class="token function">install</span> -g cnpm --registry<span class="token operator">=</span>https://registry.npm.taobao.org<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="hexo"><a href="#hexo" class="headerlink" title="hexo"></a>hexo</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">sudo</span> cnpm <span class="token function">install</span> -g hexo-cli<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>版本信息</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">hexo -vhexo-cli: <span class="token number">4.3</span>.0os: linux <span class="token number">5.4</span>.0-77-generic Ubuntu <span class="token number">20.04</span>.2 LTS <span class="token punctuation">(</span>Focal Fossa<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="搭建博客"><a href="#搭建博客" class="headerlink" title="搭建博客"></a>搭建博客</h2><h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">mkdir</span> blog <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> blog<span class="token function">sudo</span> hexo init<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>如果哪里出错了，想重来，直接删除 blog 文件夹即可</p><h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">sudo</span> hexo server<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>遇到报错</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">INFO  Validating configINFO  Start processingFATAL <span class="token punctuation">{</span> err:   TypeError: line.matchAll is not a <span class="token keyword">function</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>原因在于 nodejs 版本太低，尝试使用 n 升级 nodejs</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">sudo</span> <span class="token function">npm</span> <span class="token function">install</span> -g n<span class="token function">sudo</span> n latest<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>查看版本</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">node -vv16.4.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>成功启动 hexo server，你可以通过 <a href="http://localhost:4000">http://localhost:4000</a> 访问你的本地博客啦！</p><h3 id="写第一篇文章"><a href="#写第一篇文章" class="headerlink" title="写第一篇文章"></a>写第一篇文章</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">sudo</span> hexo new <span class="token string">'Fisrt Blog'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>信息</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">INFO  Validating configINFO  Created: /home/declan/Documents/blog/source/_posts/First-Blog.md<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>你的文章位置在上面的路径中可以找到，可以通过 markdown 语法进行书写</p><h3 id="生成"><a href="#生成" class="headerlink" title="生成"></a>生成</h3><p>清理一些缓存，然后生成我们的页面，同样使用 hexo server 从本地查看效果</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">hexo cleanhexo generatehexo server<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="布属到远端"><a href="#布属到远端" class="headerlink" title="布属到远端"></a>布属到远端</h2><h3 id="github"><a href="#github" class="headerlink" title="github"></a>github</h3><p>在 github 新建仓库 name.github.io name一定要是你的 github 用户名</p><p>在 blog 目录下，下载 git deployer</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">sudo</span> cnpm <span class="token function">install</span> --save hexo-deployer-git<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="设置-config-yml"><a href="#设置-config-yml" class="headerlink" title="设置 _config.yml"></a>设置 _config.yml</h3><p>在 blog 目录下打开 _config.yml 文件，在文件最后的 # Deployments 上修改</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token comment"># Deployment</span><span class="token comment">## Docs: https://hexo.io/docs/one-command-deployment</span>deploy:  type: <span class="token string">'git'</span>  repo: https://github.com/DeclK/declk.github.io.git  branch: master<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Deploy"><a href="#Deploy" class="headerlink" title="Deploy"></a>Deploy</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">sudo</span> hexo deploy<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>现在你的仓库里多了一些文件</p><p>以后你就可以通过你的仓库名 <em>*</em>.github.io 来访问你的博客啦！</p><h2 id="更换主题"><a href="#更换主题" class="headerlink" title="更换主题"></a>更换主题</h2><p>在寻找了许久过后决定使用 <a href="https://github.com/blinkfox/hexo-theme-matery">hexo-theme-matery</a></p>]]></content>
      
      
      <categories>
          
          <category> 软件 </category>
          
          <category> Hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
            <tag> 博客搭建 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
